<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Board - Dreamex Lab</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Dashboard specific styles */
        .dashboard-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 30px;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .dashboard-title h2 {
            margin: 0;
            color: #34495e;
        }

        .dashboard-title p {
            margin: 5px 0 0;
            color: #7f8c8d;
            font-size: 14px;
        }

        .dashboard-actions {
            display: flex;
            gap: 10px;
        }

        .dashboard-btn {
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }

        .refresh-btn {
            background-color: #3498db;
            color: white;
        }

        .refresh-btn:hover {
            background-color: #2980b9;
        }

        .dashboard-search {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        .dashboard-search input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .dashboard-search button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 4px;
            cursor: pointer;
        }

        /* User table styles */
        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .user-table th,
        .user-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .user-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #34495e;
        }

        .user-table tbody tr:hover {
            background-color: #f5f7fa;
        }

        .user-avatar-cell {
            width: 60px;
        }

        .user-avatar-sm {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .user-initial-sm {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .user-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .status-active {
            background-color: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* Pagination styles */
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .pagination-btn {
            padding: 8px 12px;
            margin: 0 5px;
            border: 1px solid #ddd;
            background-color: #fff;
            color: #333;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .pagination-btn:hover {
            background-color: #f5f5f5;
        }

        .pagination-btn.active {
            background-color: #3498db;
            color: #fff;
            border-color: #3498db;
        }

        .pagination-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Dashboard stats styles */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 14px;
        }

        /* Loading indicator */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }

        .loading-spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Menu bar styles */
        .menu-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #34495e;
            padding: 0 20px;
        }
        
        .menu-bar ul {
            display: flex;
            align-items: center;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .menu-bar ul li {
            margin: 0 10px;
        }
        
        .menu-bar ul li a {
            display: block;
            padding: 15px 10px;
            color: #ecf0f1;
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .menu-bar ul li a:hover {
            color: #f1f3f5;
        }
        
        .menu-bar ul li.current a {
            color: #fafcfd;
            font-weight: bold;
        }

        /* Dropdown styles */
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white !important;
            color: black !important;
            min-width: 160px;
            box-shadow: 0px 8px 16px rgba(0,0,0,0.2);
            z-index: 1;
            top: calc(100%);
            font-size: 6px !important;
            font-weight: normal;
            text-align: left;
        }
        .dropdown-content a {
            color: rgb(44, 43, 43) !important;
            padding: 6px 10px !important;
            text-decoration: none;  
            display: block;
            font-size: 11px !important;
        }
        .dropdown-content a:hover {
            background-color: #e8e8e8;
            transform: none; 
        }
        .dropdown:hover .dropdown-content,
        .dropdown:focus-within .dropdown-content {
            display: block;
        }

        /* User Avatar Styles */
        .user-avatar-container {
            position: relative;
            display: flex;
            align-items: center;
            margin-right: 20px;
            cursor: pointer;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .user-dropdown {
            position: absolute;
            top: 45px;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 0;
            min-width: 200px;
            display: none;
            z-index: 1000;
            text-align: left;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.08);
        }

        /* Add class for showing the dropdown */
        .user-dropdown.show {
            display: block;
            animation: dropdown-fade-in 0.2s ease-out;
        }
        
        /* Add missing animation definition */
        @keyframes dropdown-fade-in {
            0% { opacity: 0; transform: translateY(-10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        .user-email {
            padding: 5px 15px; /* Further reduced from 8px to 5px */
            border-bottom: 1px solid #eaeaea;
            color: #34495e;
            font-weight: 500;
            background-color: #f8f9fa;
            font-size: 13px; /* Reduced from 14px to 13px */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .user-dropdown a {
            display: block;
            padding: 2px 15px; /* Further reduced from 4px to 2px */
            color: #000000;
            text-decoration: none;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            font-size: 13px; /* Reduced from 14px to 13px */
            line-height: 1.4; /* Added to provide some minimal spacing */
        }
        
        /* Ensure specific dropdown links are black */
        #profileLink, #accountLink {
            color: #474646 !important; /* Pure black color with !important to override any other styles */
        }
        
        .user-dropdown a:hover {
            background-color: #f1f8fe;
            border-left-color: #3498db;
            color: #3498db;
        }
        
        .user-dropdown a:last-child {
            border-top: 1px solid #eaeaea;
        }
        
        #logoutButton {
            color: #e74c3c; /* Keep logout button red */
        }
        
        #logoutButton:hover {
            background-color: #fdeeee;
            border-left-color: #e74c3c;
        }
        
        #loginButton {
            color: #000000; /* Changed to black */
        }
        
        #loginButton:hover {
            background-color: #f1f8fe;
            border-left-color: #3498db;
            color: #3498db;
        }
        
        .user-initial {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s linear 0.25s, opacity 0.25s;
        }
        
        .modal-visible {
            visibility: visible;
            opacity: 1;
            transition-delay: 0s;
        }
        
        .modal-container {
            background-color: #fff;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            padding: 30px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #34495e;
            font-weight: 700;
        }
        
        .modal-close {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 22px;
            color: #7f8c8d;
        }
        
        .modal-form .form-group {
            margin-bottom: 20px;
        }
        
        .modal-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
            font-size: 14px;
        }
        
        .modal-form input,
        .modal-form select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .modal-form input:focus,
        .modal-form select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }
        
        .modal-form .form-row {
            display: flex;
            gap: 15px;
        }
        
        .modal-form .form-row > div {
            flex: 1;
        }
        
        .modal-form .error-message {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }
        
        .modal-form .has-error input {
            border-color: #e74c3c;
        }
        
        .modal-form .has-error .error-message {
            display: block;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-btn {
            padding: 10px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }
        
        .modal-cancel {
            background-color: #f1f2f6;
            color: #333;
        }
        
        .modal-save {
            background-color: #3498db;
            color: white;
        }
        
        .modal-save:hover {
            background-color: #2980b9;
        }
        
        .modal-cancel:hover {
            background-color: #e8e8e8;
        }
        
        /* Button to create user */
        .create-user-btn {
            background-color: #2ecc71;
            color: white;
        }
        
        .create-user-btn:hover {
            background-color: #27ae60;
        }
        
        /* Clickable table rows */
        .user-table tbody tr {
            cursor: pointer;
        }

        .modal-delete {
            background-color: #e74c3c;
            color: white;
        }
        
        .modal-delete:hover {
            background-color: #c0392b;
        }
        
        .restricted-user {
            opacity: 0.7;
            cursor: not-allowed !important;
        }
        
        .dashboard-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Audit log specific styles */
        .audit-log-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 30px;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            text-align: left; /* Ensure all content is left-aligned */
        }
        
        .page-title {
            margin-top: 0;
            margin-bottom: 30px;
            color: #34495e;
            font-size: 28px;
            text-align: center; /* Keep title centered */
        }
        
        .filters-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px; /* Increased from 15px */
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
            margin-right: 10px; /* Added margin between filter groups */
            margin-bottom: 10px; /* Added margin for when filters wrap to new line */
            padding: 5px; /* Added padding inside each filter group */
            border-radius: 4px; /* Optional: rounded corners for each filter group */
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
            font-size: 14px;
        }
        
        .filter-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .filter-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .filter-btn:hover {
            background-color: #2980b9;
        }
        
        .clear-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .clear-btn:hover {
            background-color: #c0392b;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }
        
        .spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .audit-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }
        
        .audit-table th, .audit-table td {
            padding: 12px 15px;
            text-align: left; /* Explicitly set table cells to left alignment */
            border-bottom: 1px solid #e0e0e0;
        }
        
        .audit-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #34495e;
        }
        
        .audit-table tbody tr:hover {
            background-color: #f5f7fa;
        }
        
        .empty-state {
            text-align: center; /* Keep empty state message centered */
            padding: 40px;
            color: #7f8c8d;
            font-size: 16px;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 30px;
        }
        
        .pagination button {
            padding: 8px 12px;
            margin: 0 5px;
            border: 1px solid #ddd;
            background-color: #fff;
            color: #333;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .pagination button:hover {
            background-color: #f5f5f5;
        }
        
        .pagination button.active {
            background-color: #3498db;
            color: #fff;
            border-color: #3498db;
        }
        
        .pagination button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .export-btn {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
            float: right;
            margin-bottom: 20px;
        }
        
        .export-btn:hover {
            background-color: #219653;
        }

        /* Updated Event Form Styles */
        .event-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 30px;
            background: #ffffff;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        .event-container h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2rem;
            color: #34495e;
        }
        form#eventForm fieldset {
            border: 1px solid #dde1e7;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
        }
        form#eventForm fieldset legend {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
            padding: 0 10px;
        }
        form#eventForm label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #34495e;
        }
        form#eventForm input[type="text"],
        form#eventForm input[type="datetime-local"],
        form#eventForm input[type="date"],
        form#eventForm select,
        form#eventForm textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccd0d5;
            border-radius: 4px;
            margin-bottom: 15px;
            transition: border-color 0.3s;
        }
        form#eventForm input:focus,
        form#eventForm select:focus,
        form#eventForm textarea:focus {
            border-color: #3498db;
            outline: none;
        }
        form#eventForm .checkbox-group label {
            display: inline-block;
            margin-right: 20px;
        }
        form#eventForm .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }
        form#eventForm .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
        }
        form#eventForm .btn-reset {
            background: #f8f9fa;
            color: #34495e;
            border: 1px solid #ccd0d5;
        }
        form#eventForm .btn-submit {
            background: #3498db;
            color: #fff;
        }
        
        /* Event Board specific styles */
        .event-board-container {
            max-width: 100%; /* Changed from 1200px to full width */
            margin: 80px 20px 20px 20px; /* Increased top margin to 80px for 4x spacing */
            padding: 30px;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .event-title h2 {
            margin: 0;
            color: #34495e;
        }

        .event-title p {
            margin: 5px 0 0;
            color: #7f8c8d;
            font-size: 14px;
        }

        .event-filters {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .filter-inputs {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .event-table-container {
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow-x: auto;
        }

        .event-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .event-table th,
        .event-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .event-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #34495e;
            cursor: pointer;
            font-size: 13px;
            padding: 10px 12px;
        }

        .event-table th:hover {
            background-color: #eaecef;
        }

        .event-table td {
            font-size: 12px;
            padding: 8px 12px;
        }

        .event-table tbody tr:hover {
            background-color: #f5f7fa;
            cursor: pointer;
        }

        .event-type-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            color: white;
        }

        .type-incident { background-color: #e74c3c; }
        .type-near-miss { background-color: #f39c12; }
        .type-unsafe-act { background-color: #e67e22; }
        .type-unsafe-condition { background-color: #3498db; }
        .type-environmental-impact { background-color: #2ecc71; }
        .type-property-damage { background-color: #95a5a6; }

        .severity-minor { color: #2ecc71; }
        .severity-moderate { color: #f39c12; }
        .severity-major { color: #e67e22; }
        .severity-critical { color: #e74c3c; }

        .status-pending { color: #f39c12; }
        .status-approved { color: #2ecc71; }
        .status-rejected { color: #e74c3c; }

        .empty-state {
            padding: 40px;
            text-align: center;
            color: #7f8c8d;
        }

        .event-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .btn-add-event {
            background-color: #2ecc71;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }

        .btn-add-event:hover {
            background-color: #27ae60;
        }

        /* Action button styles */
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .btn-approve {
            background-color: #2ecc71;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .btn-reject {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .btn-approve:hover {
            background-color: #27ae60;
        }
        
        .btn-reject:hover {
            background-color: #c0392b;
        }
        
        .btn-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Edit modal specific styles */
        .edit-form-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .edit-form-full {
            grid-column: span 2;
        }
        
        .edit-form-container label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #34495e;
            font-size: 14px;
        }
        
        .edit-form-container input,
        .edit-form-container select,
        .edit-form-container textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .edit-form-container textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .btn-edit {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
            margin-right: 5px;
        }
        
        .btn-edit:hover {
            background-color: #2980b9;
        }

        /* Enhanced Notification Bell Styles */
        .notification-bell-container {
            position: relative;
            margin-right: 15px;
            cursor: pointer;
        }

        .notification-bell {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 40px;
            width: 40px;
            transition: transform 0.2s ease;
            color: #ecf0f1;
        }

        .notification-bell:hover {
            transform: scale(1.1);
        }

        .bell-icon-svg {
            height: 24px;
            width: 24px;
            fill: currentColor;
        }

        .notification-counter {
            position: absolute;
            top: 2px;
            right: 2px;
            background-color: #e74c3c;
            color: white;
            border-radius: 50%;
            min-width: 18px;
            height: 18px;
            font-size: 11px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 2px;
            box-sizing: border-box;
            border: 2px solid #34495e;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: transform 0.2s ease;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4);
            }
            70% {
                box-shadow: 0 0 0 6px rgba(231, 76, 60, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0);
            }
        }

        @keyframes bellShake {
            0% { transform: rotate(0); }
            15% { transform: rotate(5deg); }
            30% { transform: rotate(-5deg); }
            45% { transform: rotate(4deg); }
            60% { transform: rotate(-4deg); }
            75% { transform: rotate(2deg); }
            85% { transform: rotate(-2deg); }
            92% { transform: rotate(1deg); }
            100% { transform: rotate(0); }
        }

        .notification-bell.has-new {
            animation: bellShake 2s cubic-bezier(.36,.07,.19,.97) both;
            animation-iteration-count: 1;
        }

        .notification-bell.animate {
            animation: bellShake 1s cubic-bezier(.36,.07,.19,.97) both;
        }

        .notification-dropdown {
            position: absolute;
            top: 45px;
            right: -10px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.15);
            width: 350px;
            max-width: 90vw;
            z-index: 1001;
            display: none;
            max-height: 450px;
            overflow-y: auto;
            animation: dropdown-fade-in 0.2s ease-out;
            border: 1px solid rgba(0,0,0,0.08);
        }

        @keyframes dropdown-fade-in {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Triangle pointer for dropdown */
        .notification-dropdown::before {
            content: '';
            position: absolute;
            top: -10px;
            right: 20px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 10px solid white;
            filter: drop-shadow(0 -2px 2px rgba(0,0,0,0.1));
        }

        .notification-bell-container.active .notification-dropdown {
            display: block;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            position: sticky;
            top: 0;
            background: white;
            border-radius: 12px 12px 0 0;
            z-index: 5;
        }

        .notification-header h4 {
            margin: 0;
            font-size: 16px;
            color: #2c3e50;
            font-weight: 600;
        }

        .notification-header-actions button {
            background: none;
            border: none;
            color: #3498db;
            font-size: 13px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .notification-header-actions button:hover {
            background-color: #f7f9fa;
            color: #2980b9;
        }

        .notification-list {
            max-height: 350px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #bdc3c7 #f5f5f5;
        }

        .notification-list::-webkit-scrollbar {
            width: 6px;
        }

        .notification-list::-webkit-scrollbar-track {
            background: #f5f5f5;
        }

        .notification-list::-webkit-scrollbar-thumb {
            background-color: #bdc3c7;
            border-radius: 6px;
        }

        .notification-list-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: flex-start;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
        }

        .notification-list-item:hover {
            background-color: #f8f9fa;
        }

        .notification-list-item.unread {
            background-color: rgba(52, 152, 219, 0.05);
        }

        .notification-list-item.unread::before {
            content: '';
            position: absolute;
            left: 7px;
            top: 50%;
            transform: translateY(-50%);
            width: 6px;
            height: 6px;
            background-color: #3498db;
            border-radius: 50%;
        }

        .notification-icon {
            margin-right: 15px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(52, 152, 219, 0.3);
            transition: transform 0.2s ease;
        }
        
        .notification-list-item:hover .notification-icon {
            transform: scale(1.1);
        }

        .notification-icon.warning {
            background-color: #f39c12;
            box-shadow: 0 2px 5px rgba(243, 156, 18, 0.3);
        }

        .notification-icon.error {
            background-color: #e74c3c;
            box-shadow: 0 2px 5px rgba(231, 76, 60, 0.3);
        }

        .notification-icon.success {
            background-color: #2ecc71;
            box-shadow: 0 2px 5px rgba(46, 204, 113, 0.3);
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            margin: 0 0 5px 0;
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            line-height: 1.3;
        }

        .notification-message {
            margin: 0 0 5px 0;
            font-size: 13px;
            color: #7f8c8d;
            line-height: 1.4;
        }

        .notification-time {
            font-size: 11px;
            color: #95a5a6;
            font-style: italic;
        }

        .notification-empty {
            padding: 40px 15px;
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="%23ecf0f1" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>');
            background-position: center 30px;
            background-repeat: no-repeat;
            background-size: 60px;
            padding-top: 100px;
        }

        /* Mark as read button */
        .notification-mark-read {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            color: #bdc3c7;
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            display: none;
            transition: all 0.2s ease;
        }
        
        .notification-list-item:hover .notification-mark-read {
            display: block;
        }
        
        .notification-mark-read:hover {
            color: #7f8c8d;
            background-color: rgba(0,0,0,0.05);
        }

        /* Timestamp column specific styles */
        .timestamp-column {
            white-space: nowrap;
            width: 140px;
        }
    </style>
    <!-- Add Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <!-- Include auth.js after Firebase SDKs -->
    <script src="js/auth.js"></script>
</head>
<body>
    <header>
        <nav class="menu-bar">
            <ul class="menu-left">
                <li><a href="login.html">Home</a></li>
                <li class="dropdown">
                    <a href="#">Risk Management</a>
                    <div class="dropdown-content">
                        <a href="riskassessment.html">Risk Assessment</a>
                        <a href="jsaboard.html">Job Safety Analysis</a>
                    </div>
                </li>
                <li class="dropdown">
                    <a href="#">Safety reporting</a>
                    <div class="dropdown-content">
                        <a href="eventboard.html">Event</a>
                        <a href="inspectionsboard.html">Inspections</a>
                    </div>
                </li>
                <li class="dropdown">
                    <a href="#">Settings</a>
                    <div class="dropdown-content">
                        <a href="account.html">User account</a>
                        <a href="setup.html">Inspections</a>
                        <a href="log.html">System audit log</a>
                    </div>
                </li>
                <li><a href="dashboard.html">Dashboard</a></li>
            </ul>
            <ul class="menu-right">
                <!-- Add Notification Bell -->
                <li class="notification-bell-container" id="notificationBellContainer">
                    <div class="notification-bell" id="notificationBell">
                        <svg class="bell-icon-svg" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                        <span class="notification-counter" id="notificationCounter" style="display: none;">0</span>
                    </div>
                    <div class="notification-dropdown" id="notificationDropdown">
                        <div class="notification-header">
                            <h4>Notifications</h4>
                            <div class="notification-header-actions">
                                <button id="markAllReadBtn">Mark all as read</button>
                            </div>
                        </div>
                        <div class="notification-list" id="notificationList">
                            <div class="notification-empty">No new notifications</div>
                        </div>
                    </div>
                </li>
                
                <!-- User Avatar Button -->
                <li class="user-avatar-container">
                    <div id="userAvatarContainer">
                        <img src="https://via.placeholder.com/32" alt="User" class="user-avatar" id="userAvatar" style="display: none;">
                        <div id="userInitial" class="user-initial">?</div>
                    </div>
                    <div class="user-dropdown">
                        <div class="user-email" id="userEmail">Not logged in</div>
                        <a href="profile.html" id="profileLink" style="display: none;">My Profile</a>
                        <a href="#" id="logoutButton" style="display: none;">Log Out</a>
                        <a href="login.html" id="loginButton">Log In</a>
                    </div>
                </li>
                </li>
            </ul>
        </nav>
    </header>

    <main class="event-board-container">
        <div class="event-header">
            <div class="event-title">
                <h2>HSE Inspections Board</h2>
                <p>All submitted inspections and their status</p>
            </div>
            <div class="event-actions">
                <a href="inspections.html" class="btn-add-event">Add New Inspection</a>
            </div>
        </div>

        <div class="event-filters">
            <div class="filter-inputs">
                <div class="filter-group">
                    <label for="inspectionTypeFilter">Inspection Type</label>
                    <select id="inspectionTypeFilter" class="filter-input">
                        <option value="">All Types</option>
                        <option value="Workplace Safety Inspections">Workplace Safety Inspections</option>
                        <option value="Equipment and Machinery Inspections">Equipment and Machinery Inspections</option>
                        <option value="Environmental Inspections">Environmental Inspections</option>
                        <option value="Fire and Emergency Preparedness Inspections">Fire and Emergency Preparedness Inspections</option>
                        <option value="Health and Hygiene Inspections">Health and Hygiene Inspections</option>
                        <option value="Regulatory and Compliance Inspections">Regulatory and Compliance Inspections</option>
                        <option value="Incident and Accident Inspections">Incident and Accident Inspections</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="locationFilter">Location</label>
                    <input type="text" id="locationFilter" class="filter-input" placeholder="Filter by location...">
                </div>
                <div class="filter-group">
                    <label for="statusFilter">Status</label>
                    <select id="statusFilter" class="filter-input">
                        <option value="">All Statuses</option>
                        <option value="Pending">Pending</option>
                        <option value="Approved">Approved</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="searchInput">Search</label>
                    <input type="text" id="searchInput" class="filter-input" placeholder="Search inspections...">
                </div>
            </div>
            <div class="filter-buttons">
                <button id="applyFiltersBtn" class="filter-btn">Apply Filters</button>
                <button id="resetFiltersBtn" class="clear-btn">Reset</button>
            </div>
        </div>

        <div id="inspectionTableContainer" class="event-table-container">
            <table class="event-table" id="inspectionTable">
                <thead>
                    <tr>
                        <th data-sort="inspectionType">Type</th>
                        <th data-sort="company">Company</th>
                        <th data-sort="eventDateTime" class="timestamp-column">Date & Time</th>
                        <th data-sort="location">Location</th>
                        <th data-sort="teamLeaderName">Team Leader</th>
                        <th data-sort="lineManager">Line Manager</th>
                        <th data-sort="housekeeping">Worksite Status</th>
                        <th data-sort="ppeCompliance">PPE Compliance</th>
                        <th data-sort="actionDeadline">Deadline</th>
                        <th data-sort="approvalStatus">Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="inspectionTableBody">
                    <!-- Inspection data will be inserted here dynamically -->
                </tbody>
            </table>
        </div>

        <div id="emptyState" class="empty-state" style="display: none;">
            <p>No inspections found matching your criteria.</p>
        </div>

        <div id="loadingIndicator" class="event-loading">
            <div class="spinner"></div>
        </div>

        <div class="pagination" id="pagination">
            <!-- Pagination controls will be inserted here dynamically -->
        </div>
    </main>

    <!-- Inspection details modal -->
    <div id="inspectionDetailsModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3 id="modalInspectionTitle">Inspection Details</h3>
                <button class="modal-close" id="closeModalBtn">&times;</button>
            </div>
            <div id="inspectionDetailsContent">
                <!-- Inspection details will be inserted here -->
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-cancel" id="closeInspectionBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- Event edit modal -->
    <div id="editEventModal" class="modal-overlay">
        <div class="modal-container" style="max-width: 700px;">
            <div class="modal-header">
                <h3 id="editModalTitle">Edit Event</h3>
                <button class="modal-close" id="closeEditModalBtn">&times;</button>
            </div>
            <form id="editEventForm">
                <input type="hidden" id="editEventId">
                <div class="edit-form-container">
                    <div>
                        <label for="editEventType">Type of Event</label>
                        <select id="editEventType" name="eventType">
                            <option value="">Select an event type</option>
                            <option value="Incident">Incident</option>
                            <option value="Near Miss">Near Miss</option>
                            <option value="Unsafe Act">Unsafe Act</option>
                            <option value="Unsafe Condition">Unsafe Condition</option>
                            <option value="Environmental Impact">Environmental Impact</option>
                            <option value="Property Damage">Property Damage</option>
                        </select>
                    </div>
                    <div>
                        <label for="editEventTitle">Event Title</label>
                        <input type="text" id="editEventTitle" name="eventTitle" required>
                    </div>
                    <div>
                        <label for="editEventDateTime">Date &amp; Time</label>
                        <input type="datetime-local" id="editEventDateTime" name="eventDateTime" required>
                    </div>
                    <div>
                        <label for="editEventLocation">Location</label>
                        <input type="text" id="editEventLocation" name="eventLocation">
                    </div>
                    <div>
                        <label for="editSeverityLevel">Severity Level</label>
                        <select id="editSeverityLevel" name="severityLevel">
                            <option value="">Select severity</option>
                            <option value="Minor">Minor</option>
                            <option value="Moderate">Moderate</option>
                            <option value="Major">Major</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>
                    <div>
                        <label for="editLineManager">Line Manager</label>
                        <select id="editLineManager" name="lineManager">
                            <option value="">Select a line manager</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div class="edit-form-full">
                        <label for="editEventDescription">Description</label>
                        <textarea id="editEventDescription" name="eventDescription"></textarea>
                    </div>
                    <div class="edit-form-full">
                        <label for="editImmediateActions">Immediate Actions Taken</label>
                        <textarea id="editImmediateActions" name="immediateActions"></textarea>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="modal-btn modal-cancel" id="cancelEditBtn">Cancel</button>
                    <button type="submit" class="modal-btn modal-save">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
    // Initialize Firebase with enhanced domain handling
    let database;
    let auth;

    function initializeFirebase() {
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.appspot.com",
            messagingSenderId: "829083030831",
            appId: "1:829083030831:web:36a370e62691e560bc3dda"
        };
        
        // Check if Firebase is already initialized
        if (firebase.apps.length === 0) {
            console.log("Initializing Firebase");
            firebase.initializeApp(firebaseConfig);
        } else {
            console.log("Firebase already initialized");
        }
        
        database = firebase.database();
        auth = firebase.auth();
        
        // Force browser to persist auth state
        return auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
            .then(() => console.log("Firebase persistence set to LOCAL"))
            .catch(error => console.error("Firebase persistence error:", error));
    }
    
    // Initialize Firebase at script load
    initializeFirebase().then(() => {
        console.log("Firebase initialized successfully");
    }).catch(error => {
        console.error("Firebase initialization failed:", error);
        showError("Failed to initialize Firebase. Please check your connection and try again.");
    });
    
    // Variables for inspections handling
    const INSPECTIONS_PER_PAGE = 10;
    let allInspections = [];
    let currentPage = 1;
    let sortField = 'createdAt';
    let sortDirection = 'desc';

    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM loaded, setting up inspections board");
        
        // Set loading state immediately
        showLoading();
        
        // Check authentication with a timeout
        const authTimeout = setTimeout(() => {
            console.warn("Auth check timed out");
            hideLoading();
            showError("Authentication timed out. Please try logging in again.");
            window.location.href = "login.html?redirect=" + encodeURIComponent(window.location.pathname);
        }, 10000);
        
        // Check authentication state
        auth.onAuthStateChanged(user => {
            clearTimeout(authTimeout);
            if (user) {
                console.log("User authenticated:", user.email);
                
                // Update UI for authenticated user
                updateUserDisplay(user);
                
                // Setup real-time listeners first before loading inspections
                setupRealtimeInspectionListeners();
                
                // Load inspections from Firebase with fallback to local cache
                loadInspectionsWithFallback();
                
                // Initialize notifications
                if (typeof initializeNotifications === 'function') {
                    initializeNotifications();
                }
                
                // Set up event listeners for filtering, sorting, etc.
                setupEventListeners();
                
                // Listen for cross-window updates
                listenForCrossWindowUpdates();
            } else {
                console.log("Not authenticated, redirecting to login page");
                hideLoading();
                window.location.href = "login.html?redirect=" + encodeURIComponent(window.location.pathname);
            }
        });
    });
    
    // Helper function to update user display in UI
    function updateUserDisplay(user) {
        // Update user email in dropdown
        document.getElementById('userEmail').textContent = user.email || "Not logged in";
        
        // Show logout button and hide login button
        document.getElementById('profileLink').style.display = 'block';
        document.getElementById('accountLink').style.display = 'block';
        document.getElementById('logoutButton').style.display = 'block';
        document.getElementById('loginButton').style.display = 'none';
        
        // Update user avatar/initial
        if (user) {
            const userInitial = document.getElementById('userInitial');
            const userAvatar = document.getElementById('userAvatar');
            
            // Get user data from Firebase
            database.ref(`users/${user.uid}`).once('value')
                .then(snapshot => {
                    const userData = snapshot.val() || {};
                    if (userData.profileImage) {
                        // Show profile image
                        userAvatar.src = userData.profileImage;
                        userAvatar.style.display = 'block';
                        userInitial.style.display = 'none';
                    } else {
                        // Show initial
                        userInitial.textContent = getUserInitial(user);
                        userInitial.style.display = 'flex';
                        userAvatar.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error("Error fetching user data:", error);
                });
        }
    }
    
    // Function to set up all event listeners
    function setupEventListeners() {
        // Logout button
        document.getElementById('logoutButton').addEventListener('click', function(e) {
            e.preventDefault();
            auth.signOut().then(() => {
                window.location.href = "login.html";
            }).catch(error => {
                console.error("Error during logout:", error);
            });
        });
        
        // Filters
        document.getElementById('applyFiltersBtn').addEventListener('click', filterInspections);
        document.getElementById('resetFiltersBtn').addEventListener('click', resetFilters);
        document.getElementById('searchInput').addEventListener('keyup', function(e) {
            if (e.key === 'Enter') filterInspections();
        });
        
        // Sorting
        const tableHeaders = document.querySelectorAll('th[data-sort]');
        tableHeaders.forEach(header => {
            header.addEventListener('click', () => {
                const field = header.getAttribute('data-sort');
                if (sortField === field) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortField = field;
                    sortDirection = 'asc';
                }
                displayInspections(filterInspectionArray(allInspections));
            });
        });
        
        // Modal close buttons
        document.getElementById('closeModalBtn').addEventListener('click', closeInspectionModal);
        document.getElementById('closeInspectionBtn').addEventListener('click', closeInspectionModal);
        
        // Add click handler for user avatar dropdown
        const userAvatarContainer = document.getElementById('userAvatarContainer');
        const userDropdown = document.querySelector('.user-dropdown');
        
        if (userAvatarContainer && userDropdown) {
            // Toggle dropdown when clicking the avatar
            userAvatarContainer.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent event from bubbling up
                userDropdown.classList.toggle('show');
                console.log('Avatar clicked, dropdown visible:', userDropdown.classList.contains('show'));
            });
            
            // Close dropdown when clicking anywhere else
            document.addEventListener('click', function(e) {
                if (userDropdown.classList.contains('show')) {
                    userDropdown.classList.remove('show');
                }
            });
            
            // Prevent clicks inside dropdown from closing it
            userDropdown.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }
    }
    
    // Function to load inspections from Firebase - enhanced with better error handling
    function loadInspections() {
        showLoading();
        console.log("Loading inspections from Firebase...");
        
        const inspectionsRef = database.ref('inspections');
        
        // Set a timeout for the database operation
        const loadTimeout = setTimeout(() => {
            console.warn("Loading inspections timed out");
            hideLoading();
            showError("Loading inspections timed out. Please check your connection and try again.");
            
            // Try to run network diagnostics
            if (window.NetworkDiagnostics) {
                window.NetworkDiagnostics.runDiagnostics()
                    .then(results => {
                        console.log("Network diagnostics:", results);
                    });
            }
        }, 15000);
        
        // Listen for real-time updates
        inspectionsRef.on('value', 
            (snapshot) => {
                // Clear timeout since we got a response
                clearTimeout(loadTimeout);
                
                console.log("Received inspections data from Firebase");
                allInspections = [];
                
                if (!snapshot.exists()) {
                    console.log("No inspections found in database");
                    hideLoading();
                    document.getElementById('emptyState').style.display = 'block';
                    document.getElementById('inspectionTableContainer').style.display = 'none';
                    return;
                }
                
                snapshot.forEach((childSnapshot) => {
                    const inspection = childSnapshot.val();
                    inspection.id = childSnapshot.key;
                    allInspections.push(inspection);
                });
                
                hideLoading();
                
                // Use the current filter settings when displaying inspections
                displayInspections(filterInspectionArray(allInspections));
                
                // Log in console for debugging
                console.log(`Loaded ${allInspections.length} inspections from database`);
            },
            (error) => {
                // Clear timeout since we got an error response
                clearTimeout(loadTimeout);
                
                console.error("Error loading inspections:", error);
                hideLoading();
                showError("Failed to load inspections: " + error.message);
                
                // Try to run network diagnostics
                if (window.NetworkDiagnostics) {
                    window.NetworkDiagnostics.runDiagnostics()
                        .then(results => {
                            console.log("Network diagnostics:", results);
                        })
                        .then(() => {
                            return window.NetworkDiagnostics.attemptFixes();
                        })
                        .then(fixResults => {
                            console.log("Fix attempts:", fixResults);
                            
                            // If fixes applied, try loading again
                            if (fixResults && !fixResults.noFixesApplied) {
                                console.log("Retrying inspection load after fix attempt");
                                setTimeout(loadInspections, 1000);
                            }
                        });
                }
            }
        );
    }
    
    // Function to display inspections in the table
    function displayInspections(inspections) {
        const tableBody = document.getElementById('inspectionTableBody');
        const emptyState = document.getElementById('emptyState');
        const tableContainer = document.getElementById('inspectionTableContainer');
        
        // Sort inspections based on current sort field and direction
        inspections.sort((a, b) => {
            let valueA = a[sortField];
            let valueB = b[sortField];
            
            // Handle different date fields
            if (sortField === 'createdAt' || sortField === 'eventDateTime' || sortField === 'actionDeadline') {
                valueA = new Date(valueA || 0).getTime();
                valueB = new Date(valueB || 0).getTime();
            } else {
                valueA = (valueA || '').toString().toLowerCase();
                valueB = (valueB || '').toString().toLowerCase();
            }
            
            if (valueA < valueB) return sortDirection === 'asc' ? -1 : 1;
            if (valueA > valueB) return sortDirection === 'asc' ? 1 : -1;
            
            // Secondary sort by creation date if primary values are equal
            if (valueA === valueB && sortField !== 'createdAt') {
                const timeA = new Date(a.createdAt || 0).getTime();
                const timeB = new Date(b.createdAt || 0).getTime();
                return sortDirection === 'asc' ? timeA - timeB : timeB - timeA;
            }
            
            return 0;
        });
        
        // Check for highlight ID from URL parameter for edited inspections
        const highlightId = sessionStorage.getItem('highlightInspectionId');
        
        // Calculate pagination
        const totalPages = Math.ceil(inspections.length / INSPECTIONS_PER_PAGE);
        const startIndex = (currentPage - 1) * INSPECTIONS_PER_PAGE;
        const paginatedInspections = inspections.slice(startIndex, startIndex + INSPECTIONS_PER_PAGE);
        
        // Check if there are any inspections to display
        if (inspections.length === 0) {
            emptyState.style.display = 'block';
            tableContainer.style.display = 'none';
        } else {
            emptyState.style.display = 'none';
            tableContainer.style.display = 'block';
            
            // Clear the table
            tableBody.innerHTML = '';
            
            // Add inspections to the table
            paginatedInspections.forEach(inspection => {
                const row = document.createElement('tr');
                
                // Add highlight class if this is the edited inspection
                if (highlightId && inspection.id === highlightId) {
                    row.classList.add('highlighted-row');
                    // Scroll this row into view with animation
                    setTimeout(() => {
                        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        // Flash animation for highlight
                        row.style.animation = 'highlight-fade 3s';
                    }, 500);
                    // Clear the highlight ID from session storage
                    sessionStorage.removeItem('highlightInspectionId');
                }
                
                // Format date and time
                const dateTime = inspection.eventDateTime ? new Date(inspection.eventDateTime) : null;
                const formattedDateTime = dateTime ? dateTime.toLocaleString() : 'N/A';
                
                // Format deadline
                const deadline = inspection.actionDeadline ? new Date(inspection.actionDeadline) : null;
                const formattedDeadline = deadline ? deadline.toLocaleDateString() : 'N/A';
                
                // Create status class
                const statusClass = inspection.approvalStatus ? 
                    `status-${inspection.approvalStatus.toLowerCase()}` : 'status-pending';
                
                // Determine worksite status summary
                let worksiteStatus = 'N/A';
                if (inspection.housekeeping === 'Satisfactory' && 
                    inspection.walkways === 'Satisfactory' && 
                    inspection.fireSafety === 'Satisfactory') {
                    worksiteStatus = 'Good';
                } else if (inspection.housekeeping === 'Unsatisfactory' || 
                         inspection.walkways === 'Unsatisfactory' || 
                         inspection.fireSafety === 'Unsatisfactory') {
                    worksiteStatus = 'Poor';
                } else if (inspection.housekeeping || inspection.walkways || inspection.fireSafety) {
                    worksiteStatus = 'Needs Improvement';
                }
                
                // Create the row HTML with inspection-specific fields
                row.innerHTML = `
                    <td>${escapeHtml(inspection.inspectionType || 'N/A')}</td>
                    <td>${escapeHtml(inspection.company || 'N/A')}</td>
                    <td>${formattedDateTime}</td>
                    <td>${escapeHtml(inspection.location || 'N/A')}</td>
                    <td>${escapeHtml(inspection.teamLeaderName || 'N/A')}</td>
                    <td>${escapeHtml(inspection.lineManager || 'N/A')}</td>
                    <td>${escapeHtml(worksiteStatus)}</td>
                    <td>${escapeHtml(inspection.ppeCompliance || 'N/A')}</td>
                    <td>${formattedDeadline}</td>
                    <td><span class="${statusClass}">${escapeHtml(inspection.approvalStatus || 'Pending')}</span></td>
                    <td class="action-buttons">
                        <button class="btn-edit" onclick="redirectToEditForm('${inspection.id}', event)">Edit</button>
                        <button class="btn-view" onclick="showInspectionDetails('${inspection.id}', event)">View</button>
                    </td>
                `;
                
                // Add click event to show inspection details
                row.addEventListener('click', (e) => {
                    // Don't trigger row click if user clicked on action buttons
                    if (!e.target.closest('.action-buttons')) {
                        const inspectionDetails = allInspections.find(i => i.id === inspection.id);
                        if (inspectionDetails) {
                            showInspectionDetails(inspectionDetails);
                        }
                    }
                });
                
                tableBody.appendChild(row);
            });
            
            // Update pagination
            renderPagination(currentPage, totalPages);
        }
    }
    
    // Function to filter inspections based on selected criteria
    function filterInspections() {
        const filteredInspections = filterInspectionArray(allInspections);
        currentPage = 1; // Reset to first page when filtering
        displayInspections(filteredInspections);
    }
    
    // Helper function to apply filters to the inspection array
    function filterInspectionArray(inspections) {
        const typeFilter = document.getElementById('inspectionTypeFilter').value;
        const locationFilter = document.getElementById('locationFilter').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const searchText = document.getElementById('searchInput').value.toLowerCase();
        
        return inspections.filter(inspection => {
            // Apply type filter
            if (typeFilter && inspection.inspectionType !== typeFilter) {
                return false;
            }
            
            // Apply location filter
            if (locationFilter && !(inspection.location || '').toLowerCase().includes(locationFilter)) {
                return false;
            }
            
            // Apply status filter
            if (statusFilter && inspection.approvalStatus !== statusFilter) {
                return false;
            }
            
            // Apply search filter
            if (searchText) {
                const searchFields = [
                    inspection.inspectionType || '',
                    inspection.company || '',
                    inspection.location || '',
                    inspection.teamLeaderName || '',
                    inspection.lineManager || '',
                    inspection.personResponsible || '',
                    inspection.identifiedHazards || '',
                    inspection.correctiveActions || ''
                ].join(' ').toLowerCase();
                
                if (!searchFields.includes(searchText)) {
                    return false;
                }
            }
            
            return true;
        });
    }
    
    // Function to reset all filters
    function resetFilters() {
        document.getElementById('inspectionTypeFilter').value = '';
        document.getElementById('locationFilter').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('searchInput').value = '';
        
        currentPage = 1;
        sortField = 'createdAt';
        sortDirection = 'desc';
        
        displayInspections(allInspections);
    }
    
    // Function to render pagination controls
    function renderPagination(currentPage, totalPages) {
        const paginationEl = document.getElementById('pagination');
        paginationEl.innerHTML = '';
        
        if (totalPages <= 1) {
            return;
        }
        
        // Previous button
        const prevButton = document.createElement('button');
        prevButton.textContent = '« Previous';
        prevButton.disabled = currentPage === 1;
        prevButton.classList.toggle('disabled', currentPage === 1);
        prevButton.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                displayInspections(filterInspectionArray(allInspections));
            }
        });
        paginationEl.appendChild(prevButton);
        
        // Page buttons
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        
        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const pageButton = document.createElement('button');
            pageButton.textContent = i;
            pageButton.classList.toggle('active', i === currentPage);
            pageButton.addEventListener('click', () => {
                currentPage = i;
                displayInspections(filterInspectionArray(allInspections));
            });
            paginationEl.appendChild(pageButton);
        }
        
        // Next button
        const nextButton = document.createElement('button');
        nextButton.textContent = 'Next »';
        nextButton.disabled = currentPage === totalPages;
        nextButton.classList.toggle('disabled', currentPage === totalPages);
        nextButton.addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                displayInspections(filterInspectionArray(allInspections));
            }
        });
        paginationEl.appendChild(nextButton);
    }
    
    // Function to show inspection details in a modal
    function showInspectionDetails(inspection) {
        const modal = document.getElementById('inspectionDetailsModal');
        const content = document.getElementById('inspectionDetailsContent');
        const title = document.getElementById('modalInspectionTitle');
        
        // Set title
        title.textContent = `Inspection at ${inspection.location || 'Unknown Location'}`;
        
        // Format dates
        const inspectionDate = inspection.eventDateTime ? new Date(inspection.eventDateTime).toLocaleString() : 'Not specified';
        const deadlineDate = inspection.actionDeadline ? new Date(inspection.actionDeadline).toLocaleDateString() : 'Not specified';
        const closureDate = inspection.closureDate ? new Date(inspection.closureDate).toLocaleDateString() : 'Not specified';
        
        // Build content HTML with inspection-specific fields
        let html = `
            <div class="inspection-details">
                <h4>General Information</h4>
                <div class="detail-section">
                    <p><strong>Inspection Type:</strong> ${escapeHtml(inspection.inspectionType || 'Not specified')}</p>
                    <p><strong>Company:</strong> ${escapeHtml(inspection.company || 'Not specified')}</p>
                    <p><strong>Date & Time:</strong> ${inspectionDate}</p>
                    <p><strong>Location:</strong> ${escapeHtml(inspection.location || 'Not specified')}</p>
                    <p><strong>Team Leader:</strong> ${escapeHtml(inspection.teamLeaderName || 'Not specified')}</p>
                    <p><strong>Line Manager:</strong> ${escapeHtml(inspection.lineManager || 'Not specified')}</p>
                </div>
                
                <h4>Worksite Conditions</h4>
                <div class="detail-section">
                    <p><strong>Housekeeping & Cleanliness:</strong> ${escapeHtml(inspection.housekeeping || 'Not specified')}</p>
                    <p><strong>Walkways & Exits Clear:</strong> ${escapeHtml(inspection.walkways || 'Not specified')}</p>
                    <p><strong>Fire Safety Equipment:</strong> ${escapeHtml(inspection.fireSafety || 'Not specified')}</p>
                </div>
                
                <h4>PPE Compliance</h4>
                <div class="detail-section">
                    <p><strong>Required PPE Worn:</strong> ${escapeHtml(inspection.ppeCompliance || 'Not specified')}</p>
                    <p><strong>Condition of PPE:</strong> ${escapeHtml(inspection.ppeCondition || 'Not specified')}</p>
                </div>
                
                <h4>Equipment & Machinery</h4>
                <div class="detail-section">
                    <p><strong>Equipment Functionality:</strong> ${escapeHtml(inspection.equipmentStatus || 'Not specified')}</p>
                    <p><strong>Lockout/Tagout Compliance:</strong> ${escapeHtml(inspection.lockoutTagout || 'Not specified')}</p>
                </div>
            </div>
        `;
        
        if (inspection.identifiedHazards) {
            html += `
                <h4>Hazard Identification</h4>
                <div class="detail-section">
                    <p>${escapeHtml(inspection.identifiedHazards)}</p>
                </div>
            `;
        }
        
        if (inspection.correctiveActions) {
            html += `
                <h4>Corrective & Preventive Actions</h4>
                <div class="detail-section">
                    <p><strong>Proposed Actions:</strong> ${escapeHtml(inspection.correctiveActions)}</p>
                    <p><strong>Person Responsible:</strong> ${escapeHtml(inspection.personResponsible || 'Not specified')}</p>
                    <p><strong>Deadline:</strong> ${deadlineDate}</p>
                </div>
            `;
        }
        
        html += `
            <h4>Review & Approval</h4>
            <div class="detail-section">
                <p><strong>Approval Status:</strong> <span class="status-${(inspection.approvalStatus || 'Pending').toLowerCase()}">${escapeHtml(inspection.approvalStatus || 'Pending')}</span></p>
                <p><strong>Supervisor Comments:</strong> ${escapeHtml(inspection.supervisorComments || 'None')}</p>
                <p><strong>Closure Date:</strong> ${closureDate}</p>
            </div>
        `;
        
        // Add metadata
        html += `
            <div class="detail-section metadata" style="margin-top: 20px; font-size: 12px; color: #777;">
                <p><strong>Created:</strong> ${inspection.createdByEmail || 'Unknown'} on ${inspection.createdAt ? new Date(inspection.createdAt).toLocaleString() : 'Unknown'}</p>
                <p><strong>Last Updated:</strong> ${inspection.lastUpdatedByEmail || 'Unknown'} on ${inspection.lastUpdatedAt ? new Date(inspection.lastUpdatedAt).toLocaleString() : 'Unknown'}</p>
            </div>
        `;
        
        // Set content
        content.innerHTML = html;
        
        // Show modal
        modal.classList.add('modal-visible');
    }
    
    // Function to close inspection details modal
    function closeInspectionModal() {
        const modal = document.getElementById('inspectionDetailsModal');
        modal.classList.remove('modal-visible');
    }
    
    // Function to redirect to the inspection form for editing
    function redirectToEditForm(inspectionId, e) {
        if (e) e.stopPropagation();
        window.location.href = `inspections.html?edit=${inspectionId}`;
    }
    
    // Helper functions
    function showLoading() {
        document.getElementById('loadingIndicator').style.display = 'flex';
        document.getElementById('inspectionTableContainer').style.display = 'none';
        document.getElementById('emptyState').style.display = 'none';
    }
    
    function hideLoading() {
        document.getElementById('loadingIndicator').style.display = 'none';
    }
    
    function showError(message) {
        const emptyState = document.getElementById('emptyState');
        emptyState.innerHTML = `<p>${message}</p>`;
        emptyState.style.display = 'block';
        document.getElementById('inspectionTableContainer').style.display = 'none';
    }
    
    function formatDateTime(dateTimeStr) {
        if (!dateTimeStr) return 'Not specified';
        const date = new Date(dateTimeStr);
        return isNaN(date) ? 'Invalid date' : date.toLocaleString();
    }
    
    function formatDate(dateStr) {
        if (!dateStr) return 'Not specified';
        const date = new Date(dateStr);
        return isNaN(date) ? 'Invalid date' : date.toLocaleDateString();
    }
    
    function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function getUserInitial(user) {
        if (!user || !user.email) return '?';
        return user.email.charAt(0).toUpperCase();
    }

    // Add real-time listeners for inspections
    function setupRealtimeInspectionListeners() {
        console.log("Setting up real-time inspection listeners");
        const inspectionsRef = database.ref('inspections');
        
        // Remove previous listeners to avoid duplicates
        inspectionsRef.off('child_added');
        inspectionsRef.off('child_changed');
        inspectionsRef.off('child_removed');
        
        // Listen for a new inspection added
        inspectionsRef.on('child_added', snapshot => {
            try {
                console.log(`Real-time update: New inspection added with ID: ${snapshot.key}`);
                let newInspection = snapshot.val();
                newInspection.id = snapshot.key;
                
                // Check if this inspection already exists in our array
                const existingIndex = allInspections.findIndex(i => i.id === newInspection.id);
                
                if (existingIndex === -1) {
                    // Add to beginning of array for newest-first display
                    allInspections.unshift(newInspection);
                    
                    // Update local storage cache
                    try {
                        const localInspections = JSON.parse(localStorage.getItem('recentInspections') || '[]');
                        localInspections.unshift(newInspection);
                        localStorage.setItem('recentInspections', JSON.stringify(localInspections.slice(0, 50)));
                    } catch (e) {
                        console.warn("Could not update local cache:", e);
                    }
                    
                    // Refresh the display
                    displayInspections(filterInspectionArray(allInspections));
                    
                    // Check if this is the inspection to highlight (from session storage)
                    const highlightId = sessionStorage.getItem('highlightInspectionId');
                    if (highlightId === newInspection.id) {
                        // Flash notification to user
                        showToast(`New inspection "${newInspection.inspectionType}" was added`, "success");
                    }
                }
            } catch (error) {
                console.error("Error processing new inspection:", error);
            }
        });

        // Listen for inspection updates
        inspectionsRef.on('child_changed', snapshot => {
            try {
                console.log(`Real-time update: Inspection updated with ID: ${snapshot.key}`);
                let updatedInspection = snapshot.val();
                updatedInspection.id = snapshot.key;
                
                const index = allInspections.findIndex(i => i.id === updatedInspection.id);
                if (index !== -1) {
                    allInspections[index] = updatedInspection;
                    
                    // Update local storage cache
                    try {
                        const localInspections = JSON.parse(localStorage.getItem('recentInspections') || '[]');
                        const updatedLocalInspections = localInspections.map(i => 
                            i.id === updatedInspection.id ? updatedInspection : i
                        );
                        localStorage.setItem('recentInspections', JSON.stringify(updatedLocalInspections));
                    } catch (e) {
                        console.warn("Could not update local cache:", e);
                    }
                    
                    // Refresh the display
                    displayInspections(filterInspectionArray(allInspections));
                    
                    // Check if this is the inspection to highlight (from session storage)
                    const highlightId = sessionStorage.getItem('highlightInspectionId');
                    if (highlightId === updatedInspection.id) {
                        // Flash notification to user
                        showToast(`Inspection "${updatedInspection.inspectionType}" was updated`, "info");
                    }
                }
            } catch (error) {
                console.error("Error processing updated inspection:", error);
            }
        });
        
        // Listen for inspection removal
        inspectionsRef.on('child_removed', snapshot => {
            try {
                console.log(`Real-time update: Inspection removed with ID: ${snapshot.key}`);
                const removedId = snapshot.key;
                
                // Find the removed inspection to show in notification
                const removedInspection = allInspections.find(i => i.id === removedId);
                
                // Remove from array
                allInspections = allInspections.filter(i => i.id !== removedId);
                
                // Update local storage cache
                try {
                    const localInspections = JSON.parse(localStorage.getItem('recentInspections') || '[]');
                    const filteredLocalInspections = localInspections.filter(i => i.id !== removedId);
                    localStorage.setItem('recentInspections', JSON.stringify(filteredLocalInspections));
                } catch (e) {
                    console.warn("Could not update local cache:", e);
                }
                
                // Refresh the display
                displayInspections(filterInspectionArray(allInspections));
                
                // Show notification if we found inspection details
                if (removedInspection) {
                    showToast(`Inspection "${removedInspection.inspectionType}" was deleted`, "warning");
                }
            } catch (error) {
                console.error("Error processing removed inspection:", error);
            }
        });
        
        console.log("Real-time inspection listeners set up successfully");
    }

    // Function to listen for cross-window/tab updates
    function listenForCrossWindowUpdates() {
        window.addEventListener('inspection_updated', (event) => {
            console.log("Received inspection update notification from another window/tab", event.detail);
            
            // Set the highlight ID to ensure it's highlighted when refreshed
            if (event.detail && event.detail.inspectionId) {
                sessionStorage.setItem('highlightInspectionId', event.detail.inspectionId);
            }
        });
        
        // Also listen for storage events (another tab might have updated localStorage)
        window.addEventListener('storage', (event) => {
            if (event.key === 'recentInspections') {
                console.log("Local inspection cache was updated in another tab");
                try {
                    const updatedInspections = JSON.parse(event.newValue || '[]');
                    if (updatedInspections.length > 0) {
                        // Update our in-memory array and refresh display
                        allInspections = updatedInspections;
                        displayInspections(filterInspectionArray(allInspections));
                    }
                } catch (e) {
                    console.warn("Could not process updated inspections from another tab", e);
                }
            }
        });
    }

    // Enhanced function to load inspections with local cache fallback
    function loadInspectionsWithFallback() {
        showLoading();
        console.log("Loading inspections from Firebase...");
        
        // Try to load inspections from local storage first for faster initial display
        try {
            const localInspections = JSON.parse(localStorage.getItem('recentInspections') || '[]');
            if (localInspections.length > 0) {
                console.log(`Loaded ${localInspections.length} inspections from local cache`);
                allInspections = localInspections;
                displayInspections(filterInspectionArray(allInspections));
            }
        } catch (e) {
            console.warn("Could not load from local cache:", e);
        }
        
        // Then load from Firebase for full and updated data
        loadInspections();
    }

    // Function to log inspections to audit logs
    function logInspection(action, details) {
        const user = auth.currentUser || (window.AuthManager ? AuthManager.getCurrentUser() : null);
        if (!user) return;
        
        const logEntry = {
            userId: user.uid,
            userEmail: user.email,
            action: action,
            details: details,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        };
        
        database.ref('auditLogs').push(logEntry)
            .catch(error => {
                console.error('Error logging inspection:', error);
            });
    }

    // Helper function to show toast notification for real-time updates
    function showToast(message, type = "info") {
        // Create toast element if it doesn't exist
        let toast = document.getElementById('update-toast');
        if (!toast) {
            toast = document.createElement('div');
            toast.id = 'update-toast';
            toast.style.position = 'fixed';
            toast.style.bottom = '20px';
            toast.style.right = '20px';
            toast.style.minWidth = '250px';
            toast.style.padding = '15px';
            toast.style.borderRadius = '4px';
            toast.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
            toast.style.zIndex = '10000';
            toast.style.transition = 'transform 0.3s ease-out';
            toast.style.transform = 'translateY(100px)';
            document.body.appendChild(toast);
        }
        
        // Set toast style based on type
        switch (type) {
            case "success":
                toast.style.backgroundColor = '#d4edda';
                toast.style.color = '#155724';
                break;
            case "warning":
                toast.style.backgroundColor = '#fff3cd';
                toast.style.color = '#856404';
                break;
            case "error":
                toast.style.backgroundColor = '#f8d7da';
                toast.style.color = '#721c24';
                break;
            default:
                toast.style.backgroundColor = '#d1ecf1';
                toast.style.color = '#0c5460';
        }
        
        // Set message and show toast
        toast.innerHTML = message;
        toast.style.transform = 'translateY(0)';
        
        // Hide toast after a few seconds
        setTimeout(() => {
            toast.style.transform = 'translateY(100px)';
        }, 5000);
    }

    // Add CSS for highlighted rows
    document.head.insertAdjacentHTML('beforeend', `
        <style>
        /* Row highlighting for edited inspections */
        .highlighted-row {
            background-color: #fff9c4 !important;
        }
        
        @keyframes highlight-fade {
            0% { background-color: #fffde7; }
            30% { background-color: #fff9c4; }
            100% { background-color: transparent; }
        }
        </style>
    `);
    
    // Initialize the page when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
        // Call setup functions
        setupRealtimeInspectionListeners();
        
        // Setup user dropdown immediately rather than waiting for auth
        const userAvatarContainer = document.getElementById('userAvatarContainer');
        const userDropdown = document.querySelector('.user-dropdown');
        
        if (userAvatarContainer && userDropdown) {
            // Toggle dropdown when clicking the avatar
            userAvatarContainer.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent event from bubbling up
                userDropdown.classList.toggle('show');
                console.log('Avatar clicked, dropdown visible:', userDropdown.classList.contains('show'));
            });
            
            // Close dropdown when clicking anywhere else
            document.addEventListener('click', function(e) {
                if (userDropdown.classList.contains('show')) {
                    userDropdown.classList.remove('show');
                }
            });
            
            // Prevent clicks inside dropdown from closing it
            userDropdown.addEventListener('click', function(e) {
                e.stopPropagation();
                console.log('Click inside dropdown, preventing propagation');
            });
        } else {
            console.error('User avatar or dropdown elements not found:', 
                          'userAvatarContainer:', userAvatarContainer, 
                          'userDropdown:', userDropdown);
        }
    });
    </script>
</body>
</html>