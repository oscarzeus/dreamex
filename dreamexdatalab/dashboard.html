<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSE System - Dashboard</title>
    <link rel="stylesheet" href="css/styles.css">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js for dashboard charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .dashboard-title {
            margin: 0;
            font-size: 1.8rem;
            color: var(--primary-color);
        }
        
        .date-filter {
            display: flex;
            align-items: center;
            background: #f8f8f8;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem 1rem;
        }
        
        .date-filter select {
            border: none;
            background: transparent;
            padding: 0.25rem;
            font-size: 0.9rem;
            color: var(--text-color);
            margin-left: 0.5rem;
            cursor: pointer;
            outline: none;
        }
        
        .metric-card {
            text-align: center;
            padding: 1.5rem;
            border-radius: 0; /* Changed from 12px to 0 */
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            position: relative;
            overflow: hidden;
            background: white;
            border-top: 4px solid var(--primary-color);
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.12);
        }
        
        .metric-card .metric-icon {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.2rem;
            opacity: 0.5;
        }
        
        .metric-card .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0.5rem 0;
            color: var(--primary-color);
            transition: all 0.3s ease;
        }
        
        .metric-card:hover .metric-value {
            transform: scale(1.05);
        }
        
        .metric-card .metric-title {
            font-size: 1rem;
            color: #777;
            margin-bottom: 0.25rem;
            font-weight: 600;
        }
        
        .metric-card .metric-change {
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 0.5rem;
            gap: 0.25rem;
        }
        
        .metric-card .metric-change.positive {
            color: var(--success-color);
        }
        
        .metric-card .metric-change.negative {
            color: var(--danger-color);
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
        }
        
        .chart-container {
            height: 350px;
            margin: 1.5rem 0;
            position: relative;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .chart-legend {
            display: flex;
            justify-content: center;
            margin-top: 1rem;
            flex-wrap: wrap;
            gap: 0.75rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 0 1rem;
            padding: 0.4rem 0.75rem;
            background: #f8f8f8;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .legend-item:hover {
            background: #f0f0f0;
        }
        
        .legend-item.inactive {
            opacity: 0.5;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        .card {
            margin-bottom: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: none;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
        }
        
        .card-header {
            padding: 1.25rem 1.5rem;
            background: white;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        
        .card-title {
            margin: 0;
            font-size: 1.25rem;
            color: var(--primary-color);
        }
        
        .card-actions {
            display: flex;
            gap: 0.75rem;
        }
        
        .card-action-btn {
            background: #f5f5f5;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #555;
            transition: all 0.2s;
        }
        
        .card-action-btn:hover {
            background: #ebebeb;
            color: var(--primary-color);
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            margin-bottom: 0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        table th {
            background-color: #f8f8f8;
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 600;
            color: #444;
            border-bottom: 1px solid #eee;
            position: sticky;
            top: 0;
        }
        
        table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f0f0f0;
        }
        
        table tr:last-child td {
            border-bottom: none;
        }
        
        table tr:hover {
            background-color: rgba(0, 0, 0, 0.015);
        }
        
        .status-badge {
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-approved {
            background-color: rgba(46, 204, 113, 0.15);
            color: #27ae60;
        }
        
        .status-review {
            background-color: rgba(243, 156, 18, 0.15);
            color: #e67e22;
        }
        
        .status-rejected {
            background-color: rgba(231, 76, 60, 0.15);
            color: #c0392b;
        }
        
        .risk-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        
        .risk-high {
            background-color: #e74c3c;
        }
        
        .risk-medium {
            background-color: #f39c12;
        }
        
        .risk-low {
            background-color: #3498db;
        }
        
        .compliance-progress {
            width: 100%;
            height: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .compliance-bar {
            height: 100%;
            background-color: var(--success-color);
            border-radius: 5px;
            transition: width 1s ease-in-out;
        }
        
        .compliance-score {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        @media (max-width: 768px) {
            .metric-grid {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: 1rem;
            }
            
            .card-header, .card-body {
                padding: 1rem;
            }
            
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .date-filter {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Header Placeholder - will be replaced by the header component -->
    <div id="header-placeholder"></div>

    <main>
        <div class="content-wrapper">
            <h1>HSE Dashboard</h1>
            
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Key Performance Indicators</h2>
                </div>
                <div class="card-body">
                    <div class="metric-grid">
                        <div class="metric-card">
                            <div class="metric-icon"><i class="fas fa-exclamation-triangle"></i></div>
                            <div class="metric-title">Incidents This Month</div>
                            <div class="metric-value">3</div>
                            <div class="metric-change negative">
                                <i class="fas fa-arrow-up"></i> +1 from last month
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-icon"><i class="fas fa-clipboard-check"></i></div>
                            <div class="metric-title">Safety Inspections</div>
                            <div class="metric-value">24</div>
                            <div class="metric-change positive">
                                <i class="fas fa-arrow-up"></i> +4 from last month
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-icon"><i class="fas fa-tasks"></i></div>
                            <div class="metric-title">Risk Assessments</div>
                            <div class="metric-value">12</div>
                            <div class="metric-change positive">
                                <i class="fas fa-arrow-up"></i> +2 from last month
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-icon"><i class="fas fa-clock"></i></div>
                            <div class="metric-title">Avg. Resolution Time</div>
                            <div class="metric-value">4.2d</div>
                            <div class="metric-change positive">
                                <i class="fas fa-arrow-down"></i> -0.8 from last month
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Incident Trends</h2>
                            <div class="card-actions">
                                <button class="card-action-btn" title="Download Report" id="downloadIncidentChart">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="card-action-btn" title="View Details">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                                <div>
                                    <select id="eventTypeFilter" class="form-select" style="width: auto;">
                                        <option value="all">All Events</option>
                                        <option value="incidents">Incidents Only</option>
                                        <option value="nearMisses">Near Misses Only</option>
                                        <option value="observations">Safety Observations Only</option>
                                        <option value="inspections">Inspections Only</option>
                                        <option value="audits">Audits Only</option>
                                    </select>
                                </div>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <label for="dateRangeFilter">Date Range:</label>
                                    <select id="dateRangeFilter" class="form-select" style="width: auto;">
                                        <option value="6">Last 6 Months</option>
                                        <option value="3">Last 3 Months</option>
                                        <option value="12">Last 12 Months</option>
                                        <option value="1">Last Month</option>
                                        <option value="custom">Custom Range</option>
                                    </select>
                                </div>
                                <div id="customDateRange" style="display: none; gap: 0.5rem; align-items: center;">
                                    <input type="date" id="customStartDate" class="form-control" style="width: auto;">
                                    <span>to</span>
                                    <input type="date" id="customEndDate" class="form-control" style="width: auto;">
                                    <button id="applyCustomRange" class="btn btn-primary btn-sm">Apply</button>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="incidentsChart"></canvas>
                            </div>
                            <div style="display: flex; justify-content: center; align-items: center; gap: 2rem; margin-top: 1rem; flex-wrap: wrap;">
                                <div class="chart-legend">
                                    <div class="legend-item" data-series="incidents">
                                        <div class="legend-color" style="background-color: #3498db;"></div>
                                        <span>Incidents</span>
                                    </div>
                                    <div class="legend-item" data-series="nearMisses">
                                        <div class="legend-color" style="background-color: #2ecc71;"></div>
                                        <span>Near Misses</span>
                                    </div>
                                    <div class="legend-item" data-series="observations">
                                        <div class="legend-color" style="background-color: #f39c12;"></div>
                                        <span>Safety Observations</span>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <label for="displayModeFilter">Display:</label>
                                    <select id="displayModeFilter" class="form-select" style="width: auto;">
                                        <option value="month">Monthly</option>
                                        <option value="week">Weekly</option>
                                        <option value="year">Yearly</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Risk Distribution</h2>
                            <div class="card-actions">
                                <button class="card-action-btn" title="View Details">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                                <div>
                                    <select id="riskCategoryFilter" class="form-select" style="width: auto;">
                                        <option value="all">All Categories</option>
                                        <option value="operational">Operational</option>
                                        <option value="environmental">Environmental</option>
                                        <option value="health">Health</option>
                                        <option value="safety">Safety</option>
                                        <option value="quality">Quality</option>
                                    </select>
                                </div>
                                <div>
                                    <select id="riskLocationFilter" class="form-select" style="width: auto;">
                                        <option value="all">All Locations</option>
                                        <option value="warehouse">Warehouse</option>
                                        <option value="manufacturing">Manufacturing</option>
                                        <option value="office">Office</option>
                                        <option value="field">Field</option>
                                    </select>
                                </div>
                                <div>
                                    <select id="riskDepartmentFilter" class="form-select" style="width: auto;">
                                        <option value="all">All Departments</option>
                                        <option value="operations">Operations</option>
                                        <option value="logistics">Logistics</option>
                                        <option value="admin">Admin</option>
                                        <option value="manufacturing">Manufacturing</option>
                                    </select>
                                </div>
                                <div>
                                    <select id="riskStatusFilter" class="form-select" style="width: auto;">
                                        <option value="all">All Statuses</option>
                                        <option value="approved">Approved</option>
                                        <option value="review">Under Review</option>
                                        <option value="rejected">Rejected</option>
                                    </select>
                                </div>
                                <div>
                                    <select id="riskLevelFilter" class="form-select" style="width: auto;">
                                        <option value="all">All Risk Levels</option>
                                        <option value="high">High Risk</option>
                                        <option value="medium">Medium Risk</option>
                                        <option value="low">Low Risk</option>
                                    </select>
                                </div>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <select id="riskDateRangeFilter" class="form-select" style="width: auto;">
                                        <option value="all">All Dates</option>
                                        <option value="30">Last 30 Days</option>
                                        <option value="90">Last 90 Days</option>
                                        <option value="180">Last 180 Days</option>
                                        <option value="365">Last 365 Days</option>
                                        <option value="custom">Custom Range</option>
                                    </select>
                                </div>
                                <div id="riskCustomDateRange" style="display: none; gap: 0.5rem; align-items: center;">
                                    <input type="date" id="riskCustomStartDate" class="form-control" style="width: auto;">
                                    <span>to</span>
                                    <input type="date" id="riskCustomEndDate" class="form-control" style="width: auto;">
                                    <button id="applyRiskCustomRange" class="btn btn-primary btn-sm">Apply</button>
                                </div>
                            </div>
                            <div class="chart-container" style="height: 280px;">
                                <canvas id="riskDistributionChart"></canvas>
                            </div>
                            <div class="chart-legend risk-chart-legend">
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #e74c3c;"></div>
                                    <span>High Risk</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #f39c12;"></div>
                                    <span>Medium Risk</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #3498db;"></div>
                                    <span>Low Risk</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Upcoming Training</h2>
                            <div class="card-actions">
                                <a href="training.html" class="btn btn-sm btn-outline-primary">View All</a>
                            </div>
                        </div>
                        <div class="card-body">
                            <ul class="event-list">
                                <li class="event-item">
                                    <div class="event-date formatted-date" data-time="2025-04-18T00:00:00.000Z">
                                        <span class="month"></span>
                                        <span class="day"></span>
                                    </div>
                                    <div class="event-details">
                                        <h3 class="event-title">Fire Safety Training</h3>
                                        <p class="event-info">
                                            <span class="event-time"><i class="fas fa-clock"></i> 9:00 AM - 11:30 AM</span>
                                            <span class="event-location"><i class="fas fa-map-marker-alt"></i> Training Room A</span>
                                        </p>
                                        <span class="badge bg-primary">Mandatory</span>
                                    </div>
                                </li>
                                <li class="event-item">
                                    <div class="event-date formatted-date" data-time="2025-04-22T00:00:00.000Z">
                                        <span class="month"></span>
                                        <span class="day"></span>
                                    </div>
                                    <div class="event-details">
                                        <h3 class="event-title">Chemical Hazards</h3>
                                        <p class="event-info">
                                            <span class="event-time"><i class="fas fa-clock"></i> 2:00 PM - 4:00 PM</span>
                                            <span class="event-location"><i class="fas fa-map-marker-alt"></i> Conference Hall</span>
                                        </p>
                                        <span class="badge bg-secondary">Optional</span>
                                    </div>
                                </li>
                                <li class="event-item">
                                    <div class="event-date formatted-date" data-time="2025-04-29T00:00:00.000Z">
                                        <span class="month"></span>
                                        <span class="day"></span>
                                    </div>
                                    <div class="event-details">
                                        <h3 class="event-title">First Aid Refresher</h3>
                                        <p class="event-info">
                                            <span class="event-time"><i class="fas fa-clock"></i> 10:00 AM - 3:00 PM</span>
                                            <span class="event-location"><i class="fas fa-map-marker-alt"></i> Medical Center</span>
                                        </p>
                                        <span class="badge bg-primary">Mandatory</span>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Recent Incidents</h2>
                            <div class="card-actions">
                                <a href="event.html" class="btn btn-sm btn-outline-primary">View All</a>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="activity-feed">
                                <div class="activity-item">
                                    <span class="activity-icon bg-danger"><i class="fas fa-exclamation-triangle"></i></span>
                                    <div class="activity-content">
                                        <span class="activity-title">Minor Slip and Fall</span>
                                        <p>Reported in Warehouse, no injury recorded. Floor was wet without warning signs.</p>
                                        <span class="activity-time formatted-date" data-time="2025-04-13T00:00:00.000Z"></span>
                                    </div>
                                    <span class="badge bg-danger">High</span>
                                </div>
                                <div class="activity-item">
                                    <span class="activity-icon bg-warning"><i class="fas fa-bolt"></i></span>
                                    <div class="activity-content">
                                        <span class="activity-title">Electrical Near Miss</span>
                                        <p>Exposed wiring found during routine inspection in Manufacturing Area B.</p>
                                        <span class="activity-time formatted-date" data-time="2025-04-09T00:00:00.000Z"></span>
                                    </div>
                                    <span class="badge bg-warning">Medium</span>
                                </div>
                                <div class="activity-item">
                                    <span class="activity-icon bg-info"><i class="fas fa-eye"></i></span>
                                    <div class="activity-content">
                                        <span class="activity-title">Safety Observation</span>
                                        <p>Employee observed not using proper PPE when handling chemicals.</p>
                                        <span class="activity-time formatted-date" data-time="2025-04-05T00:00:00.000Z"></span>
                                    </div>
                                    <span class="badge bg-info">Low</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Safety Compliance</h2>
                    <div class="card-actions">
                        <button class="card-action-btn" title="Export">
                            <i class="fas fa-file-export"></i>
                        </button>
                        <button class="card-action-btn" title="Filter">
                            <i class="fas fa-filter"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <table>
                        <thead>
                            <tr>
                                <th>Department</th>
                                <th>Compliance Score</th>
                                <th>Progress</th>
                                <th>Last Inspection</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                                <tr>
                                    <td>Operations</td>
                                    <td>94%</td>
                                    <td>
                                        <div class="compliance-progress">
                                            <div class="compliance-bar" style="width: 94%;"></div>
                                        </div>
                                    </td>
                                    <td class="formatted-date" data-time="2025-04-10T00:00:00.000Z"></td>
                                    <td><span class="status-badge status-approved">Compliant</span></td>
                                </tr>
                                <tr>
                                    <td>Warehouse</td>
                                    <td>87%</td>
                                    <td>
                                        <div class="compliance-progress">
                                            <div class="compliance-bar" style="width: 87%;"></div>
                                        </div>
                                    </td>
                                    <td class="formatted-date" data-time="2025-04-08T00:00:00.000Z"></td>
                                    <td><span class="status-badge status-approved">Compliant</span></td>
                                </tr>
                                <tr>
                                    <td>Manufacturing</td>
                                    <td>78%</td>
                                    <td>
                                        <div class="compliance-progress">
                                            <div class="compliance-bar" style="width: 78%;"></div>
                                        </div>
                                    </td>
                                    <td class="formatted-date" data-time="2025-04-05T00:00:00.000Z"></td>
                                    <td><span class="status-badge status-review">Review</span></td>
                                </tr>
                                <tr>
                                    <td>Logistics</td>
                                    <td>92%</td>
                                    <td>
                                        <div class="compliance-progress">
                                            <div class "compliance-bar" style="width: 92%;"></div>
                                        </div>
                                    </td>
                                    <td class="formatted-date" data-time="2025-04-07T00:00:00.000Z"></td>
                                    <td><span class="status-badge status-approved">Compliant</span></td>
                                </tr>
                                <tr>
                                    <td>Admin</td>
                                    <td>98%</td>
                                    <td>
                                        <div class="compliance-progress">
                                            <div class="compliance-bar" style="width: 98%;"></div>
                                        </div>
                                    </td>
                                    <td class="formatted-date" data-time="2025-04-11T00:00:00.000Z"></td>
                                    <td><span class="status-badge status-approved">Compliant</span></td>
                                </tr>
                            </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Combined JSA Chart Section -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Job Safety Analysis Overview</h2>
                    <div class="card-actions">
                        <button class="card-action-btn" title="Download Report" id="downloadJsaChart">
                            <i class="fas fa-download"></i>
                        </button>
                        <a href="job-safety-analysis.html" class="btn btn-sm btn-outline-primary">View All</a>
                    </div>
                </div>
                <div class="card-body">
                    <div style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div>
                            <select id="jsaViewMode" class="form-select" style="width: auto;">
                                <option value="status">View by Status</option>
                                <option value="risk">View by Risk Level</option>
                            </select>
                        </div>
                        <div>
                            <select id="jsaDepartmentFilter" class="form-select" style="width: auto;">
                                <option value="all">All Departments</option>
                                <!-- Will be populated from Firebase -->
                            </select>
                        </div>
                        <div>
                            <select id="jsaStatusFilter" class="form-select" style="width: auto;">
                                <option value="all">All Statuses</option>
                                <option value="draft">Draft</option>
                                <option value="pending">Under Review</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <select id="jsaDateRangeFilter" class="form-select" style="width: auto;">
                                <option value="30">Last 30 Days</option>
                                <option value="90" selected>Last 90 Days</option>
                                <option value="180">Last 180 Days</option>
                                <option value="365">Last 365 Days</option>
                                <option value="all">All Time</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div id="jsaCustomDateRange" style="display: none; gap: 0.5rem; align-items: center;">
                            <input type="date" id="jsaCustomStartDate" class="form-control" style="width: auto;">
                            <span>to</span>
                            <input type="date" id="jsaCustomEndDate" class="form-control" style="width: auto;">
                            <button id="applyJsaCustomRange" class="btn btn-primary btn-sm">Apply</button>
                        </div>
                    </div>
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="jsaChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Training Request Overview Chart Section -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Training Request Overview</h2>
                    <div class="card-actions">
                        <button class="card-action-btn" title="Download Report" id="downloadTrainingRequestChart">
                            <i class="fas fa-download"></i>
                        </button>
                        <a href="training-requests.html" class="btn btn-sm btn-outline-primary">View All</a>
                    </div>
                </div>
                <div class="card-body">
                    <div style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div>
                            <select id="trainingReqViewMode" class="form-select" style="width: auto;">
                                <option value="status">View by Status</option>
                                <option value="priority">View by Priority</option>
                                <option value="type">View by Training Type</option>
                            </select>
                        </div>
                        <div>
                            <select id="trainingReqDepartmentFilter" class="form-select" style="width: auto;">
                                <option value="all">All Departments</option>
                                <!-- Will be populated from Firebase -->
                            </select>
                        </div>
                        <div>
                            <select id="trainingReqStatusFilter" class="form-select" style="width: auto;">
                                <option value="all">All Statuses</option>
                                <option value="draft">Draft</option>
                                <option value="pending">Pending</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                                <option value="scheduled">Scheduled</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <select id="trainingReqDateRangeFilter" class="form-select" style="width: auto;">
                                <option value="30">Last 30 Days</option>
                                <option value="90" selected>Last 90 Days</option>
                                <option value="180">Last 180 Days</option>
                                <option value="365">Last 365 Days</option>
                                <option value="all">All Time</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div id="trainingReqCustomDateRange" style="display: none; gap: 0.5rem; align-items: center;">
                            <input type="date" id="trainingReqCustomStartDate" class="form-control" style="width: auto;">
                            <span>to</span>
                            <input type="date" id="trainingReqCustomEndDate" class="form-control" style="width: auto;">
                            <button id="applyTrainingReqCustomRange" class="btn btn-primary btn-sm">Apply</button>
                        </div>
                    </div>
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="trainingRequestChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Permit Overview Chart Section -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Permit Overview</h2>
                    <div class="card-actions">
                        <button class="card-action-btn" title="Download Report" id="downloadPermitChart">
                            <i class="fas fa-download"></i>
                        </button>
                        <a href="permitboard.html" class="btn btn-sm btn-outline-primary">View All</a>
                    </div>
                </div>
                <div class="card-body">
                    <div style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div>
                            <select id="permitViewMode" class="form-select" style="width: auto;">
                                <option value="status">By Status</option>
                                <option value="type">By Type</option>
                            </select>
                        </div>
                        <div>
                            <select id="permitDepartmentFilter" class="form-select" style="width: auto;">
                                <option value="all">All Departments</option>
                            </select>
                        </div>
                        <div>
                            <select id="permitStatusFilter" class="form-select" style="width: auto;">
                                <option value="all">All Statuses</option>
                                <option value="pending">Pending</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                                <option value="expired">Expired</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <select id="permitDateRangeFilter" class="form-select" style="width: auto;">
                                <option value="30">Last 30 Days</option>
                                <option value="90">Last 90 Days</option>
                                <option value="180">Last 180 Days</option>
                                <option value="365">Last 365 Days</option>
                                <option value="all">All Time</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div id="permitCustomDateRange" style="display: none; gap: 0.5rem; align-items: center;">
                            <input type="date" id="permitCustomStartDate" class="form-control" style="width: auto;">
                            <span>to</span>
                            <input type="date" id="permitCustomEndDate" class="form-control" style="width: auto;">
                            <button id="applyPermitCustomRange" class="btn btn-primary btn-sm">Apply</button>
                        </div>
                    </div>
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="permitChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 HSE Online System. All rights reserved.</p>
    </footer>

    <!-- Firebase scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <!-- Moment.js for date formatting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <!-- Custom scripts -->
    <script src="js/datetime-utils.js"></script>
    <script src="js/main.js"></script>
    <script src="js/header-loader.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.firebasestorage.app",
            messagingSenderId: "829083030831",
            appId: "1:829083030831:web:36a370e62691e560bc3dda"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();
        const auth = firebase.auth();

        auth.onAuthStateChanged(user => {
            if (user) {
                console.log("User is signed in:", user.email);
                // Initialize datetime formatting
                if (window.DateTimeUtils) {
                    // Format all elements with 'formatted-date' class
                    const formatDateForEvent = (element) => {
                        const timestamp = element.getAttribute('data-time');
                        if (!timestamp) return;
                        
                        const date = new Date(timestamp);
                        if (isNaN(date.getTime())) return;

                        // For event dates that show month/day separately
                        if (element.querySelector('.month') && element.querySelector('.day')) {
                            const month = window.DateTimeUtils.formatDate(date, user.uid, { format: 'MMM' });
                            const day = window.DateTimeUtils.formatDate(date, user.uid, { format: 'D' });
                            element.querySelector('.month').textContent = month;
                            element.querySelector('.day').textContent = day;
                        } else {
                            // For regular date displays
                            element.textContent = window.DateTimeUtils.formatDate(date, user.uid);
                        }
                    };

                    // Update all date elements initially
                    document.querySelectorAll('.formatted-date').forEach(formatDateForEvent);

                    // Listen for date/time preference changes
                    document.addEventListener('datetimePreferencesChanged', function(e) {
                        document.querySelectorAll('.formatted-date').forEach(formatDateForEvent);
                    });
                }

                initializeRealTimeGraphs(user.uid);
                loadDashboardData(user.uid);
            } else {
                console.log("No user is signed in.");
                window.location.href = "login.html";
            }
        });

        function initializeRealTimeGraphs(userId) {
            // Initialize Chart.js graphs
            const incidentsCtx = document.getElementById('incidentsChart').getContext('2d');
            const riskDistributionCtx = document.getElementById('riskDistributionChart').getContext('2d');

            // Initialize incidents chart
            const incidentsChart = new Chart(incidentsCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Incidents',
                            data: [],
                            backgroundColor: '#3498db',
                            borderColor: '#3498db',
                            borderWidth: 1,
                            borderRadius: 4,
                            maxBarThickness: 35,
                            minBarLength: 5,
                            barPercentage: 0.8,
                            categoryPercentage: 0.9
                        },
                        {
                            label: 'Near Misses',
                            data: [],
                            backgroundColor: '#2ecc71',
                            borderColor: '#2ecc71',
                            borderWidth: 1,
                            borderRadius: 4,
                            maxBarThickness: 35,
                            minBarLength: 5,
                            barPercentage: 0.8,
                            categoryPercentage: 0.9
                        },
                        {
                            label: 'Safety Observations',
                            data: [],
                            backgroundColor: '#f39c12',
                            borderColor: '#f39c12',
                            borderWidth: 1,
                            borderRadius: 4,
                            maxBarThickness: 35,
                            minBarLength: 5,
                            barPercentage: 0.8,
                            categoryPercentage: 0.9
                        },
                        {
                            label: 'Inspections',
                            data: [],
                            backgroundColor: '#9b59b6',
                            borderColor: '#9b59b6',
                            borderWidth: 1,
                            borderRadius: 4,
                            maxBarThickness: 35,
                            minBarLength: 5,
                            barPercentage: 0.8,
                            categoryPercentage: 0.9
                        },
                        {
                            label: 'Audits',
                            data: [],
                            backgroundColor: '#34495e',
                            borderColor: '#34495e',
                            borderWidth: 1,
                            borderRadius: 4,
                            maxBarThickness: 35,
                            minBarLength: 5,
                            barPercentage: 0.8,
                            categoryPercentage: 0.9
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                display: true,
                                drawBorder: true,
                                drawOnChartArea: true,
                                drawTicks: true,
                            },
                            ticks: {
                                stepSize: 1,
                                precision: 0
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y + ' events';
                                }
                            }
                        }
                    }
                }
            });

            function handleLegendDisplay(selectedValue) {
                const datasets = incidentsChart.data.datasets;
                const legendItems = document.querySelectorAll('.chart-legend .legend-item');
                
                // Reset all datasets to hidden
                datasets.forEach(dataset => dataset.hidden = true);
                
                // Hide all legend items first
                legendItems.forEach(item => {
                    if (selectedValue !== 'all') {
                        item.style.display = 'none';
                    }
                });

                if (selectedValue === 'all') {
                    // Show all datasets and legend items
                    datasets.forEach(dataset => dataset.hidden = false);
                    legendItems.forEach(item => {
                        item.style.display = 'flex';
                    });
                } else {
                    // Show only the selected dataset and legend item
                    const datasetMap = {
                        'incidents': 'Incidents',
                        'nearMisses': 'Near Misses',
                        'observations': 'Safety Observations',
                        'inspections': 'Inspections',
                        'audits': 'Audits'
                    };
                    
                    const selectedDataset = datasets.find(ds => ds.label === datasetMap[selectedValue]);
                    if (selectedDataset) {
                        selectedDataset.hidden = false;
                        // Show only the corresponding legend item
                        const selectedLegendItem = Array.from(legendItems).find(item => 
                            item.textContent.trim() === datasetMap[selectedValue]
                        );
                        if (selectedLegendItem) {
                            selectedLegendItem.style.display = 'flex';
                        }
                    }
                }
                
                incidentsChart.update();
            }

            // Add event listener for the filter
            document.getElementById('eventTypeFilter').addEventListener('change', function(e) {
                const selectedValue = e.target.value;
                handleLegendDisplay(selectedValue);
            });

            // Initial display with all items shown
            handleLegendDisplay('all');

            // Initialize risk distribution chart
            const riskDistributionChart = new Chart(riskDistributionCtx, {
                type: 'bar',  // Changed from doughnut to bar to match events graph
                data: {
                    labels: ['High Risk', 'Medium Risk', 'Low Risk', 'Extreme Risk'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#e74c3c', '#f39c12', '#3498db', '#dc3545'],
                        borderColor: ['#e74c3c', '#f39c12', '#3498db', '#dc3545'],
                        borderWidth: 1,
                        borderRadius: 4,
                        maxBarThickness: 50,
                        minBarLength: 5,
                        barPercentage: 0.5,
                    }]  
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',  // Horizontal bar chart
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: {
                                display: true,
                            },
                            ticks: {
                                stepSize: 1,
                                precision: 0
                            }
                        },
                        y: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false,  // Hide legend like in risk assessment graph
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.x + ' assessments';
                                }
                            }
                        }
                    }
                }
            });

            // Set up real-time listeners
            setupEventListener(incidentsChart);
            setupRiskAssessmentListener(riskDistributionChart);
            setupJsaCharts(); // Add JSA charts setup
            setupTrainingRequestsChart(); // Add Training Requests chart setup
            setupJSAListener();
        }

        function setupEventListener(chart) {
            function updateChartData(monthsToShow, customStartDate = null, customEndDate = null) {
                let startDate, endDate;
                const displayMode = document.getElementById('displayModeFilter').value;

                if (customStartDate && customEndDate) {
                    startDate = moment(customStartDate);
                    endDate = moment(customEndDate);
                } else {
                    endDate = moment();
                    startDate = moment().subtract(monthsToShow, 'months').startOf('month');
                }

                // Generate labels based on display mode - ensure we have all time periods
                const labels = [];
                const currentDate = moment(startDate).startOf(displayMode);
                while (currentDate <= endDate) {
                    switch(displayMode) {
                        case 'week':
                            labels.push(currentDate.format('MMM DD, YYYY'));
                            currentDate.add(1, 'week');
                            break;
                        case 'month':
                            labels.push(currentDate.format('MMM YYYY'));
                            currentDate.add(1, 'month');
                            break;
                        case 'year':
                            labels.push(currentDate.format('YYYY'));
                            currentDate.add(1, 'year');
                            break;
                    }
                }
                
                // Always update chart labels to show all time periods
                chart.data.labels = labels;

                // Initialize data arrays for each event type with zeros for all time periods
                const eventData = {
                    incidents: Array(labels.length).fill(0),
                    nearMisses: Array(labels.length).fill(0),
                    observations: Array(labels.length).fill(0),
                    inspections: Array(labels.length).fill(0),
                    audits: Array(labels.length).fill(0)
                };

                // Listen for real-time event updates
                database.ref('events').on('value', snapshot => {
                    // Reset counters to ensure zero values for periods with no data
                    Object.keys(eventData).forEach(key => {
                        eventData[key] = Array(labels.length).fill(0);
                    });

                    if (snapshot.exists()) {
                        snapshot.forEach(child => {
                            const event = child.val();
                            const eventDate = moment(event.dateOfEvent);
                            
                            if (eventDate >= startDate && eventDate <= endDate) {
                                // Calculate index based on display mode
                                let index;
                                switch(displayMode) {
                                    case 'week':
                                        index = Math.floor(eventDate.diff(startDate, 'weeks'));
                                        break;
                                    case 'month':
                                        index = eventDate.diff(startDate.startOf('month'), 'months');
                                        break;
                                    case 'year':
                                        index = eventDate.diff(startDate.startOf('year'), 'years');
                                        break;
                                }

                                if (index >= 0 && index < labels.length) {
                                    switch(event.eventType.toLowerCase()) {
                                        case 'incident':
                                            eventData.incidents[index]++;
                                            break;
                                        case 'near-miss':
                                            eventData.nearMisses[index]++;
                                            break;
                                        case 'observation':
                                            eventData.observations[index]++;
                                            break;
                                        case 'inspection':
                                            eventData.inspections[index]++;
                                            break;
                                        case 'audit':
                                            eventData.audits[index]++;
                                            break;
                                    }
                                }
                            }
                        });
                    }

                    // Always update all datasets to ensure zero values are displayed
                    chart.data.datasets[0].data = eventData.incidents;
                    chart.data.datasets[1].data = eventData.nearMisses;
                    chart.data.datasets[2].data = eventData.observations;
                    chart.data.datasets[3].data = eventData.inspections;
                    chart.data.datasets[4].data = eventData.audits;
                    
                    chart.update();
                });
            }

            // Initial update with 6 months
            updateChartData(6);

            // Add event listener for display mode changes
            document.getElementById('displayModeFilter').addEventListener('change', function() {
                const dateRangeValue = document.getElementById('dateRangeFilter').value;
                if (dateRangeValue === 'custom') {
                    const startDate = document.getElementById('customStartDate').value;
                    const endDate = document.getElementById('customEndDate').value;
                    if (startDate && endDate) {
                        updateChartData(null, startDate, endDate);
                    }
                } else {
                    const monthsToShow = parseInt(dateRangeValue);
                    updateChartData(monthsToShow);
                }
            });

            // Add event listener for date range changes
            document.getElementById('dateRangeFilter').addEventListener('change', function(e) {
                const selectedValue = e.target.value;
                const customDateRange = document.getElementById('customDateRange');

                if (selectedValue === 'custom') {
                    customDateRange.style.display = 'flex';
                    // Set default dates for custom range
                    const endDate = moment().format('YYYY-MM-DD');
                    const startDate = moment().subtract(6, 'months').format('YYYY-MM-DD');
                    document.getElementById('customStartDate').value = startDate;
                    document.getElementById('customEndDate').value = endDate;
                } else {
                    customDateRange.style.display = 'none';
                    const monthsToShow = parseInt(selectedValue);
                    updateChartData(monthsToShow);
                }
            });

            // Add event listener for custom range apply button
            document.getElementById('applyCustomRange').addEventListener('click', function() {
                const startDate = document.getElementById('customStartDate').value;
                const endDate = document.getElementById('customEndDate').value;
                if (startDate && endDate) {
                    updateChartData(null, startDate, endDate);
                } else {
                    alert('Please select both start and end dates');
                }
            });
        }

        function setupRiskAssessmentListener(chart) {
            // Add event listeners for risk filters
            document.getElementById('riskCategoryFilter').addEventListener('change', updateRiskChart);
            document.getElementById('riskLocationFilter').addEventListener('change', updateRiskChart);
            document.getElementById('riskDepartmentFilter').addEventListener('change', updateRiskChart);
            document.getElementById('riskStatusFilter').addEventListener('change', updateRiskChart);
            document.getElementById('riskLevelFilter').addEventListener('change', updateRiskChart);
            document.getElementById('riskDateRangeFilter').addEventListener('change', function(e) {
                const selectedValue = e.target.value;
                const customDateRange = document.getElementById('riskCustomDateRange');

                if (selectedValue === 'custom') {
                    customDateRange.style.display = 'flex';
                    // Set default dates for custom range
                    const endDate = moment().format('YYYY-MM-DD');
                    const startDate = moment().subtract(90, 'days').format('YYYY-MM-DD');
                    document.getElementById('riskCustomStartDate').value = startDate;
                    document.getElementById('riskCustomEndDate').value = endDate;
                } else {
                    customDateRange.style.display = 'none';
                    updateRiskChart();
                }
            });
            document.getElementById('applyRiskCustomRange').addEventListener('click', updateRiskChart);

            function updateRiskChart() {
                const categoryFilter = document.getElementById('riskCategoryFilter').value;
                const locationFilter = document.getElementById('riskLocationFilter').value;
                const departmentFilter = document.getElementById('riskDepartmentFilter').value;
                const statusFilter = document.getElementById('riskStatusFilter').value;
                const levelFilter = document.getElementById('riskLevelFilter').value;
                const dateRangeFilter = document.getElementById('riskDateRangeFilter').value;
                const customStartDate = document.getElementById('riskCustomStartDate').value;
                const customEndDate = document.getElementById('riskCustomEndDate').value;

                // Always show all risk level labels in the legend
                const legendItems = document.querySelectorAll('.risk-chart-legend .legend-item');
                legendItems.forEach(item => {
                    item.style.display = levelFilter === 'all' ? 'flex' : 'none';
                });
                
                // If a specific level is selected, only show its legend
                if (levelFilter !== 'all') {
                    const selectedLegend = Array.from(legendItems).find(item => 
                        item.textContent.trim().toLowerCase().includes(levelFilter)
                    );
                    if (selectedLegend) {
                        selectedLegend.style.display = 'flex';
                    }
                }

                // Calculate date range
                let startDate, endDate;
                if (dateRangeFilter === 'custom' && customStartDate && customEndDate) {
                    startDate = moment(customStartDate);
                    endDate = moment(customEndDate);
                } else {
                    endDate = moment();
                    switch(dateRangeFilter) {
                        case '30':
                            startDate = moment().subtract(30, 'days');
                            break;
                        case '90':
                            startDate = moment().subtract(90, 'days');
                            break;
                        case '180':
                            startDate = moment().subtract(180, 'days');
                            break;
                        case '365':
                            startDate = moment().subtract(365, 'days');
                            break;
                        default:
                            startDate = moment(0);  // All dates
                    }
                }

                // Define all possible risk levels and initialize counts to zero
                const riskLevels = ['High Risk', 'Medium Risk', 'Low Risk', 'Extreme Risk'];
                let riskCounts = {
                    'High Risk': 0,
                    'Medium Risk': 0,
                    'Low Risk': 0,
                    'Extreme Risk': 0
                };

                database.ref('riskmanagement').on('value', snapshot => {
                    // Reset all counts to zero first
                    Object.keys(riskCounts).forEach(key => riskCounts[key] = 0);

                    // Process risk data if it exists
                    if (snapshot.exists()) {
                        snapshot.forEach(child => {
                            const assessment = child.val();
                            const assessmentDate = moment(assessment.dateIdentified);
                            
                            // Get the risk level from either residual or inherent assessment
                            let riskLevel = (assessment.residualAssessment?.level || assessment.inherentAssessment?.level || '').toLowerCase();
                            
                            // Convert risk level to match our chart labels
                            let riskLevelLabel;
                            switch(riskLevel) {
                                case 'high': riskLevelLabel = 'High Risk'; break;
                                case 'medium': riskLevelLabel = 'Medium Risk'; break;
                                case 'low': riskLevelLabel = 'Low Risk'; break;
                                case 'extreme': riskLevelLabel = 'Extreme Risk'; break;
                                default: return; // Skip if no valid risk level
                            }

                            // Apply filters
                            if ((categoryFilter === 'all' || assessment.category === categoryFilter) &&
                                (locationFilter === 'all' || assessment.location === locationFilter) &&
                                (departmentFilter === 'all' || assessment.department === departmentFilter) &&
                                (statusFilter === 'all' || assessment.status === statusFilter) &&
                                (levelFilter === 'all' || riskLevel === levelFilter) &&
                                (assessmentDate >= startDate && assessmentDate <= endDate)) {
                                
                                // Increment the appropriate risk level counter
                                if (riskCounts[riskLevelLabel] !== undefined) {
                                    riskCounts[riskLevelLabel]++;
                                }
                            }
                        });
                    }

                    // Update chart data, keeping the same order as the labels
                    chart.data.labels = riskLevels; // Always show all risk levels
                    chart.data.datasets[0].data = riskLevels.map(level => riskCounts[level]);
                    chart.update();
                });
            }
            
            // Initial chart update
            updateRiskChart();
        }

        function setupJSAListener() {
            database.ref('jsa').on('value', snapshot => {
                if (snapshot.exists()) {
                    let totalJSA = 0;
                    let completedJSA = 0;

                    snapshot.forEach(child => {
                        const jsa = child.val();
                        totalJSA++;
                        if (jsa.status === 'completed') {
                            completedJSA++;
                        }
                    });

                    const jsaCompletionRate = (completedJSA / totalJSA) * 100;
                    // Update JSA statistics if needed
                    updateJSAStatistics(totalJSA, completedJSA, jsaCompletionRate);
                }
            });
        }

        function updateTrainingList(trainings) {
            const trainingList = document.querySelector('.event-list');
            if (!trainingList) return;

            trainingList.innerHTML = trainings.map(training => `
                <li class="event-item">
                    <div class="event-date formatted-date" data-time="${training.date}">
                        <span class="month"></span>
                        <span class="day"></span>
                    </div>
                    <div class="event-details">
                        <h3 class="event-title">${training.title}</h3>
                        <p class="event-info">
                            <span class="event-time"><i class="fas fa-clock"></i> ${training.time}</span>
                            <span class="event-location"><i class="fas fa-map-marker-alt"></i> ${training.location}</span>
                        </p>
                        <span class="badge bg-${training.mandatory ? 'primary' : 'secondary'}">${training.mandatory ? 'Mandatory' : 'Optional'}</span>
                    </div>
                </li>
            `).join('');

            // Update formatted dates
            document.querySelectorAll('.formatted-date').forEach(element => {
                formatDateForEvent(element);
            });
        }

        function updateJSAStatistics(total, completed, completionRate) {
            // Update JSA statistics in the dashboard if you have such elements
            // This is a placeholder - implement according to your UI
        }

        function loadDashboardData(userId) {
            // Load user-specific dashboard data from Firebase
            database.ref('users/' + userId).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        // Update dashboard with user data
                        if (userData.firstName) {
                            document.querySelector('.welcome-message').textContent = 
                                `Welcome back, ${userData.firstName}!`;
                        }
                    }
                })
                .catch(error => {
                    console.error("Error loading dashboard data:", error);
                });
            
            // Set up all charts
            setupPermitChart();
        }

        // Add JSA charts visualization function
        function setupJsaCharts() {
            const jsaCtx = document.getElementById('jsaChart').getContext('2d');
            
            // Store all departments from Firebase
            let allDepartmentsList = [];
            
            // Load departments for filter
            loadDepartmentsForJsa();
            
            // Create the chart with initial configuration for time series data
            const jsaChart = new Chart(jsaCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',  // Horizontal bars
                    scales: {
                        x: {
                            beginAtZero: true,
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Number of JSAs'
                            },
                            ticks: {
                                precision: 0
                            }
                        },
                        y: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Department/Status'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'JSA Status Distribution',
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            display: true,
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.x + ' JSAs';
                                }
                            }
                        }
                    }
                }
            });
            
            // Set up event listeners for filters
            document.getElementById('jsaViewMode').addEventListener('change', updateJsaChart);
            document.getElementById('jsaDepartmentFilter').addEventListener('change', updateJsaChart);
            document.getElementById('jsaStatusFilter').addEventListener('change', updateJsaChart);
            document.getElementById('jsaDateRangeFilter').addEventListener('change', function(e) {
                const selectedValue = e.target.value;
                const customDateRange = document.getElementById('jsaCustomDateRange');

                if (selectedValue === 'custom') {
                    customDateRange.style.display = 'flex';
                    // Set default dates for custom range
                    const endDate = moment().format('YYYY-MM-DD');
                    const startDate = moment().subtract(90, 'days').format('YYYY-MM-DD');
                    document.getElementById('jsaCustomStartDate').value = startDate;
                    document.getElementById('jsaCustomEndDate').value = endDate;
                } else {
                    customDateRange.style.display = 'none';
                    updateJsaChart();
                }
            });
            document.getElementById('applyJsaCustomRange').addEventListener('click', updateJsaChart);
            
            // Load departments for JSA filter and store complete list
            function loadDepartmentsForJsa() {
                const departmentSelect = document.getElementById('jsaDepartmentFilter');
                departmentSelect.innerHTML = '<option value="all">All Departments</option>';
                
                // Get all departments from Firebase
                database.ref('departments').once('value')
                    .then(snapshot => {
                        if (snapshot.exists()) {
                            // Reset the departments list
                            allDepartmentsList = [];
                            
                            snapshot.forEach(deptSnapshot => {
                                const dept = deptSnapshot.val();
                                const deptName = dept.name || deptSnapshot.key;
                                
                                // Add to dropdown
                                const option = document.createElement('option');
                                option.value = deptSnapshot.key;
                                option.textContent = deptName;
                                departmentSelect.appendChild(option);
                                
                                // Add to our tracking array
                                allDepartmentsList.push({
                                    id: deptSnapshot.key,
                                    name: deptName
                                });
                            });
                        } else {
                            // Add default departments if none exist
                            const defaultDepts = ['Operations', 'Warehouse', 'Manufacturing', 'Logistics', 'Maintenance', 'Settings', 'HR', 'IT'];
                            defaultDepts.forEach(dept => {
                                const option = document.createElement('option');
                                option.value = dept.toLowerCase();
                                option.textContent = dept;
                                departmentSelect.appendChild(option);
                                
                                // Add to our tracking array
                                allDepartmentsList.push({
                                    id: dept.toLowerCase(),
                                    name: dept
                                });
                            });
                        }
                        
                        // After loading departments, update the chart
                        updateJsaChart();
                    });
            }
            
            // Update JSA chart based on filters
            function updateJsaChart() {
                const viewMode = document.getElementById('jsaViewMode').value;
                const departmentFilter = document.getElementById('jsaDepartmentFilter').value;
                const statusFilter = document.getElementById('jsaStatusFilter').value;
                const dateRangeFilter = document.getElementById('jsaDateRangeFilter').value;
                const customStartDate = document.getElementById('jsaCustomStartDate').value;
                const customEndDate = document.getElementById('jsaCustomEndDate').value;
                
                // Status filter should be disabled when viewing by status
                const statusFilterEl = document.getElementById('jsaStatusFilter');
                statusFilterEl.disabled = viewMode === 'status';
                if (viewMode === 'status') {
                    statusFilterEl.value = 'all';
                }
                
                // Calculate date range (same as before)
                let startDate, endDate;
                if (dateRangeFilter === 'custom' && customStartDate && customEndDate) {
                    startDate = moment(customStartDate);
                    endDate = moment(customEndDate);
                } else if (dateRangeFilter === 'all') {
                    startDate = moment(0);
                    endDate = moment();
                } else {
                    endDate = moment();
                    startDate = moment().subtract(parseInt(dateRangeFilter), 'days');
                }
                
                // Get JSA data from Firebase
                database.ref('jsas').once('value')
                    .then(snapshot => {
                        // Initialize empty data structure for all departments
                        const departmentsData = {};
                        
                        // Initialize all departments with zero counts
                        allDepartmentsList.forEach(dept => {
                            departmentsData[dept.id] = {
                                name: dept.name,
                                statusCounts: {
                                    draft: 0,
                                    pending: 0,
                                    approved: 0,
                                    rejected: 0
                                },
                                riskCounts: {
                                    low: 0,
                                    medium: 0,
                                    high: 0
                                }
                            };
                        });
                        
                        // Process all JSAs to count by department and status/risk
                        if (snapshot.exists()) {
                            snapshot.forEach(child => {
                                const jsa = child.val();
                                const jsaDate = moment(jsa.datePrepared || jsa.createdAt || jsa.timestamp);
                                const jsaDept = jsa.department || 'unknown';
                                const jsaStatus = jsa.status || 'draft';
                                
                                // Apply date and status filters
                                if ((statusFilter === 'all' || jsaStatus === statusFilter) && 
                                    jsaDate >= startDate && jsaDate <= endDate) {
                                    
                                    // If department doesn't exist in our data structure, add it
                                    if (!departmentsData[jsaDept]) {
                                        departmentsData[jsaDept] = {
                                            name: jsaDept,
                                            statusCounts: {
                                                draft: 0,
                                                pending: 0,
                                                approved: 0,
                                                rejected: 0
                                            },
                                            riskCounts: {
                                                low: 0,
                                                medium: 0,
                                                high: 0
                                            }
                                        };
                                    }
                                    
                                    // Count by status
                                    if (departmentsData[jsaDept].statusCounts[jsaStatus] !== undefined) {
                                        departmentsData[jsaDept].statusCounts[jsaStatus]++;
                                    }
                                    
                                    // Calculate risk level
                                    if (jsa.tasks && jsa.tasks.length) {
                                        let highestRisk = 0;
                                        jsa.tasks.forEach(task => {
                                            if (task.steps) {
                                                task.steps.forEach(step => {
                                                    if (step.initialRisk) {
                                                        const risk = step.initialRisk.likelihood * step.initialRisk.severity;
                                                        highestRisk = Math.max(highestRisk, risk);
                                                    }
                                                });
                                            }
                                        });
                                        
                                        let riskLevel = '';
                                        if (highestRisk >= 15) riskLevel = 'high';
                                        else if (highestRisk >= 8) riskLevel = 'medium';
                                        else if (highestRisk > 0) riskLevel = 'low';
                                        
                                        if (riskLevel && departmentsData[jsaDept].riskCounts[riskLevel] !== undefined) {
                                            departmentsData[jsaDept].riskCounts[riskLevel]++;
                                        }
                                    }
                                }
                            });
                        }
                        
                        // Prepare departments for display based on filter
                        let displayDepartments;
                        
                        if (departmentFilter !== 'all') {
                            // Show only the selected department
                            displayDepartments = [departmentFilter];
                        } else {
                            // Show all departments, sorted alphabetically
                            displayDepartments = Object.keys(departmentsData).sort((a, b) => {
                                const nameA = departmentsData[a].name.toLowerCase();
                                const nameB = departmentsData[b].name.toLowerCase();
                                return nameA.localeCompare(nameB);
                            });
                        }
                        
                        // Create labels using department names, not IDs
                        const departmentLabels = displayDepartments.map(deptId => departmentsData[deptId].name);
                        
                        // Update chart based on view mode
                        if (viewMode === 'status') {
                            // Update for status view grouped by department
                            jsaChart.options.plugins.title.text = 'JSA Status Distribution by Department';
                            jsaChart.options.scales.y.title.text = 'Department';
                            
                            jsaChart.data.labels = departmentLabels;
                            jsaChart.data.datasets = [
                                {
                                    label: 'Draft',
                                    data: displayDepartments.map(deptId => departmentsData[deptId]?.statusCounts.draft || 0),
                                    backgroundColor: 'rgba(108, 117, 125, 0.7)',
                                    borderColor: '#6c757d',
                                    borderWidth: 1,
                                    stack: 'Stack 0'
                                },
                                {
                                    label: 'Under Review',
                                    data: displayDepartments.map(deptId => departmentsData[deptId]?.statusCounts.pending || 0),
                                    backgroundColor: 'rgba(255, 193, 7, 0.7)',
                                    borderColor: '#ffc107',
                                    borderWidth: 1,
                                    stack: 'Stack 0'
                                },
                                {
                                    label: 'Approved',
                                    data: displayDepartments.map(deptId => departmentsData[deptId]?.statusCounts.approved || 0),
                                    backgroundColor: 'rgba(46, 204, 113, 0.7)',
                                    borderColor: '#2ecc71',
                                    borderWidth: 1,
                                    stack: 'Stack 0'
                                },
                                {
                                    label: 'Rejected',
                                    data: displayDepartments.map(deptId => departmentsData[deptId]?.statusCounts.rejected || 0),
                                    backgroundColor: 'rgba(231, 76, 60, 0.7)',
                                    borderColor: '#e74c3c',
                                    borderWidth: 1,
                                    stack: 'Stack 0'
                                }
                            ];
                        } else {
                            // Update for risk view grouped by department
                            jsaChart.options.plugins.title.text = 'JSA Risk Level Distribution by Department';
                            jsaChart.options.scales.y.title.text = 'Department';
                            
                            jsaChart.data.labels = departmentLabels;
                            jsaChart.data.datasets = [
                                {
                                    label: 'Low Risk',
                                    data: displayDepartments.map(deptId => departmentsData[deptId]?.riskCounts.low || 0),
                                    backgroundColor: 'rgba(52, 152, 219, 0.7)',
                                    borderColor: '#3498db',
                                    borderWidth: 1,
                                    stack: 'Stack 0'
                                },
                                {
                                    label: 'Medium Risk',
                                    data: displayDepartments.map(deptId => departmentsData[deptId]?.riskCounts.medium || 0),
                                    backgroundColor: 'rgba(243, 156, 18, 0.7)',
                                    borderColor: '#f39c12',
                                    borderWidth: 1,
                                    stack: 'Stack 0'
                                },
                                {
                                    label: 'High Risk',
                                    data: displayDepartments.map(deptId => departmentsData[deptId]?.riskCounts.high || 0),
                                    backgroundColor: 'rgba(231, 76, 60, 0.7)',
                                    borderColor: '#e74c3c',
                                    borderWidth: 1,
                                    stack: 'Stack 0'
                                }
                            ];
                        }
                        
                        // Update the chart
                        jsaChart.update();
                    });
            }
            
            // Initial chart update and download functionality (same as before)
            updateJsaChart();
            
            document.getElementById('downloadJsaChart').addEventListener('click', function() {
                const canvas = document.getElementById('jsaChart');
                if (canvas) {
                    const viewMode = document.getElementById('jsaViewMode').value;
                    const filename = viewMode === 'status' ? 'jsa-status-chart.png' : 'jsa-risk-chart.png';
                    
                    const image = canvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.download = filename;
                    link.href = image;
                    link.click();
                }
            });
        }

        // Add Training Requests chart visualization function
        function setupTrainingRequestsChart() {
            const trainingReqCtx = document.getElementById('trainingRequestChart').getContext('2d');
            
            // Store all departments from Firebase
            let allDepartmentsList = [];
            
            // Load departments for filter
            loadDepartmentsForTrainingRequests();
            
            // Create the chart with initial configuration
            const trainingRequestChart = new Chart(trainingReqCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',  // Horizontal bars
                    scales: {
                        x: {
                            beginAtZero: true,
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Number of Training Requests'
                            },
                            ticks: {
                                precision: 0
                            }
                        },
                        y: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Department/Status'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Training Request Status Distribution',
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            display: true,
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.x + ' requests';
                                }
                            }
                        }
                    }
                }
            });
            
            // Set up event listeners for filters
            document.getElementById('trainingReqViewMode').addEventListener('change', updateTrainingRequestChart);
            document.getElementById('trainingReqDepartmentFilter').addEventListener('change', updateTrainingRequestChart);
            document.getElementById('trainingReqStatusFilter').addEventListener('change', updateTrainingRequestChart);
            document.getElementById('trainingReqDateRangeFilter').addEventListener('change', function(e) {
                const selectedValue = e.target.value;
                const customDateRange = document.getElementById('trainingReqCustomDateRange');

                if (selectedValue === 'custom') {
                    customDateRange.style.display = 'flex';
                    // Set default dates for custom range
                    const endDate = moment().format('YYYY-MM-DD');
                    const startDate = moment().subtract(90, 'days').format('YYYY-MM-DD');
                    document.getElementById('trainingReqCustomStartDate').value = startDate;
                    document.getElementById('trainingReqCustomEndDate').value = endDate;
                } else {
                    customDateRange.style.display = 'none';
                    updateTrainingRequestChart();
                }
            });
            document.getElementById('applyTrainingReqCustomRange').addEventListener('click', updateTrainingRequestChart);
            
            // Load departments for Training Request filter
            function loadDepartmentsForTrainingRequests() {
                const departmentSelect = document.getElementById('trainingReqDepartmentFilter');
                departmentSelect.innerHTML = '<option value="all">All Departments</option>';
                
                // Get all departments from Firebase
                database.ref('departments').once('value')
                    .then(snapshot => {
                        if (snapshot.exists()) {
                            // Reset the departments list
                            allDepartmentsList = [];
                            
                            snapshot.forEach(deptSnapshot => {
                                const dept = deptSnapshot.val();
                                const deptName = dept.name || deptSnapshot.key;
                                
                                // Add to dropdown
                                const option = document.createElement('option');
                                option.value = deptSnapshot.key;
                                option.textContent = deptName;
                                departmentSelect.appendChild(option);
                                
                                // Add to our tracking array
                                allDepartmentsList.push({
                                    id: deptSnapshot.key,
                                    name: deptName
                                });
                            });
                        } else {
                            // Add default departments if none exist
                            const defaultDepts = ['Operations', 'Warehouse', 'Manufacturing', 'Logistics', 'Maintenance', 'Settings', 'HR', 'IT'];
                            defaultDepts.forEach(dept => {
                                const option = document.createElement('option');
                                option.value = dept.toLowerCase();
                                option.textContent = dept;
                                departmentSelect.appendChild(option);
                                
                                // Add to our tracking array
                                allDepartmentsList.push({
                                    id: dept.toLowerCase(),
                                    name: dept
                                });
                            });
                        }
                        
                        // After loading departments, update the chart
                        updateTrainingRequestChart();
                    });
            }
            
            // Update Training Request chart based on filters
            function updateTrainingRequestChart() {
                const viewMode = document.getElementById('trainingReqViewMode').value;
                const departmentFilter = document.getElementById('trainingReqDepartmentFilter').value;
                const statusFilter = document.getElementById('trainingReqStatusFilter').value;
                const dateRangeFilter = document.getElementById('trainingReqDateRangeFilter').value;
                const customStartDate = document.getElementById('trainingReqCustomStartDate').value;
                const customEndDate = document.getElementById('trainingReqCustomEndDate').value;
                
                // Status filter should be disabled when viewing by status
                const statusFilterEl = document.getElementById('trainingReqStatusFilter');
                statusFilterEl.disabled = viewMode === 'status';
                if (viewMode === 'status') {
                    statusFilterEl.value = 'all';
                }
                
                // Calculate date range
                let startDate, endDate;
                if (dateRangeFilter === 'custom' && customStartDate && customEndDate) {
                    startDate = moment(customStartDate);
                    endDate = moment(customEndDate);
                } else if (dateRangeFilter === 'all') {
                    startDate = moment(0);
                    endDate = moment();
                } else {
                    endDate = moment();
                    startDate = moment().subtract(parseInt(dateRangeFilter), 'days');
                }
                
                // Get Training Request data from Firebase
                database.ref('training-requests').once('value')
                    .then(snapshot => {
                        // Initialize empty data structure for all departments
                        const departmentsData = {};
                        
                        // Initialize all departments with zero counts
                        allDepartmentsList.forEach(dept => {
                            departmentsData[dept.id] = {
                                name: dept.name,
                                statusCounts: {
                                    draft: 0,
                                    pending: 0,
                                    approved: 0,
                                    rejected: 0,
                                    scheduled: 0,
                                    completed: 0
                                },
                                priorityCounts: {
                                    low: 0,
                                    medium: 0,
                                    high: 0
                                },
                                trainingTypeCounts: {}
                            };
                        });
                        
                        // Process all training requests to count by department and status/priority/type
                        if (snapshot.exists()) {
                            snapshot.forEach(child => {
                                const request = child.val();
                                const requestDate = moment(request.requestDate || request.createdAt || request.timestamp);
                                const requestDept = request.department || 'unknown';
                                const requestStatus = request.status || 'pending';
                                const requestPriority = request.priority || 'medium';
                                const trainingType = request.trainingType || 'unknown';
                                
                                // Apply date and status filters
                                if ((statusFilter === 'all' || requestStatus === statusFilter) && 
                                    requestDate >= startDate && requestDate <= endDate) {
                                    
                                    // If department doesn't exist in our data structure, add it
                                    if (!departmentsData[requestDept]) {
                                        departmentsData[requestDept] = {
                                            name: requestDept,
                                            statusCounts: {
                                                draft: 0,
                                                pending: 0,
                                                approved: 0,
                                                rejected: 0,
                                                scheduled: 0,
                                                completed: 0
                                            },
                                            priorityCounts: {
                                                low: 0,
                                                medium: 0,
                                                high: 0
                                            },
                                            trainingTypeCounts: {}
                                        };
                                    }
                                    
                                    // Count by status
                                    if (departmentsData[requestDept].statusCounts[requestStatus] !== undefined) {
                                        departmentsData[requestDept].statusCounts[requestStatus]++;
                                    }
                                    
                                    // Count by priority
                                    if (departmentsData[requestDept].priorityCounts[requestPriority] !== undefined) {
                                        departmentsData[requestDept].priorityCounts[requestPriority]++;
                                    }
                                    
                                    // Count by training type
                                    if (!departmentsData[requestDept].trainingTypeCounts[trainingType]) {
                                        departmentsData[requestDept].trainingTypeCounts[trainingType] = 0;
                                    }
                                    departmentsData[requestDept].trainingTypeCounts[trainingType]++;
                                }
                            });
                        }
                        
                        // Prepare departments for display based on filter
                        let displayDepartments;
                        
                        if (departmentFilter !== 'all') {
                            // Show only the selected department
                            displayDepartments = [departmentFilter];
                        } else {
                            // Show all departments, sorted alphabetically
                            displayDepartments = Object.keys(departmentsData).sort((a, b) => {
                                const nameA = departmentsData[a].name.toLowerCase();
                                const nameB = departmentsData[b].name.toLowerCase();
                                return nameA.localeCompare(nameB);
                            });
                        }
                        
                        // Create labels using department names, not IDs
                        const departmentLabels = displayDepartments.map(deptId => departmentsData[deptId].name);
                        
                        // Update chart based on view mode
                        if (viewMode === 'status') {
                            // Update for status view grouped by department
                            trainingRequestChart.options.plugins.title.text = 'Training Request Status Distribution by Department';
                            trainingRequestChart.options.scales.y.title.text = 'Department';
                            
                            trainingRequestChart.data.labels = departmentLabels;
                            trainingRequestChart.data.datasets = [
                                {
                                    label: 'Draft',
                                    data: displayDepartments.map(deptId => departmentsData[deptId]?.statusCounts.draft || 0),
                                    backgroundColor: 'rgba(149, 165, 166, 0.7)',
                                    borderColor: '#95a5a6',
                                    borderWidth: 1,
                                    stack: 'Stack 0'
                                },
                                {
                                    label: 'Pending',
                                    data: displayDepartments.map(deptId => departmentsData[deptId]?.statusCounts.pending || 0),
                                    backgroundColor: 'rgba(243, 156, 18, 0.7)',
                                    borderColor: '#f39c12',
                                    borderWidth: 1,
                                    stack: 'Stack 0'
                                },
                                {
                                    label: 'Approved',
                                    data: displayDepartments.map(deptId => departmentsData[deptId]?.statusCounts.approved || 0),
                                    backgroundColor: 'rgba(46, 204, 113, 0.7)',
                                    borderColor: '#2ecc71',
                                    borderWidth: 1,
                                    stack: 'Stack 0'
                                },
                                {
                                    label: 'Scheduled',
                                    data: displayDepartments.map(deptId => departmentsData[deptId]?.statusCounts.scheduled || 0),
                                    backgroundColor: 'rgba(155, 89, 182, 0.7)',
                                    borderColor: '#9b59b6',
                                    borderWidth: 1,
                                    stack: 'Stack 0'
                                },
                                {
                                    label: 'Completed',
                                    data: displayDepartments.map(deptId => departmentsData[deptId]?.statusCounts.completed || 0),
                                    backgroundColor: 'rgba(52, 152, 219, 0.7)',
                                    borderColor: '#3498db',
                                    borderWidth: 1,
                                    stack: 'Stack 0'
                                },
                                {
                                    label: 'Rejected',
                                    data: displayDepartments.map(deptId => departmentsData[deptId]?.statusCounts.rejected || 0),
                                    backgroundColor: 'rgba(231, 76, 60, 0.7)',
                                    borderColor: '#e74c3c',
                                    borderWidth: 1,
                                    stack: 'Stack 0'
                                }
                            ];
                        } else if (viewMode === 'priority') {
                            // Update for priority view grouped by department
                            trainingRequestChart.options.plugins.title.text = 'Training Request Priority Distribution by Department';
                            trainingRequestChart.options.scales.y.title.text = 'Department';
                            
                            trainingRequestChart.data.labels = departmentLabels;
                            trainingRequestChart.data.datasets = [
                                {
                                    label: 'Low Priority',
                                    data: displayDepartments.map(deptId => departmentsData[deptId]?.priorityCounts.low || 0),
                                    backgroundColor: 'rgba(46, 204, 113, 0.7)',
                                    borderColor: '#2ecc71',
                                    borderWidth: 1,
                                    stack: 'Stack 0'
                                },
                                {
                                    label: 'Medium Priority',
                                    data: displayDepartments.map(deptId => departmentsData[deptId]?.priorityCounts.medium || 0),
                                    backgroundColor: 'rgba(243, 156, 18, 0.7)',
                                    borderColor: '#f39c12',
                                    borderWidth: 1,
                                    stack: 'Stack 0'
                                },
                                {
                                    label: 'High Priority',
                                    data: displayDepartments.map(deptId => departmentsData[deptId]?.priorityCounts.high || 0),
                                    backgroundColor: 'rgba(231, 76, 60, 0.7)',
                                    borderColor: '#e74c3c',
                                    borderWidth: 1,
                                    stack: 'Stack 0'
                                }
                            ];
                        } else if (viewMode === 'type') {
                            // Update for training type view grouped by department
                            trainingRequestChart.options.plugins.title.text = 'Training Request Type Distribution by Department';
                            trainingRequestChart.options.scales.y.title.text = 'Department';
                            
                            // Get all unique training types across all departments
                            const allTrainingTypes = new Set();
                            displayDepartments.forEach(deptId => {
                                Object.keys(departmentsData[deptId].trainingTypeCounts).forEach(type => {
                                    allTrainingTypes.add(type);
                                });
                            });
                            
                            // Sort training types alphabetically
                            const trainingTypes = Array.from(allTrainingTypes).sort();
                            
                            // Create a dataset for each training type
                            const colorPalette = [
                                { bg: 'rgba(52, 152, 219, 0.7)', border: '#3498db' },  // Blue
                                { bg: 'rgba(46, 204, 113, 0.7)', border: '#2ecc71' },  // Green
                                { bg: 'rgba(243, 156, 18, 0.7)', border: '#f39c12' },  // Orange
                                { bg: 'rgba(155, 89, 182, 0.7)', border: '#9b59b6' },  // Purple
                                { bg: 'rgba(231, 76, 60, 0.7)', border: '#e74c3c' },   // Red
                                { bg: 'rgba(149, 165, 166, 0.7)', border: '#95a5a6' }, // Gray
                                { bg: 'rgba(26, 188, 156, 0.7)', border: '#1abc9c' },  // Turquoise
                                { bg: 'rgba(241, 196, 15, 0.7)', border: '#f1c40f' }   // Yellow
                            ];
                            
                            trainingRequestChart.data.labels = departmentLabels;
                            trainingRequestChart.data.datasets = trainingTypes.map((type, index) => {
                                const colorIndex = index % colorPalette.length;
                                const color = colorPalette[colorIndex];
                                
                                // Format the label to be more readable
                                let label = type;
                                if (type !== 'unknown' && type !== 'other') {
                                    // Convert kebab-case to Title Case (e.g., "first-aid" to "First Aid")
                                    label = type.split('-')
                                        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                                        .join(' ');
                                } else if (type === 'other') {
                                    label = 'Other';
                                } else {
                                    label = 'Unknown';
                                }
                                
                                return {
                                    label: label,
                                    data: displayDepartments.map(deptId => departmentsData[deptId]?.trainingTypeCounts[type] || 0),
                                    backgroundColor: color.bg,
                                    borderColor: color.border,
                                    borderWidth: 1,
                                    stack: 'Stack 0'
                                };
                            });
                        }
                        
                        // Update the chart
                        trainingRequestChart.update();
                    });
            }
            
            // Download chart functionality
            document.getElementById('downloadTrainingRequestChart').addEventListener('click', function() {
                const canvas = document.getElementById('trainingRequestChart');
                if (canvas) {
                    const viewMode = document.getElementById('trainingReqViewMode').value;
                    const filename = viewMode === 'status' ? 'training-request-status-chart.png' : 'training-request-priority-chart.png';
                    
                    const image = canvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.download = filename;
                    link.href = image;
                    link.click();
                }
            });
        }

        // Add Permit chart visualization function
        function setupPermitChart() {
            const permitCtx = document.getElementById('permitChart').getContext('2d');
            
            // Initialize the permit chart
            const permitChart = new Chart(permitCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',  // Horizontal bars
                    scales: {
                        x: {
                            beginAtZero: true,
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Number of Permits'
                            },
                            ticks: {
                                precision: 0
                            }
                        },
                        y: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Permit Status/Type'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Permit Status Distribution',
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            display: true,
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.x + ' permits';
                                }
                            }
                        }
                    }
                }
            });
            
            // Load department data for filter dropdown
            loadDepartmentsForPermits();
            
            // Set up event listeners for filters
            document.getElementById('permitViewMode').addEventListener('change', updatePermitChart);
            document.getElementById('permitDepartmentFilter').addEventListener('change', updatePermitChart);
            document.getElementById('permitStatusFilter').addEventListener('change', updatePermitChart);
            document.getElementById('permitDateRangeFilter').addEventListener('change', function(e) {
                const selectedValue = e.target.value;
                const customDateRange = document.getElementById('permitCustomDateRange');

                if (selectedValue === 'custom') {
                    customDateRange.style.display = 'flex';
                    // Set default dates for custom range
                    const endDate = moment().format('YYYY-MM-DD');
                    const startDate = moment().subtract(30, 'days').format('YYYY-MM-DD');
                    document.getElementById('permitCustomStartDate').value = startDate;
                    document.getElementById('permitCustomEndDate').value = endDate;
                } else {
                    customDateRange.style.display = 'none';
                    updatePermitChart();
                }
            });
            document.getElementById('applyPermitCustomRange').addEventListener('click', updatePermitChart);
            
            // Load departments for Permit filter
            function loadDepartmentsForPermits() {
                const departmentSelect = document.getElementById('permitDepartmentFilter');
                
                // Get all departments from Firebase
                database.ref('departments').once('value')
                    .then(snapshot => {
                        if (snapshot.exists()) {
                            snapshot.forEach(deptSnapshot => {
                                const dept = deptSnapshot.val();
                                const deptName = dept.name || deptSnapshot.key;
                                
                                // Add to dropdown
                                const option = document.createElement('option');
                                option.value = deptSnapshot.key;
                                option.textContent = deptName;
                                departmentSelect.appendChild(option);
                            });
                        } else {
                            // Add default departments if none exist
                            const defaultDepts = ['Operations', 'Warehouse', 'Manufacturing', 'Logistics', 'Maintenance', 'Admin', 'HR', 'IT'];
                            defaultDepts.forEach(dept => {
                                const option = document.createElement('option');
                                option.value = dept.toLowerCase();
                                option.textContent = dept;
                                departmentSelect.appendChild(option);
                            });
                        }
                        
                        // After loading departments, update the chart
                        updatePermitChart();
                    });
            }
            
            // Update Permit chart based on filters
            function updatePermitChart() {
                const viewMode = document.getElementById('permitViewMode').value;
                const departmentFilter = document.getElementById('permitDepartmentFilter').value;
                const statusFilter = document.getElementById('permitStatusFilter').value;
                const dateRangeFilter = document.getElementById('permitDateRangeFilter').value;
                const customStartDate = document.getElementById('permitCustomStartDate').value;
                const customEndDate = document.getElementById('permitCustomEndDate').value;
                
                // Status filter should be disabled when viewing by status
                const statusFilterEl = document.getElementById('permitStatusFilter');
                statusFilterEl.disabled = viewMode === 'status';
                if (viewMode === 'status') {
                    statusFilterEl.value = 'all';
                }
                
                // Calculate date range
                let startDate, endDate;
                if (dateRangeFilter === 'custom' && customStartDate && customEndDate) {
                    startDate = moment(customStartDate);
                    endDate = moment(customEndDate);
                } else if (dateRangeFilter === 'all') {
                    startDate = moment(0);
                    endDate = moment();
                } else {
                    endDate = moment();
                    startDate = moment().subtract(parseInt(dateRangeFilter), 'days');
                }
                
                // Get Permit data from Firebase
                database.ref('permits').once('value')
                    .then(snapshot => {
                        // Initialize data structures to hold permit counts
                        const statusData = {
                            pending: 0,
                            approved: 0,
                            rejected: 0,
                            expired: 0
                        };
                        
                        const typeData = {
                            'hot-work': 0,
                            'cold-work': 0,
                            'electrical': 0,
                            'confined-space': 0,
                            'height': 0,
                            'excavation': 0,
                            'other': 0
                        };
                        
                        // Process permits data
                        if (snapshot.exists()) {
                            snapshot.forEach(child => {
                                const permit = child.val();
                                const permitDate = moment(permit.createdAt || permit.timestamp || permit.validFrom);
                                const permitDept = permit.department || 'unknown';
                                const permitStatus = permit.status || 'pending';
                                const permitType = permit.permitType || 'other';
                                
                                // Apply filters
                                if ((statusFilter === 'all' || permitStatus === statusFilter) &&
                                    (departmentFilter === 'all' || permitDept === departmentFilter) &&
                                    permitDate >= startDate && permitDate <= endDate) {
                                    
                                    // Count by status
                                    if (statusData[permitStatus] !== undefined) {
                                        statusData[permitStatus]++;
                                    }
                                    
                                    // Count by permit type
                                    if (typeData[permitType] !== undefined) {
                                        typeData[permitType]++;
                                    } else {
                                        typeData['other']++;
                                    }
                                }
                            });
                        }
                        
                        // Update chart based on view mode
                        if (viewMode === 'status') {
                            // Format data for status view
                            permitChart.options.plugins.title.text = 'Permit Status Distribution';
                            
                            // Define the statuses to display
                            const statuses = ['pending', 'approved', 'rejected', 'expired'];
                            
                            // Create human-readable labels
                            const statusLabels = statuses.map(status => {
                                return status.charAt(0).toUpperCase() + status.slice(1);
                            });
                            
                            // Update chart data
                            permitChart.data.labels = statusLabels;
                            permitChart.data.datasets = [{
                                label: 'Permits',
                                data: statuses.map(status => statusData[status]),
                                backgroundColor: [
                                    'rgba(255, 193, 7, 0.7)',  // Pending - yellow
                                    'rgba(46, 204, 113, 0.7)', // Approved - green
                                    'rgba(231, 76, 60, 0.7)',  // Rejected - red
                                    'rgba(149, 165, 166, 0.7)' // Expired - gray
                                ],
                                borderColor: [
                                    '#ffc107', // Pending
                                    '#2ecc71', // Approved
                                    '#e74c3c', // Rejected
                                    '#95a5a6'  // Expired
                                ],
                                borderWidth: 1
                            }];
                        } else {
                            // Format data for type view
                            permitChart.options.plugins.title.text = 'Permit Type Distribution';
                            
                            // Define the permit types to display
                            const types = ['hot-work', 'cold-work', 'electrical', 'confined-space', 'height', 'excavation', 'other'];
                            
                            // Create human-readable labels for the types
                            const typeLabels = types.map(type => {
                                return type.split('-')
                                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                                    .join(' ') + ' Permit';
                            });
                            
                            // Update chart data
                            permitChart.data.labels = typeLabels;
                            permitChart.data.datasets = [{
                                label: 'Permits',
                                data: types.map(type => typeData[type]),
                                backgroundColor: [
                                    'rgba(231, 76, 60, 0.7)',   // Hot-work - red
                                    'rgba(52, 152, 219, 0.7)',  // Cold-work - blue
                                    'rgba(241, 196, 15, 0.7)',  // Electrical - yellow
                                    'rgba(155, 89, 182, 0.7)',  // Confined-space - purple
                                    'rgba(46, 204, 113, 0.7)',  // Height - green
                                    'rgba(211, 84, 0, 0.7)',    // Excavation - orange
                                    'rgba(149, 165, 166, 0.7)'  // Other - gray
                                ],
                                borderColor: [
                                    '#e74c3c', // Hot-work
                                    '#3498db', // Cold-work
                                    '#f1c40f', // Electrical
                                    '#9b59b6', // Confined-space
                                    '#2ecc71', // Height
                                    '#d35400', // Excavation
                                    '#95a5a6'  // Other
                                ],
                                borderWidth: 1
                            }];
                        }
                        
                        // Update the chart
                        permitChart.update();
                    });
            }
            
            // Download chart functionality
            document.getElementById('downloadPermitChart').addEventListener('click', function() {
                const canvas = document.getElementById('permitChart');
                if (canvas) {
                    const viewMode = document.getElementById('permitViewMode').value;
                    const filename = viewMode === 'status' ? 'permit-status-chart.png' : 'permit-type-chart.png';
                    
                    const image = canvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.download = filename;
                    link.href = image;
                    link.click();
                }
            });
        }
    </script>
</body>
</html>