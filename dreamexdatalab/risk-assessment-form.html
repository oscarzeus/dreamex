<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSE System - Risk Assessment Form</title>
    <link rel="stylesheet" href="css/styles.css">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }
        
        .risk-container {
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
            margin-top: 60px; /* Increased margin-top from 90px to 120px to move content further down */
        }
        
        .risk-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .risk-title h2 {
            margin-bottom: 5px;
        }
        
        .risk-title p {
            color: #666;
            margin-top: 0;
        }
        
        .form-section {
            background-color: #fff;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .form-section h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--primary-color);
            font-size: 18px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .form-group {
            flex: 1 1 300px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
        }
        
        textarea.form-control {
            min-height: 60px;
            resize: vertical;
        }
        
        select.form-control {
            cursor: pointer;
        }
        
        input[readonly], input:disabled, select:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }
        
        #fileList {
            margin-top: 10px;
        }
        
        #fileList li {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            padding: 8px 12px;
            margin-bottom: 5px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #fileList .file-name {
            flex: 1;
        }
        
        #fileList .file-actions {
            display: flex;
            gap: 5px;
        }
        
        #fileList .file-actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-color);
            padding: 2px 5px;
        }
        
        #fileList .file-actions button:hover {
            color: var(--primary-color);
        }
        
        #fileList .file-actions .delete-file {
            color: #dc3545;
        }
        
        #fileList .file-actions .delete-file:hover {
            color: #bd2130;
        }
        
        #uploadStatus {
            margin-top: 5px;
            font-size: 14px;
        }
        
        /* Risk level colors */
        .risk-low {
            color: #155724;
            background-color: #d4edda;
        }
        
        .risk-medium {
            color: #856404;
            background-color: #fff3cd;
        }
        
        .risk-high {
            color: #721c24;
            background-color: #f8d7da;
        }
        
        .risk-extreme {
            color: white;
            background-color: #dc3545;
        }
        
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .form-group {
                flex: 1 1 100%;
            }
            
            .risk-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
        }

        /* File attachment styles */
        .file-attachment-section {
            margin-bottom: 15px;
        }
        
        .file-input-container {
            position: relative;
            margin-bottom: 10px;
        }
        
        .file-input-container input[type="file"] {
            opacity: 0;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            z-index: 2;
        }
        
        .file-input-trigger {
            display: inline-flex;
            align-items: center;
            padding: 10px 15px;
            background-color: #f0f0f0;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
        }
        
        .file-input-trigger i {
            margin-right: 8px;
        }
        
        .file-list {
            list-style: none;
            padding: 0;
            margin: 15px 0;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            margin-bottom: 8px;
            background-color: #f9f9f9;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }
        
        .file-info {
            display: flex;
            align-items: center;
            flex: 1;
        }
        
        .file-icon {
            font-size: 1.2rem;
            margin-right: 10px;
            color: var(--primary-color);
        }
        
        .file-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 10px;
        }
        
        .file-size {
            color: #666;
            font-size: 0.85rem;
            margin-right: 15px;
        }
        
        .file-actions {
            display: flex;
            align-items: center;
        }
        
        .file-actions button {
            background: none;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
            padding: 4px 8px;
            font-size: 0.9rem;
        }
        
        .file-actions a {
            color: var(--secondary-color);
            text-decoration: none;
            margin-right: 10px;
            padding: 4px 8px;
            font-size: 0.9rem;
        }
        
        .file-actions a:hover,
        .file-actions button:hover {
            text-decoration: underline;
        }
        
        .upload-progress {
            height: 4px;
            width: 100%;
            background-color: #f0f0f0;
            margin-top: 5px;
            display: none;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: var(--secondary-color);
            transition: width 0.3s;
        }
        
        /* Max file size message */
        .max-file-size {
            font-size: 0.8rem;
            color: #666;
            margin-left: 5px;
        }

        /* Add these styles for the control items */
        .control-items-container {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px;
            max-height: 250px;
            overflow-y: auto;
            background-color: #f9f9f9;
        }
        
        .control-item {
            display: flex;
            margin-bottom: 8px;
            align-items: center;
            background-color: white;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }
        
        .control-item:last-child {
            margin-bottom: 0;
        }
        
        .control-item input {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }
        
        .control-item .delete-control-btn {
            margin-left: 8px;
            background-color: #f8d7da;
            color: #721c24;
            border: none;
            border-radius: 4px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .control-item .delete-control-btn:hover {
            background-color: #f5c6cb;
        }
        
        .no-controls-message {
            font-style: italic;
            color: #6c757d;
            padding: 10px;
            text-align: center;
        }

        /* Add these styles for the control item numbers */
        .control-item {
            display: flex;
            margin-bottom: 8px;
            align-items: center;
            background-color: white;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }
        
        .control-number {
            min-width: 24px;
            height: 24px;
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            flex-shrink: 0;
        }
        
        .control-item input {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        /* Add specific height for hazard textarea */
        #hazard {
            height: 38px; /* This matches the standard height of input fields */
            min-height: auto; /* Override the general textarea min-height */
            resize: none; /* Prevent resizing since we want it fixed */
        }
    </style>
</head>
<body>
    <!-- Header Placeholder - will be replaced by the header component -->
    <div id="header-placeholder"></div>

    <main class="risk-container">
        <div class="risk-header">
            <div class="risk-title">
                <h2>Risk Assessment</h2>
                <p>Create and submit a new risk assessment</p>
            </div>
            <a href="riskboard.html" class="btn btn-primary">View All Risks</a>
        </div>
        <form id="riskForm">
            <!-- Basic Information Section -->
            <div class="form-section">
                <h3>Basic Information</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="riskID">Risk ID</label>
                        <input type="text" id="riskID" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label for="hazard">Hazard *</label>
                        <textarea id="hazard" class="form-control" required placeholder="Describe the hazard in detail..."></textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="hazardType">Hazard Type *</label>
                        <select id="hazardType" class="form-control" required>
                            <option value="">Select hazard type</option>
                            <!-- Hazard types will be populated from Firebase -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="riskTitle">Risk Title *</label>
                        <input type="text" id="riskTitle" class="form-control" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="riskCategory">Risk Category *</label>
                        <select id="riskCategory" class="form-control" required>
                            <option value="">Select a category</option>
                            <!-- Risk categories will be populated from Firebase -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="department">Department *</label>
                        <select id="department" class="form-control" required>
                            <option value="">Select a department</option>
                            <!-- Department options will be populated from Firebase -->
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="location">Location *</label>
                        <select id="location" class="form-control" required>
                            <option value="">Select a location</option>
                            <!-- Location options will be populated from Firebase -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="dateIdentified">Date Identified *</label>
                        <input type="date" id="dateIdentified" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="riskStatus">Status *</label>
                        <select id="riskStatus" class="form-control" required>
                            <option value="">Select a status</option>
                            <!-- Status options will be populated from Firebase -->
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="riskDescription">Risk Description *</label>
                        <textarea id="riskDescription" class="form-control" required></textarea>
                    </div>
                </div>
            </div>
            <!-- Inherent Risk Assessment Section -->
            <div class="form-section">
                <h3>Inherent Risk Assessment (Before Controls)</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="inherentLikelihood">Inherent Likelihood *</label>
                        <select id="inherentLikelihood" class="form-control" required>
                            <option value="">Select likelihood</option>
                            <!-- Likelihood options will be populated from Firebase -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="inherentConsequence">Inherent Impact *</label>
                        <select id="inherentConsequence" class="form-control" required>
                            <option value="">Select impact</option>
                            <!-- Impact options will be populated from Firebase -->
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="inherentRiskRating">Inherent Risk Rating</label>
                        <input type="text" id="inherentRiskRating" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label for="inherentRiskLevel">Inherent Risk Level</label>
                        <input type="text" id="inherentRiskLevel" class="form-control" readonly>
                    </div>
                </div>
            </div>
            <!-- Controls and Mitigation Section -->
            <div class="form-section">
                <h3>Controls and Mitigation</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="strategy">Risk Strategy *</label>
                        <select id="strategy" class="form-control" required>
                            <option value="">Select strategy</option>
                            <!-- Risk strategy options will be populated from Firebase -->
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="existingControls">
                            Existing Controls
                            <button type="button" id="addControlBtn" class="btn btn-sm btn-primary">
                                <i class="fas fa-plus"></i> Add Control
                            </button>
                        </label>
                        <div id="existingControlsList" class="control-items-container">
                            <!-- Control items will be added here dynamically -->
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="mitigationActions">
                            Proposed Mitigation Actions *
                            <button type="button" id="addMitigationBtn" class="btn btn-sm btn-primary">
                                <i class="fas fa-plus"></i> Add Mitigation
                            </button>
                        </label>
                        <div id="mitigationActionsList" class="control-items-container">
                            <!-- Mitigation items will be added here dynamically -->
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="responsiblePerson">Responsible Person (Full Name) *</label>
                        <select id="responsiblePerson" class="form-control" required>
                            <option value="">Select a person</option>
                            <!-- User options will be populated from Firebase -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="lineManager">Line Manager (Full Name)</label>
                        <input type="text" id="lineManager" class="form-control" placeholder="Auto-populated from responsible person" readonly>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="targetDate">Target Completion Date *</label>
                        <input type="date" id="targetDate" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="currentUserName">Created By</label>
                        <input type="text" id="currentUserName" class="form-control" readonly>
                        <input type="hidden" id="currentUserId" name="createdById">
                    </div>
                </div>
            </div>
            <!-- Residual Risk Assessment Section -->
            <div class="form-section">
                <h3>Residual Risk Assessment (After Controls)</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="residualLikelihood">Residual Likelihood *</label>
                        <select id="residualLikelihood" class="form-control" required>
                            <option value="">Select likelihood</option>
                            <!-- Likelihood options will be populated from Firebase -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="residualConsequence">Residual Impact *</label>
                        <select id="residualConsequence" class="form-control" required>
                            <option value="">Select impact</option>
                            <!-- Impact options will be populated from Firebase -->
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="residualRiskRating">Residual Risk Rating</label>
                        <input type="text" id="residualRiskRating" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label for="residualRiskLevel">Residual Risk Level</label>
                        <input type="text" id="residualRiskLevel" class="form-control" readonly>
                    </div>
                </div>
            </div>
            <!-- Additional Information Section -->
            <div class="form-section">
                <h3>Additional Information</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="additionalNotes">Additional Notes</label>
                        <textarea id="additionalNotes" class="form-control"></textarea>
                    </div>
                </div>
            </div>

            <!-- File Upload Section -->
            <div class="form-section">
                <h3>Attachments</h3>
                <p>Attach relevant documents, images, or files (diagrams, procedures, safety data sheets, etc.)</p>
                
                <div class="file-attachment-section">
                    <div class="file-input-container">
                        <div class="file-input-trigger">
                            <i class="fas fa-upload"></i>
                            Select Files
                        </div>
                        <input type="file" id="fileUpload" multiple>
                        <span class="max-file-size">Max file size: 5MB</span>
                    </div>
                    
                    <div class="upload-progress">
                        <div class="progress-bar"></div>
                    </div>
                    
                    <ul id="fileList" class="file-list">
                        <!-- File items will be added here -->
                    </ul>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button type="button" id="resetBtn" class="btn btn-secondary">Reset Form</button>
                <button type="submit" id="submitBtn" class="btn btn-primary">Submit Risk</button>
            </div>
        </form>
    </main>

    <footer>
        <p>&copy; 2025 HSE Online System. All rights reserved.</p>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="js/header-loader.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.firebasestorage.app",
            messagingSenderId: "829083030831",
            appId: "1:829083030831:web:36a370e62691e560bc3dda"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();
        const auth = firebase.auth();
        
        // Add Firebase helper module
        const firebaseHelper = {
            async ensureAuthenticated() {
                if (!auth.currentUser) {
                    // If no user is signed in, sign in anonymously
                    try {
                        await auth.signInAnonymously();
                    } catch (error) {
                        console.error("Error signing in anonymously:", error);
                        throw error;
                    }
                }
                return auth.currentUser;
            },

            async getFileDownloadURL(filePath) {
                try {
                    const url = await storage.ref(filePath).getDownloadURL();
                    return url;
                } catch (error) {
                    console.error("Error getting download URL:", error);
                    throw error;
                }
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            // Form elements
            const riskForm = document.getElementById('riskForm');
            const resetBtn = document.getElementById('resetBtn');
            const submitBtn = document.getElementById('submitBtn');
            
            // Select elements that need to be populated from Firebase
            const riskCategorySelect = document.getElementById('riskCategory');
            const departmentSelect = document.getElementById('department');
            const locationSelect = document.getElementById('location');
            const riskStatusSelect = document.getElementById('riskStatus');
            const inherentLikelihoodSelect = document.getElementById('inherentLikelihood');
            const inherentConsequenceSelect = document.getElementById('inherentConsequence');
            const strategySelect = document.getElementById('strategy');
            const responsiblePersonSelect = document.getElementById('responsiblePerson');
            const residualLikelihoodSelect = document.getElementById('residualLikelihood');
            const residualConsequenceSelect = document.getElementById('residualConsequence');
            const hazardTypeSelect = document.getElementById('hazardType');
            
            // Risk calculation elements
            const inherentRiskRating = document.getElementById('inherentRiskRating');
            const inherentRiskLevel = document.getElementById('inherentRiskLevel');
            const residualRiskRating = document.getElementById('residualRiskRating');
            const residualRiskLevel = document.getElementById('residualRiskLevel');
            
            // File upload elements
            const fileUpload = document.getElementById('fileUpload');
            const uploadStatus = document.getElementById('uploadStatus');
            const fileList = document.getElementById('fileList');
            const uploadProgress = document.querySelector('.upload-progress');
            const progressBar = document.querySelector('.progress-bar');
            
            // Store attached files
            let attachedFiles = [];
            
            // Current user
            const currentUserName = document.getElementById('currentUserName');
            const currentUserId = document.getElementById('currentUserId');
            
            // Get risk ID from URL if editing existing risk
            const urlParams = new URLSearchParams(window.location.search);
            const riskId = urlParams.get('id');
            
            // Generate risk ID
            const riskIDInput = document.getElementById('riskID');
            const dateIdentifiedInput = document.getElementById('dateIdentified');
            
            // Set default date to today
            const today = new Date();
            const formattedDate = today.toISOString().substr(0, 10);
            dateIdentifiedInput.value = formattedDate;
            
            // Generate a risk ID
            function generateRiskID() {
                const prefix = 'RISK';
                const timestamp = Date.now().toString().substr(-6);
                const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                return `${prefix}-${timestamp}-${random}`;
            }
            
            // Set the generated risk ID (if not editing existing risk)
            if (!riskId) {
                riskIDInput.value = generateRiskID();
            }
            
            // Check for current user
            auth.onAuthStateChanged(function(user) {
                if (user) {
                    // User is signed in
                    database.ref('users/' + user.uid).once('value')
                        .then(snapshot => {
                            const userData = snapshot.val();
                            if (userData) {
                                currentUserName.value = userData.name || user.email;
                                currentUserId.value = user.uid;
                            } else {
                                currentUserName.value = user.email;
                                currentUserId.value = user.uid;
                            }
                        });
                } else {
                    // No user signed in, redirect to login
                    window.location.href = 'login.html';
                }
            });
            
            // Load Risk Categories
            database.ref('fieldOptions/risk-category').once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        snapshot.forEach(categorySnapshot => {
                            const category = categorySnapshot.val();
                            // Only add enabled categories
                            if (category.enabled !== false) {
                                const option = document.createElement('option');
                                option.value = category.value || categorySnapshot.key;
                                option.textContent = category.label;
                                riskCategorySelect.appendChild(option);
                            }
                        });
                    } else {
                        // Add default categories if none exist - these should match settings.html defaults
                        const defaultCategories = [
                            { label: 'Strategic Risks', value: 'strategic-risks' },
                            { label: 'Operational Risks', value: 'operational-risks' },
                            { label: 'Financial Risks', value: 'financial-risks' },
                            { label: 'Compliance & Legal Risks', value: 'compliance-legal-risks' },
                            { label: 'Health, Safety & Environmental (HSE) Risks', value: 'hse-risks' },
                            { label: 'Reputational Risks', value: 'reputational-risks' },
                            { label: 'Technological Risks', value: 'technological-risks' },
                            { label: 'Project Risks', value: 'project-risks' },
                            { label: 'Natural & External Risks', value: 'natural-external-risks' },
                            { label: 'Human Resource Risks', value: 'human-resource-risks' }
                        ];
                        
                        defaultCategories.forEach(category => {
                            const option = document.createElement('option');
                            option.value = category.value;
                            option.textContent = category.label;
                            riskCategorySelect.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error("Error loading risk categories:", error);
                });
                
            // Load Departments - Updated to match user management page
            database.ref('departments').once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        snapshot.forEach(deptSnapshot => {
                            const dept = deptSnapshot.val();
                            const option = document.createElement('option');
                            option.value = deptSnapshot.key;
                            option.textContent = dept.name;
                            departmentSelect.appendChild(option);
                        });
                    } else {
                        // If no departments exist, show placeholder
                        const option = document.createElement('option');
                        option.value = "";
                        option.textContent = "No departments available";
                        option.disabled = true;
                        departmentSelect.appendChild(option);
                    }
                })
                .catch(error => {
                    console.error("Error loading departments:", error);
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "Error loading departments";
                    option.disabled = true;
                    departmentSelect.appendChild(option);
                });
                
            // Load Locations
            database.ref('locations').once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        snapshot.forEach(locSnapshot => {
                            const loc = locSnapshot.val();
                            const option = document.createElement('option');
                            option.value = locSnapshot.key;
                            option.textContent = loc.name;
                            locationSelect.appendChild(option);
                        });
                    } else {
                        // Add default locations if none exist
                        const defaultLocs = ['Main Building', 'Warehouse', 'Production Floor', 'Office Area', 'Loading Dock', 'Laboratory', 'Outdoor Yard'];
                        defaultLocs.forEach(loc => {
                            const option = document.createElement('option');
                            option.value = loc.toLowerCase().replace(/\s+/g, '-');
                            option.textContent = loc;
                            locationSelect.appendChild(option);
                        });
                    }
                });
                
            // Load Risk Status options
            const statusOptions = ['Not started', 'Ongoing', 'Completed'];
            statusOptions.forEach(status => {
                const option = document.createElement('option');
                option.value = status.toLowerCase().replace(/\s+/g, '-');
                option.textContent = status;
                riskStatusSelect.appendChild(option);
            });
            
            // Load Likelihood options (1-5)
            const likelihoodOptions = [
                { value: 1, text: '1 - Rare' },
                { value: 2, text: '2 - Unlikely' },
                { value: 3, text: '3 - Possible' },
                { value: 4, text: '4 - Likely' },
                { value: 5, text: '5 - Almost Certain' }
            ];
            
            likelihoodOptions.forEach(option => {
                // For Inherent Likelihood
                const inherentOption = document.createElement('option');
                inherentOption.value = option.value;
                inherentOption.textContent = option.text;
                inherentLikelihoodSelect.appendChild(inherentOption);
                
                // For Residual Likelihood
                const residualOption = document.createElement('option');
                residualOption.value = option.value;
                residualOption.textContent = option.text;
                residualLikelihoodSelect.appendChild(residualOption);
            });
            
            // Load Consequence/Impact options (1-5)
            const consequenceOptions = [
                { value: 1, text: '1 - Negligible' },
                { value: 2, text: '2 - Minor' },
                { value: 3, text: '3 - Moderate' },
                { value: 4, text: '4 - Major' },
                { value: 5, text: '5 - Catastrophic' }
            ];
            
            consequenceOptions.forEach(option => {
                // For Inherent Consequence
                const inherentOption = document.createElement('option');
                inherentOption.value = option.value;
                inherentOption.textContent = option.text;
                inherentConsequenceSelect.appendChild(inherentOption);
                
                // For Residual Consequence
                const residualOption = document.createElement('option');
                residualOption.value = option.value;
                residualOption.textContent = option.text;
                residualConsequenceSelect.appendChild(residualOption);
            });
            
            // Load Risk Strategy options
            database.ref('fieldOptions/risk-strategy').once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        snapshot.forEach(strategySnapshot => {
                            const strategy = strategySnapshot.val();
                            // Only add enabled strategies
                            if (strategy.enabled !== false) {
                                const option = document.createElement('option');
                                option.value = strategy.value || strategySnapshot.key;
                                option.textContent = strategy.label;
                                strategySelect.appendChild(option);
                            }
                        });
                    } else {
                        // Add default strategies if none exist
                        const strategyOptions = ['Avoid', 'Mitigate', 'Transfer', 'Accept'];
                        strategyOptions.forEach(strategy => {
                            const option = document.createElement('option');
                            option.value = strategy.toLowerCase();
                            option.textContent = strategy;
                            strategySelect.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error("Error loading risk strategies:", error);
                    
                    // Fallback to default options if there's an error
                    const strategyOptions = ['Avoid', 'Mitigate', 'Transfer', 'Accept'];
                    strategyOptions.forEach(strategy => {
                        const option = document.createElement('option');
                        option.value = strategy.toLowerCase();
                        option.textContent = strategy;
                        strategySelect.appendChild(option);
                    });
                });
            
            // Load users for responsible person
            database.ref('users').once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        snapshot.forEach(userSnapshot => {
                            const user = userSnapshot.val();
                            const option = document.createElement('option');
                            option.value = userSnapshot.key;
                            
                            // Display only the full name without role or other information
                            let fullName = '';
                            if (user.firstName && user.lastName) {
                                fullName = `${user.firstName} ${user.lastName}`;
                            } else if (user.name) {
                                fullName = user.name;
                            } else if (user.fullName) {
                                fullName = user.fullName;
                            } else if (user.displayName) {
                                fullName = user.displayName;
                            } else if (user.username) {
                                fullName = user.username;
                            } else if (user.email) {
                                fullName = user.email.split('@')[0]; // Remove domain part
                            } else {
                                fullName = `User ${userSnapshot.key}`;
                            }
                            
                            option.textContent = fullName;
                            responsiblePersonSelect.appendChild(option);
                        });
                    } else {
                        // If no users exist, add a placeholder option
                        const option = document.createElement('option');
                        option.value = "";
                        option.textContent = "No users available";
                        option.disabled = true;
                        responsiblePersonSelect.appendChild(option);
                    }
                })
                .catch(error => {
                    console.error("Error loading users:", error);
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "Error loading users";
                    option.disabled = true;
                    responsiblePersonSelect.appendChild(option);
                });
            
            // Auto-populate line manager when responsible person is selected
            responsiblePersonSelect.addEventListener('change', function() {
                const selectedUserId = this.value;
                const lineManagerInput = document.getElementById('lineManager');
                
                // Clear the current line manager value
                lineManagerInput.value = '';
                
                if (selectedUserId) {
                    // Show loading indicator
                    lineManagerInput.placeholder = "Loading line manager...";
                    
                    // Fetch the selected user's data
                    database.ref('users/' + selectedUserId).once('value')
                        .then(snapshot => {
                            if (snapshot.exists()) {
                                const userData = snapshot.val();
                                
                                // Check if user has a line manager assigned
                                if (userData.lineManager) {
                                    // Fetch the line manager's details
                                    database.ref('users/' + userData.lineManager).once('value')
                                        .then(managerSnapshot => {
                                            if (managerSnapshot.exists()) {
                                                const managerData = managerSnapshot.val();
                                                
                                                // Get line manager's full name
                                                let managerName = '';
                                                if (managerData.firstName && managerData.lastName) {
                                                    managerName = `${managerData.firstName} ${managerData.lastName}`;
                                                } else if (managerData.name) {
                                                    managerName = managerData.name;
                                                } else if (managerData.fullName) {
                                                    managerName = managerData.fullName;
                                                } else if (managerData.displayName) {
                                                    managerName = managerData.displayName;
                                                } else {
                                                    managerName = managerData.email || `Unknown Manager`;
                                                }
                                                
                                                // Set the line manager input value
                                                lineManagerInput.value = managerName;
                                            }
                                            // Reset placeholder whether manager is found or not
                                            lineManagerInput.placeholder = "Auto-populated from responsible person";
                                        })
                                        .catch(error => {
                                            console.error("Error fetching line manager:", error);
                                            lineManagerInput.placeholder = "No line manager found";
                                        });
                                } else {
                                    // No line manager assigned
                                    lineManagerInput.placeholder = "No line manager assigned";
                                }
                            } else {
                                lineManagerInput.placeholder = "User not found";
                            }
                        })
                        .catch(error => {
                            console.error("Error fetching user data:", error);
                            lineManagerInput.placeholder = "Error loading line manager";
                        });
                } else {
                    // No user selected
                    lineManagerInput.placeholder = "Auto-populated from responsible person";
                }
            });
            
            // Risk matrix calculation
            function calculateRiskRating(likelihood, consequence) {
                return likelihood * consequence;
            }
            
            // Determine risk level based on rating
            function determineRiskLevel(rating) {
                if (rating >= 15) return 'extreme';
                if (rating >= 8) return 'high';
                if (rating >= 4) return 'medium';
                return 'low';
            }
            
            // Format risk level text
            function formatRiskLevel(level) {
                return level.charAt(0).toUpperCase() + level.slice(1);
            }
            
            // Update inherent risk rating and level
            function updateInherentRisk() {
                const likelihood = parseInt(inherentLikelihoodSelect.value) || 0;
                const consequence = parseInt(inherentConsequenceSelect.value) || 0;
                
                if (likelihood > 0 && consequence > 0) {
                    const rating = calculateRiskRating(likelihood, consequence);
                    const level = determineRiskLevel(rating);
                    
                    inherentRiskRating.value = rating;
                    inherentRiskLevel.value = formatRiskLevel(level);
                    inherentRiskLevel.className = 'form-control risk-' + level;
                } else {
                    inherentRiskRating.value = '';
                    inherentRiskLevel.value = '';
                    inherentRiskLevel.className = 'form-control';
                }
            }
            
            // Update residual risk rating and level
            function updateResidualRisk() {
                const likelihood = parseInt(residualLikelihoodSelect.value) || 0;
                const consequence = parseInt(residualConsequenceSelect.value) || 0;
                
                if (likelihood > 0 && consequence > 0) {
                    const rating = calculateRiskRating(likelihood, consequence);
                    const level = determineRiskLevel(rating);
                    
                    residualRiskRating.value = rating;
                    residualRiskLevel.value = formatRiskLevel(level);
                    residualRiskLevel.className = 'form-control risk-' + level;
                } else {
                    residualRiskRating.value = '';
                    residualRiskLevel.value = '';
                    residualRiskLevel.className = 'form-control';
                }
            }
            
            // Event listeners for risk calculations
            inherentLikelihoodSelect.addEventListener('change', updateInherentRisk);
            inherentConsequenceSelect.addEventListener('change', updateInherentRisk);
            residualLikelihoodSelect.addEventListener('change', updateResidualRisk);
            residualConsequenceSelect.addEventListener('change', updateResidualRisk);
            
            // File upload handling
            const uploadedFiles = [];
            
            // File input change handler
            fileUpload.addEventListener('change', function(e) {
                const files = e.target.files;
                if (!files.length) return;
                
                // Process each selected file
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    
                    // Check file size (max 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        alert(`File ${file.name} is too large. Maximum file size is 5MB.`);
                        continue;
                    }
                    
                    uploadFileWithAuth(file);
                }
                
                // Reset file input
                fileUpload.value = '';
            });
            
            // Upload file with authentication
            async function uploadFileWithAuth(file) {
                // Show progress bar
                uploadProgress.style.display = 'block';
                progressBar.style.width = '0%';
                
                try {
                    // Ensure user is authenticated first
                    await firebaseHelper.ensureAuthenticated();
                    
                    // Create storage reference
                    const fileRef = storage.ref().child(`risk-attachments/${Date.now()}-${file.name}`);
                    
                    // Upload file
                    const uploadTask = fileRef.put(file, {
                        customMetadata: {
                            'uploadedBy': auth.currentUser ? auth.currentUser.uid : 'anonymous',
                            'uploadDate': new Date().toISOString(),
                            'publicReadable': 'true'
                        }
                    });
                    
                    uploadTask.on('state_changed',
                        (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            progressBar.style.width = progress + '%';
                        },
                        (error) => {
                            console.error("Upload failed:", error);
                            uploadProgress.style.display = 'none';
                            
                            // Improved error handling with more specific messages
                            let errorMessage = "Upload failed: ";
                            switch(error.code) {
                                case 'storage/unauthorized':
                                    errorMessage += "You don't have permission to upload files.";
                                    break;
                                case 'storage/canceled':
                                    errorMessage += "Upload was cancelled.";
                                    break;
                                case 'storage/quota-exceeded':
                                    errorMessage += "Storage quota exceeded.";
                                    break;
                                case 'storage/invalid-url':
                                    errorMessage += "Invalid storage location.";
                                    break;
                                case 'storage/unknown':
                                default:
                                    errorMessage += error.message || "An unknown error occurred.";
                            }
                            
                            alert(errorMessage);
                            console.error('Detailed error:', error);
                        },
                        () => {
                            // Upload complete
                            uploadProgress.style.display = 'none';
                            
                            // Get download URL
                            uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                                // Create file data object with downloadable flag
                                const fileData = {
                                    name: file.name,
                                    path: `risk-attachments/${Date.now()}-${file.name}`,
                                    size: formatFileSize(file.size),
                                    url: downloadURL,
                                    timestamp: Date.now(),
                                    downloadable: true
                                };
                                
                                // Add to attached files list
                                attachedFiles.push(fileData);
                                renderFileList();
                            });
                        }
                    );
                } catch (error) {
                    console.error("Error starting upload:", error);
                    uploadProgress.style.display = 'none';
                    alert("Authentication failed. Please try again.");
                }
            }
            
            // Format file size helper function
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            // Render the file list in the UI
            function renderFileList() {
                fileList.innerHTML = '';
                
                if (attachedFiles.length === 0) {
                    fileList.innerHTML = '<li class="no-files">No files attached</li>';
                    return;
                }
                
                attachedFiles.forEach((fileData, index) => {
                    const fileItem = document.createElement('li');
                    fileItem.className = 'file-item';
                    
                    // Determine appropriate icon based on file extension
                    let iconClass = 'fa-file';
                    if (fileData.name) {
                        const ext = fileData.name.split('.').pop().toLowerCase();
                        
                        if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg'].includes(ext)) {
                            iconClass = 'fa-file-image';
                        } else if (['pdf'].includes(ext)) {
                            iconClass = 'fa-file-pdf';
                        } else if (['doc', 'docx'].includes(ext)) {
                            iconClass = 'fa-file-word';
                        } else if (['xls', 'xlsx'].includes(ext)) {
                            iconClass = 'fa-file-excel';
                        } else if (['ppt', 'pptx'].includes(ext)) {
                            iconClass = 'fa-file-powerpoint';
                        } else if (['zip', 'rar', '7z'].includes(ext)) {
                            iconClass = 'fa-file-archive';
                        } else if (['txt', 'rtf'].includes(ext)) {
                            iconClass = 'fa-file-alt';
                        }
                    }
                    
                    // Create different HTML for local-only vs. stored files
                    if (fileData.isLocalOnly) {
                        fileItem.innerHTML = `
                            <div class="file-info">
                                <i class="fas ${iconClass} file-icon"></i>
                                <span class="file-name">${fileData.name} <em>(file info only)</em></span>
                                <span class="file-size">${fileData.size}</span>
                            </div>
                            <div class="file-actions">
                                <button type="button" title="Remove File" data-index="${index}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                    } else {
                        fileItem.innerHTML = `
                            <div class="file-info">
                                <i class="fas ${iconClass} file-icon"></i>
                                <span class="file-name">${fileData.name}</span>
                                <span class="file-size">${fileData.size}</span>
                            </div>
                            <div class="file-actions">
                                ${fileData.url ? `
                                    <a href="${fileData.url}" target="_blank" title="View File" class="download-link" data-path="${fileData.path}">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="${fileData.url}" download="${fileData.name}" title="Download File">
                                        <i class="fas fa-download"></i>
                                    </a>
                                ` : ''}
                                <button type="button" title="Remove File" data-index="${index}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                    }
                    
                    fileList.appendChild(fileItem);
                    
                    // Add event listener for delete button
                    const deleteBtn = fileItem.querySelector('button');
                    deleteBtn.addEventListener('click', function() {
                        const fileIndex = parseInt(this.dataset.index);
                        deleteFile(fileIndex);
                    });
                    
                    // Add event listener for view/download links to ensure authenticated access
                    const viewLinks = fileItem.querySelectorAll('.download-link');
                    viewLinks.forEach(link => {
                        link.addEventListener('click', async function(e) {
                            e.preventDefault();
                            
                            const filePath = this.getAttribute('data-path');
                            if (!filePath) return;
                            
                            try {
                                // Ensure user is authenticated before accessing file
                                await firebaseHelper.ensureAuthenticated();
                                
                                // Get fresh download URL (in case token expired)
                                const downloadURL = await firebaseHelper.getFileDownloadURL(filePath);
                                window.open(downloadURL, '_blank');
                            } catch (error) {
                                console.error('Error accessing file:', error);
                                alert('Unable to access file. Please ensure you are logged in.');
                            }
                        });
                    });
                });
            }
            
            // Delete a file
            function deleteFile(index) {
                if (confirm('Are you sure you want to remove this file?')) {
                    attachedFiles.splice(index, 1);
                    renderFileList();
                }
            }
            
            // Load existing risk data if editing
            if (riskId) {
                // First load the hazard types and responsible persons to ensure options are available
                const hazardDropdown = document.getElementById('hazardType');
                const responsiblePersonDropdown = document.getElementById('responsiblePerson');
                
                // Promise for loading hazard options
                const loadHazardsPromise = database.ref('fieldOptions/hazard-type').once('value')
                    .then(hazardSnapshot => {
                        // Process hazard types
                        if (hazardSnapshot.exists()) {
                            hazardSnapshot.forEach(hazardOptionSnapshot => {
                                const hazard = hazardOptionSnapshot.val();
                                if (hazard.enabled !== false) {
                                    const option = document.createElement('option');
                                    option.value = hazard.value || hazardOptionSnapshot.key;
                                    option.textContent = hazard.label;
                                    hazardDropdown.appendChild(option);
                                }
                            });
                        } else {
                            // Add default hazard types if none exist
                            const defaultHazards = [
                                { label: 'Chemical', value: 'chemical' },
                                { label: 'Electrical', value: 'electrical' },
                                { label: 'Mechanical', value: 'mechanical' },
                                { label: 'Ergonomic', value: 'ergonomic' },
                                { label: 'Biological', value: 'biological' },
                                { label: 'Physical', value: 'physical' },
                                { label: 'Psychosocial', value: 'psychosocial' },
                                { label: 'Environmental', value: 'environmental' }
                            ];
                            
                            defaultHazards.forEach(hazard => {
                                const option = document.createElement('option');
                                option.value = hazard.value;
                                option.textContent = hazard.label;
                                hazardDropdown.appendChild(option);
                            });
                        }
                        return true;
                    })
                    .catch(error => {
                        console.error("Error loading hazard types:", error);
                        return false;
                    });
                
                // Promise for loading responsible persons
                const loadResponsiblePersonsPromise = database.ref('users').once('value')
                    .then(snapshot => {
                        if (snapshot.exists()) {
                            snapshot.forEach(userSnapshot => {
                                const user = userSnapshot.val();
                                const option = document.createElement('option');
                                option.value = userSnapshot.key;
                                
                                // Display only the full name
                                let fullName = '';
                                if (user.firstName && user.lastName) {
                                    fullName = `${user.firstName} ${user.lastName}`;
                                } else if (user.name) {
                                    fullName = user.name;
                                } else if (user.fullName) {
                                    fullName = user.fullName;
                                } else if (user.displayName) {
                                    fullName = user.displayName;
                                } else if (user.username) {
                                    fullName = user.username;
                                } else if (user.email) {
                                    fullName = user.email.split('@')[0]; // Remove domain part
                                } else {
                                    fullName = `User ${userSnapshot.key}`;
                                }
                                
                                option.textContent = fullName;
                                responsiblePersonDropdown.appendChild(option);
                            });
                        }
                        return true;
                    })
                    .catch(error => {
                        console.error("Error loading responsible persons:", error);
                        return false;
                    });
                
                // Wait for both dropdowns to be loaded before proceeding
                Promise.all([loadHazardsPromise, loadResponsiblePersonsPromise])
                    .then(() => {
                        // Now load the risk data after options are loaded
                        database.ref('riskmanagement/' + riskId).once('value')
                            .then(snapshot => {
                                if (snapshot.exists()) {
                                    const riskData = snapshot.val();
                                    
                                    // Set form values
                                    riskIDInput.value = riskData.id || riskId;
                                    
                                    // Set hazard field first
                                    document.getElementById('hazard').value = riskData.hazard || '';
                                    
                                    // Set hazard type with validation
                                    if (riskData.hazardType) {
                                        // Check if the option exists in the dropdown
                                        let hazardOptionExists = false;
                                        for (let i = 0; i < hazardDropdown.options.length; i++) {
                                            if (hazardDropdown.options[i].value === riskData.hazardType) {
                                                hazardOptionExists = true;
                                                hazardDropdown.value = riskData.hazardType;
                                                break;
                                            }
                                        }
                                        
                                        if (!hazardOptionExists) {
                                            console.warn(`Hazard option "${riskData.hazardType}" not found in dropdown options`);
                                        }
                                    }
                                    
                                    // Set responsible person dropdown value with validation
                                    if (riskData.controls && riskData.controls.responsiblePerson) {
                                        // Check if the option exists in the dropdown
                                        let personOptionExists = false;
                                        for (let i = 0; i < responsiblePersonDropdown.options.length; i++) {
                                            if (responsiblePersonDropdown.options[i].value === riskData.controls.responsiblePerson) {
                                                personOptionExists = true;
                                                break;
                                            }
                                        }
                                        
                                        if (personOptionExists) {
                                            responsiblePersonDropdown.value = riskData.controls.responsiblePerson;
                                            // Trigger change event to auto-populate line manager
                                            const changeEvent = new Event('change');
                                            responsiblePersonDropdown.dispatchEvent(changeEvent);
                                        } else {
                                            console.warn(`Responsible person "${riskData.controls.responsiblePerson}" not found in dropdown options`);
                                        }
                                    }
                                    
                                    // Set target completion date with proper formatting
                                    if (riskData.controls && riskData.controls.targetDate) {
                                        const targetDateInput = document.getElementById('targetDate');
                                        // Ensure date is in YYYY-MM-DD format
                                        if (riskData.controls.targetDate.includes('T')) {
                                            // Handle ISO format (YYYY-MM-DDTHH:MM:SS.sssZ)
                                            targetDateInput.value = riskData.controls.targetDate.split('T')[0];
                                        } else if (riskData.controls.targetDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
                                            // Already in YYYY-MM-DD format
                                            targetDateInput.value = riskData.controls.targetDate;
                                        } else {
                                            // Try to parse and format the date
                                            try {
                                                const dateObj = new Date(riskData.controls.targetDate);
                                                if (!isNaN(dateObj.getTime())) {
                                                    const year = dateObj.getFullYear();
                                                    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                                                    const day = String(dateObj.getDate()).padStart(2, '0');
                                                    targetDateInput.value = `${year}-${month}-${day}`;
                                                }
                                            } catch (e) {
                                                console.error("Error parsing target date:", e);
                                            }
                                        }
                                    }
                                    
                                    // Continue setting other form values
                                    document.getElementById('riskTitle').value = riskData.title || '';
                                    riskCategorySelect.value = riskData.category || '';
                                    departmentSelect.value = riskData.department || '';
                                    locationSelect.value = riskData.location || '';
                                    dateIdentifiedInput.value = riskData.dateIdentified || formattedDate;
                                    riskStatusSelect.value = riskData.status || '';
                                    document.getElementById('riskDescription').value = riskData.description || '';
                                    
                                    // Inherent risk assessment
                                    if (riskData.inherentAssessment) {
                                        inherentLikelihoodSelect.value = riskData.inherentAssessment.likelihood || '';
                                        inherentConsequenceSelect.value = riskData.inherentAssessment.consequence || '';
                                        inherentRiskRating.value = riskData.inherentAssessment.rating || '';
                                        inherentRiskLevel.value = riskData.inherentAssessment.level || '';
                                        
                                        if (riskData.inherentAssessment.level) {
                                            inherentRiskLevel.className = 'form-control risk-' + riskData.inherentAssessment.level.toLowerCase();
                                        }
                                    }
                                    
                                    // Controls and mitigation
                                    if (riskData.controls) {
                                        strategySelect.value = riskData.controls.strategy || '';
                                        
                                        // Handle existing controls as an array
                                        if (riskData.controls.existing) {
                                            // Clear the no controls message
                                            document.getElementById('existingControlsList').innerHTML = '';
                                            
                                            // Add each control as a separate item
                                            if (Array.isArray(riskData.controls.existing)) {
                                                riskData.controls.existing.forEach(control => {
                                                    addControlItem(control);
                                                });
                                            } else if (typeof riskData.controls.existing === 'string') {
                                                // Handle legacy format (string)
                                                const controlLines = riskData.controls.existing.split('\n');
                                                controlLines.forEach(line => {
                                                    if (line.trim()) {
                                                        addControlItem(line.trim());
                                                    }
                                                });
                                            }
                                        } else {
                                            // Make sure we show the no controls message
                                            showNoControlsMessage();
                                        }
                                        
                                        // Handle proposed mitigation actions as an array
                                        if (riskData.controls.proposed) {
                                            // Clear the no mitigations message
                                            document.getElementById('mitigationActionsList').innerHTML = '';
                                            
                                            // Add each mitigation as a separate item
                                            if (Array.isArray(riskData.controls.proposed)) {
                                                riskData.controls.proposed.forEach(mitigation => {
                                                    addMitigationItem(mitigation);
                                                });
                                            } else if (typeof riskData.controls.proposed === 'string') {
                                                // Handle legacy format (string)
                                                const mitigationLines = riskData.controls.proposed.split('\n');
                                                mitigationLines.forEach(line => {
                                                    if (line.trim()) {
                                                        addMitigationItem(line.trim());
                                                    }
                                                });
                                            }
                                        } else {
                                            // Make sure we show the no mitigations message
                                            showNoMitigationsMessage();
                                        }
                                        
                                        // ...existing code...
                                    }
                                    
                                    // Residual risk assessment
                                    if (riskData.residualAssessment) {
                                        residualLikelihoodSelect.value = riskData.residualAssessment.likelihood || '';
                                        residualConsequenceSelect.value = riskData.residualAssessment.consequence || '';
                                        residualRiskRating.value = riskData.residualAssessment.rating || '';
                                        residualRiskLevel.value = riskData.residualAssessment.level || '';
                                        
                                        if (riskData.residualAssessment.level) {
                                            residualRiskLevel.className = 'form-control risk-' + riskData.residualAssessment.level.toLowerCase();
                                        }
                                    }
                                    
                                    // Additional information
                                    document.getElementById('additionalNotes').value = riskData.additionalNotes || '';
                                    
                                    // Load existing attachments
                                    if (riskData.attachments) {
                                        // Clear any existing attachments first
                                        attachedFiles = [];
                                        
                                        // Convert to array if it's an object
                                        let attachmentArray;
                                        if (Array.isArray(riskData.attachments)) {
                                            attachmentArray = riskData.attachments;
                                        } else if (typeof riskData.attachments === 'object') {
                                            attachmentArray = Object.values(riskData.attachments);
                                        } else {
                                            attachmentArray = [];
                                        }
                                        
                                        // Add each attachment to attachedFiles array
                                        attachmentArray.forEach(attachment => {
                                            if (attachment && attachment.name && attachment.url) {
                                                attachedFiles.push({
                                                    name: attachment.name,
                                                    url: attachment.url,
                                                    path: attachment.path || '',
                                                    size: attachment.size || 'Unknown size',
                                                    timestamp: attachment.uploadedAt || Date.now(),
                                                    downloadable: true,
                                                    isExisting: true
                                                });
                                            }
                                        });
                                        
                                        // Update UI with loaded attachments
                                        renderFileList();
                                    }
                                    
                                    // Update page title to reflect editing
                                    document.title = 'HSE System - Edit Risk Assessment';
                                    document.querySelector('.risk-title h2').textContent = 'Edit Risk Assessment';
                                    document.querySelector('.risk-title p').textContent = 'Update an existing risk assessment';
                                    submitBtn.textContent = 'Update Risk Assessment';
                                } else {
                                    alert('Risk assessment not found!');
                                    window.location.href = 'risk-assessment.html';
                                }
                            })
                            .catch(error => {
                                console.error('Error loading risk data:', error);
                                alert('Error loading risk assessment data.');
                            });
                    })
                    .catch(error => {
                        console.error("Error loading hazard types for edit:", error);
                        
                        // Still try to load the risk data even if hazards failed to load
                        database.ref('riskmanagement/' + riskId).once('value')
                            .then(snapshot => {
                                if (snapshot.exists()) {
                                    const riskData = snapshot.val();
                                    
                                    // Set form values
                                    riskIDInput.value = riskData.id || riskId;
                                    // Continue with other fields, but skip hazard setting
                                    document.getElementById('riskTitle').value = riskData.title || '';
                                    riskCategorySelect.value = riskData.category || '';
                                    departmentSelect.value = riskData.department || '';
                                    locationSelect.value = riskData.location || '';
                                    dateIdentifiedInput.value = riskData.dateIdentified || formattedDate;
                                    riskStatusSelect.value = riskData.status || '';
                                    document.getElementById('riskDescription').value = riskData.description || '';
                                    
                                    // Inherent risk assessment
                                    if (riskData.inherentAssessment) {
                                        inherentLikelihoodSelect.value = riskData.inherentAssessment.likelihood || '';
                                        inherentConsequenceSelect.value = riskData.inherentAssessment.consequence || '';
                                        inherentRiskRating.value = riskData.inherentAssessment.rating || '';
                                        inherentRiskLevel.value = riskData.inherentAssessment.level || '';
                                        
                                        if (riskData.inherentAssessment.level) {
                                            inherentRiskLevel.className = 'form-control risk-' + riskData.inherentAssessment.level.toLowerCase();
                                        }
                                    }
                                    
                                    // Controls and mitigation
                                    if (riskData.controls) {
                                        strategySelect.value = riskData.controls.strategy || '';
                                        
                                        // Handle existing controls as an array
                                        if (riskData.controls.existing) {
                                            // Clear the no controls message
                                            document.getElementById('existingControlsList').innerHTML = '';
                                            
                                            // Add each control as a separate item
                                            if (Array.isArray(riskData.controls.existing)) {
                                                riskData.controls.existing.forEach(control => {
                                                    addControlItem(control);
                                                });
                                            } else if (typeof riskData.controls.existing === 'string') {
                                                // Handle legacy format (string)
                                                const controlLines = riskData.controls.existing.split('\n');
                                                controlLines.forEach(line => {
                                                    if (line.trim()) {
                                                        addControlItem(line.trim());
                                                    }
                                                });
                                            }
                                        } else {
                                            // Make sure we show the no controls message
                                            showNoControlsMessage();
                                        }
                                        
                                        // Handle proposed mitigation actions as an array
                                        if (riskData.controls.proposed) {
                                            // Clear the no mitigations message
                                            document.getElementById('mitigationActionsList').innerHTML = '';
                                            
                                            // Add each mitigation as a separate item
                                            if (Array.isArray(riskData.controls.proposed)) {
                                                riskData.controls.proposed.forEach(mitigation => {
                                                    addMitigationItem(mitigation);
                                                });
                                            } else if (typeof riskData.controls.proposed === 'string') {
                                                // Handle legacy format (string)
                                                const mitigationLines = riskData.controls.proposed.split('\n');
                                                mitigationLines.forEach(line => {
                                                    if (line.trim()) {
                                                        addMitigationItem(line.trim());
                                                    }
                                                });
                                            }
                                        } else {
                                            // Make sure we show the no mitigations message
                                            showNoMitigationsMessage();
                                        }
                                        
                                        // ...existing code...
                                    }
                                    
                                    // Residual risk assessment
                                    if (riskData.residualAssessment) {
                                        residualLikelihoodSelect.value = riskData.residualAssessment.likelihood || '';
                                        residualConsequenceSelect.value = riskData.residualAssessment.consequence || '';
                                        residualRiskRating.value = riskData.residualAssessment.rating || '';
                                        residualRiskLevel.value = riskData.residualAssessment.level || '';
                                        
                                        if (riskData.residualAssessment.level) {
                                            residualRiskLevel.className = 'form-control risk-' + riskData.residualAssessment.level.toLowerCase();
                                        }
                                    }
                                    
                                    // Additional information
                                    document.getElementById('additionalNotes').value = riskData.additionalNotes || '';
                                    
                                    // Load existing attachments
                                    if (riskData.attachments) {
                                        // Clear any existing attachments first
                                        attachedFiles = [];
                                        
                                        // Convert to array if it's an object
                                        let attachmentArray;
                                        if (Array.isArray(riskData.attachments)) {
                                            attachmentArray = riskData.attachments;
                                        } else if (typeof riskData.attachments === 'object') {
                                            attachmentArray = Object.values(riskData.attachments);
                                        } else {
                                            attachmentArray = [];
                                        }
                                        
                                        // Add each attachment to attachedFiles array
                                        attachmentArray.forEach(attachment => {
                                            if (attachment && attachment.name && attachment.url) {
                                                attachedFiles.push({
                                                    name: attachment.name,
                                                    url: attachment.url,
                                                    path: attachment.path || '',
                                                    size: attachment.size || 'Unknown size',
                                                    timestamp: attachment.uploadedAt || Date.now(),
                                                    downloadable: true,
                                                    isExisting: true
                                                });
                                            }
                                        });
                                        
                                        // Update UI with loaded attachments
                                        renderFileList();
                                    }
                                    
                                    // Update page title to reflect editing
                                    document.title = 'HSE System - Edit Risk Assessment';
                                    document.querySelector('.risk-title h2').textContent = 'Edit Risk Assessment';
                                    document.querySelector('.risk-title p').textContent = 'Update an existing risk assessment';
                                    submitBtn.textContent = 'Update Risk Assessment';
                                } else {
                                    alert('Risk assessment not found!');
                                    window.location.href = 'risk-assessment.html';
                                }
                            })
                            .catch(error => {
                                console.error('Error loading risk data:', error);
                                alert('Error loading risk assessment data.');
                            });
                    });
            } else {
                // If not editing, just load the hazard types for a new form
                database.ref('fieldOptions/hazard-type').once('value')
                    .then(snapshot => {
                        if (snapshot.exists()) {
                            const existingValues = new Set(); // Track existing values to prevent duplicates
                            
                            snapshot.forEach(hazardSnapshot => {
                                const hazard = hazardSnapshot.val();
                                // Only add enabled hazard types that haven't been added yet
                                if (hazard.enabled !== false && !existingValues.has(hazard.value)) {
                                    existingValues.add(hazard.value);
                                    const option = document.createElement('option');
                                    option.value = hazard.value || hazardSnapshot.key;
                                    option.textContent = hazard.label;
                                    hazardTypeSelect.appendChild(option);
                                }
                            });
                        } else {
                            // Add default hazard types if none exist
                            const defaultHazards = [
                                { label: 'Chemical', value: 'chemical' },
                                { label: 'Electrical', value: 'electrical' },
                                { label: 'Mechanical', value: 'mechanical' },
                                { label: 'Ergonomic', value: 'ergonomic' },
                                { label: 'Biological', value: 'biological' },
                                { label: 'Physical', value: 'physical' },
                                { label: 'Psychosocial', value: 'psychosocial' },
                                { label: 'Environmental', value: 'environmental' }
                            ];
                            
                            defaultHazards.forEach(hazard => {
                                const option = document.createElement('option');
                                option.value = hazard.value;
                                option.textContent = hazard.label;
                                hazardTypeSelect.appendChild(option);
                            });
                        }
                    })
                    .catch(error => {
                        console.error("Error loading hazard types:", error);
                    });
            }
            
            // Reset form
            resetBtn.addEventListener('click', function() {
                if (confirm('Are you sure you want to reset the form? All entered data will be lost.')) {
                    riskForm.reset();
                    
                    if (!riskId) {
                        riskIDInput.value = generateRiskID();
                    }
                    
                    dateIdentifiedInput.value = formattedDate;
                    
                    inherentRiskRating.value = '';
                    inherentRiskLevel.value = '';
                    inherentRiskLevel.className = 'form-control';
                    
                    residualRiskRating.value = '';
                    residualRiskLevel.value = '';
                    residualRiskLevel.className = 'form-control';
                    
                    uploadedFiles.length = 0;
                    updateFileListUI();
                    uploadStatus.textContent = '';
                    
                    // Re-populate current user info
                    auth.onAuthStateChanged(function(user) {
                        if (user) {
                            database.ref('users/' + user.uid).once('value')
                                .then(snapshot => {
                                    const userData = snapshot.val();
                                    if (userData) {
                                        currentUserName.value = userData.name || user.email;
                                        currentUserId.value = user.uid;
                                    } else {
                                        currentUserName.value = user.email;
                                        currentUserId.value = user.uid;
                                    }
                                });
                        }
                    });
                    
                    // If editing, reload the original data
                    if (riskId) {
                        database.ref('risks/' + riskId).once('value')
                            .then(snapshot => {
                                if (snapshot.exists()) {
                                    const riskData = snapshot.val();
                                    
                                    // Set form values
                                    riskIDInput.value = riskData.id || riskId;
                                    document.getElementById('hazard').value = riskData.hazard || '';
                                    document.getElementById('riskTitle').value = riskData.title || '';
                                    // ...and so on (same as above)
                                }
                            });
                    }
                }
            });
            
            // Submit form
            riskForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Disable submit button to prevent multiple submissions
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
                
                // Get form data
                const formData = {
                    id: riskIDInput.value,
                    hazard: document.getElementById('hazard').value,
                    hazardType: document.getElementById('hazardType').value, // Add this line
                    title: document.getElementById('riskTitle').value,
                    category: document.getElementById('riskCategory').value,
                    department: document.getElementById('department').value,
                    location: document.getElementById('location').value,
                    dateIdentified: document.getElementById('dateIdentified').value,
                    status: document.getElementById('riskStatus').value,
                    description: document.getElementById('riskDescription').value,
                    inherentAssessment: {
                        likelihood: parseInt(inherentLikelihoodSelect.value),
                        consequence: parseInt(inherentConsequenceSelect.value),
                        rating: parseInt(inherentRiskRating.value),
                        level: inherentRiskLevel.value
                    },
                    controls: {
                        strategy: document.getElementById('strategy').value,
                        existing: getControlItems(), // Get controls as an array
                        proposed: getMitigationItems(), // Get mitigations as an array
                        responsiblePerson: document.getElementById('responsiblePerson').value,
                        lineManager: document.getElementById('lineManager').value,
                        targetDate: document.getElementById('targetDate').value
                    },
                    residualAssessment: {
                        likelihood: parseInt(residualLikelihoodSelect.value),
                        consequence: parseInt(residualConsequenceSelect.value),
                        rating: parseInt(residualRiskRating.value),
                        level: residualRiskLevel.value
                    },
                    additionalNotes: document.getElementById('additionalNotes').value,
                    createdBy: {
                        id: currentUserId.value,
                        name: currentUserName.value
                    },
                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                };
                
                // If creating a new risk, add createdAt
                if (!riskId) {
                    formData.createdAt = firebase.database.ServerValue.TIMESTAMP;
                }
                
                // Create a reference to the risk in the database
                let riskRef;
                if (riskId) {
                    // Update existing risk
                    riskRef = database.ref('riskmanagement/' + riskId);
                } else {
                    // Create new risk
                    riskRef = database.ref('riskmanagement').push();
                }

                // Handle attachments
                // Preserve existing attachments
                formData.attachments = [];
                
                // Add all attachments from attachedFiles array
                attachedFiles.forEach(file => {
                    if (file.isExisting) {
                        // For existing files, just keep their data
                        formData.attachments.push({
                            name: file.name,
                            url: file.url,
                            path: file.path || '',
                            size: file.size,
                            uploadedAt: file.timestamp || Date.now()
                        });
                    } else {
                        // For new files uploaded in this session (already in Firebase Storage)
                        formData.attachments.push({
                            name: file.name,
                            url: file.url,
                            path: file.path || '',
                            size: file.size,
                            uploadedAt: Date.now()
                        });
                    }
                });
                
                // Save the risk data
                riskRef.update(formData)
                    .then(() => {
                        alert(riskId ? 'Risk assessment updated successfully!' : 'Risk assessment submitted successfully!');
                        window.location.href = 'risk-assessment.html';
                    })
                    .catch(error => {
                        console.error('Error saving risk:', error);
                        alert('Error submitting risk assessment: ' + error.message);
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = riskId ? 'Update Risk Assessment' : 'Submit Risk';
                    });
            });

            // Event handlers
            addControlBtn.addEventListener('click', function() {
                addControlItem();
            });

            addMitigationBtn.addEventListener('click', function() {
                addMitigationItem();
            });
            
            // Add a control item
            function addControlItem(value = '') {
                const controlsList = document.getElementById('existingControlsList');
                
                // Remove the no controls message if it exists
                const noControlsMessage = controlsList.querySelector('.no-controls-message');
                if (noControlsMessage) {
                    noControlsMessage.remove();
                }
                
                // Determine the next control number
                const controlNumber = controlsList.children.length + 1;
                
                // Create a new control item
                const controlItem = document.createElement('div');
                controlItem.className = 'control-item';
                controlItem.innerHTML = `
                    <div class="control-number">${controlNumber}</div>
                    <input type="text" class="control-input form-control" value="${value}" placeholder="Enter control measure...">
                    <button type="button" class="delete-control-btn">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                // Add event listener to the delete button
                const deleteBtn = controlItem.querySelector('.delete-control-btn');
                deleteBtn.addEventListener('click', function() {
                    controlItem.remove();
                    
                    // Renumber the remaining controls
                    renumberControls();
                    
                    // If no controls are left, show the message
                    if (controlsList.children.length === 0) {
                        showNoControlsMessage();
                    }
                });
                
                // Add the control item to the list
                controlsList.appendChild(controlItem);
                
                // Focus on the new input
                const input = controlItem.querySelector('input');
                input.focus();
            }
            
            // Add a mitigation action item
            function addMitigationItem(value = '') {
                const mitigationsList = document.getElementById('mitigationActionsList');
                
                // Remove the no mitigations message if it exists
                const noMitigationsMessage = mitigationsList.querySelector('.no-controls-message');
                if (noMitigationsMessage) {
                    noMitigationsMessage.remove();
                }
                
                // Determine the next mitigation number
                const mitigationNumber = mitigationsList.children.length + 1;
                
                // Create a new mitigation item
                const mitigationItem = document.createElement('div');
                mitigationItem.className = 'control-item';
                mitigationItem.innerHTML = `
                    <div class="control-number">${mitigationNumber}</div>
                    <input type="text" class="mitigation-input form-control" value="${value}" placeholder="Enter mitigation action...">
                    <button type="button" class="delete-control-btn">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                // Add event listener to the delete button
                const deleteBtn = mitigationItem.querySelector('.delete-control-btn');
                deleteBtn.addEventListener('click', function() {
                    mitigationItem.remove();
                    
                    // Renumber the remaining mitigations
                    renumberMitigations();
                    
                    // If no mitigations are left, show the message
                    if (mitigationsList.children.length === 0) {
                        showNoMitigationsMessage();
                    }
                });
                
                // Add the mitigation item to the list
                mitigationsList.appendChild(mitigationItem);
                
                // Focus on the new input
                const input = mitigationItem.querySelector('input');
                input.focus();
            }
            
            // Renumber all controls after addition or deletion
            function renumberControls() {
                const controlsList = document.getElementById('existingControlsList');
                const controlItems = controlsList.querySelectorAll('.control-item');
                
                controlItems.forEach((item, index) => {
                    const numberLabel = item.querySelector('.control-number');
                    if (numberLabel) {
                        numberLabel.textContent = index + 1;
                    }
                });
            }
            
            // Renumber all mitigations after addition or deletion
            function renumberMitigations() {
                const mitigationsList = document.getElementById('mitigationActionsList');
                const mitigationItems = mitigationsList.querySelectorAll('.control-item');
                
                mitigationItems.forEach((item, index) => {
                    const numberLabel = item.querySelector('.control-number');
                    if (numberLabel) {
                        numberLabel.textContent = index + 1;
                    }
                });
            }
            
            // Show a message when no controls are added
            function showNoControlsMessage() {
                const controlsList = document.getElementById('existingControlsList');
                const message = document.createElement('div');
                message.className = 'no-controls-message';
                message.textContent = 'No controls added yet. Click "Add Control" to add one.';
                controlsList.appendChild(message);
            }
            
            // Show a message when no mitigations are added
            function showNoMitigationsMessage() {
                const mitigationsList = document.getElementById('mitigationActionsList');
                const message = document.createElement('div');
                message.className = 'no-controls-message';
                message.textContent = 'No mitigation actions added yet. Click "Add Mitigation" to add one.';
                mitigationsList.appendChild(message);
            }
            
            // Show initial messages
            showNoControlsMessage();
            showNoMitigationsMessage();
            
            // Get all control items
            function getControlItems() {
                const controlInputs = document.querySelectorAll('#existingControlsList .control-input');
                const controls = [];
                
                controlInputs.forEach(input => {
                    const value = input.value.trim();
                    if (value) {
                        controls.push(value);
                    }
                });
                
                return controls;
            }
            
            // Get all mitigation items
            function getMitigationItems() {
                const mitigationInputs = document.querySelectorAll('#mitigationActionsList .mitigation-input');
                const mitigations = [];
                
                mitigationInputs.forEach(input => {
                    const value = input.value.trim();
                    if (value) {
                        mitigations.push(value);
                    }
                });
                
                return mitigations;
            }

        });
    </script>
</body>
</html>