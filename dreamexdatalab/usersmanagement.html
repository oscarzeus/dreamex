<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSE System - User Management</title>
    <link rel="stylesheet" href="css/styles.css">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Dashboard specific styles */
        .users-container {
            width: 100%;
            max-width: none;
            margin: 70px 0 20px 0;
            padding: 15px;
            box-sizing: border-box;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        .users-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .users-title h2 {
            margin: 0;
            color: #34495e;
        }

        .users-title p {
            margin: 5px 0 0;
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .tab-container {
            margin-bottom: 20px;
        }
        
        .tabs {
            display: flex;
            gap: 5px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }
        
        .tab-content {
            display: none;
            padding: 20px 0;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .search-bar {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        
        .search-bar input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .search-bar button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .user-list {
            margin-bottom: 20px;
        }
        
        /* User table styles */
        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .user-table th,
        .user-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .user-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #34495e;
        }

        .user-table tbody tr:hover {
            background-color: #f5f7fa;
        }

        .user-avatar-cell {
            width: 60px;
        }

        .user-avatar-sm {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .user-initial-sm {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .user-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .status-active {
            background-color: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        /* Pagination styles */
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .pagination-btn {
            padding: 8px 12px;
            margin: 0 5px;
            border: 1px solid #ddd;
            background-color: #fff;
            color: #333;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .pagination-btn:hover {
            background-color: #f5f5f5;
        }

        .pagination-btn.active {
            background-color: #3498db;
            color: #fff;
            border-color: #3498db;
        }

        .pagination-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow-y: auto; /* Enable vertical scrolling */
            padding: 20px 0;
        }
        
        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 20px;
            border-radius: 8px;
            max-width: 700px; /* Increased from 600px for more space */
            width: 90%; /* Use percentage instead of fixed width for better responsiveness */
            max-height: 90vh; /* Maximum height relative to viewport */
            overflow-y: auto; /* Enable scrolling within the modal if content is too long */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        /* Specific adjustments for the edit user modal */
        #editUserModal .modal-content {
            padding-bottom: 30px; /* Add more padding at the bottom */
        }
        
        #editUserModal .checkbox-grid {
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); /* Slightly smaller for better fit */
        }
        
        /* Add responsive adjustments */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 5% auto;
                padding: 15px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .form-group {
                flex: 1 0 100%;
            }
        }
        
        .user-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 0.875rem;
        }
        
        .btn-edit {
            background-color: #17a2b8;
            color: white;
        }
        
        .btn-edit:hover {
            background-color: #138496;
        }
        
        .btn-delete {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-delete:hover {
            background-color: #c82333;
        }
        
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
        }
        
        .checkbox-item input {
            width: auto;
            margin-right: 8px;
        }

        /* Add these CSS rules to ensure proper dropdown display */
        .user-avatar {
            position: relative;
            cursor: pointer;
        }
        
        .user-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 4px;
            padding: 10px 0;
            min-width: 200px;
            z-index: 1000;
        }
        
        .user-menu.show {
            display: block;
        }
        
        .user-menu-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            text-decoration: none;
            color: var(--text-color);
            transition: background-color 0.2s;
        }
        
        .user-menu-item:hover {
            background-color: #f8f9fa;
        }
        
        .user-menu-item i {
            margin-right: 10px;
            width: 16px;
        }
        
        /* Loading indicator */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }

        .loading-spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Add this to your existing styles */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: rgba(52, 152, 219, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #34495e;
            margin-bottom: 4px;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .dashboard-stats {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 480px) {
            .dashboard-stats {
                grid-template-columns: 1fr;
            }
        }

        /* Add these styles for the multi-select dropdown */
        select[multiple] {
            min-height: 120px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            background-color: white;
        }

        select[multiple] option {
            padding: 8px;
            margin: 2px 0;
            border-radius: 4px;
        }

        select[multiple] option:hover {
            background-color: #f0f0f0;
        }

        select[multiple] option:checked {
            background-color: #e3f2fd;
            color: #1976d2;
        }
    </style>
</head>
<body>
    <!-- Header Placeholder - will be replaced by the header component -->
    <div id="header-placeholder"></div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <main class="users-container">
        <div class="users-header">
            <div class="users-title">
                <h2>User Management</h2>
                <p>Manage system users, roles, and permissions</p>
            </div>
            <div class="dashboard-actions">
                <button id="addUserBtn" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add New User
                </button>
            </div>
        </div>

        <div class="tab-container">
            <div class="tabs">
                <button class="tab-btn active" data-tab="users">Users</button>
                <button class="tab-btn" data-tab="roles">Roles & Permissions</button>
                <button class="tab-btn" data-tab="departments">Departments</button>
                <button class="tab-btn" data-tab="locations">Locations</button>
            </div>

            <!-- Users Tab -->
            <div id="users" class="tab-content active">
                <div class="search-bar">
                    <input type="text" id="userSearch" placeholder="Search users by name, email, or role...">
                    <button>
                        <i class="fas fa-search"></i>
                    </button>
                </div>

                <!-- Users stats section with improved styling -->
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-icon" style="background-color: rgba(52, 152, 219, 0.1);">
                            <i class="fas fa-users" style="color: #3498db; font-size: 24px;"></i>
                        </div>
                        <div>
                            <div class="stat-value" id="totalUsersCount">0</div>
                            <div class="stat-label">Total Users</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background-color: rgba(46, 204, 113, 0.1);">
                            <i class="fas fa-user-check" style="color: #2ecc71; font-size: 24px;"></i>
                        </div>
                        <div>
                            <div class="stat-value" id="activeUsersCount">0</div>
                            <div class="stat-label">Active Users</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background-color: rgba(243, 156, 18, 0.1);">
                            <i class="fas fa-user-clock" style="color: #f39c12; font-size: 24px;"></i>
                        </div>
                        <div>
                            <div class="stat-value" id="pendingUsersCount">0</div>
                            <div class="stat-label">Pending Users</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background-color: rgba(231, 76, 60, 0.1);">
                            <i class="fas fa-user-slash" style="color: #e74c3c; font-size: 24px;"></i>
                        </div>
                        <div>
                            <div class="stat-value" id="inactiveUsersCount">0</div>
                            <div class="stat-label">Inactive Users</div>
                        </div>
                    </div>
                </div>

                <div class="user-list">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th class="user-avatar-cell">User</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Department</th>
                                <th>Job Title</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            <!-- User rows will be populated from Firebase -->
                        </tbody>
                    </table>
                </div>

                <div class="pagination" id="userPagination">
                    <!-- Pagination buttons will be generated by JavaScript -->
                </div>
            </div>

            <!-- Roles Tab -->
            <div id="roles" class="tab-content">
                <div class="search-bar">
                    <input type="text" placeholder="Search roles...">
                    <button>
                        <i class="fas fa-search"></i>
                    </button>
                </div>

                <div class="action-bar" style="margin-bottom: 20px;">
                    <button id="addRoleBtn" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add New Role
                    </button>
                </div>

                <div class="user-list">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Role Name</th>
                                <th>Description</th>
                                <th>Users</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="roleTableBody">
                            <!-- Role rows will be populated from Firebase -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Departments Tab -->
            <div id="departments" class="tab-content">
                <div class="search-bar">
                    <input type="text" placeholder="Search departments...">
                    <button>
                        <i class="fas fa-search"></i>
                    </button>
                </div>

                <div class="action-bar" style="margin-bottom: 20px;">
                    <button id="addDeptBtn" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add New Department
                    </button>
                </div>

                <div class="user-list">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Department Name</th>
                                <th>Manager</th>
                                <th>Members</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="deptTableBody">
                            <!-- Department rows will be populated from Firebase -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Locations Tab -->
            <div id="locations" class="tab-content">
                <div class="search-bar">
                    <input type="text" placeholder="Search locations...">
                    <button>
                        <i class="fas fa-search"></i>
                    </button>
                </div>

                <div class="action-bar" style="margin-bottom: 20px;">
                    <button id="addLocationBtn" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add New Location
                    </button>
                </div>

                <div class="user-list">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Location Name</th>
                                <th>Description</th>
                                <th>Users</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="locationTableBody">
                            <!-- Location rows will be populated from Firebase -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 HSE Online System. All rights reserved.</p>
    </footer>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New User</h3>
                <button class="modal-close">&times;</button>
            </div>
            <form id="addUserForm">
                <div class="form-section">
                    <h3>Basic Information</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="firstName">First Name *</label>
                            <input type="text" id="firstName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="lastName">Last Name *</label>
                            <input type="text" id="lastName" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="gender">Gender</label>
                            <select id="gender" class="form-control">
                                <option value="">Select gender</option>
                                <!-- Options will be loaded from Firebase -->
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="employeeId">Employee ID *</label>
                            <input type="text" id="employeeId" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="email">Email Address *</label>
                            <input type="email" id="email" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="phone">Phone Number</label>
                            <input type="tel" id="phone" class="form-control">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Account Details</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="username">Username *</label>
                            <input type="text" id="username" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="password">Temporary Password *</label>
                            <input type="password" id="password" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="role">Role *</label>
                            <select id="role" class="form-control" required>
                                <option value="">Select role</option>
                                <!-- Options will be loaded from Firebase -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="department">Department *</label>
                            <select id="department" class="form-control" required>
                                <option value="">Select department</option>
                                <!-- Department options will be populated from Firebase -->
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="jobTitle">Job Title</label>
                            <input type="text" id="jobTitle" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="lineManager">Line Manager</label>
                            <select id="lineManager" class="form-control">
                                <option value="">Select line manager</option>
                                <!-- Line manager options will be populated from Firebase -->
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="status">Account Status</label>
                            <select id="status" class="form-control">
                                <option value="">Select status</option>
                                <!-- Options will be loaded from Firebase -->
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Additional Settings</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Send welcome email with login credentials</label>
                            <div class="checkbox-item">
                                <input type="checkbox" id="sendWelcomeEmail" checked>
                                <label for="sendWelcomeEmail">Yes, send welcome email</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Force password change on first login</label>
                            <div class="checkbox-item">
                                <input type="checkbox" id="forcePasswordChange" checked>
                                <label for="forcePasswordChange">Yes, require password change</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Access Rights</h3>
                    <p style="margin-bottom: 10px;">Select specific areas this user can access:</p>
                    <div class="checkbox-grid">
                        <div class="checkbox-item">
                            <input type="checkbox" id="access-dashboard">
                            <label for="access-dashboard">Dashboard</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="access-jsa">
                            <label for="access-jsa">Job Safety Analysis</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="access-risk">
                            <label for="access-risk">Risk Assessment</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="access-events">
                            <label for="access-events">Events</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="access-inspections">
                            <label for="access-inspections">Inspections</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="access-reports">
                            <label for="access-reports">Reports</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="access-users">
                            <label for="access-users">User Management</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="access-settings">
                            <label for="access-settings">System Settings</label>
                        </div>
                    </div>
                </div>

                <div class="action-buttons" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary modal-close-btn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Role Modal -->
    <div id="addRoleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Role</h3>
                <button class="modal-close">&times;</button>
            </div>
            <form id="addRoleForm">
                <div class="form-section">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="roleName">Role Name *</label>
                            <input type="text" id="roleName" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="roleDescription">Description</label>
                            <textarea id="roleDescription" class="form-control" rows="3"></textarea>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Permissions</h3>
                    <p style="margin-bottom: 10px;">Select permissions for this role:</p>
                    
                    <div style="margin-bottom: 15px;">
                        <h4 style="font-size: 1rem; margin-bottom: 10px;">Dashboard</h4>
                        <div class="checkbox-grid">
                            <div class="checkbox-item">
                                <input type="checkbox" id="perm-dashboard-view">
                                <label for="perm-dashboard-view">View Dashboard</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="perm-dashboard-customize">
                                <label for="perm-dashboard-customize">Customize Dashboard</label>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <h4 style="font-size: 1rem; margin-bottom: 10px;">Risk Assessment</h4>
                        <div class="checkbox-grid">
                            <div class="checkbox-item">
                                <input type="checkbox" id="perm-risk-view">
                                <label for="perm-risk-view">View Risks</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="perm-risk-create">
                                <label for="perm-risk-create">Create Risks</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="perm-risk-edit">
                                <label for="perm-risk-edit">Edit Risks</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="perm-risk-delete">
                                <label for="perm-risk-delete">Delete Risks</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="perm-risk-approve">
                                <label for="perm-risk-approve">Approve Risks</label>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <h4 style="font-size: 1rem; margin-bottom: 10px;">Job Safety Analysis</h4>
                        <div class="checkbox-grid">
                            <div class="checkbox-item">
                                <input type="checkbox" id="perm-jsa-view">
                                <label for="perm-jsa-view">View JSAs</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="perm-jsa-create">
                                <label for="perm-jsa-create">Create JSAs</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="perm-jsa-edit">
                                <label for="perm-jsa-edit">Edit JSAs</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="perm-jsa-delete">
                                <label for="perm-jsa-delete">Delete JSAs</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="perm-jsa-approve">
                                <label for="perm-jsa-approve">Approve JSAs</label>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <h4 style="font-size: 1rem; margin-bottom: 10px;">User Management</h4>
                        <div class="checkbox-grid">
                            <div class="checkbox-item">
                                <input type="checkbox" id="perm-users-view">
                                <label for="perm-users-view">View Users</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="perm-users-create">
                                <label for="perm-users-create">Create Users</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="perm-users-edit">
                                <label for="perm-users-edit">Edit Users</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="perm-users-delete">
                                <label for="perm-users-delete">Delete Users</label>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <h4 style="font-size: 1rem; margin-bottom: 10px;">System Settings</h4>
                        <div class="checkbox-grid">
                            <div class="checkbox-item">
                                <input type="checkbox" id="perm-system-settings">
                                <label for="perm-system-settings">Change Settings</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="perm-system-logs">
                                <label for="perm-system-logs">View Audit Logs</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="action-buttons" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary modal-close-btn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Role</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Department Modal -->
    <div id="addDeptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Department</h3>
                <button class="modal-close">&times;</button>
            </div>
            <form id="addDeptForm">
                <div class="form-section">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="deptName">Department Name *</label>
                            <input type="text" id="deptName" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="deptManager">Department Manager</label>
                            <select id="deptManager" class="form-control">
                                <option value="">Select a manager</option>
                                <!-- Manager options will be populated from Firebase -->
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="deptDescription">Description</label>
                            <textarea id="deptDescription" class="form-control" rows="3"></textarea>
                        </div>
                    </div>
                    <!-- Remove the people field section -->
                </div>
                
                <div class="action-buttons" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary modal-close-btn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Department</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit User</h3>
                <button class="modal-close">&times;</button>
            </div>
            <form id="editUserForm">
                <input type="hidden" id="editUserId">
                <div class="form-section">
                    <h3>Basic Information</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editFirstName">First Name *</label>
                            <input type="text" id="editFirstName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="editLastName">Last Name *</label>
                            <input type="text" id="editLastName" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editGender">Gender</label>
                            <select id="editGender" class="form-control">
                                <option value="">Select gender</option>
                                <!-- Options will be loaded from Firebase -->
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editEmployeeId">Employee ID</label>
                            <input type="text" id="editEmployeeId" class="form-control">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Contact Information</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editEmail">Email Address *</label>
                            <input type="email" id="editEmail" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="editPhone">Phone Number</label>
                            <input type="tel" id="editPhone" class="form-control">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editUsername">Username *</label>
                            <input type="text" id="editUsername" class="form-control" required>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Role & Department</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editRole">Role *</label>
                            <select id="editRole" class="form-control" required>
                                <option value="">Select role</option>
                                <!-- Options will be loaded from Firebase -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editDepartment">Department *</label>
                            <select id="editDepartment" class="form-control" required>
                                <option value="">Select department</option>
                                <!-- Options will be loaded from Firebase -->
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editJobTitle">Job Title</label>
                            <input type="text" id="editJobTitle" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="editLineManager">Line Manager</label>
                            <select id="editLineManager" class="form-control">
                                <option value="">Select line manager</option>
                                <!-- Options will be loaded from Firebase -->
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Status & Access Rights</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editStatus">Account Status *</label>
                            <select id="editStatus" class="form-control" required>
                                <option value="">Select status</option>
                                <!-- Options will be loaded from Firebase -->
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="flex: 1 0 100%;">
                            <label>Access Rights</label>
                            <div class="checkbox-grid">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="edit-access-dashboard">
                                    <label for="edit-access-dashboard">Dashboard Access</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="edit-access-jsa">
                                    <label for="edit-access-jsa">JSA Management</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="edit-access-risk">
                                    <label for="edit-access-risk">Risk Assessment</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="edit-access-events">
                                    <label for="edit-access-events">Events Management</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="edit-access-inspections">
                                    <label for="edit-access-inspections">Inspections</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="edit-access-reports">
                                    <label for="edit-access-reports">Reports Access</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="edit-access-users">
                                    <label for="edit-access-users">User Management</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="edit-access-settings">
                                    <label for="edit-access-settings">Settings Access</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="action-buttons" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary modal-close-btn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Location Modal -->
    <div id="addLocationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Location</h3>
                <button class="modal-close">&times;</button>
            </div>
            <form id="addLocationForm">
                <div class="form-section">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="locationName">Location Name *</label>
                            <input type="text" id="locationName" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="locationAddress">Address</label>
                            <input type="text" id="locationAddress" class="form-control">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="locationDescription">Description</label>
                            <textarea id="locationDescription" class="form-control" rows="3"></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary modal-close-btn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Location</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <!-- Moment.js for date formatting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <!-- Custom scripts -->
    <script src="js/datetime-utils.js"></script>
    <script src="js/main.js"></script>
    <script src="js/header-loader.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.firebasestorage.app",
            messagingSenderId: "829083030831",
            appId: "1:829083030831:web:36a370e62691e560bc3dda"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM fully loaded - setting up event listeners");
            
            // Fix the sign out button event listener
            const signOutBtn = document.getElementById('signOutBtn');
            if (signOutBtn) {
                signOutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    auth.signOut().then(() => {
                        console.log('User signed out');
                        window.location.href = 'login.html';
                    }).catch((error) => {
                        console.error('Sign out error:', error);
                    });
                });
            } else {
                console.error("Sign out button not found in the document");
            }
            
            // User avatar dropdown functionality - fixed version
            const userAvatar = document.querySelector('.user-avatar');
            if (userAvatar) {
                userAvatar.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log("Avatar clicked");
                    
                    const userMenu = this.querySelector('.user-menu');
                    if (userMenu) {
                        userMenu.classList.toggle('show');
                    }
                });
                
                // Close when clicking outside
                document.addEventListener('click', function(e) {
                    if (!userAvatar.contains(e.target)) {
                        const userMenu = userAvatar.querySelector('.user-menu');
                        if (userMenu && userMenu.classList.contains('show')) {
                            userMenu.classList.remove('show');
                        }
                    }
                });
            } else {
                console.error("User avatar element not found");
            }

            // Tab switching functionality
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Remove active class from all buttons and contents
                    tabBtns.forEach(b => b.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked button and corresponding content
                    this.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // Modal functionality
            const modals = document.querySelectorAll('.modal');
            const addUserBtn = document.getElementById('addUserBtn');
            const addRoleBtn = document.getElementById('addRoleBtn');
            const addDeptBtn = document.getElementById('addDeptBtn');
            const modalCloseBtns = document.querySelectorAll('.modal-close, .modal-close-btn');
            
            // Open modals
            addUserBtn.addEventListener('click', function() {
                document.getElementById('addUserModal').style.display = 'block';
            });
            
            addRoleBtn.addEventListener('click', function() {
                document.getElementById('addRoleModal').style.display = 'block';
            });
            
            addDeptBtn.addEventListener('click', function() {
                document.getElementById('addDeptModal').style.display = 'block';
            });
            
            // Close modals
            modalCloseBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    modals.forEach(modal => {
                        modal.style.display = 'none';
                    });
                });
            });
            
            // Close modal when clicking outside
            window.addEventListener('click', function(event) {
                modals.forEach(modal => {
                    if (event.target == modal) {
                        modal.style.display = 'none';
                    }
                });
            });
            
            // Load users from Firebase
            function loadUsers() {
                const userTableBody = document.getElementById('userTableBody');
                
                // Set up real-time listener for users
                database.ref('users').on('value', snapshot => {
                    userTableBody.innerHTML = ''; // Clear existing rows
                    
                    // Reset counters
                    let totalUsers = 0;
                    let activeUsers = 0;
                    let pendingUsers = 0;
                    let inactiveUsers = 0;
                    
                    if (snapshot.exists()) {
                        // First, get all departments to create a lookup map
                        database.ref('departments').once('value')
                            .then(deptSnapshot => {
                                const departments = {};
                                if (deptSnapshot.exists()) {
                                    deptSnapshot.forEach(dept => {
                                        departments[dept.key] = dept.val().name;
                                    });
                                }
                                
                                // Now create user rows with department names
                                snapshot.forEach(userSnapshot => {
                                    const user = userSnapshot.val();
                                    const userRow = document.createElement('tr');
                                    
                                    // Update counters
                                    totalUsers++;
                                    if (user.status === 'active') activeUsers++;
                                    else if (user.status === 'pending') pendingUsers++;
                                    else if (user.status === 'inactive') inactiveUsers++;
                                    
                                    // Create user avatar or initial
                                    const userInitial = user.firstName ? user.firstName.charAt(0).toUpperCase() : '?';
                                    
                                    // Determine status class
                                    let statusClass = '';
                                    switch(user.status) {
                                        case 'active':
                                            statusClass = 'status-active';
                                            break;
                                        case 'inactive':
                                            statusClass = 'status-inactive';
                                            break;
                                        case 'pending':
                                            statusClass = 'status-pending';
                                            break;
                                    }
                                    
                                    // Get department name from the lookup map
                                    const departmentName = departments[user.department] || 'N/A';
                                    
                                    userRow.innerHTML = `
                                        <td class="user-avatar-cell">
                                            <div class="user-initial-sm">${userInitial}</div>
                                        </td>
                                        <td>${user.firstName} ${user.lastName}</td>
                                        <td>${user.email}</td>
                                        <td>${user.role || 'N/A'}</td>
                                        <td>${departmentName}</td>
                                        <td>${user.jobTitle || 'N/A'}</td>
                                        <td>
                                            <span class="user-status ${statusClass}">
                                                ${user.status ? user.status.charAt(0).toUpperCase() + user.status.slice(1) : 'N/A'}
                                            </span>
                                        </td>
                                        <td class="user-actions">
                                            <button class="btn btn-sm btn-edit" data-id="${userSnapshot.key}">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-delete" data-id="${userSnapshot.key}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    `;
                                    
                                    userTableBody.appendChild(userRow);
                                });
                                
                                // Update stats
                                document.getElementById('totalUsersCount').textContent = totalUsers;
                                document.getElementById('activeUsersCount').textContent = activeUsers;
                                document.getElementById('pendingUsersCount').textContent = pendingUsers;
                                document.getElementById('inactiveUsersCount').textContent = inactiveUsers;
                                
                                // Add event listeners to edit and delete buttons
                                document.querySelectorAll('.btn-edit').forEach(btn => {
                                    btn.addEventListener('click', function() {
                                        const userId = this.getAttribute('data-id');
                                        editUser(userId);
                                    });
                                });
                                
                                document.querySelectorAll('.btn-delete').forEach(btn => {
                                    btn.addEventListener('click', function() {
                                        const userId = this.getAttribute('data-id');
                                        if (confirm('Are you sure you want to delete this user?')) {
                                            // Delete user from Firebase
                                            database.ref(`users/${userId}`).remove()
                                                .then(() => {
                                                    alert('User deleted successfully');
                                                    loadUsers(); // Reload the user list
                                                })
                                                .catch(error => {
                                                    alert(`Error deleting user: ${error.message}`);
                                                });
                                        }
                                    });
                                });
                            });
                    } else {
                        userTableBody.innerHTML = `
                            <tr>
                                <td colspan="7" style="text-align: center;">No users found</td>
                            </tr>
                        `;
                    }
                });
            }
            
            // Load roles function
            function loadRoles() {
                // ...existing code...
            }
            
            // Load departments function
            function loadDepartments() {
                const deptTableBody = document.getElementById('deptTableBody');
                deptTableBody.innerHTML = ''; // Clear existing rows
                
                // Set up a real-time listener for departments
                database.ref('departments').on('value', snapshot => {
                    deptTableBody.innerHTML = ''; // Clear the table on each update
                    
                    if (snapshot.exists()) {
                        snapshot.forEach(deptSnapshot => {
                            const dept = deptSnapshot.val();
                            const deptId = deptSnapshot.key;
                            
                            // Get manager name if available
                            let managerName = 'Not assigned';
                            if (dept.manager) {
                                // Fetch manager name from users collection
                                database.ref('users/' + dept.manager).once('value')
                                    .then(userSnapshot => {
                                        if (userSnapshot.exists()) {
                                            const manager = userSnapshot.val();
                                            managerName = `${manager.firstName} ${manager.lastName}`;
                                            // Update the manager cell in the table
                                            const managerCell = document.querySelector(`#dept-manager-${deptId}`);
                                            if (managerCell) {
                                                managerCell.textContent = managerName;
                                            }
                                        }
                                    });
                            }
                            
                            // Count members in department
                            database.ref('users').orderByChild('department').equalTo(deptId).once('value')
                                .then(usersSnapshot => {
                                    const memberCount = usersSnapshot.exists() ? Object.keys(usersSnapshot.val()).length : 0;
                                    
                                    // Update the members cell in the table
                                    const membersCell = document.querySelector(`#dept-members-${deptId}`);
                                    if (membersCell) {
                                        membersCell.textContent = memberCount;
                                    }
                                });
                            
                            // Create table row
                            const deptRow = document.createElement('tr');
                            deptRow.innerHTML = `
                                <td>${dept.name}</td>
                                <td id="dept-manager-${deptId}">${managerName}</td>
                                <td id="dept-members-${deptId}">Loading...</td>
                                <td class="user-actions">
                                    <button class="btn btn-sm btn-edit" onclick="editDepartment('${deptId}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-delete" onclick="deleteDepartment('${deptId}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            `;
                            
                            deptTableBody.appendChild(deptRow);
                        });
                    } else {
                        deptTableBody.innerHTML = `
                            <tr>
                                <td colspan="4" style="text-align: center;">No departments found</td>
                            </tr>
                        `;
                    }
                });
            }
            
            // Load department options for dropdowns
            function loadDepartmentOptions() {
                const departmentSelectAdd = document.getElementById('department');
                const departmentSelectEdit = document.getElementById('editDepartment');
                const lineManagerSelect = document.getElementById('lineManager');
                const editLineManagerSelect = document.getElementById('editLineManager');
                
                // Clear existing options helper function
                function clearOptions(select) {
                    while (select && select.options.length > 1) {
                        select.remove(1);
                    }
                }
                
                // Load departments
                database.ref('departments').on('value', snapshot => {
                    clearOptions(departmentSelectAdd);
                    clearOptions(departmentSelectEdit);
                    
                    if (snapshot.exists()) {
                        snapshot.forEach(deptSnapshot => {
                            const dept = deptSnapshot.val();
                            
                            if (departmentSelectAdd) {
                                const addOption = document.createElement('option');
                                addOption.value = deptSnapshot.key;
                                addOption.textContent = dept.name;
                                departmentSelectAdd.appendChild(addOption);
                            }
                            
                            if (departmentSelectEdit) {
                                const editOption = document.createElement('option');
                                editOption.value = deptSnapshot.key;
                                editOption.textContent = dept.name;
                                departmentSelectEdit.appendChild(editOption);
                            }
                        });
                    }
                });

                // Load users for line manager selection
                database.ref('users').on('value', snapshot => {
                    clearOptions(lineManagerSelect);
                    clearOptions(editLineManagerSelect);
                    
                    if (snapshot.exists()) {
                        const users = [];
                        snapshot.forEach(userSnapshot => {
                            const user = userSnapshot.val();
                            users.push({
                                id: userSnapshot.key,
                                name: `${user.firstName} ${user.lastName}`
                            });
                        });

                        // Sort users by name
                        users.sort((a, b) => a.name.localeCompare(b.name));

                        // Add users to line manager dropdowns
                        users.forEach(user => {
                            if (lineManagerSelect) {
                                const option = document.createElement('option');
                                option.value = user.id;
                                option.textContent = user.name; // Only show the name
                                lineManagerSelect.appendChild(option);
                            }
                            
                            if (editLineManagerSelect) {
                                const option = document.createElement('option');
                                option.value = user.id;
                                option.textContent = user.name; // Only show the name
                                editLineManagerSelect.appendChild(option);
                            }
                        });
                    }
                });
            }
            
            // Delete department function
            window.deleteDepartment = function(deptId) {
                if (confirm('Are you sure you want to delete this department? Users in this department will need to be reassigned.')) {
                    // Show loading overlay
                    document.getElementById('loadingOverlay').style.display = 'flex';
                    
                    // Check if any users are in this department
                    database.ref('users').orderByChild('department').equalTo(deptId).once('value')
                        .then(snapshot => {
                            if (snapshot.exists()) {
                                const userCount = Object.keys(snapshot.val()).length;
                                if (userCount > 0) {
                                    if (!confirm(`This department has ${userCount} users assigned to it. Deleting it may affect these users. Do you still want to proceed?`)) {
                                        document.getElementById('loadingOverlay').style.display = 'none';
                                        return;
                                    }
                                }
                            }
                            
                            // Delete the department
                            database.ref('departments/' + deptId).remove()
                                .then(() => {
                                    document.getElementById('loadingOverlay').style.display = 'none';
                                    alert('Department deleted successfully!');
                                    // The real-time listener will update the UI
                                })
                                .catch(error => {
                                    document.getElementById('loadingOverlay').style.display = 'none';
                                    console.error('Error deleting department:', error);
                                    alert('Error deleting department: ' + error.message);
                                });
                        })
                        .catch(error => {
                            document.getElementById('loadingOverlay').style.display = 'none';
                            console.error('Error checking users in department:', error);
                            alert('Error checking users in department: ' + error.message);
                        });
                }
            };
            
            // Edit department function
            window.editDepartment = function(deptId) {
                // Implementation for editing departments will go here
                alert('Edit department functionality will be implemented in a future update.');
            };
            
            // Function to load user data into edit form
            function editUser(userId) {
                // Show loading overlay during data fetch
                document.getElementById('loadingOverlay').style.display = 'flex';
                
                // Get user data
                database.ref('users/' + userId).once('value')
                    .then(snapshot => {
                        // Hide loading overlay
                        document.getElementById('loadingOverlay').style.display = 'none';
                        
                        if (snapshot.exists()) {
                            const userData = snapshot.val();
                            
                            // Set hidden user ID field
                            document.getElementById('editUserId').value = userId;
                            
                            // Populate form fields with user data
                            document.getElementById('editFirstName').value = userData.firstName || '';
                            document.getElementById('editLastName').value = userData.lastName || '';
                            document.getElementById('editGender').value = userData.gender || '';
                            document.getElementById('editEmployeeId').value = userData.employeeId || '';
                            document.getElementById('editEmail').value = userData.email || '';
                            document.getElementById('editPhone').value = userData.phone || '';
                            document.getElementById('editUsername').value = userData.username || '';
                            document.getElementById('editRole').value = userData.role || '';
                            document.getElementById('editJobTitle').value = userData.jobTitle || '';
                            document.getElementById('editStatus').value = userData.status || 'active';
                            
                            // Set line manager if available
                            if (userData.lineManager) {
                                document.getElementById('editLineManager').value = userData.lineManager;
                            }
                            
                            // Set access rights checkboxes
                            if (userData.accessRights) {
                                document.getElementById('edit-access-dashboard').checked = userData.accessRights.dashboard || false;
                                document.getElementById('edit-access-jsa').checked = userData.accessRights.jsa || false;
                                document.getElementById('edit-access-risk').checked = userData.accessRights.risk || false;
                                document.getElementById('edit-access-events').checked = userData.accessRights.events || false;
                                document.getElementById('edit-access-inspections').checked = userData.accessRights.inspections || false;
                                document.getElementById('edit-access-reports').checked = userData.accessRights.reports || false;
                                document.getElementById('edit-access-users').checked = userData.accessRights.users || false;
                                document.getElementById('edit-access-settings').checked = userData.accessRights.settings || false;
                            } else {
                                // Reset checkboxes if no access rights are defined
                                document.getElementById('edit-access-dashboard').checked = false;
                                document.getElementById('edit-access-jsa').checked = false;
                                document.getElementById('edit-access-risk').checked = false;
                                document.getElementById('edit-access-events').checked = false;
                                document.getElementById('edit-access-inspections').checked = false;
                                document.getElementById('edit-access-reports').checked = false;
                                document.getElementById('edit-access-users').checked = false;
                                document.getElementById('edit-access-settings').checked = false;
                            }
                            
                            // Load departments for edit form
                            loadEditDepartmentOptions(userData.department);
                            
                            // Load options for fields
                            const editGenderSelect = document.getElementById('editGender');
                            const editRoleSelect = document.getElementById('editRole');
                            const editStatusSelect = document.getElementById('editStatus');
                            
                            // Load gender options from settings
                            loadFieldOptionsFromSettings('user-gender', editGenderSelect);
                            loadFieldOptionsFromSettings('user-role', editRoleSelect);
                            loadFieldOptionsFromSettings('account-status', editStatusSelect);
                            
                            // Show the edit modal
                            document.getElementById('editUserModal').style.display = 'block';
                        } else {
                            alert('User not found');
                        }
                    })
                    .catch(error => {
                        // Hide loading overlay in case of error
                        document.getElementById('loadingOverlay').style.display = 'none';
                        
                        console.error('Error loading user data:', error);
                        alert('Error loading user data: ' + error.message);
                    });
            }
            
            // Load department options for edit form
            function loadEditDepartmentOptions(selectedDepartment) {
                const departmentSelect = document.getElementById('editDepartment');
                
                // Clear existing options except the first one
                while (departmentSelect.options.length > 1) {
                    departmentSelect.remove(1);
                }
                
                database.ref('departments').once('value')
                    .then(snapshot => {
                        if (snapshot.exists()) {
                            snapshot.forEach(deptSnapshot => {
                                const dept = deptSnapshot.val();
                                const option = document.createElement('option');
                                option.value = deptSnapshot.key;
                                option.textContent = dept.name;
                                departmentSelect.appendChild(option);
                            });
                            
                            // Set the selected department if provided
                            if (selectedDepartment) {
                                departmentSelect.value = selectedDepartment;
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error loading department options:', error);
                    });
            }
            
            // Handle edit user form submission
            const editUserForm = document.getElementById('editUserForm');
            editUserForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Get the user ID from hidden field
                const userId = document.getElementById('editUserId').value;
                
                // Get updated user data
                const updatedUser = {
                    firstName: document.getElementById('editFirstName').value,
                    lastName: document.getElementById('editLastName').value,
                    gender: document.getElementById('editGender').value,
                    employeeId: document.getElementById('editEmployeeId').value,
                    email: document.getElementById('editEmail').value,
                    phone: document.getElementById('editPhone').value,
                    username: document.getElementById('editUsername').value,
                    role: document.getElementById('editRole').value,
                    department: document.getElementById('editDepartment').value,
                    jobTitle: document.getElementById('editJobTitle').value,
                    lineManager: document.getElementById('editLineManager').value,
                    status: document.getElementById('editStatus').value,
                    accessRights: {
                        dashboard: document.getElementById('edit-access-dashboard').checked,
                        jsa: document.getElementById('edit-access-jsa').checked,
                        risk: document.getElementById('edit-access-risk').checked,
                        events: document.getElementById('edit-access-events').checked,
                        inspections: document.getElementById('edit-access-inspections').checked,
                        reports: document.getElementById('edit-access-reports').checked,
                        users: document.getElementById('edit-access-users').checked,
                        settings: document.getElementById('edit-access-settings').checked
                    },
                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                };
                
                // Show loading overlay
                document.getElementById('loadingOverlay').style.display = 'flex';
                
                // Update user in Firebase
                database.ref('users/' + userId).update(updatedUser)
                    .then(() => {
                        // Hide loading overlay
                        document.getElementById('loadingOverlay').style.display = 'none';
                        
                        // Close modal
                        document.getElementById('editUserModal').style.display = 'none';
                        
                        // Show success message
                        alert('User updated successfully!');
                    })
                    .catch(error => {
                        // Hide loading overlay
                        document.getElementById('loadingOverlay').style.display = 'none';
                        console.error('Error updating user:', error);
                        alert('Error updating user: ' + error.message);
                    });
            });

            // Populate department dropdown in the add user form
            // ...existing code...
            
            // Handle user form submission
            // ...existing code...
            
            // Handle department form submission
            const addDeptForm = document.getElementById('addDeptForm');
            addDeptForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Get form data
                const deptName = document.getElementById('deptName').value;
                const deptManager = document.getElementById('deptManager').value;
                const deptDescription = document.getElementById('deptDescription').value;
                
                // Create department object (remove people array)
                const department = {
                    name: deptName,
                    manager: deptManager,
                    description: deptDescription,
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                };
                
                // Generate a unique key for the department
                const newDeptRef = database.ref('departments').push();
                
                // Show loading overlay
                document.getElementById('loadingOverlay').style.display = 'flex';
                
                // Save department to Firebase
                newDeptRef.set(department)
                    .then(() => {
                        // Hide loading overlay
                        document.getElementById('loadingOverlay').style.display = 'none';
                        
                        // Reset form
                        addDeptForm.reset();
                        
                        // Close modal
                        document.getElementById('addDeptModal').style.display = 'none';
                        
                        // Show success message
                        alert('Department created successfully!');
                        
                        // No need to manually reload departments as the real-time listener will handle it
                    })
                    .catch(error => {
                        // Hide loading overlay
                        document.getElementById('loadingOverlay').style.display = 'none';
                        
                        console.error('Error creating department:', error);
                        alert('Error creating department: ' + error.message);
                    });
            });
            
            // Handle role form submission
            // ...existing code...
            
            // Handle department form submission
            // ...existing code...
            
            // Initialize the page
            loadUsers();
            loadRoles();
            loadDepartments();
            loadDepartmentOptions();
            loadLocations(); // Add this line
            
            // Handle search functionality
            document.getElementById('userSearch').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const userRows = document.querySelectorAll('#userTableBody tr');
                
                userRows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    if (text.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });

            // Add this to your Firebase script section
            const signOutButton = document.getElementById('signOutBtn');
            if (signOutButton) {
                console.log("Found sign out button, adding event listener");
                signOutButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log("Sign out button clicked");
                    
                    // Show loading indicator
                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing out...';
                    this.disabled = true;
                    
                    auth.signOut().then(() => {
                        console.log('User signed out successfully');
                        // Clear any stored user data
                        localStorage.clear();
                        sessionStorage.clear();
                        // Redirect to login
                        window.location.href = 'login.html';
                    }).catch((error) => {
                        console.error('Sign out error:', error);
                        alert('Error signing out: ' + error.message);
                        // Reset button if error
                        this.innerHTML = '<i class="fas fa-sign-out-alt"></i> Sign Out';
                        this.disabled = false;
                    });
                });
            } else {
                console.error("Sign out button not found");
            }

            // Location management functions
            function loadLocations() {
                const locationTableBody = document.getElementById('locationTableBody');
                locationTableBody.innerHTML = ''; // Clear existing rows
                
                // Set up a real-time listener for locations
                database.ref('locations').on('value', snapshot => {
                    locationTableBody.innerHTML = ''; // Clear the table on each update
                    
                    if (snapshot.exists()) {
                        snapshot.forEach(locationSnapshot => {
                            const location = locationSnapshot.val();
                            const locationId = locationSnapshot.key;
                            
                            // Count users at this location
                            database.ref('users').orderByChild('location').equalTo(locationId).once('value')
                                .then(usersSnapshot => {
                                    const userCount = usersSnapshot.exists() ? Object.keys(usersSnapshot.val()).length : 0;
                                    
                                    // Update the users cell in the table
                                    const usersCell = document.querySelector(`#location-users-${locationId}`);
                                    if (usersCell) {
                                        usersCell.textContent = userCount;
                                    }
                                });
                            
                            // Create table row
                            const locationRow = document.createElement('tr');
                            locationRow.innerHTML = `
                                <td>${location.name}</td>
                                <td>${location.description || 'N/A'}</td>
                                <td id="location-users-${locationId}">Loading...</td>
                                <td class="user-actions">
                                    <button class="btn btn-sm btn-edit" onclick="editLocation('${locationId}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-delete" onclick="deleteLocation('${locationId}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            `;
                            
                            locationTableBody.appendChild(locationRow);
                        });
                    } else {
                        locationTableBody.innerHTML = `
                            <tr>
                                <td colspan="4" style="text-align: center;">No locations found</td>
                        `;
                    }
                });
            }
            
            // Delete location function
            window.deleteLocation = function(locationId) {
                if (confirm('Are you sure you want to delete this location? Users at this location will need to be reassigned.')) {
                    // Show loading overlay
                    document.getElementById('loadingOverlay').style.display = 'flex';
                    
                    // Check if any users are at this location
                    database.ref('users').orderByChild('location').equalTo(locationId).once('value')
                        .then(snapshot => {
                            if (snapshot.exists()) {
                                const userCount = Object.keys(snapshot.val()).length;
                                if (userCount > 0) {
                                    if (!confirm(`This location has ${userCount} users assigned to it. Deleting it may affect these users. Do you still want to proceed?`)) {
                                        document.getElementById('loadingOverlay').style.display = 'none';
                                        return;
                                    }
                                }
                            }
                            
                            // Delete the location
                            database.ref('locations/' + locationId).remove()
                                .then(() => {
                                    document.getElementById('loadingOverlay').style.display = 'none';
                                    alert('Location deleted successfully!');
                                    // The real-time listener will update the UI
                                })
                                .catch(error => {
                                    document.getElementById('loadingOverlay').style.display = 'none';
                                    console.error('Error deleting location:', error);
                                    alert('Error deleting location: ' + error.message);
                                });
                        })
                        .catch(error => {
                            document.getElementById('loadingOverlay').style.display = 'none';
                            console.error('Error checking users at location:', error);
                            alert('Error checking users at location: ' + error.message);
                        });
                }
            };
            
            // Edit location function
            window.editLocation = function(locationId) {
                // Implementation for editing locations will go here
                alert('Edit location functionality will be implemented in a future update.');
            };
            
            // Handle location form submission
            const addLocationForm = document.getElementById('addLocationForm');
            const addLocationBtn = document.getElementById('addLocationBtn');
            
            // Make sure we have a button event listener
            if (addLocationBtn) {
                addLocationBtn.addEventListener('click', function() {
                    document.getElementById('addLocationModal').style.display = 'block';
                });
            }
            
            // Handle form submission
            addLocationForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Get form data
                const locationName = document.getElementById('locationName').value;
                const locationAddress = document.getElementById('locationAddress').value;
                const locationDescription = document.getElementById('locationDescription').value;
                
                // Create location object
                const location = {
                    name: locationName,
                    address: locationAddress,
                    description: locationDescription,
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                };
                
                // Generate a unique key for the location
                const newLocationRef = database.ref('locations').push();
                
                // Show loading overlay
                document.getElementById('loadingOverlay').style.display = 'flex';
                
                // Save location to Firebase
                newLocationRef.set(location)
                    .then(() => {
                        // Hide loading overlay
                        document.getElementById('loadingOverlay').style.display = 'none';
                        
                        // Reset form
                        addLocationForm.reset();
                        
                        // Close modal
                        document.getElementById('addLocationModal').style.display = 'none';
                        
                        // Show success message
                        alert('Location created successfully!');
                    })
                    .catch(error => {
                        // Hide loading overlay
                        document.getElementById('loadingOverlay').style.display = 'none';
                        
                        console.error('Error creating location:', error);
                        alert('Error creating location: ' + error.message);
                    });
            });

            // Add this new function to load field options from Firebase
            function loadFieldOptionsFromSettings(fieldType, selectElement) {
                database.ref(`fieldOptions/${fieldType}`).once('value')
                    .then(snapshot => {
                        // Clear existing options except the first one
                        while (selectElement.options.length > 1) {
                            selectElement.remove(1);
                        }

                        if (snapshot.exists()) {
                            snapshot.forEach(optionSnapshot => {
                                const option = optionSnapshot.val();
                                if (option.enabled) {
                                    const optElement = document.createElement('option');
                                    optElement.value = option.value;
                                    optElement.textContent = option.label;
                                    selectElement.appendChild(optElement);
                                }
                            });
                        } else {
                            console.log(`No options found for ${fieldType}`);
                        }
                    })
                    .catch(error => {
                        console.error(`Error loading ${fieldType} options:`, error);
                    });
            }

            // Modify the modal opening event to load field options
            addUserBtn.addEventListener('click', function() {
                const genderSelect = document.getElementById('gender');
                const roleSelect = document.getElementById('role');
                const statusSelect = document.getElementById('status');

                // Load options for each field
                loadFieldOptionsFromSettings('user-gender', genderSelect);
                loadFieldOptionsFromSettings('user-role', roleSelect);
                loadFieldOptionsFromSettings('account-status', statusSelect);

                document.getElementById('addUserModal').style.display = 'block';
            });

            // Similarly, modify the edit user function to load options
            function editUser(userId) {
                // Show loading overlay during data fetch
                document.getElementById('loadingOverlay').style.display = 'flex';
                
                // Get user data
                database.ref('users/' + userId).once('value')
                    .then(snapshot => {
                        // Hide loading overlay
                        document.getElementById('loadingOverlay').style.display = 'none';
                        
                        if (snapshot.exists()) {
                            const userData = snapshot.val();
                            
                            // Set hidden user ID field
                            document.getElementById('editUserId').value = userId;
                            
                            // Populate form fields with user data
                            document.getElementById('editFirstName').value = userData.firstName || '';
                            document.getElementById('editLastName').value = userData.lastName || '';
                            document.getElementById('editGender').value = userData.gender || '';
                            document.getElementById('editEmployeeId').value = userData.employeeId || '';
                            document.getElementById('editEmail').value = userData.email || '';
                            document.getElementById('editPhone').value = userData.phone || '';
                            document.getElementById('editUsername').value = userData.username || '';
                            document.getElementById('editRole').value = userData.role || '';
                            document.getElementById('editJobTitle').value = userData.jobTitle || '';
                            document.getElementById('editStatus').value = userData.status || 'active';
                            
                            // Set line manager if available
                            if (userData.lineManager) {
                                document.getElementById('editLineManager').value = userData.lineManager;
                            }
                            
                            // Set access rights checkboxes
                            if (userData.accessRights) {
                                document.getElementById('edit-access-dashboard').checked = userData.accessRights.dashboard || false;
                                document.getElementById('edit-access-jsa').checked = userData.accessRights.jsa || false;
                                document.getElementById('edit-access-risk').checked = userData.accessRights.risk || false;
                                document.getElementById('edit-access-events').checked = userData.accessRights.events || false;
                                document.getElementById('edit-access-inspections').checked = userData.accessRights.inspections || false;
                                document.getElementById('edit-access-reports').checked = userData.accessRights.reports || false;
                                document.getElementById('edit-access-users').checked = userData.accessRights.users || false;
                                document.getElementById('edit-access-settings').checked = userData.accessRights.settings || false;
                            } else {
                                // Reset checkboxes if no access rights are defined
                                document.getElementById('edit-access-dashboard').checked = false;
                                document.getElementById('edit-access-jsa').checked = false;
                                document.getElementById('edit-access-risk').checked = false;
                                document.getElementById('edit-access-events').checked = false;
                                document.getElementById('edit-access-inspections').checked = false;
                                document.getElementById('edit-access-reports').checked = false;
                                document.getElementById('edit-access-users').checked = false;
                                document.getElementById('edit-access-settings').checked = false;
                            }
                            
                            // Load departments for edit form
                            loadEditDepartmentOptions(userData.department);
                            
                            // Load options for fields
                            const editRoleSelect = document.getElementById('editRole');
                            const editStatusSelect = document.getElementById('editStatus');
                            loadFieldOptionsFromSettings('user-role', editRoleSelect);
                            loadFieldOptionsFromSettings('account-status', editStatusSelect);
                            
                            // Show the edit modal
                            document.getElementById('editUserModal').style.display = 'block';
                        } else {
                            alert('User not found');
                        }
                    })
                    .catch(error => {
                        // Hide loading overlay in case of error
                        document.getElementById('loadingOverlay').style.display = 'none';
                        
                        console.error('Error loading user data:', error);
                        alert('Error loading user data: ' + error.message);
                    });
            }

            // Listen for field options changes from settings.html
            document.addEventListener('fieldOptionsChanged', function(event) {
                if (event.detail && event.detail.fieldType === 'user-gender') {
                    // Reload gender options for both add and edit forms
                    const genderSelect = document.getElementById('gender');
                    const editGenderSelect = document.getElementById('editGender');
                    loadFieldOptionsFromSettings('user-gender', genderSelect);
                    loadFieldOptionsFromSettings('user-gender', editGenderSelect);
                }
            });

            // Check localStorage for updates from settings page
            window.addEventListener('storage', function(event) {
                if (event.key === 'fieldOptionsUpdated') {
                    try {
                        const data = JSON.parse(event.newValue);
                        if (data && data.fieldType === 'user-gender') {
                            // Reload gender options for both add and edit forms
                            const genderSelect = document.getElementById('gender');
                            const editGenderSelect = document.getElementById('editGender');
                            loadFieldOptionsFromSettings('user-gender', genderSelect);
                            loadFieldOptionsFromSettings('user-gender', editGenderSelect);
                        }
                    } catch (e) {
                        console.error('Error parsing localStorage update:', e);
                    }
                }
            });
        });
    </script>
</body>
</html>