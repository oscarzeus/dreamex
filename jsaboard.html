<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSA Board - Dreamex Lab</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Dashboard specific styles */
        .dashboard-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 30px;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }
        .menu-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #34495e;
            padding: 0 20px;
        }
        
        .menu-bar ul {
            display: flex;
            align-items: center;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .menu-bar ul li {
            margin: 0 10px;
        }
        
        .menu-bar ul li a {
            display: block;
            padding: 15px 10px;
            color: #ecf0f1;
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .menu-bar ul li a:hover {
            color: #f1f3f5;
        }
        
        .menu-bar ul li.current a {
            color: #fafcfd;
            font-weight: bold;
        }

        /* Dropdown styles */
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white !important;
            color: black !important;
            min-width: 160px;
            box-shadow: 0px 8px 16px rgba(0,0,0,0.2);
            z-index: 1;
            top: calc(100%);
            font-size: 6px !important;
            font-weight: normal;
            text-align: left;
        }
        .dropdown-content a {
            color: rgb(44, 43, 43) !important;
            padding: 6px 10px !important;
            text-decoration: none;  
            display: block;
            font-size: 11px !important;
        }
        .dropdown-content a:hover {
            background-color: #e8e8e8;
            transform: none; 
        }
        .dropdown:hover .dropdown-content,
        .dropdown:focus-within .dropdown-content {
            display: block;
        }
        /* ...existing code... */

        /* JSA Board specific styles */
        .event-board-container {
            max-width: 100%; /* Changed from 1200px to full width */
            margin: 80px 20px 20px 20px; /* Increased top margin to 80px for 4x spacing */
            padding: 30px;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .event-title h2 {
            margin: 0;
            color: #34495e;
        }

        .event-title p {
            margin: 5px 0 0;
            color: #7f8c8d;
            font-size: 14px;
        }

        .event-filters {
            display: flex;
            flex-direction: column;
            gap: 20px;  /* Increased from 15px for better spacing */
            margin-bottom: 25px;
            padding: 25px;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .filter-inputs {
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap;
            gap: 15px;
            width: 100%;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 0; /* Allow fields to shrink below min-width */
        }

        /* Add responsive handling for very small screens */
        @media (max-width: 1200px) {
            .filter-inputs {
                flex-wrap: wrap;
            }
            
            .filter-group {
                min-width: 200px; /* Set minimum width when wrapped */
            }
        }

        .filter-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #34495e;
            font-size: 14px;
        }

        .filter-input {
            height: 40px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 14px;
            transition: all 0.2s ease;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            width: 100%;
            box-sizing: border-box; /* Ensure padding doesn't affect width */
        }

        select.filter-input {
            background-image: url("data:image/svg+xml;utf8,<svg fill='%23555' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/><path d='M0 0h24v24H0z' fill='none'/></svg>");
            background-repeat: no-repeat;
            background-position: right 8px center;
            padding-right: 30px;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }

        .filter-input:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            outline: none;
        }

        .filter-buttons {
            display: flex;
            justify-content: flex-start; /* Changed from flex-end to align buttons to the left */
            gap: 15px;
            margin-top: 10px;
        }

        .filter-btn, .clear-btn {
            height: 40px;
            min-width: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        .event-table-container {
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow-x: auto;
        }

        .event-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .event-table th,
        .event-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .event-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #34495e;
            cursor: pointer;
            font-size: 13px;
            padding: 10px 12px;
        }

        .event-table th:hover {
            background-color: #eaecef;
        }

        .event-table td {
            font-size: 12px;
            padding: 8px 12px;
        }

        .event-table tbody tr:hover {
            background-color: #f5f7fa;
            cursor: pointer;
        }

        /* JSA specific status styles */
        .risk-high { 
            background-color: #e74c3c; 
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        .risk-medium { 
            background-color: #f39c12; 
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        .risk-low { 
            background-color: #2ecc71; 
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .status-pending { color: #f39c12; }
        .status-approved { color: #2ecc71; }
        .status-rejected { color: #e74c3c; }

        .empty-state {
            padding: 40px;
            text-align: center;
            color: #7f8c8d;
        }

        .event-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .btn-add-event {
            background-color: #2ecc71;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: normal;
            text-decoration: none;
            display: inline-block;
            transition: background-color 0.2s ease;
        }
        
        .btn-add-event:before {
            content: none;
        }
        
        .btn-add-event:hover {
            background-color: #27ae60;
            transform: none;
            box-shadow: none;
        }
        
        /* Filter buttons */
        .filter-btn, .clear-btn {
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: normal;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border: none;
            box-shadow: none;
            min-width: auto;
        }
        
        .filter-btn {
            background-color: #3498db;
            color: white;
            background-image: none;
        }
        
        .clear-btn {
            background-color: #e74c3c;
            color: white;
            background-image: none;
        }
        
        .filter-btn:hover, .clear-btn:hover {
            transform: none;
            box-shadow: none;
        }
        
        .filter-btn:hover {
            background-color: #2980b9;
        }
        
        .clear-btn:hover {
            background-color: #c0392b;
        }
        
        /* Table action buttons */
        .btn-edit, .btn-view, .btn-approve, .btn-reject {
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-edit {
            background-color: #3498db;
            color: white;
        }
        
        .btn-view {
            background-color: #95a5a6;
            color: white;
        }
        
        .btn-edit:hover, .btn-view:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 5px rgba(0,0,0,0.2);
        }
        
        .btn-edit:hover {
            background: linear-gradient(to bottom, #2980b9, #2471a3);
        }
        
        .btn-view:hover {
            background: linear-gradient(to bottom, #7f8c8d, #6c7a7d);
        }
        
        /* Pagination buttons */
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        
        .pagination button {
            padding: 8px 12px;
            margin: 0 5px;
            border: 1px solid #ddd;
            background-color: #fff;
            color: #333;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
            font-weight: normal;
            box-shadow: none;
        }
        
        .pagination button:hover:not(.disabled) {
            background-color: #f5f5f5;
            transform: none;
            box-shadow: none;
        }
        
        .pagination button.active {
            background-color: #3498db;
            color: #fff;
            border-color: #3498db;
            box-shadow: none;
            background-image: none;
        }
        
        /* Modal buttons */
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-btn {
            padding: 10px 16px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: normal;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            min-width: auto;
            box-shadow: none;
        }
        
        .modal-cancel {
            background-color: #f1f2f6;
            color: #333;
            border: none;
            background-image: none;
        }
        
        .modal-btn:hover {
            transform: none;
            box-shadow: none;
        }
        
        .modal-cancel:hover {
            background-color: #e8e8e8;
        }
        
        /* Row highlighting for edited JSA entries */
        .highlighted-row {
            background-color: #fff9c4 !important;
        }
        
        @keyframes highlight-fade {
            0% { background-color: #fffde7; }
            30% { background-color: #fff9c4; }
            100% { background-color: transparent; }
        }
        
        /* Timestamp column specific styles */
        .timestamp-column {
            white-space: nowrap;
            width: 140px;
        }

        /* Edit modal specific styles */
        .edit-form-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .edit-form-full {
            grid-column: span 2;
        }
        
        .edit-form-container label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #34495e;
            font-size: 14px;
        }
        
        .edit-form-container input,
        .edit-form-container select,
        .edit-form-container textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .edit-form-container textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .btn-edit {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
            margin-right: 5px;
        }
        
        .btn-edit:hover {
            background-color: #2980b9;
        }
        
        .btn-view {
            background-color: #95a5a6;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .btn-view:hover {
            background-color: #7f8c8d;
        }

        /* Aligned and improved action buttons */
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 5px;
            white-space: nowrap;
        }
        
        /* Fix conflicts in button styles by providing a single, consolidated style */
        .btn-edit, .btn-view {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 60px;
            text-align: center;
            margin: 0;
        }
        
        .btn-view {
            background-color: #95a5a6;
        }
        
        .btn-approve {
            background-color: #2ecc71;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 60px;
            text-align: center;
        }
        
        .btn-reject {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 60px;
            text-align: center;
        }
        
        .btn-edit:hover {
            background-color: #2980b9;
        }
        
        .btn-view:hover {
            background-color: #7f8c8d;
        }
        
        .btn-approve:hover {
            background-color: #27ae60;
        }
        
        .btn-reject:hover {
            background-color: #c0392b;
        }
        
        /* Remove duplicated button styles that are causing conflicts */
        .btn-edit:hover, .btn-view:hover {
            transform: none;
            box-shadow: none;
        }

        /* Consistent input field sizes */
        .filter-input {
            height: 40px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 14px;
            transition: all 0.2s ease;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            width: 100%;
            box-sizing: border-box; /* Ensure padding doesn't affect width */
        }

        /* Consistent button sizes */
        .filter-btn, 
        .clear-btn {
            height: 40px;
            min-width: 120px;
            padding: 0 16px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: normal;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border: none;
            box-shadow: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Table action buttons with consistent sizing */
        .btn-edit, 
        .btn-view, 
        .btn-approve, 
        .btn-reject {
            min-width: 70px;
            height: 32px;
            padding: 0 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
        }

        /* Form elements consistency */
        input, select, button, .btn-add-event {
            box-sizing: border-box; /* Apply box-sizing to all form elements */
        }

        /* Align add button with other buttons */
        .btn-add-event {
            height: 40px;
            min-width: 120px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Consistent notification bell and user avatar styles */
        .menu-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* Notification bell styles */
        .notification-bell-container {
            position: relative;
        }

        .notification-bell {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.2s ease;
            position: relative;
        }

        .notification-bell:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .bell-icon-svg {
            width: 20px;
            height: 20px;
            fill: none;
            stroke: #555;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .notification-counter {
            position: absolute;
            top: 0;
            right: 0;
            background-color: #e74c3c;
            color: white;
            font-size: 10px;
            min-width: 16px;
            height: 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .notification-dropdown {
            position: absolute;
            top: 45px;
            right: -10px;
            background-color: white;
            width: 320px;
            max-height: 400px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            display: none;
            z-index: 1000;
        }

        .notification-bell:hover + .notification-dropdown,
        .notification-dropdown:hover {
            display: block;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        .notification-header h4 {
            margin: 0;
            font-size: 16px;
            color: #333;
        }

        .notification-header-actions button {
            background: none;
            border: none;
            color: #3498db;
            font-size: 13px;
            cursor: pointer;
            padding: 3px 6px;
        }

        .notification-list {
            max-height: 350px;
            overflow-y: auto;
        }

        .notification-empty {
            padding: 20px;
            text-align: center;
            color: #7f8c8d;
            font-size: 14px;
        }

        /* User avatar styles */
        .user-avatar-container {
            position: relative;
            display: flex;
            align-items: center;
            margin-right: 20px;
            cursor: pointer;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .user-dropdown {
            position: absolute;
            top: 45px;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 0;
            min-width: 200px;
            display: none;
            z-index: 1000;
            text-align: left;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.08);
        }

        /* Add class for showing the dropdown */
        .user-dropdown.show {
            display: block;
            animation: dropdown-fade-in 0.2s ease-out;
        }
        
        .user-email {
            padding: 8px 15px; /* Increased from 5px to 8px */
            border-bottom: 1px solid #eaeaea;
            color: #34495e;
            font-weight: 500;
            background-color: #f8f9fa;
            font-size: 13px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .user-dropdown a {
            display: block;
            padding: 6px 15px; /* Increased from 2px to 6px */
            color: #000000;
            text-decoration: none;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            font-size: 13px;
            line-height: 1.5; /* Increased from 1.4 to 1.5 */
        }
        
        /* Ensure specific dropdown links are black */
        #profileLink, #accountLink {
            color: #474646 !important; /* Pure black color with !important to override any other styles */
        }
        
        .user-dropdown a:hover {
            background-color: #f1f8fe;
            border-left-color: #3498db;
            color: #3498db;
        }
        
        .user-dropdown a:last-child {
            border-top: 1px solid #eaeaea;
        }
        
        #logoutButton {
            color: #e74c3c; /* Keep logout button red */
        }
        
        #logoutButton:hover {
            background-color: #fdeeee;
            border-left-color: #e74c3c;
        }
        
        #loginButton {
            color: #000000; /* Changed to black */
        }
        
        #loginButton:hover {
            background-color: #f1f8fe;
            border-left-color: #3498db;
            color: #3498db;
        }
        
        .user-initial {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Ensure all heading elements are left-aligned */
        h1, h2, h3, h4, h5, h6, .section-title, .modal-title, .card-title, .form-section h3 {
            text-align: left !important;
        }
        
        /* Specifically target modal titles and headers which sometimes get centered */
        .modal-header h3, 
        .modal-title,
        #modalJsaTitle {
            text-align: left !important;
        }
        
        /* Ensure detail section headings are left-aligned */
        .detail-section h4,
        .jsa-details h4 {
            text-align: left !important;
        }
    </style>
    <!-- Add Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <!-- Include auth.js after Firebase SDKs -->
    <script src="js/auth.js"></script>
</head>
<body>
    <header>
        <nav class="menu-bar">
            <ul class="menu-left">
                <li><a href="login.html">Home</a></li>
                <li class="dropdown">
                    <a href="#">Risk Management</a>
                    <div class="dropdown-content">
                        <a href="riskassessment.html">Risk Assessment</a>
                        <a href="jsaboard.html">Job Safety Analysis</a>
                    </div>
                </li>
                <li class="dropdown">
                    <a href="#">Safety reporting</a>
                    <div class="dropdown-content">
                        <a href="eventboard.html">Event</a>
                        <a href="inspectionsboard.html">Inspections</a>
                    </div>
                </li>
                <li class="dropdown">
                    <a href="#">Settings</a>
                    <div class="dropdown-content">
                        <a href="account.html">User account</a>
                        <a href="setup.html">Inspections</a>
                        <a href="log.html">System audit log</a>
                    </div>
                </li>
                <li><a href="dashboard.html">Dashboard</a></li>
            </ul>
            <ul class="menu-right">
                <li class="user-avatar-container">
                    <div id="userAvatarContainer">
                        <img src="https://via.placeholder.com/32" alt="User" class="user-avatar" id="userAvatar" style="display: none;">
                        <div id="userInitial" class="user-initial">?</div>
                    </div>
                    <div class="user-dropdown">
                        <div class="user-email" id="userEmail">Not logged in</div>
                        <a href="profile.html" id="profileLink" style="display: none;">My Profile</a>
                        <a href="#" id="logoutButton" style="display: none;">Log Out</a>
                        <a href="login.html" id="loginButton">Log In</a>
                    </div>
                </li>
            </ul>
        </nav>
    </header>

    <main class="event-board-container">
        <div class="event-header">
            <div class="event-title">
                <h2>Job Safety Analysis Board</h2>
                <p>All submitted JSA forms and their status</p>
            </div>
            <div class="event-actions">
                <a href="jsa.html" class="btn-add-event">Add New JSA</a>
            </div>
        </div>

        <div class="event-filters">
            <div class="filter-inputs">
                <div class="filter-group">
                    <label for="jobTypeFilter">Job Type</label>
                    <select id="jobTypeFilter" class="filter-input">
                        <option value="">All Types</option>
                        <option value="Mechanical">Mechanical</option>
                        <option value="Electrical">Electrical</option>
                        <option value="Maintenance">Maintenance</option>
                        <option value="Construction">Construction</option>
                        <option value="Excavation">Excavation</option>
                        <option value="Working at Heights">Working at Heights</option>
                        <option value="Chemical Handling">Chemical Handling</option>
                        <option value="Confined Space">Confined Space</option>
                        <option value="Hot Work">Hot Work</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="locationFilter">Location</label>
                    <input type="text" id="locationFilter" class="filter-input" placeholder="Filter by location...">
                </div>
                <div class="filter-group">
                    <label for="riskLevelFilter">Risk Level</label>
                    <select id="riskLevelFilter" class="filter-input">
                        <option value="">All Levels</option>
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="statusFilter">Status</label>
                    <select id="statusFilter" class="filter-input">
                        <option value="">All Statuses</option>
                        <option value="Pending">Pending</option>
                        <option value="Approved">Approved</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="searchInput">Search</label>
                    <input type="text" id="searchInput" class="filter-input" placeholder="Search JSAs...">
                </div>
            </div>
            <div class="filter-buttons">
                <button id="resetFiltersBtn" class="clear-btn">Reset</button>
                <button id="applyFiltersBtn" class="filter-btn">Apply Filters</button>
            </div>
        </div>

        <div id="jsaTableContainer" class="event-table-container">
            <table class="event-table" id="jsaTable">
                <thead>
                    <tr>
                        <th data-sort="jobTitle">Job Title</th>
                        <th data-sort="jobType">Job Type</th>
                        <th data-sort="jobDate" class="timestamp-column">Date</th>
                        <th data-sort="location">Location</th>
                        <th data-sort="department">Department</th>
                        <th data-sort="supervisor">Supervisor</th>
                        <th data-sort="riskLevel">Risk Level</th>
                        <th data-sort="createdByName">Created By</th>
                        <th data-sort="approvalStatus">Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="jsaTableBody">
                    <!-- JSA data will be inserted here dynamically -->
                </tbody>
            </table>
        </div>

        <div id="emptyState" class="empty-state" style="display: none;">
            <p>No JSA forms found matching your criteria.</p>
        </div>

        <div id="loadingIndicator" class="event-loading">
            <div class="spinner"></div>
        </div>

        <div class="pagination" id="pagination">
            <!-- Pagination controls will be inserted here dynamically -->
        </div>
    </main>

    <!-- JSA details modal -->
    <div id="jsaDetailsModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3 id="modalJsaTitle">JSA Details</h3>
                <button class="modal-close" id="closeModalBtn">&times;</button>
            </div>
            <div id="jsaDetailsContent">
                <!-- JSA details will be inserted here -->
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-cancel" id="closeJsaBtn">Close</button>
            </div>
        </div>
    </div>

    <script>
    // Initialize Firebase with enhanced domain handling
    let database;
    let auth;

    function initializeFirebase() {
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.appspot.com",
            messagingSenderId: "829083030831",
            appId: "1:829083030831:web:36a370e62691e560bc3dda"
        };
        
        // Check if Firebase is already initialized
        if (firebase.apps.length === 0) {
            console.log("Initializing Firebase");
            firebase.initializeApp(firebaseConfig);
        } else {
            console.log("Firebase already initialized");
        }
        
        database = firebase.database();
        auth = firebase.auth();
        
        // Force browser to persist auth state
        return auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
            .then(() => console.log("Firebase persistence set to LOCAL"))
            .catch(error => console.error("Firebase persistence error:", error));
    }
    
    // Initialize Firebase at script load
    initializeFirebase().then(() => {
        console.log("Firebase initialized successfully");
    }).catch(error => {
        console.error("Firebase initialization failed:", error);
        showError("Failed to initialize Firebase. Please check your connection and try again.");
    });
    
    // Variables for JSA handling
    const JSA_PER_PAGE = 10;
    let allJsas = [];
    let currentPage = 1;
    let sortField = 'createdAt';
    let sortDirection = 'desc';

    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM loaded, setting up JSA board");
        
        // Setup avatar dropdown functionality immediately
        setupAvatarDropdown();
        
        // Set loading state immediately
        showLoading();
        
        // Check authentication with a timeout
        const authTimeout = setTimeout(() => {
            console.warn("Auth check timed out");
            hideLoading();
            showError("Authentication timed out. Please try logging in again.");
            window.location.href = "login.html?redirect=" + encodeURIComponent(window.location.pathname);
        }, 10000);
        
        // Check authentication state
        auth.onAuthStateChanged(user => {
            clearTimeout(authTimeout);
            if (user) {
                console.log("User authenticated:", user.email);
                
                // Update UI for authenticated user
                updateUserDisplay(user);
                
                // Setup real-time listeners first before loading JSAs
                setupRealtimeJsaListeners();
                
                // Load JSAs from Firebase with fallback to local cache
                loadJsasWithFallback();
                
                // Initialize notifications
                if (typeof initializeNotifications === 'function') {
                    initializeNotifications();
                }
                
                // Set up event listeners for filtering, sorting, etc.
                setupEventListeners();
                
                // Listen for cross-window updates
                listenForCrossWindowUpdates();
            } else {
                console.log("Not authenticated, redirecting to login page");
                hideLoading();
                window.location.href = "login.html?redirect=" + encodeURIComponent(window.location.pathname);
            }
        });
    });
    
    // Function to setup avatar dropdown
    function setupAvatarDropdown() {
        console.log("Setting up avatar dropdown");
        const userAvatarContainer = document.getElementById('userAvatarContainer');
        const userDropdown = document.querySelector('.user-dropdown');
        
        if (userAvatarContainer && userDropdown) {
            // Toggle dropdown when clicking the avatar
            userAvatarContainer.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent event from bubbling up
                userDropdown.classList.toggle('show');
            });
            
            // Close dropdown when clicking anywhere else
            document.addEventListener('click', function(e) {
                if (userDropdown.classList.contains('show')) {
                    userDropdown.classList.remove('show');
                }
            });
            
            // Prevent clicks inside dropdown from closing it
            userDropdown.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        } else {
            console.warn("Avatar container or dropdown not found in DOM");
        }
    }
    
    // Helper function to update user display in UI
    function updateUserDisplay(user) {
        // Update user email in dropdown
        document.getElementById('userEmail').textContent = user.email || "Not logged in";
        
        // Show logout button and hide login button
        document.getElementById('profileLink').style.display = 'block';
        document.getElementById('accountLink').style.display = 'block';
        document.getElementById('logoutButton').style.display = 'block';
        document.getElementById('loginButton').style.display = 'none';
        
        // Update user avatar/initial
        if (user) {
            const userInitial = document.getElementById('userInitial');
            const userAvatar = document.getElementById('userAvatar');
            
            // Get user data from Firebase
            database.ref(`users/${user.uid}`).once('value')
                .then(snapshot => {
                    const userData = snapshot.val() || {};
                    if (userData.profileImage) {
                        // Show profile image
                        userAvatar.src = userData.profileImage;
                        userAvatar.style.display = 'block';
                        userInitial.style.display = 'none';
                    } else {
                        // Show initial
                        userInitial.textContent = getUserInitial(user);
                        userInitial.style.display = 'flex';
                        userAvatar.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error("Error fetching user data:", error);
                });
        }
    }
    
    // Function to set up all event listeners
    function setupEventListeners() {
        // Logout button
        document.getElementById('logoutButton').addEventListener('click', function(e) {
            e.preventDefault();
            auth.signOut().then(() => {
                window.location.href = "login.html";
            }).catch(error => {
                console.error("Error during logout:", error);
            });
        });
        
        // Filters
        document.getElementById('applyFiltersBtn').addEventListener('click', filterJsas);
        document.getElementById('resetFiltersBtn').addEventListener('click', resetFilters);
        document.getElementById('searchInput').addEventListener('keyup', function(e) {
            if (e.key === 'Enter') filterJsas();
        });
        
        // Sorting
        const tableHeaders = document.querySelectorAll('th[data-sort]');
        tableHeaders.forEach(header => {
            header.addEventListener('click', () => {
                const field = header.getAttribute('data-sort');
                if (sortField === field) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortField = field;
                    sortDirection = 'asc';
                }
                displayJsas(filterJsaArray(allJsas));
            });
        });
        
        // Modal close buttons
        document.getElementById('closeModalBtn').addEventListener('click', closeJsaModal);
        document.getElementById('closeJsaBtn').addEventListener('click', closeJsaModal);
    }
    
    // Function to load JSAs from Firebase - enhanced with better error handling
    function loadJsas() {
        showLoading();
        console.log("Loading JSAs from Firebase...");
        
        const jsasRef = database.ref('jsas');
        
        // Set a timeout for the database operation
        const loadTimeout = setTimeout(() => {
            console.warn("Loading JSAs timed out");
            hideLoading();
            showError("Loading JSAs timed out. Please check your connection and try again.");
        }, 15000);
        
        // Listen for real-time updates
        jsasRef.on('value', 
            (snapshot) => {
                // Clear timeout since we got a response
                clearTimeout(loadTimeout);
                
                console.log("Received JSA data from Firebase");
                allJsas = [];
                
                if (!snapshot.exists()) {
                    console.log("No JSAs found in database");
                    hideLoading();
                    document.getElementById('emptyState').style.display = 'block';
                    document.getElementById('jsaTableContainer').style.display = 'none';
                    return;
                }
                
                snapshot.forEach((childSnapshot) => {
                    const jsa = childSnapshot.val();
                    jsa.id = childSnapshot.key;
                    allJsas.push(jsa);
                });
                
                hideLoading();
                
                // Use the current filter settings when displaying JSAs
                displayJsas(filterJsaArray(allJsas));
                
                // Log in console for debugging
                console.log(`Loaded ${allJsas.length} JSAs from database`);
            },
            (error) => {
                // Clear timeout since we got an error response
                clearTimeout(loadTimeout);
                
                console.error("Error loading JSAs:", error);
                hideLoading();
                showError("Failed to load JSAs: " + error.message);
            }
        );
    }
    
    // Function to display JSAs in the table
    function displayJsas(jsas) {
        const tableBody = document.getElementById('jsaTableBody');
        const emptyState = document.getElementById('emptyState');
        const tableContainer = document.getElementById('jsaTableContainer');
        
        // Sort JSAs based on current sort field and direction
        jsas.sort((a, b) => {
            let valueA = a[sortField];
            let valueB = b[sortField];
            
            // Handle different date fields
            if (sortField === 'createdAt' || sortField === 'jobDate') {
                valueA = new Date(valueA || 0).getTime();
                valueB = new Date(valueB || 0).getTime();
            } else {
                valueA = (valueA || '').toString().toLowerCase();
                valueB = (valueB || '').toString().toLowerCase();
            }
            
            if (valueA < valueB) return sortDirection === 'asc' ? -1 : 1;
            if (valueA > valueB) return sortDirection === 'asc' ? 1 : -1;
            
            // Secondary sort by creation date if primary values are equal
            if (valueA === valueB && sortField !== 'createdAt') {
                const timeA = new Date(a.createdAt || 0).getTime();
                const timeB = new Date(b.createdAt || 0).getTime();
                return sortDirection === 'asc' ? timeA - timeB : timeB - timeA;
            }
            
            return 0;
        });
        
        // Check for highlight ID from URL parameter for edited JSAs
        const highlightId = sessionStorage.getItem('highlightJsaId');
        
        // Calculate pagination
        const totalPages = Math.ceil(jsas.length / JSA_PER_PAGE);
        const startIndex = (currentPage - 1) * JSA_PER_PAGE;
        const paginatedJsas = jsas.slice(startIndex, startIndex + JSA_PER_PAGE);
        
        // Check if there are any JSAs to display
        if (jsas.length === 0) {
            emptyState.style.display = 'block';
            tableContainer.style.display = 'none';
        } else {
            emptyState.style.display = 'none';
            tableContainer.style.display = 'block';
            
            // Clear the table
            tableBody.innerHTML = '';
            
            // Add JSAs to the table
            paginatedJsas.forEach(jsa => {
                const row = document.createElement('tr');
                
                // Add highlight class if this is the edited JSA
                if (highlightId && jsa.id === highlightId) {
                    row.classList.add('highlighted-row');
                    // Scroll this row into view with animation
                    setTimeout(() => {
                        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        // Flash animation for highlight
                        row.style.animation = 'highlight-fade 3s';
                    }, 500);
                    // Clear the highlight ID from session storage
                    sessionStorage.removeItem('highlightJsaId');
                }
                
                // Format date
                const jobDate = jsa.jobDate ? new Date(jsa.jobDate) : null;
                const formattedDate = jobDate ? jobDate.toLocaleDateString() : 'N/A';
                
                // Create risk level class
                const riskLevelClass = jsa.riskLevel ? 
                    `risk-${jsa.riskLevel.toLowerCase()}` : '';
                
                // Create status class
                const statusClass = jsa.approvalStatus ? 
                    `status-${jsa.approvalStatus.toLowerCase()}` : 'status-pending';
                
                // Create the row HTML with JSA-specific fields
                row.innerHTML = `
                    <td>${escapeHtml(jsa.jobTitle || 'N/A')}</td>
                    <td>${escapeHtml(jsa.jobType || 'N/A')}</td>
                    <td>${formattedDate}</td>
                    <td>${escapeHtml(jsa.location || 'N/A')}</td>
                    <td>${escapeHtml(jsa.department || 'N/A')}</td>
                    <td>${escapeHtml(jsa.supervisor || 'N/A')}</td>
                    <td><span class="${riskLevelClass}">${escapeHtml(jsa.riskLevel || 'N/A')}</span></td>
                    <td>${escapeHtml(jsa.createdByName || 'N/A')}</td>
                    <td><span class="${statusClass}">${escapeHtml(jsa.approvalStatus || 'Pending')}</span></td>
                    <td class="action-buttons">
                        <button class="btn-edit" onclick="redirectToEditForm('${jsa.id}', event)">Edit</button>
                        <button class="btn-view" onclick="showJsaDetails('${jsa.id}', event)">View</button>
                        ${jsa.approvalStatus !== 'Approved' && jsa.approvalStatus !== 'Rejected' ? 
                            `<button class="btn-approve" onclick="approveJsa('${jsa.id}', event)">Approve</button>
                             <button class="btn-reject" onclick="rejectJsa('${jsa.id}', event)">Reject</button>` : ''}
                    </td>
                `;
                
                // Add click event to show JSA details
                row.addEventListener('click', (e) => {
                    // Don't trigger row click if user clicked on action buttons
                    if (!e.target.closest('.action-buttons')) {
                        const jsaDetails = allJsas.find(i => i.id === jsa.id);
                        if (jsaDetails) {
                            showJsaDetails(jsaDetails);
                        }
                    }
                });
                
                tableBody.appendChild(row);
            });
            
            // Update pagination
            renderPagination(currentPage, totalPages);
        }
    }
    
    // Function to filter JSAs based on selected criteria
    function filterJsas() {
        const filteredJsas = filterJsaArray(allJsas);
        currentPage = 1; // Reset to first page when filtering
        displayJsas(filteredJsas);
    }
    
    // Helper function to apply filters to the JSA array
    function filterJsaArray(jsas) {
        const jobTypeFilter = document.getElementById('jobTypeFilter').value;
        const locationFilter = document.getElementById('locationFilter').value.toLowerCase();
        const riskLevelFilter = document.getElementById('riskLevelFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;
        const searchText = document.getElementById('searchInput').value.toLowerCase();
        
        return jsas.filter(jsa => {
            // Apply job type filter
            if (jobTypeFilter && jsa.jobType !== jobTypeFilter) {
                return false;
            }
            
            // Apply location filter
            if (locationFilter && !(jsa.location || '').toLowerCase().includes(locationFilter)) {
                return false;
            }
            
            // Apply risk level filter
            if (riskLevelFilter && jsa.riskLevel !== riskLevelFilter) {
                return false;
            }
            
            // Apply status filter
            if (statusFilter && jsa.approvalStatus !== statusFilter) {
                return false;
            }
            
            // Apply search filter
            if (searchText) {
                const searchFields = [
                    jsa.jobTitle || '',
                    jsa.jobType || '',
                    jsa.location || '',
                    jsa.department || '',
                    jsa.supervisor || '',
                    jsa.createdByName || '',
                    jsa.jobDescription || '',
                    jsa.hazards || '',
                    jsa.controls || ''
                ].join(' ').toLowerCase();
                
                if (!searchFields.includes(searchText)) {
                    return false;
                }
            }
            
            return true;
        });
    }
    
    // Function to reset all filters
    function resetFilters() {
        document.getElementById('jobTypeFilter').value = '';
        document.getElementById('locationFilter').value = '';
        document.getElementById('riskLevelFilter').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('searchInput').value = '';
        
        currentPage = 1;
        sortField = 'createdAt';
        sortDirection = 'desc';
        
        displayJsas(allJsas);
    }
    
    // Function to render pagination controls
    function renderPagination(currentPage, totalPages) {
        const paginationEl = document.getElementById('pagination');
        paginationEl.innerHTML = '';
        
        if (totalPages <= 1) {
            return;
        }
        
        // Previous button
        const prevButton = document.createElement('button');
        prevButton.textContent = ' Previous';
        prevButton.disabled = currentPage === 1;
        prevButton.classList.toggle('disabled', currentPage === 1);
        prevButton.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                displayJsas(filterJsaArray(allJsas));
            }
        });
        paginationEl.appendChild(prevButton);
        
        // Page buttons
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        
        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const pageButton = document.createElement('button');
            pageButton.textContent = i;
            pageButton.classList.toggle('active', i === currentPage);
            pageButton.addEventListener('click', () => {
                currentPage = i;
                displayJsas(filterJsaArray(allJsas));
            });
            paginationEl.appendChild(pageButton);
        }
        
        // Next button
        const nextButton = document.createElement('button');
        nextButton.textContent = 'Next ';
        nextButton.disabled = currentPage === totalPages;
        nextButton.classList.toggle('disabled', currentPage === totalPages);
        nextButton.addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                displayJsas(filterJsaArray(allJsas));
            }
        });
        paginationEl.appendChild(nextButton);
    }
    
    // Function to show JSA details in a modal
    function showJsaDetails(jsa) {
        const modal = document.getElementById('jsaDetailsModal');
        const content = document.getElementById('jsaDetailsContent');
        const title = document.getElementById('modalJsaTitle');
        
        // Set title
        title.textContent = `JSA: ${jsa.jobTitle || 'Untitled Job'}`;
        
        // Format dates
        const jobDate = jsa.jobDate ? new Date(jsa.jobDate).toLocaleDateString() : 'Not specified';
        
        // Build content HTML with JSA-specific fields
        let html = `
            <div class="jsa-details">
                <h4>Job Information</h4>
                <div class="detail-section">
                    <p><strong>Job Title:</strong> ${escapeHtml(jsa.jobTitle || 'Not specified')}</p>
                    <p><strong>Job Type:</strong> ${escapeHtml(jsa.jobType || 'Not specified')}</p>
                    <p><strong>Date:</strong> ${jobDate}</p>
                    <p><strong>Location:</strong> ${escapeHtml(jsa.location || 'Not specified')}</p>
                    <p><strong>Department:</strong> ${escapeHtml(jsa.department || 'Not specified')}</p>
                    <p><strong>Supervisor:</strong> ${escapeHtml(jsa.supervisor || 'Not specified')}</p>
                </div>
                
                <h4>Job Description</h4>
                <div class="detail-section">
                    <p>${escapeHtml(jsa.jobDescription || 'No description provided')}</p>
                </div>
            </div>
        `;
        
        // Add steps, hazards and controls if available
        if (jsa.steps && jsa.steps.length > 0) {
            html += `<h4>Job Steps, Hazards, and Controls</h4>
                     <div class="detail-section">
                        <table style="width:100%; border-collapse: collapse; margin-bottom: 15px;">
                            <thead>
                                <tr>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Step</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Potential Hazards</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Control Measures</th>
                                </tr>
                            </thead>
                            <tbody>`;
            
            jsa.steps.forEach(step => {
                html += `<tr>
                            <td style="border: 1px solid #ddd; padding: 8px;">${escapeHtml(step.description || '')}</td>
                            <td style="border: 1px solid #ddd; padding: 8px;">${escapeHtml(step.hazards || '')}</td>
                            <td style="border: 1px solid #ddd; padding: 8px;">${escapeHtml(step.controls || '')}</td>
                         </tr>`;
            });
            
            html += `   </tbody>
                      </table>
                     </div>`;
        }
        
        html += `
            <h4>Risk Assessment</h4>
            <div class="detail-section">
                <p><strong>Overall Risk Level:</strong> <span class="risk-${(jsa.riskLevel || 'medium').toLowerCase()}">${escapeHtml(jsa.riskLevel || 'Medium')}</span></p>
                <p><strong>Required PPE:</strong> ${escapeHtml(jsa.requiredPPE || 'Not specified')}</p>
                <p><strong>Special Permits:</strong> ${escapeHtml(jsa.specialPermits || 'None')}</p>
            </div>
            
            <h4>Approval Information</h4>
            <div class="detail-section">
                <p><strong>Created By:</strong> ${escapeHtml(jsa.createdByName || 'Unknown')} (${escapeHtml(jsa.createdByEmail || 'Unknown')})</p>
                <p><strong>Review Status:</strong> <span class="${statusClass}">${escapeHtml(jsa.approvalStatus || 'Pending')}</span></p>
                <p><strong>Reviewer Comments:</strong> ${escapeHtml(jsa.reviewerComments || 'No comments')}</p>
            </div>
        `;
        
        // Add metadata
        html += `
            <div class="detail-section metadata" style="margin-top: 20px; font-size: 12px; color: #777;">
                <p><strong>Created:</strong> ${jsa.createdByEmail || 'Unknown'} on ${jsa.createdAt ? new Date(jsa.createdAt).toLocaleString() : 'Unknown'}</p>
                <p><strong>Last Updated:</strong> ${jsa.lastUpdatedByEmail || 'Unknown'} on ${jsa.lastUpdatedAt ? new Date(jsa.lastUpdatedAt).toLocaleString() : 'Unknown'}</p>
            </div>
        `;
        
        // Set content
        content.innerHTML = html;
        
        // Show modal
        modal.classList.add('modal-visible');
    }
    
    // Function to close JSA details modal
    function closeJsaModal() {
        const modal = document.getElementById('jsaDetailsModal');
        modal.classList.remove('modal-visible');
    }
    
    // Function to redirect to the JSA form for editing
    function redirectToEditForm(jsaId, e) {
        if (e) e.stopPropagation();
        window.location.href = `jsa.html?edit=${jsaId}`;
    }
    
    // Helper functions
    function showLoading() {
        document.getElementById('loadingIndicator').style.display = 'flex';
        document.getElementById('jsaTableContainer').style.display = 'none';
        document.getElementById('emptyState').style.display = 'none';
    }
    
    function hideLoading() {
        document.getElementById('loadingIndicator').style.display = 'none';
    }
    
    function showError(message) {
        const emptyState = document.getElementById('emptyState');
        emptyState.innerHTML = `<p>${message}</p>`;
        emptyState.style.display = 'block';
        document.getElementById('jsaTableContainer').style.display = 'none';
    }
    
    function formatDate(dateStr) {
        if (!dateStr) return 'Not specified';
        const date = new Date(dateStr);
        return isNaN(date) ? 'Invalid date' : date.toLocaleDateString();
    }
    
    function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function getUserInitial(user) {
        if (!user || !user.email) return '?';
        return user.email.charAt(0).toUpperCase();
    }

    // Add real-time listeners for JSAs
    function setupRealtimeJsaListeners() {
        console.log("Setting up real-time JSA listeners");
        const jsasRef = database.ref('jsas');
        
        // Remove previous listeners to avoid duplicates
        jsasRef.off('child_added');
        jsasRef.off('child_changed');
        jsasRef.off('child_removed');
        
        // Listen for a new JSA added
        jsasRef.on('child_added', snapshot => {
            try {
                console.log(`Real-time update: New JSA added with ID: ${snapshot.key}`);
                let newJsa = snapshot.val();
                newJsa.id = snapshot.key;
                
                // Check if this JSA already exists in our array
                const existingIndex = allJsas.findIndex(i => i.id === newJsa.id);
                
                if (existingIndex === -1) {
                    // Add to beginning of array for newest-first display
                    allJsas.unshift(newJsa);
                    
                    // Update local storage cache
                    try {
                        const localJsas = JSON.parse(localStorage.getItem('recentJsas') || '[]');
                        localJsas.unshift(newJsa);
                        localStorage.setItem('recentJsas', JSON.stringify(localJsas.slice(0, 50)));
                    } catch (e) {
                        console.warn("Could not update local cache:", e);
                    }
                    
                    // Refresh the display
                    displayJsas(filterJsaArray(allJsas));
                    
                    // Check if this is the JSA to highlight (from session storage)
                    const highlightId = sessionStorage.getItem('highlightJsaId');
                    if (highlightId === newJsa.id) {
                        // Flash notification to user
                        showToast(`New JSA "${newJsa.jobTitle}" was added`, "success");
                    }
                }
            } catch (error) {
                console.error("Error processing new JSA:", error);
            }
        });

        // Listen for JSA updates
        jsasRef.on('child_changed', snapshot => {
            try {
                console.log(`Real-time update: JSA updated with ID: ${snapshot.key}`);
                let updatedJsa = snapshot.val();
                updatedJsa.id = snapshot.key;
                
                const index = allJsas.findIndex(i => i.id === updatedJsa.id);
                if (index !== -1) {
                    allJsas[index] = updatedJsa;
                    
                    // Update local storage cache
                    try {
                        const localJsas = JSON.parse(localStorage.getItem('recentJsas') || '[]');
                        const updatedLocalJsas = localJsas.map(i => 
                            i.id === updatedJsa.id ? updatedJsa : i
                        );
                        localStorage.setItem('recentJsas', JSON.stringify(updatedLocalJsas));
                    } catch (e) {
                        console.warn("Could not update local cache:", e);
                    }
                    
                    // Refresh the display
                    displayJsas(filterJsaArray(allJsas));
                    
                    // Check if this is the JSA to highlight (from session storage)
                    const highlightId = sessionStorage.getItem('highlightJsaId');
                    if (highlightId === updatedJsa.id) {
                        // Flash notification to user
                        showToast(`JSA "${updatedJsa.jobTitle}" was updated`, "info");
                    }
                }
            } catch (error) {
                console.error("Error processing updated JSA:", error);
            }
        });
        
        // Listen for JSA removal
        jsasRef.on('child_removed', snapshot => {
            try {
                console.log(`Real-time update: JSA removed with ID: ${snapshot.key}`);
                const removedId = snapshot.key;
                
                // Find the removed JSA to show in notification
                const removedJsa = allJsas.find(i => i.id === removedId);
                
                // Remove from array
                allJsas = allJsas.filter(i => i.id !== removedId);
                
                // Update local storage cache
                try {
                    const localJsas = JSON.parse(localStorage.getItem('recentJsas') || '[]');
                    const filteredLocalJsas = localJsas.filter(i => i.id !== removedId);
                    localStorage.setItem('recentJsas', JSON.stringify(filteredLocalJsas));
                } catch (e) {
                    console.warn("Could not update local cache:", e);
                }
                
                // Refresh the display
                displayJsas(filterJsaArray(allJsas));
                
                // Show notification if we found JSA details
                if (removedJsa) {
                    showToast(`JSA "${removedJsa.jobTitle}" was deleted`, "warning");
                }
            } catch (error) {
                console.error("Error processing removed JSA:", error);
            }
        });
        
        console.log("Real-time JSA listeners set up successfully");
    }

    // Function to listen for cross-window/tab updates
    function listenForCrossWindowUpdates() {
        window.addEventListener('jsa_updated', (event) => {
            console.log("Received JSA update notification from another window/tab", event.detail);
            
            // Set the highlight ID to ensure it's highlighted when refreshed
            if (event.detail && event.detail.jsaId) {
                sessionStorage.setItem('highlightJsaId', event.detail.jsaId);
            }
        });
        
        // Also listen for storage events (another tab might have updated localStorage)
        window.addEventListener('storage', (event) => {
            if (event.key === 'recentJsas') {
                console.log("Local JSA cache was updated in another tab");
                try {
                    const updatedJsas = JSON.parse(event.newValue || '[]');
                    if (updatedJsas.length > 0) {
                        // Update our in-memory array and refresh display
                        allJsas = updatedJsas;
                        displayJsas(filterJsaArray(allJsas));
                    }
                } catch (e) {
                    console.warn("Could not process updated JSAs from another tab", e);
                }
            }
        });
    }

    // Enhanced function to load JSAs with local cache fallback
    function loadJsasWithFallback() {
        showLoading();
        console.log("Loading JSAs from Firebase...");
        
        // Try to load JSAs from local storage first for faster initial display
        try {
            const localJsas = JSON.parse(localStorage.getItem('recentJsas') || '[]');
            if (localJsas.length > 0) {
                console.log(`Loaded ${localJsas.length} JSAs from local cache`);
                allJsas = localJsas;
                displayJsas(filterJsaArray(allJsas));
            }
        } catch (e) {
            console.warn("Could not load from local cache:", e);
        }
        
        // Then load from Firebase for full and updated data
        loadJsas();
    }

    // Helper function to show toast notification for real-time updates
    function showToast(message, type = "info") {
        // Create toast element if it doesn't exist
        let toast = document.getElementById('update-toast');
        if (!toast) {
            toast = document.createElement('div');
            toast.id = 'update-toast';
            toast.style.position = 'fixed';
            toast.style.bottom = '20px';
            toast.style.right = '20px';
            toast.style.minWidth = '250px';
            toast.style.padding = '15px';
            toast.style.borderRadius = '4px';
            toast.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
            toast.style.zIndex = '10000';
            toast.style.transition = 'transform 0.3s ease-out';
            toast.style.transform = 'translateY(100px)';
            document.body.appendChild(toast);
        }
        
        // Set toast style based on type
        switch (type) {
            case "success":
                toast.style.backgroundColor = '#d4edda';
                toast.style.color = '#155724';
                break;
            case "warning":
                toast.style.backgroundColor = '#fff3cd';
                toast.style.color = '#856404';
                break;
            case "error":
                toast.style.backgroundColor = '#f8d7da';
                toast.style.color = '#721c24';
                break;
            default:
                toast.style.backgroundColor = '#d1ecf1';
                toast.style.color = '#0c5460';
        }
        
        // Set message and show toast
        toast.innerHTML = message;
        toast.style.transform = 'translateY(0)';
        
        // Hide toast after a few seconds
        setTimeout(() => {
            toast.style.transform = 'translateY(100px)';
        }, 5000);
    }

    // Add the approval functions
    function approveJsa(jsaId, event) {
        if (event) event.stopPropagation();
        
        // Get the JSA from the array
        const jsa = allJsas.find(j => j.id === jsaId);
        if (!jsa) return;
        
        // Update the status
        jsa.approvalStatus = 'Approved';
        jsa.lastUpdatedAt = new Date().toISOString();
        jsa.lastUpdatedByEmail = auth.currentUser ? auth.currentUser.email : 'Unknown';
        
        // Save to Firebase
        database.ref(`jsas/${jsaId}`).update({
            approvalStatus: jsa.approvalStatus,
            lastUpdatedAt: jsa.lastUpdatedAt,
            lastUpdatedByEmail: jsa.lastUpdatedByEmail
        }).then(() => {
            console.log(`JSA ${jsaId} approved successfully`);
            showToast(`JSA "${jsa.jobTitle}" has been approved`, "success");
            
            // Refresh display
            displayJsas(filterJsaArray(allJsas));
        }).catch(error => {
            console.error("Error approving JSA:", error);
            showToast("Error approving JSA: " + error.message, "error");
        });
    }
    
    function rejectJsa(jsaId, event) {
        if (event) event.stopPropagation();
        
        // Get the JSA from the array
        const jsa = allJsas.find(j => j.id === jsaId);
        if (!jsa) return;
        
        // Prompt for rejection reason
        const reason = prompt("Please provide a reason for rejection:", "");
        if (reason === null) return; // User canceled
        
        // Update the status
        jsa.approvalStatus = 'Rejected';
        jsa.reviewerComments = reason;
        jsa.lastUpdatedAt = new Date().toISOString();
        jsa.lastUpdatedByEmail = auth.currentUser ? auth.currentUser.email : 'Unknown';
        
        // Save to Firebase
        database.ref(`jsas/${jsaId}`).update({
            approvalStatus: jsa.approvalStatus,
            reviewerComments: jsa.reviewerComments,
            lastUpdatedAt: jsa.lastUpdatedAt,
            lastUpdatedByEmail: jsa.lastUpdatedByEmail
        }).then(() => {
            console.log(`JSA ${jsaId} rejected successfully`);
            showToast(`JSA "${jsa.jobTitle}" has been rejected`, "warning");
            
            // Refresh display
            displayJsas(filterJsaArray(allJsas));
        }).catch(error => {
            console.error("Error rejecting JSA:", error);
            showToast("Error rejecting JSA: " + error.message, "error");
        });
    }
    </script>
</body>
</html>