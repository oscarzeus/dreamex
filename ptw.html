<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Permit to Work - Dreamex Lab</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Main container styles */
        .ptw-container {
            max-width: 1600px; /* Increased from 1000px for wider form */
            margin: 80px auto 30px;
            padding: 30px;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        .ptw-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .ptw-title h2 {
            margin: 0;
            color: #34495e;
        }

        .ptw-title p {
            margin: 5px 0 0;
            color: #7f8c8d;
            font-size: 14px;
        }

        /* Form styles */
        .ptw-form {
            margin-top: 20px;
            width: 100%;
        }

        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .form-section h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #34495e;
            font-size: 18px;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 10px;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 15px;
            max-width: 100%;
        }

        .form-group {
            flex: 1;
            min-width: 250px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            height: 40px;
            padding: 8px 12px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fff;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            box-sizing: border-box;
        }

        .form-control:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        .checkbox-group {
            margin-top: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 10px;
        }

        .checkbox-item label {
            font-weight: normal;
            margin-bottom: 0;
        }

        /* Nested sections for hazards/controls */
        .nested-section {
            background-color: #fff;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            margin-top: 15px;
        }

        .nested-item {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: start;
        }

        .nested-item .form-group {
            margin-bottom: 0;
        }

        .nested-item-controls {
            display: flex;
            gap: 10px;
            margin-top: 28px; /* Align with inputs */
        }

        /* Button styles */
        .btn {
            height: 40px;
            min-width: 120px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            letter-spacing: 0.3px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 14px;
        }

        .btn:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: #2ecc71;
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        .btn-danger {
            background-color: #e74c3c;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-add {
            height: 32px;
            min-width: 32px;
            padding: 0;
            font-size: 20px;
            font-weight: bold;
        }

        .btn-remove {
            height: 32px;
            min-width: 32px;
            padding: 0;
            font-weight: bold;
        }

        .form-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
        }

        /* Required field indicator */
        .required:after {
            content: '*';
            color: #e74c3c;
            margin-left: 4px;
        }

        /* Form validation styles */
        .invalid-feedback {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .form-control.is-invalid {
            border-color: #e74c3c;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='none' stroke='%23e74c3c' viewBox='0 0 12 12'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23e74c3c' stroke='none'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px 16px;
        }

        .form-control.is-invalid + .invalid-feedback {
            display: block;
        }

        /* Status styles */
        .status-indicator {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            max-width: 120px;
        }

        .status-draft {
            background-color: #f8f9fa;
            color: #495057;
            border: 1px dashed #ced4da;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background-color: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background-color: #f8d7da;
            color: #721c24;
        }

        .status-expired {
            background-color: #e2e3e5;
            color: #383d41;
        }

        /* Permit types styling */
        .permit-type-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .permit-type {
            flex: 1;
            min-width: 160px;
            text-align: center;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .permit-type:hover {
            border-color: #3498db;
            background-color: #f1f9ff;
        }

        .permit-type.selected {
            border-color: #3498db;
            background-color: #ebf5fb;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .permit-type-icon {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .permit-type-name {
            font-weight: 600;
            color: #34495e;
        }

        /* Notification bell and user avatar styles (keep consistent with other pages) */
        .menu-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* Notification bell styles */
        .notification-bell-container {
            position: relative;
        }

        .notification-bell {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.2s ease;
            position: relative;
        }

        .notification-bell:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .bell-icon-svg {
            width: 20px;
            height: 20px;
            fill: none;
            stroke: #555;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .notification-counter {
            position: absolute;
            top: 0;
            right: 0;
            background-color: #e74c3c;
            color: white;
            font-size: 10px;
            min-width: 16px;
            height: 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .notification-dropdown {
            position: absolute;
            top: 45px;
            right: -10px;
            background-color: white;
            width: 320px;
            max-height: 400px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            display: none;
            z-index: 1000;
        }

        .notification-bell:hover + .notification-dropdown,
        .notification-dropdown:hover {
            display: block;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        .notification-header h4 {
            margin: 0;
            font-size: 16px;
            color: #333;
        }

        .notification-header-actions button {
            background: none;
            border: none;
            color: #3498db;
            font-size: 13px;
            cursor: pointer;
            padding: 3px 6px;
        }

        .notification-list {
            max-height: 350px;
            overflow-y: auto;
        }

        .notification-empty {
            padding: 20px;
            text-align: center;
            color: #7f8c8d;
            font-size: 14px;
        }

        /* User avatar styles */
        .user-avatar-container {
            position: relative;
            display: flex;
            align-items: center;
            margin-right: 20px;
            cursor: pointer;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .user-dropdown {
            position: absolute;
            top: 45px;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 0;
            min-width: 200px;
            display: none;
            z-index: 1000;
            text-align: left;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.08);
        }

        /* Add class for showing the dropdown */
        .user-dropdown.show {
            display: block;
            animation: dropdown-fade-in 0.2s ease-out;
        }
        
        .user-email {
            padding: 5px 15px; /* Further reduced from 8px to 5px */
            border-bottom: 1px solid #eaeaea;
            color: #34495e;
            font-weight: 500;
            background-color: #f8f9fa;
            font-size: 13px; /* Reduced from 14px to 13px */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .user-dropdown a {
            display: block;
            padding: 2px 15px; /* Further reduced from 4px to 2px */
            color: #000000;
            text-decoration: none;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            font-size: 13px; /* Reduced from 14px to 13px */
            line-height: 1.4; /* Added to provide some minimal spacing */
        }
        
        /* Ensure specific dropdown links are black */
        #profileLink, #accountLink {
            color: #474646 !important; /* Pure black color with !important to override any other styles */
        }
        
        .user-dropdown a:hover {
            background-color: #f1f8fe;
            border-left-color: #3498db;
            color: #3498db;
        }
        
        .user-dropdown a:last-child {
            border-top: 1px solid #eaeaea;
        }
        
        #logoutButton {
            color: #e74c3c; /* Keep logout button red */
        }
        
        #logoutButton:hover {
            background-color: #fdeeee;
            border-left-color: #e74c3c;
        }
        
        #loginButton {
            color: #000000; /* Changed to black */
        }
        
        #loginButton:hover {
            background-color: #f1f8fe;
            border-left-color: #3498db;
            color: #3498db;
        }
        
        .user-initial {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Align table headers to left */
        table th {
            text-align: left !important;
        }
        
        /* Ensure nested tables in permit-specific content are also left-aligned */
        #permitSpecificContent th {
            text-align: left !important;
        }

        /* Ensure all heading elements are left-aligned */
        h1, h2, h3, h4, h5, h6, .section-title, .ptw-title h2, .ptw-title p, .form-section h3 {
            text-align: left !important;
        }
        
        /* Ensure permit type headings and descriptions are left-aligned */
        .permit-type-name,
        .permit-type-desc {
            text-align: left !important;
        }

        /* Ensure consistent alignment in permit-specific content */
        #permitSpecificTitle,
        #permitSpecificContent p,
        .checkbox-group p {
            text-align: left !important;
        }
        .menu-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #34495e;
            padding: 0 20px;
        }
        
        .menu-bar ul {
            display: flex;
            align-items: center;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .menu-bar ul li {
            margin: 0 10px;
        }
        
        .menu-bar ul li a {
            display: block;
            padding: 15px 10px;
            color: #ecf0f1;
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .menu-bar ul li a:hover {
            color: #f1f3f5;
        }
        
        .menu-bar ul li.current a {
            color: #fafcfd;
            font-weight: bold;
        }

        /* Dropdown styles */
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white !important;
            color: black !important;
            min-width: 160px;
            box-shadow: 0px 8px 16px rgba(0,0,0,0.2);
            z-index: 1;
            top: calc(100%);
            font-size: 6px !important;
            font-weight: normal;
            text-align: left;
        }
        .dropdown-content a {
            color: rgb(44, 43, 43) !important;
            padding: 6px 10px !important;
            text-decoration: none;  
            display: block;
            font-size: 11px !important;
        }
        .dropdown-content a:hover {
            background-color: #e8e8e8;
            transform: none; 
        }
        .dropdown:hover .dropdown-content,
        .dropdown:focus-within .dropdown-content {
            display: block;
        }
    </style>
    <!-- Add Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <!-- Include auth.js after Firebase SDKs -->
    <script src="js/auth.js"></script>
</head>
<body>
    <header>
        <nav class="menu-bar">
            <ul class="menu-left">
                <li><a href="login.html">Home</a></li>
                <li class="dropdown">
                    <a href="#">Risk Management</a>
                    <div class="dropdown-content">
                        <a href="riskassessment.html">Risk Assessment</a>
                        <a href="jsaboard.html">Job Safety Analysis</a>
                    </div>
                </li>
                <li class="dropdown">
                    <a href="#">Safety reporting</a>
                    <div class="dropdown-content">
                        <a href="eventboard.html">Event</a>
                        <a href="inspectionsboard.html">Inspections</a>
                    </div>
                </li>
                <li class="dropdown">
                    <a href="#">Settings</a>
                    <div class="dropdown-content">
                        <a href="account.html">User account</a>
                        <a href="setup.html">Inspections</a>
                        <a href="log.html">System audit log</a>
                    </div>
                </li>
                <li><a href="dashboard.html">Dashboard</a></li>
            </ul>
            <ul class="menu-right">
                <!-- User Avatar Button -->
                <li class="user-avatar-container">
                    <div id="userAvatarContainer">
                        <img src="https://via.placeholder.com/32" alt="User" class="user-avatar" id="userAvatar" style="display: none;">
                        <div id="userInitial" class="user-initial">?</div>
                    </div>
                    <div class="user-dropdown">
                        <div class="user-email" id="userEmail">Not logged in</div>
                        <a href="profile.html" id="profileLink" style="display: none;">My Profile</a>
                        <a href="#" id="logoutButton" style="display: none;">Log Out</a>
                        <a href="login.html" id="loginButton">Log In</a>
                    </div>
                </li>
            </ul>
        </nav>
    </header>

    <main class="ptw-container">
        <div class="ptw-header">
            <div class="ptw-title">
                <h2>Permit to Work Application</h2>
                <p>Complete this form to request authorization for work that requires specific safety controls</p>
            </div>
        </div>

        <form id="ptwForm" class="ptw-form">
            <!-- Permit Type Selection -->
            <div class="form-section">
                <h3>Permit Type</h3>
                <p>Select the type of permit required for this work:</p>
                <div class="permit-type-selector">
                    <div class="permit-type" data-type="hot-work">
                        <div class="permit-type-icon">üî•</div>
                        <div class="permit-type-name">Hot Work</div>
                        <div class="permit-type-desc">Welding, cutting, grinding</div>
                    </div>
                    <div class="permit-type" data-type="confined-space">
                        <div class="permit-type-icon">‚ö†Ô∏è</div>
                        <div class="permit-type-name">Confined Space</div>
                        <div class="permit-type-desc">Work in restricted areas</div>
                    </div>
                    <div class="permit-type" data-type="working-at-height">
                        <div class="permit-type-icon">üîù</div>
                        <div class="permit-type-name">Working at Height</div>
                        <div class="permit-type-desc">Above 2 meters</div>
                    </div>
                    <div class="permit-type" data-type="electrical">
                        <div class="permit-type-icon">‚ö°</div>
                        <div class="permit-type-name">Electrical</div>
                        <div class="permit-type-desc">Electrical installations</div>
                    </div>
                </div>
                <input type="hidden" id="permitType" name="permitType" required>
                <div class="invalid-feedback">Please select a permit type</div>
            </div>

            <!-- Work Details -->
            <div class="form-section">
                <h3>Work Details</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="workTitle" class="required">Work Title</label>
                        <input type="text" class="form-control" id="workTitle" name="workTitle" required placeholder="Brief title for the work">
                        <div class="invalid-feedback">Please provide a work title</div>
                    </div>
                    <div class="form-group">
                        <label for="projectName" class="required">Project/Job Reference</label>
                        <input type="text" class="form-control" id="projectName" name="projectName" required placeholder="Project or job reference number">
                        <div class="invalid-feedback">Please provide a project/job reference</div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="location" class="required">Location</label>
                        <input type="text" class="form-control" id="location" name="location" required placeholder="Specific work location">
                        <div class="invalid-feedback">Please provide a location</div>
                    </div>
                    <div class="form-group">
                        <label for="department">Department</label>
                        <input type="text" class="form-control" id="department" name="department" placeholder="Department responsible for work">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="workDescription" class="required">Description of Work</label>
                        <textarea class="form-control" id="workDescription" name="workDescription" rows="4" required placeholder="Detailed description of the work to be performed"></textarea>
                        <div class="invalid-feedback">Please describe the work to be performed</div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="startDate" class="required">Start Date & Time</label>
                        <input type="datetime-local" class="form-control" id="startDate" name="startDate" required>
                        <div class="invalid-feedback">Please provide a start date and time</div>
                    </div>
                    <div class="form-group">
                        <label for="endDate" class="required">End Date & Time</label>
                        <input type="datetime-local" class="form-control" id="endDate" name="endDate" required>
                        <div class="invalid-feedback">Please provide an end date and time</div>
                    </div>
                </div>
            </div>

            <!-- Hazards and Controls -->
            <div class="form-section">
                <h3>Hazard Identification and Control Measures</h3>
                <p>Identify potential hazards associated with this work and the control measures to be implemented:</p>
                
                <div id="hazardsContainer" class="nested-section">
                    <div class="nested-item" data-index="0">
                        <div class="form-group">
                            <label for="hazard-0">Hazard</label>
                            <input type="text" class="form-control" id="hazard-0" name="hazards[0].description" placeholder="Describe the hazard">
                        </div>
                        <div class="form-group">
                            <label for="control-0">Control Measure</label>
                            <input type="text" class="form-control" id="control-0" name="hazards[0].control" placeholder="Describe the control measure">
                        </div>
                        <div class="nested-item-controls">
                            <button type="button" class="btn btn-danger btn-remove" onclick="removeHazard(0)">-</button>
                        </div>
                    </div>
                </div>
                <div style="text-align: right; margin-top: 10px;">
                    <button type="button" class="btn btn-success btn-add" onclick="addHazard()">+</button>
                </div>
            </div>

            <!-- PPE Requirements -->
            <div class="form-section">
                <h3>Personal Protective Equipment (PPE)</h3>
                <p>Select all PPE required for this work:</p>
                <div class="checkbox-group">
                    <div class="form-row">
                        <div class="checkbox-item">
                            <input type="checkbox" id="ppe-safety-helmet" name="ppe" value="safety-helmet">
                            <label for="ppe-safety-helmet">Safety Helmet</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="ppe-safety-glasses" name="ppe" value="safety-glasses">
                            <label for="ppe-safety-glasses">Safety Glasses</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="ppe-face-shield" name="ppe" value="face-shield">
                            <label for="ppe-face-shield">Face Shield</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="ppe-hearing-protection" name="ppe" value="hearing-protection">
                            <label for="ppe-hearing-protection">Hearing Protection</label>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="checkbox-item">
                            <input type="checkbox" id="ppe-respiratory" name="ppe" value="respiratory">
                            <label for="ppe-respiratory">Respiratory Protection</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="ppe-safety-gloves" name="ppe" value="safety-gloves">
                            <label for="ppe-safety-gloves">Safety Gloves</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="ppe-safety-harness" name="ppe" value="safety-harness">
                            <label for="ppe-safety-harness">Safety Harness</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="ppe-safety-boots" name="ppe" value="safety-boots">
                            <label for="ppe-safety-boots">Safety Boots</label>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="additionalPpe">Additional PPE Requirements</label>
                        <input type="text" class="form-control" id="additionalPpe" name="additionalPpe" placeholder="Specify any additional PPE requirements">
                    </div>
                </div>
            </div>

            <!-- Permit Specifics Based on Type -->
            <!-- This section will dynamically change based on the permit type selected -->
            <div id="permitSpecificSection" class="form-section" style="display:none;">
                <h3 id="permitSpecificTitle">Permit-Specific Requirements</h3>
                <div id="permitSpecificContent">
                    <!-- Content will be loaded dynamically -->
                </div>
            </div>

            <!-- Authorizations -->
            <div class="form-section">
                <h3>Work Authorization</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="requestorName" class="required">Requestor Name</label>
                        <input type="text" class="form-control" id="requestorName" name="requestorName" required placeholder="Your name">
                        <div class="invalid-feedback">Please provide your name</div>
                    </div>
                    <div class="form-group">
                        <label for="requestorPosition" class="required">Position</label>
                        <input type="text" class="form-control" id="requestorPosition" name="requestorPosition" required placeholder="Your position">
                        <div class="invalid-feedback">Please provide your position</div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="supervisorName" class="required">Supervisor Name</label>
                        <input type="text" class="form-control" id="supervisorName" name="supervisorName" required placeholder="Name of work supervisor">
                        <div class="invalid-feedback">Please provide a supervisor name</div>
                    </div>
                    <div class="form-group">
                        <label for="supervisorContact" class="required">Supervisor Contact</label>
                        <input type="text" class="form-control" id="supervisorContact" name="supervisorContact" required placeholder="Phone or email">
                        <div class="invalid-feedback">Please provide supervisor contact information</div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="additionalComments">Additional Comments</label>
                        <textarea class="form-control" id="additionalComments" name="additionalComments" rows="3" placeholder="Any additional information or special considerations"></textarea>
                    </div>
                </div>
            </div>

            <!-- Declaration -->
            <div class="form-section">
                <h3>Declaration</h3>
                <div class="checkbox-item">
                    <input type="checkbox" id="declaration" name="declaration" required>
                    <label for="declaration" class="required">I confirm that the information provided is accurate, all necessary safety measures will be implemented, and all personnel involved are adequately trained for this work.</label>
                    <div class="invalid-feedback">You must agree to the declaration</div>
                </div>
            </div>

            <!-- Submit Buttons -->
            <div class="form-buttons">
                <button type="button" class="btn" id="saveDraftBtn">Save Draft</button>
                <button type="submit" class="btn btn-success">Submit for Approval</button>
            </div>
        </form>
    </main>

    <script>
        // Initialize Firebase with error handling
        let database;
        let auth;
        let currentUser;
        let hazardCount = 1;

        function initializeFirebase() {
            const firebaseConfig = {
                apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
                authDomain: "users-8be65.firebaseapp.com",
                databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
                projectId: "users-8be65",
                storageBucket: "users-8be65.appspot.com",
                messagingSenderId: "829083030831",
                appId: "1:829083030831:web:36a370e62691e560bc3dda"
            };
            
            // Check if Firebase is already initialized
            if (firebase.apps.length === 0) {
                console.log("Initializing Firebase");
                firebase.initializeApp(firebaseConfig);
            } else {
                console.log("Firebase already initialized");
            }
            
            database = firebase.database();
            auth = firebase.auth();
            
            // Force browser to persist auth state
            return auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                .then(() => console.log("Firebase persistence set to LOCAL"))
                .catch(error => console.error("Firebase persistence error:", error));
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM loaded, setting up PTW form");
            
            // Initialize Firebase
            initializeFirebase().then(() => {
                // Check authentication state
                auth.onAuthStateChanged(user => {
                    if (user) {
                        console.log("User authenticated:", user.email);
                        currentUser = user;
                        updateUserDisplay(user);
                        
                        // Check if we're editing an existing permit
                        const urlParams = new URLSearchParams(window.location.search);
                        const editPermitId = urlParams.get('edit');
                        
                        if (editPermitId) {
                            // We're in edit mode, load the permit data
                            loadPermitForEditing(editPermitId);
                        } else {
                            // New permit mode
                            prefillUserData(user);
                        }
                        
                        // Set up form event listeners
                        setupFormListeners();
                    } else {
                        console.log("Not authenticated, redirecting to login page");
                        window.location.href = "login.html?redirect=" + encodeURIComponent(window.location.pathname);
                    }
                });
            }).catch(error => {
                console.error("Firebase initialization failed:", error);
                showError("Failed to initialize Firebase. Please try again later.");
            });
            
            // Set up permit type selection
            setupPermitTypeSelection();
        });

        // Helper function to update user display in UI
        function updateUserDisplay(user) {
            // Update user email in dropdown
            document.getElementById('userEmail').textContent = user.email || "Not logged in";
            
            // Show logout button and hide login button
            document.getElementById('profileLink').style.display = 'block';
            document.getElementById('accountLink').style.display = 'block';
            document.getElementById('logoutButton').style.display = 'block';
            document.getElementById('loginButton').style.display = 'none';
            
            // Update user avatar/initial
            const userInitial = document.getElementById('userInitial');
            const userAvatar = document.getElementById('userAvatar');
            
            // Get user data from Firebase
            database.ref(`users/${user.uid}`).once('value')
                .then(snapshot => {
                    const userData = snapshot.val() || {};
                    if (userData.profileImage) {
                        // Show profile image
                        userAvatar.src = userData.profileImage;
                        userAvatar.style.display = 'block';
                        userInitial.style.display = 'none';
                    } else {
                        // Show initial
                        userInitial.textContent = getUserInitial(user);
                        userInitial.style.display = 'flex';
                        userAvatar.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error("Error fetching user data:", error);
                });
        }

        function getUserInitial(user) {
            if (!user || !user.email) return '?';
            return user.email.charAt(0).toUpperCase();
        }

        // Prefill user data in the form
        function prefillUserData(user) {
            database.ref(`users/${user.uid}`).once('value')
                .then(snapshot => {
                    const userData = snapshot.val() || {};
                    
                    // Prefill requestor name if available
                    if (userData.displayName) {
                        document.getElementById('requestorName').value = userData.displayName;
                    }

                    if (userData.position) {
                        document.getElementById('requestorPosition').value = userData.position;
                    }
                    
                    // Set default dates (today and tomorrow)
                    const now = new Date();
                    const tomorrow = new Date();
                    tomorrow.setDate(now.getDate() + 1);
                    
                    // Format dates for datetime-local inputs (YYYY-MM-DDTHH:MM)
                    const formatDate = (date) => {
                        return date.toISOString().slice(0, 16);
                    };
                    
                    document.getElementById('startDate').value = formatDate(now);
                    document.getElementById('endDate').value = formatDate(tomorrow);
                })
                .catch(error => {
                    console.error("Error prefilling user data:", error);
                });
        }

        // Set up permit type selection functionality
        function setupPermitTypeSelection() {
            const permitTypes = document.querySelectorAll('.permit-type');
            
            permitTypes.forEach(type => {
                type.addEventListener('click', () => {
                    // Remove selected class from all types
                    permitTypes.forEach(t => t.classList.remove('selected'));
                    
                    // Add selected class to clicked type
                    type.classList.add('selected');
                    
                    // Update hidden input value
                    const permitTypeValue = type.getAttribute('data-type');
                    document.getElementById('permitType').value = permitTypeValue;
                    
                    // Show permit-specific section
                    loadPermitSpecificContent(permitTypeValue);
                });
            });
        }

        // Load content specific to the selected permit type
        function loadPermitSpecificContent(permitType) {
            const permitSpecificSection = document.getElementById('permitSpecificSection');
            const permitSpecificTitle = document.getElementById('permitSpecificTitle');
            const permitSpecificContent = document.getElementById('permitSpecificContent');
            
            // Show the section
            permitSpecificSection.style.display = 'block';
            
            // Set title and content based on permit type
            switch (permitType) {
                case 'hot-work':
                    permitSpecificTitle.textContent = 'Hot Work Requirements';
                    permitSpecificContent.innerHTML = `
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fireWatchRequired" class="required">Fire Watch Required?</label>
                                <select class="form-control" id="fireWatchRequired" name="permitSpecific.fireWatchRequired" required>
                                    <option value="">Select...</option>
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="fireExtinguisherType" class="required">Fire Extinguisher Type</label>
                                <select class="form-control" id="fireExtinguisherType" name="permitSpecific.fireExtinguisherType" required>
                                    <option value="">Select...</option>
                                    <option value="water">Water</option>
                                    <option value="foam">Foam</option>
                                    <option value="co2">CO2</option>
                                    <option value="dry-powder">Dry Powder</option>
                                    <option value="wet-chemical">Wet Chemical</option>
                                </select>
                            </div>
                        </div>
                        <div class="checkbox-group">
                            <p><strong>Pre-work Checks:</strong></p>
                            <div class="form-row">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="hw-check-1" name="permitSpecific.preChecks" value="combustibles-removed" required>
                                    <label for="hw-check-1">Combustible materials removed or protected</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="hw-check-2" name="permitSpecific.preChecks" value="fire-alarm" required>
                                    <label for="hw-check-2">Fire alarm system status confirmed</label>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="hw-check-3" name="permitSpecific.preChecks" value="ventilation" required>
                                    <label for="hw-check-3">Adequate ventilation confirmed</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="hw-check-4" name="permitSpecific.preChecks" value="equipment-inspected" required>
                                    <label for="hw-check-4">Equipment inspected and in good condition</label>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'confined-space':
                    permitSpecificTitle.textContent = 'Confined Space Requirements';
                    permitSpecificContent.innerHTML = `
                        <div class="form-row">
                            <div class="form-group">
                                <label for="atmosphereTestedBy" class="required">Atmosphere Tested By</label>
                                <input type="text" class="form-control" id="atmosphereTestedBy" name="permitSpecific.atmosphereTestedBy" required>
                            </div>
                            <div class="form-group">
                                <label for="oxygenLevel" class="required">Oxygen Level (%)</label>
                                <input type="number" step="0.1" min="0" max="100" class="form-control" id="oxygenLevel" name="permitSpecific.oxygenLevel" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="emergencyPlan" class="required">Emergency Rescue Plan</label>
                                <textarea class="form-control" id="emergencyPlan" name="permitSpecific.emergencyPlan" rows="3" required></textarea>
                            </div>
                        </div>
                        <div class="checkbox-group">
                            <p><strong>Required Controls:</strong></p>
                            <div class="form-row">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="cs-check-1" name="permitSpecific.controls" value="continuous-monitoring" required>
                                    <label for="cs-check-1">Continuous atmosphere monitoring</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="cs-check-2" name="permitSpecific.controls" value="standby-person" required>
                                    <label for="cs-check-2">Standby person assigned</label>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="cs-check-3" name="permitSpecific.controls" value="communication" required>
                                    <label for="cs-check-3">Communication method established</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="cs-check-4" name="permitSpecific.controls" value="isolation" required>
                                    <label for="cs-check-4">Energy isolation completed</label>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'working-at-height':
                    permitSpecificTitle.textContent = 'Working at Height Requirements';
                    permitSpecificContent.innerHTML = `
                        <div class="form-row">
                            <div class="form-group">
                                <label for="workHeight" class="required">Working Height (meters)</label>
                                <input type="number" step="0.1" min="0" class="form-control" id="workHeight" name="permitSpecific.workHeight" required>
                            </div>
                            <div class="form-group">
                                <label for="accessEquipment" class="required">Access Equipment</label>
                                <select class="form-control" id="accessEquipment" name="permitSpecific.accessEquipment" required>
                                    <option value="">Select...</option>
                                    <option value="ladder">Ladder</option>
                                    <option value="scaffold">Scaffold</option>
                                    <option value="mewp">MEWP (Mobile Elevating Work Platform)</option>
                                    <option value="roof">Roof Access</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="checkbox-group">
                            <p><strong>Fall Prevention/Protection:</strong></p>
                            <div class="form-row">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="wh-check-1" name="permitSpecific.fallProtection" value="guardrails" required>
                                    <label for="wh-check-1">Guardrails in place</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="wh-check-2" name="permitSpecific.fallProtection" value="harness" required>
                                    <label for="wh-check-2">Full body harness and lanyard</label>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="wh-check-3" name="permitSpecific.fallProtection" value="anchor-points" required>
                                    <label for="wh-check-3">Anchor points identified and secure</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="wh-check-4" name="permitSpecific.fallProtection" value="rescue-plan" required>
                                    <label for="wh-check-4">Rescue plan in place</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="dropZoneControl" class="required">Drop Zone Control Measures</label>
                                <textarea class="form-control" id="dropZoneControl" name="permitSpecific.dropZoneControl" rows="3" required></textarea>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'electrical':
                    permitSpecificTitle.textContent = 'Electrical Work Requirements';
                    permitSpecificContent.innerHTML = `
                        <div class="form-row">
                            <div class="form-group">
                                <label for="voltageLevel" class="required">Voltage Level</label>
                                <select class="form-control" id="voltageLevel" name="permitSpecific.voltageLevel" required>
                                    <option value="">Select...</option>
                                    <option value="low">Low Voltage (< 1000V AC)</option>
                                    <option value="high">High Voltage (‚â• 1000V AC)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="isolationMethod" class="required">Isolation Method</label>
                                <select class="form-control" id="isolationMethod" name="permitSpecific.isolationMethod" required>
                                    <option value="">Select...</option>
                                    <option value="lock-out">Lock-out/Tag-out</option>
                                    <option value="isolation-switch">Isolation Switch</option>
                                    <option value="circuit-breaker">Circuit Breaker</option>
                                    <option value="fuse-removal">Fuse Removal</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="checkbox-group">
                            <p><strong>Electrical Safety Checks:</strong></p>
                            <div class="form-row">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="el-check-1" name="permitSpecific.safetyChecks" value="verified-dead" required>
                                    <label for="el-check-1">Circuit verified dead</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="el-check-2" name="permitSpecific.safetyChecks" value="earthing" required>
                                    <label for="el-check-2">Earthing/grounding in place</label>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="el-check-3" name="permitSpecific.safetyChecks" value="insulated-tools" required>
                                    <label for="el-check-3">Insulated tools available</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="el-check-4" name="permitSpecific.safetyChecks" value="warning-signs" required>
                                    <label for="el-check-4">Warning signs posted</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="electricalCompetency" class="required">Worker Competency</label>
                                <textarea class="form-control" id="electricalCompetency" name="permitSpecific.electricalCompetency" rows="3" placeholder="List qualifications/certifications of workers" required></textarea>
                            </div>
                        </div>
                    `;
                    break;
                    
                default:
                    permitSpecificSection.style.display = 'none';
                    break;
            }
        }

        // Add more hazards dynamically
        function addHazard() {
            const hazardsContainer = document.getElementById('hazardsContainer');
            const newIndex = hazardCount++;
            
            const hazardItem = document.createElement('div');
            hazardItem.className = 'nested-item';
            hazardItem.setAttribute('data-index', newIndex);
            
            hazardItem.innerHTML = `
                <div class="form-group">
                    <label for="hazard-${newIndex}">Hazard</label>
                    <input type="text" class="form-control" id="hazard-${newIndex}" name="hazards[${newIndex}].description" placeholder="Describe the hazard">
                </div>
                <div class="form-group">
                    <label for="control-${newIndex}">Control Measure</label>
                    <input type="text" class="form-control" id="control-${newIndex}" name="hazards[${newIndex}].control" placeholder="Describe the control measure">
                </div>
                <div class="nested-item-controls">
                    <button type="button" class="btn btn-danger btn-remove" onclick="removeHazard(${newIndex})">-</button>
                </div>
            `;
            
            hazardsContainer.appendChild(hazardItem);
        }

        // Remove a hazard
        function removeHazard(index) {
            const hazardItem = document.querySelector(`.nested-item[data-index="${index}"]`);
            if (hazardItem && document.querySelectorAll('.nested-item').length > 1) {
                hazardItem.remove();
            }
        }

        // Set up form event listeners
        function setupFormListeners() {
            const form = document.getElementById('ptwForm');
            const saveDraftBtn = document.getElementById('saveDraftBtn');
            
            // Save draft button
            saveDraftBtn.addEventListener('click', () => {
                savePermit('draft');
            });
            
            // Form submission
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                if (validateForm()) {
                    savePermit('pending');
                }
            });
            
            // Logout button
            document.getElementById('logoutButton').addEventListener('click', function(e) {
                e.preventDefault();
                auth.signOut().then(() => {
                    window.location.href = "login.html";
                }).catch(error => {
                    console.error("Error during logout:", error);
                });
            });
            
            // Add click handler for user avatar dropdown
            const userAvatarContainer = document.getElementById('userAvatarContainer');
            const userDropdown = document.querySelector('.user-dropdown');
            
            if (userAvatarContainer && userDropdown) {
                // Toggle dropdown when clicking the avatar
                userAvatarContainer.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent event from bubbling up
                    userDropdown.classList.toggle('show');
                });
                
                // Close dropdown when clicking anywhere else
                document.addEventListener('click', function(e) {
                    if (userDropdown.classList.contains('show')) {
                        userDropdown.classList.remove('show');
                    }
                });
                
                // Prevent clicks inside dropdown from closing it
                userDropdown.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }
        }

        // Form validation
        function validateForm() {
            const form = document.getElementById('ptwForm');
            let isValid = true;
            
            // Check all required inputs
            const requiredInputs = form.querySelectorAll('[required]');
            requiredInputs.forEach(input => {
                if (!input.value.trim()) {
                    input.classList.add('is-invalid');
                    isValid = false;
                } else {
                    input.classList.remove('is-invalid');
                }
            });
            
            // Check permit type is selected
            const permitType = document.getElementById('permitType');
            if (!permitType.value) {
                permitType.classList.add('is-invalid');
                isValid = false;
                alert("Please select a permit type");
            }
            
            // Check dates are valid
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            
            if (endDate <= startDate) {
                document.getElementById('endDate').classList.add('is-invalid');
                isValid = false;
                alert("End date must be after start date");
            }
            
            // Check declaration checkbox
            const declaration = document.getElementById('declaration');
            if (!declaration.checked) {
                declaration.classList.add('is-invalid');
                isValid = false;
                alert("You must agree to the declaration");
            }
            
            return isValid;
        }

        // Save permit to Firebase
        function savePermit(status) {
            if (!currentUser) {
                alert("You must be logged in to submit a permit");
                return;
            }
            
            console.log("Saving permit with status:", status);
            
            // Check if we're editing an existing permit
            const form = document.getElementById('ptwForm');
            const existingPermitId = form.getAttribute('data-permit-id');
            const isEditing = Boolean(existingPermitId);
            
            // Collect form data
            const formData = new FormData(form);
            const permitData = {};
            
            // Create structure to hold hazards properly
            permitData.hazards = [];
            const hazardItems = {};
            
            formData.forEach((value, key) => {
                // Special handling for hazards to avoid bracket notation
                if (key.includes('hazards[')) {
                    const match = key.match(/hazards\[(\d+)\]\.(.+)/);
                    if (match) {
                        const [, index, prop] = match;
                        if (!hazardItems[index]) {
                            hazardItems[index] = {};
                        }
                        hazardItems[index][prop] = value;
                    }
                }
                // Handle other nested properties (using dot notation)
                else if (key.includes('.')) {
                    const parts = key.split('.');
                    if (!permitData[parts[0]]) {
                        permitData[parts[0]] = {};
                    }
                    permitData[parts[0]][parts[1]] = value;
                } 
                // Handle checkboxes (multiple values with same name)
                else if (key === 'ppe') {
                    if (!permitData[key]) {
                        permitData[key] = [];
                    }
                    permitData[key].push(value);
                }
                // Handle other fields
                else {
                    permitData[key] = value;
                }
            });
            
            // Convert hazard items object to array
            Object.keys(hazardItems).forEach(index => {
                if (hazardItems[index].description || hazardItems[index].control) {
                    permitData.hazards.push({
                        description: hazardItems[index].description || '',
                        control: hazardItems[index].control || ''
                    });
                }
            });
            
            // Add metadata
            permitData.createdAt = new Date().toISOString();
            permitData.createdBy = currentUser.uid;
            permitData.createdByEmail = currentUser.email;
            permitData.status = status;
            permitData.lastUpdatedAt = new Date().toISOString();
            
            console.log("Permit data prepared:", permitData);
            
            // Update the Firebase reference part to handle editing vs creating new
            try {
                // Create a reference based on whether we're editing or creating new
                let permitRef;
                let actionMessage;
                
                if (isEditing) {
                    permitRef = database.ref(`permits/${existingPermitId}`);
                    actionMessage = status === 'draft' ? "Permit updated as draft" : "Permit updated and submitted for approval";
                } else {
                    permitRef = database.ref('permits').push();
                    actionMessage = status === 'draft' ? "Permit saved as draft" : "Permit submitted successfully for approval";
                }
                
                console.log(`${isEditing ? 'Updating' : 'Creating'} permit, attempting to save data...`);
                
                // Set or update the data
                permitRef.update(permitData)
                    .then(() => {
                        console.log("Permit saved successfully");
                        alert(actionMessage);
                        // Redirect to board page
                        window.location.href = "ptwboard.html";
                    })
                    .catch(error => {
                        console.error("Firebase error saving permit:", error);
                        alert("Failed to save permit: " + error.message);
                    });
            } catch (error) {
                console.error("Exception while saving permit:", error);
                alert("An error occurred while saving the permit: " + error.message);
            }
        }

        // New function to load permit data for editing
        function loadPermitForEditing(permitId) {
            console.log("Loading permit for editing:", permitId);
            
            // Update the UI to show we're in edit mode
            document.querySelector('.ptw-title h2').textContent = "Edit Permit to Work";
            
            // Get the permit data from Firebase
            database.ref(`permits/${permitId}`).once('value')
                .then(snapshot => {
                    const permitData = snapshot.val();
                    
                    if (!permitData) {
                        alert("Permit not found");
                        window.location.href = "ptwboard.html";
                        return;
                    }
                    
                    console.log("Loaded permit data:", permitData);
                    
                    // Store the original permit ID for updating later
                    document.getElementById('ptwForm').setAttribute('data-permit-id', permitId);
                    
                    // Populate form fields with permit data
                    populateFormWithPermitData(permitData);
                })
                .catch(error => {
                    console.error("Error loading permit for editing:", error);
                    alert("Failed to load permit data: " + error.message);
                });
        }

        // Populate form with permit data
        function populateFormWithPermitData(permitData) {
            // Select the permit type
            if (permitData.permitType) {
                const permitTypeElement = document.querySelector(`.permit-type[data-type="${permitData.permitType}"]`);
                if (permitTypeElement) {
                    document.querySelectorAll('.permit-type').forEach(el => el.classList.remove('selected'));
                    permitTypeElement.classList.add('selected');
                    document.getElementById('permitType').value = permitData.permitType;
                    
                    // Load permit-specific content
                    loadPermitSpecificContent(permitData.permitType);
                }
            }
            
            // Populate basic fields
            const fieldsToPopulate = [
                'workTitle', 'projectName', 'location', 'department', 
                'workDescription', 'startDate', 'endDate',
                'requestorName', 'requestorPosition', 'supervisorName', 
                'supervisorContact', 'additionalComments'
            ];
            
            fieldsToPopulate.forEach(field => {
                if (permitData[field]) {
                    const element = document.getElementById(field);
                    if (element) {
                        element.value = permitData[field];
                    }
                }
            });
            
            // Handle hazards (clear existing and add from data)
            if (permitData.hazards && Array.isArray(permitData.hazards)) {
                // Clear existing hazards except the first one
                const hazardsContainer = document.getElementById('hazardsContainer');
                const existingHazards = document.querySelectorAll('.nested-item');
                for (let i = 1; i < existingHazards.length; i++) {
                    existingHazards[i].remove();
                }
                
                // Reset hazard counter
                hazardCount = 1;
                
                // Clear first hazard inputs
                document.getElementById('hazard-0').value = '';
                document.getElementById('control-0').value = '';
                
                // Add hazards from permit data
                permitData.hazards.forEach((hazard, index) => {
                    if (index === 0) {
                        // Use the existing first hazard row
                        document.getElementById('hazard-0').value = hazard.description || '';
                        document.getElementById('control-0').value = hazard.control || '';
                    } else {
                        // Add new hazard rows for the rest
                        addHazard();
                        document.getElementById(`hazard-${hazardCount-1}`).value = hazard.description || '';
                        document.getElementById(`control-${hazardCount-1}`).value = hazard.control || '';
                    }
                });
            }
            
            // Handle PPE checkboxes
            if (permitData.ppe && Array.isArray(permitData.ppe)) {
                // Uncheck all first
                document.querySelectorAll('input[name="ppe"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                // Check the ones in the permit data
                permitData.ppe.forEach(ppe => {
                    const checkbox = document.getElementById(`ppe-${ppe}`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
            }
            
            // Handle additional PPE
            if (permitData.additionalPpe) {
                document.getElementById('additionalPpe').value = permitData.additionalPpe;
            }
            
            // Handle permit-specific fields after a short delay to ensure content is loaded
            setTimeout(() => {
                if (permitData.permitSpecific) {
                    const specificData = permitData.permitSpecific;
                    
                    // Populate based on permit type
                    switch (permitData.permitType) {
                        case 'hot-work':
                            populateSelect('fireWatchRequired', specificData.fireWatchRequired);
                            populateSelect('fireExtinguisherType', specificData.fireExtinguisherType);
                            populateCheckboxes('permitSpecific.preChecks', specificData.preChecks);
                            break;
                        
                        case 'confined-space':
                            populateField('atmosphereTestedBy', specificData.atmosphereTestedBy);
                            populateField('oxygenLevel', specificData.oxygenLevel);
                            populateField('emergencyPlan', specificData.emergencyPlan);
                            populateCheckboxes('permitSpecific.controls', specificData.controls);
                            break;
                        
                        case 'working-at-height':
                            populateField('workHeight', specificData.workHeight);
                            populateSelect('accessEquipment', specificData.accessEquipment);
                            populateCheckboxes('permitSpecific.fallProtection', specificData.fallProtection);
                            populateField('dropZoneControl', specificData.dropZoneControl);
                            break;
                        
                        case 'electrical':
                            populateSelect('voltageLevel', specificData.voltageLevel);
                            populateSelect('isolationMethod', specificData.isolationMethod);
                            populateCheckboxes('permitSpecific.safetyChecks', specificData.safetyChecks);
                            populateField('electricalCompetency', specificData.electricalCompetency);
                            break;
                    }
                }
            }, 500); // Give the DOM time to update with the permit-specific fields
            
            // Update form buttons for edit mode
            const formButtons = document.querySelector('.form-buttons');
            formButtons.innerHTML = `
                <button type="button" class="btn" id="saveDraftBtn">Update as Draft</button>
                <button type="submit" class="btn btn-success">Update for Approval</button>
            `;
        }

        // Helper functions for populating form elements
        function populateField(fieldId, value) {
            if (value !== undefined) {
                const field = document.getElementById(fieldId);
                if (field) field.value = value;
            }
        }

        function populateSelect(selectId, value) {
            if (value !== undefined) {
                const select = document.getElementById(selectId);
                if (select) {
                    for (let i = 0; i < select.options.length; i++) {
                        if (select.options[i].value === value) {
                            select.selectedIndex = i;
                            break;
                        }
                    }
                }
            }
        }

        function populateCheckboxes(name, values) {
            if (!values) return;
            
            // Handle both array and single string cases
            const valuesArray = Array.isArray(values) ? values : [values];
            
            document.querySelectorAll(`input[name="${name}"]`).forEach(checkbox => {
                checkbox.checked = valuesArray.includes(checkbox.value);
            });
        }
    </script>
    <!-- Standalone script for user avatar dropdown -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Setting up user avatar dropdown handler");
            
            const userAvatarContainer = document.getElementById('userAvatarContainer');
            const userDropdown = document.querySelector('.user-dropdown');
            
            if (userAvatarContainer && userDropdown) {
                console.log("Found avatar container and dropdown elements");
                
                // Remove any existing event listeners by cloning the element
                const newUserAvatarContainer = userAvatarContainer.cloneNode(true);
                userAvatarContainer.parentNode.replaceChild(newUserAvatarContainer, userAvatarContainer);
                
                // Toggle dropdown when clicking the avatar
                newUserAvatarContainer.addEventListener('click', function(e) {
                    console.log("Avatar clicked!");
                    e.preventDefault();
                    e.stopPropagation();
                    userDropdown.classList.toggle('show');
                });
                
                // Close dropdown when clicking elsewhere
                document.addEventListener('click', function(e) {
                    if (!newUserAvatarContainer.contains(e.target) && userDropdown.classList.contains('show')) {
                        userDropdown.classList.remove('show');
                    }
                });
                
                // Prevent clicks inside dropdown from closing it
                userDropdown.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
                
                // Also make login button work
                const loginButton = document.getElementById('loginButton');
                if (loginButton) {
                    loginButton.addEventListener('click', function(e) {
                        e.preventDefault();
                        window.location.href = "login.html";
                    });
                }
            } else {
                console.error("Could not find avatar container or dropdown elements");
                console.log("userAvatarContainer:", userAvatarContainer);
                console.log("userDropdown:", userDropdown);
            }
        });
    </script>
</body>
</html>
