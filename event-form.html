<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSE System - Report Event</title>
    <link rel="stylesheet" href="css/styles.css">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .event-form-container {
            max-width: 100%; /* Updated from 1000px to 100% to take full width */
            margin: 90px auto 0; /* Added top margin to match other pages */
            padding: 20px;
        }
        
        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 60px;
        }
        
        .event-title h2 {
            margin-bottom: 5px;
        }
        
        .event-title p {
            color: #666;
            margin-top: 0;
        }
        
        .form-section {
            background-color: #fff;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .form-section h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--primary-color);
            font-size: 18px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .form-group {
            flex: 1 1 300px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        
        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }
        
        select.form-control {
            cursor: pointer;
        }
        
        input[readonly], input:disabled, select:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
        }
        
        /* File Upload Styles */
        .file-upload-container {
            margin-top: 20px;
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            cursor: pointer;
        }
        
        .file-input-label {
            display: inline-block;
            padding: 10px 15px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .file-input-label i {
            margin-right: 8px;
        }
        
        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-list {
            margin-top: 15px;
            list-style: none;
            padding: 0;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        
        .file-icon {
            margin-right: 10px;
            color: #555;
        }
        
        .file-name {
            flex: 1;
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .file-size {
            color: #888;
            font-size: 12px;
            margin: 0 15px;
        }
        
        .file-actions {
            display: flex;
            gap: 5px;
        }
        
        .file-actions button {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 14px;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .form-group {
                flex: 1 1 100%;
            }
        }
        
        /* Equipment selector styles */
        .input-with-button {
            position: relative;
            display: flex;
        }
        
        .input-with-button select,
        .input-with-button input {
            flex: 1;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }
        
        .input-with-button .add-button {
            width: 40px;
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--primary-color);
            color: white;
            border: 1px solid var(--primary-color);
        }
        
        .equipment-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow: auto;
        }
        
        .equipment-modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            position: relative;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .close-modal {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }
        
        .close-modal:hover {
            color: #333;
        }
        
        .equipment-modal h3 {
            margin-top: 0;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .equipment-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .equipment-item {
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 4px;
            margin-bottom: 8px;
            cursor: pointer;
        }
        
        .equipment-item:hover {
            background-color: #f9f9f9;
        }
        
        .equipment-item.selected {
            background-color: #e3f2fd;
            border-color: #90caf9;
        }
        
        .equipment-search {
            margin-bottom: 15px;
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .equipment-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        /* Selected equipment styles */
        .selected-equipment-container {
            margin-bottom: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .selected-equipment-item {
            display: flex;
            align-items: center;
            background-color: #f0f7ff;
            border: 1px solid #cfe2ff;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 14px;
        }
        
        .selected-equipment-item .equipment-name {
            margin-right: 8px;
        }
        
        .selected-equipment-item .remove-equipment {
            color: #dc3545;
            cursor: pointer;
            border: none;
            background: none;
            padding: 0;
            font-size: 14px;
            display: flex;
            align-items: center;
        }

        /* Enhanced Equipment selector styles */
        .input-with-button {
            position: relative;
            display: flex;
            margin-top: 8px;
        }
        
        .input-with-button select,
        .input-with-button input {
            flex: 1;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            transition: all 0.2s ease;
            border-color: #d1d9e6;
        }
        
        .input-with-button select:focus,
        .input-with-button input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(var(--primary-color-rgb), 0.15);
            outline: none;
        }
        
        .input-with-button .add-button {
            width: 44px;
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--primary-color);
            color: white;
            border: 1px solid var(--primary-color);
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .input-with-button .add-button:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.12);
        }
        
        .input-with-button .add-button:active {
            transform: translateY(0);
        }
        
        .equipment-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow: auto;
            animation: fadeIn 0.2s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .equipment-modal-content {
            background-color: white;
            margin: 8% auto;
            padding: 25px;
            border-radius: 10px;
            width: 90%;
            max-width: 650px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            animation: slideIn 0.3s ease;
            transform-origin: top center;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .close-modal {
            position: absolute;
            right: 20px;
            top: 18px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
            transition: color 0.2s;
            z-index: 10;
        }
        
        .close-modal:hover {
            color: #333;
        }
        
        .equipment-modal h3 {
            margin-top: 0;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
            font-size: 20px;
            color: var(--primary-color);
        }
        
        .equipment-search {
            margin-bottom: 15px;
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
        }
        
        .equipment-search:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.15);
            outline: none;
        }
        
        .equipment-search::placeholder {
            color: #a0a0a0;
        }
        
        .equipment-list {
            max-height: 350px;
            overflow-y: auto;
            margin-bottom: 20px;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 8px;
            background-color: #fafafa;
            scrollbar-width: thin;
        }
        
        .equipment-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .equipment-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .equipment-list::-webkit-scrollbar-thumb {
            background: #cdcdcd;
            border-radius: 10px;
        }
        
        .equipment-list::-webkit-scrollbar-thumb:hover {
            background: #b3b3b3;
        }
        
        .equipment-item {
            padding: 12px 15px;
            border: 1px solid #e9e9e9;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            background-color: white;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }
        
        .equipment-item:before {
            content: '';
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid #ddd;
            border-radius: 3px;
            margin-right: 12px;
            transition: all 0.2s;
        }
        
        .equipment-item:hover {
            background-color: #f5f9ff;
            border-color: #d0e1fd;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .equipment-item.selected {
            background-color: #e3f2fd;
            border-color: #90caf9;
        }
        
        .equipment-item.selected:before {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z'/%3E%3C/svg%3E");
            background-size: 12px;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        .equipment-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .equipment-modal-footer button {
            padding: 8px 16px;
            transition: all 0.2s;
        }
        
        .equipment-modal-footer button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        /* Enhanced Selected equipment styles */
        .selected-equipment-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-height: 42px;
            padding: 5px 0;
            margin: 8px 0 15px;
        }
        
        .selected-equipment-item {
            display: flex;
            align-items: center;
            background-color: #f0f7ff;
            border: 1px solid #cfe2ff;
            border-radius: 8px;
            padding: 8px 14px;
            font-size: 14px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
            animation: fadeInScale 0.3s ease;
            width: 100%;
            justify-content: space-between;
        }
        
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.98);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .selected-equipment-item:hover {
            background-color: #e6f2ff;
            border-color: #b6d4fe;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }
        
        .equipment-name-section {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .selected-equipment-item .equipment-name {
            font-weight: 500;
            white-space: nowrap;
        }

        .equipment-quantity-section {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .equipment-quantity-label {
            color: #666;
            font-size: 13px;
        }
        
        .equipment-quantity {
            width: 60px;
            padding: 4px 8px;
            border: 1px solid #cfe2ff;
            border-radius: 4px;
            text-align: center;
            font-size: 14px;
            background-color: #fff;
            transition: all 0.2s ease;
        }

        .equipment-quantity:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(var(--primary-color-rgb), 0.1);
        }
        
        .selected-equipment-item .remove-equipment {
            color: #dc3545;
            cursor: pointer;
            border: none;
            background: none;
            padding: 0;
            font-size: 14px;
            display: flex;
            align-items: center;
            transition: all 0.2s;
            opacity: 0.7;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            justify-content: center;
            margin-left: 10px;
        }
        
        .selected-equipment-item .remove-equipment:hover {
            opacity: 1;
            background-color: #ffeeee;
            transform: scale(1.1);
        }
        
        /* Empty state styling */
        .selected-equipment-container:empty:before {
            content: 'No equipment selected';
            color: #a0a0a0;
            font-style: italic;
            padding: 8px 0;
            display: block;
        }
        
        /* Label enhancement for equipment section */
        .form-group label[for="inspectionArea"] {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 500;
            color: #444;
        }
        
        .form-group label[for="inspectionArea"]:after {
            content: '(select multiple)';
            font-size: 12px;
            font-weight: normal;
            color: #777;
        }

        /* Enhanced Selected equipment styles with findings */
        .selected-equipment-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 42px;
            padding: 5px 0;
            margin: 8px 0 15px;
        }
        
        .selected-equipment-item {
            display: flex;
            flex-direction: column;
            background-color: #f0f7ff;
            border: 1px solid #cfe2ff;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 14px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
            animation: fadeInScale 0.3s ease;
            width: 100%;
        }
        
        .equipment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .equipment-name-section {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .selected-equipment-item .equipment-name {
            font-weight: 600;
            font-size: 15px;
            color: #333;
        }

        .equipment-quantity-section {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .equipment-quantity-label {
            color: #666;
            font-size: 13px;
            white-space: nowrap;
        }
        
        .equipment-quantity {
            width: 60px;
            padding: 4px 8px;
            border: 1px solid #cfe2ff;
            border-radius: 4px;
            text-align: center;
            font-size: 14px;
            background-color: #fff;
            transition: all 0.2s ease;
        }

        .equipment-quantity:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(var(--primary-color-rgb), 0.1);
        }
        
        .equipment-findings-section {
            width: 100%;
            padding-top: 8px;
        }
        
        .equipment-findings-label {
            display: block;
            margin-bottom: 5px;
            font-size: 13px;
            color: #555;
            font-weight: 500;
        }
        
        .equipment-findings {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #cfe2ff;
            border-radius: 4px;
            font-size: 14px;
            min-height: 70px;
            resize: vertical;
            background-color: #fff;
            transition: all 0.2s ease;
        }
        
        .equipment-findings:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(var(--primary-color-rgb), 0.1);
        }
        
        .selected-equipment-item .remove-equipment {
            color: #dc3545;
            cursor: pointer;
            border: none;
            background: none;
            padding: 0;
            font-size: 14px;
            display: flex;
            align-items: center;
            transition: all 0.2s;
            opacity: 0.7;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            justify-content: center;
            margin-left: 10px;
        }
        
        .selected-equipment-item .remove-equipment:hover {
            opacity: 1;
            background-color: #ffeeee;
            transform: scale(1.1);
        }
        
        /* Empty state styling */
        .selected-equipment-container:empty:before {
            content: 'No equipment selected';
            color: #a0a0a0;
            font-style: italic;
            padding: 8px 0;
            display: block;
        }

        .selected-factors-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 12px;
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        .selected-factor-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
            background-color: #ffffff;
            border: 1px solid #dcdcdc;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            transition: box-shadow 0.3s ease, transform 0.3s ease;
        }

        .factor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            font-weight: 600;
            color: #333;
            padding-bottom: 8px;
            border-bottom: 1px solid #f0f0f0;
        }

        .factor-header .remove-factor {
            color: #e74c3c;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .factor-header .remove-factor:hover {
            background-color: #fee;
            color: #c0392b;
        }

        .factor-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .factor-details .form-group {
            margin: 0;
        }

        .factor-details label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: #555;
            margin-bottom: 4px;
        }

        .factor-details textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #dcdcdc;
            border-radius: 6px;
            font-size: 13px;
            background-color: #fdfdfd;
            min-height: 52px;
            resize: vertical;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .factor-details textarea:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
            outline: none;
        }

        .factor-details .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 0;
        }

        .factor-details .form-row .form-group {
            width: 100%;
        }

        .factor-details input[type="date"],
        .factor-details select {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #dcdcdc;
            border-radius: 6px;
            font-size: 13px;
            background-color: #fdfdfd;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .factor-details input[type="date"]:focus,
        .factor-details select:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
            outline: none;
        }
    </style>
</head>
<body>
    <!-- Header placeholder that will be filled by header-loader.js -->
    <div id="header-placeholder"></div>

    <main class="event-form-container">
        <div class="event-header">
            <div class="event-title">
                <h2 id="formTitle">Report New Event</h2>
                <p id="formDescription">Submit details of a new incident, observation, or safety concern</p>
            </div>
            <a href="event.html" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Events
            </a>
        </div>

        <form id="eventForm">
            <input type="hidden" id="eventId">
            
            <!-- Basic Information Section -->
            <div class="form-section">
                <h3>Basic Information</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="eventType">Event Type *</label>
                        <select id="eventType" class="form-control" required>
                            <option value="">Select Event Type</option>
                            <option value="incident">Incident</option>
                            <option value="near-miss">Near Miss</option>
                            <option value="observation">Safety Observation</option>
                            <option value="inspection">Inspection</option>
                            <option value="audit">Audit</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="eventTitle">Title *</label>
                        <input type="text" id="eventTitle" class="form-control" placeholder="Brief title describing the event" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="eventDate">Date of Event *</label>
                        <input type="date" id="eventDate" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="eventTime">Time of Event</label>
                        <input type="time" id="eventTime" class="form-control">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="eventLocation">Location *</label>
                        <select id="eventLocation" class="form-control" required>
                            <option value="">Select Location</option>
                            <!-- Locations will be populated from Firebase -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="department">Department *</label>
                        <select id="department" class="form-control" required>
                            <option value="">Select Department</option>
                            <!-- Departments will be populated from Firebase -->
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="reportedBy">Reported By *</label>
                        <input type="text" id="reportedBy" class="form-control" readonly>
                        <input type="hidden" id="reportedById">
                    </div>
                    <div class="form-group">
                        <label for="reportDate">Date Reported</label>
                        <input type="date" id="reportDate" class="form-control" readonly>
                    </div>
                </div>
            </div>

            <!-- Event Details Section -->
            <div class="form-section">
                <h3>Event Details</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="eventDescription">Description *</label>
                        <textarea id="eventDescription" class="form-control" placeholder="Provide a detailed description of what happened" required></textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="severity">Severity *</label>
                        <select id="severity" class="form-control" required>
                            <option value="">Select Severity</option>
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="eventStatus">Status</label>
                        <select id="eventStatus" class="form-control">
                            <option value="open">Open</option>
                            <option value="in-progress">In Progress</option>
                            <option value="closed">Closed</option>
                        </select>
                    </div>
                </div>
                
                <!-- Incident-specific details -->
                <div id="incidentDetails" class="event-type-section" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="injuryType">Injury Type</label>
                            <select id="injuryType" class="form-control">
                                <option value="">Select Injury Type</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="propertyDamage">Property Damage</label>
                            <select id="propertyDamage" class="form-control">
                                <option value="none">None</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="incidentCategory">Incident Category</label>
                            <select id="incidentCategory" class="form-control">
                                <option value="">Select Category</option>
                                <option value="slip-trip-fall">Slip, Trip, or Fall</option>
                                <option value="struck-by">Struck By Object</option>
                                <option value="caught-in">Caught In/Between</option>
                                <option value="vehicle">Vehicle Incident</option>
                                <option value="chemical">Chemical Exposure</option>
                                <option value="fire">Fire or Explosion</option>
                                <option value="ergonomic">Ergonomic</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="workRelated">Work Related?</label>
                            <select id="workRelated" class="form-control">
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                                <option value="undetermined">Undetermined</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Inspection-specific details -->
                <div id="inspectionDetails" class="event-type-section" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="inspectionType">Inspection Type</label>
                            <select id="inspectionType" class="form-control">
                                <option value="">Select Type</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="inspectionArea">Equipment *</label>
                            <div class="selected-equipment-container" id="selectedEquipmentContainer"></div>
                            <div class="input-with-button">
                                <select id="inspectionArea" class="form-control">
                                    <option value="">Select Equipment</option>
                                </select>
                                <button type="button" id="addEquipmentBtn" class="add-button">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="checklistUsed">Checklist Used</label>
                            <select id="checklistUsed" class="form-control">
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="inspectionFrequency">Frequency</label>
                            <select id="inspectionFrequency" class="form-control">
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                                <option value="quarterly">Quarterly</option>
                                <option value="annually">Annually</option>
                                <option value="one-time">One-Time</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="inspectionFindings">Findings *</label>
                            <textarea id="inspectionFindings" class="form-control" placeholder="List the findings from your inspection"></textarea>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="totalItems">Total Items Checked</label>
                            <input type="number" id="totalItems" class="form-control" min="0" readonly style="background-color: #f8f9fa;">
                        </div>
                        <div class="form-group">
                            <label for="nonConformities">Non-Conformities Found</label>
                            <input type="number" id="nonConformities" class="form-control" min="0">
                        </div>
                    </div>
                </div>
                
                <!-- Observation-specific details -->
                <div id="observationDetails" class="event-type-section" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="observationType">Observation Type</label>
                            <select id="observationType" class="form-control">
                                <option value="">Select Type</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="behaviorCategory">Behavior Category</label>
                            <select id="behaviorCategory" class="form-control">
                                <option value="">Select Category</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="observationFeedback">Feedback Provided?</label>
                            <select id="observationFeedback" class="form-control">
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="observationResponse">Response to Feedback</label>
                            <select id="observationResponse" class="form-control">
                                <option value="positive">Positive</option>
                                <option value="negative">Negative</option>
                                <option value="neutral">Neutral</option>
                                <option value="na">N/A</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Audit-specific details -->
                <div id="auditDetails" class="event-type-section" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="auditScope">Audit Scope *</label>
                            <textarea id="auditScope" class="form-control" placeholder="Define the scope of this audit"></textarea>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="auditStandard">Compliance Standard</label>
                            <input type="text" id="auditStandard" class="form-control" placeholder="Standard or regulation">
                        </div>
                        <div class="form-group">
                            <label for="auditType">Audit Type</label>
                            <select id="auditType" class="form-control">
                                <option value="internal">Internal</option>
                                <option value="external">External</option>
                                <option value="regulatory">Regulatory</option>
                                <option value="certification">Certification</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="leadAuditor">Lead Auditor</label>
                            <input type="text" id="leadAuditor" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="auditTeam">Audit Team</label>
                            <input type="text" id="auditTeam" class="form-control" placeholder="Names of team members">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="majorFindings">Major Non-Conformities</label>
                            <input type="number" id="majorFindings" class="form-control" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="minorFindings">Minor Non-Conformities</label>
                            <input type="number" id="minorFindings" class="form-control" min="0" value="0">
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="immediateActions">Immediate Actions Taken</label>
                        <textarea id="immediateActions" class="form-control" placeholder="Describe any immediate actions taken"></textarea>
                    </div>
                </div>
            </div>

            <!-- Contributing Factors & Corrective Actions Section -->
            <div class="form-section">
                <h3>Contributing Factors & Corrective Actions</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="contributingFactors">Contributing Factors</label>
                        <div class="selected-factors-container" id="selectedFactorsContainer"></div>
                        <div class="input-with-button">
                            <select id="contributingFactors" class="form-control">
                                <option value="">Select Contributing Factor</option>
                            </select>
                            <button type="button" id="addFactorBtn" class="add-button">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="correctiveActions">Corrective Actions</label>
                        <textarea id="correctiveActions" class="form-control" placeholder="Describe actions to prevent recurrence"></textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="assignedTo">Assigned To</label>
                        <select id="assignedTo" class="form-control">
                            <option value="">Select Person</option>
                            <!-- Users will be populated from Firebase -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="dueDate">Due Date</label>
                        <input type="date" id="dueDate" class="form-control">
                    </div>
                </div>
            </div>

            <!-- Attachments Section -->
            <div class="form-section">
                <h3>Attachments</h3>
                <p>Upload photos, documents, or other relevant files</p>
                
                <div class="file-upload-container">
                    <div class="file-input-wrapper">
                        <label class="file-input-label">
                            <i class="fas fa-upload"></i> Choose Files
                        </label>
                        <input type="file" id="fileUpload" multiple>
                    </div>
                    <small style="display: block; margin-top: 5px; color: #666;">Maximum file size: 5MB</small>
                    
                    <ul class="file-list" id="fileList">
                        <!-- File items will be added here -->
                    </ul>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button type="button" id="cancelBtn" class="btn btn-secondary">Cancel</button>
                <button type="button" id="saveAsDraftBtn" class="btn btn-outline-primary">Save as Draft</button>
                <button type="submit" id="submitBtn" class="btn btn-primary">Submit Event</button>
            </div>
        </form>
    </main>

    <!-- Equipment Selection Modal -->
    <div id="equipmentModal" class="equipment-modal">
        <div class="equipment-modal-content">
            <span class="close-modal">&times;</span>
            <h3>Select Equipment</h3>
            <input type="text" id="equipmentSearch" class="equipment-search" placeholder="Search equipment...">
            <div class="equipment-list" id="equipmentList">
                <!-- Equipment items will be populated here -->
            </div>
            <div class="equipment-modal-footer">
                <button type="button" id="selectEquipmentBtn" class="btn btn-primary">Select</button>
                <button type="button" id="cancelEquipmentBtn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 HSE Online System. All rights reserved.</p>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <!-- Header loader script -->
    <script src="js/header-loader.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.firebasestorage.app",
            messagingSenderId: "829083030831",
            appId: "1:829083030831:web:36a370e62691e560bc3dda"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        const storage = firebase.storage();
        
        document.addEventListener('DOMContentLoaded', function() {
            // Set default date to today
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            document.getElementById('eventDate').value = formattedDate;
            document.getElementById('reportDate').value = formattedDate;
            
            // Store event data globally for edit mode
            let currentEventData = null;
            
            // Get event ID from URL if editing existing event
            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get('id');
            
            if (eventId) {
                // Update form title and description
                document.getElementById('formTitle').textContent = 'Edit Event';
                document.getElementById('formDescription').textContent = 'Update an existing event record';
                document.getElementById('submitBtn').textContent = 'Update Event';
                
                // Set the event ID
                document.getElementById('eventId').value = eventId;
                
                // Load event data for editing
                loadEventData(eventId);
            }
            
            // Check for current user
            auth.onAuthStateChanged(function(user) {
                if (user) {
                    // User is signed in
                    database.ref('users/' + user.uid).once('value')
                        .then(snapshot => {
                            const userData = snapshot.val();
                            if (userData) {
                                document.getElementById('reportedBy').value = userData.firstName && userData.lastName ? 
                                    `${userData.firstName} ${userData.lastName}` : user.email;
                            } else {
                                document.getElementById('reportedBy').value = user.email;
                            }
                            document.getElementById('reportedById').value = user.uid;
                        });
                } else {
                    // No user signed in, redirect to login
                    alert('Please sign in to report an event');
                    window.location.href = 'login.html';
                }
            });
            
            // Load locations
            loadLocations();
            
            // Load departments
            loadDepartments();
            
            // Load users for assignment
            loadUsers();
            
            // Event type change handler to show/hide specific fields
            document.getElementById('eventType').addEventListener('change', function() {
                const eventType = this.value;
                
                // Hide all event-type sections first
                const eventSections = document.querySelectorAll('.event-type-section');
                eventSections.forEach(section => {
                    section.style.display = 'none';
                });
                
                // Show the appropriate section based on event type
                switch(eventType) {
                    case 'incident':
                    case 'near-miss':
                        document.getElementById('incidentDetails').style.display = 'block';
                        break;
                    case 'inspection':
                        document.getElementById('inspectionDetails').style.display = 'block';
                        break;
                    case 'observation':
                        document.getElementById('observationDetails').style.display = 'block';
                        break;
                    case 'audit':
                        document.getElementById('auditDetails').style.display = 'block';
                        break;
                }
                
                // Ensure users are loaded correctly when switching event types
                if (currentEventData && currentEventData.assignedTo) {
                    loadUsers();
                }
            });
            
            // File upload handling
            const fileUpload = document.getElementById('fileUpload');
            const fileList = document.getElementById('fileList');
            const attachedFiles = [];
            
            fileUpload.addEventListener('change', function() {
                const files = this.files;
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    
                    // Check file size (max 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        alert(`File ${file.name} is too large. Maximum size is 5MB.`);
                        continue;
                    }
                    
                    // Add file to list
                    const fileItem = {
                        file: file,
                        name: file.name,
                        size: formatFileSize(file.size),
                        type: file.type
                    };
                    
                    attachedFiles.push(fileItem);
                    addFileToList(fileItem, attachedFiles.length - 1);
                }
                
                // Clear file input
                this.value = '';
            });
            
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            function addFileToList(fileItem, index) {
                const li = document.createElement('li');
                li.className = 'file-item';
                
                // Determine file icon based on file type
                let iconClass = 'fa-file';
                const fileExt = fileItem.name.split('.').pop().toLowerCase();
                
                if (['jpg', 'jpeg', 'png', 'gif'].includes(fileExt)) {
                    iconClass = 'fa-file-image';
                } else if (fileExt === 'pdf') {
                    iconClass = 'fa-file-pdf';
                } else if (['doc', 'docx'].includes(fileExt)) {
                    iconClass = 'fa-file-word';
                } else if (['xls', 'xlsx'].includes(fileExt)) {
                    iconClass = 'fa-file-excel';
                } else if (['ppt', 'pptx'].includes(fileExt)) {
                    iconClass = 'fa-file-powerpoint';
                } else if (['zip', 'rar'].includes(fileExt)) {
                    iconClass = 'fa-file-archive';
                }
                
                // Prepare file actions based on whether file is existing (has URL) or new
                let downloadButton = '';
                if (fileItem.isExisting && fileItem.url) {
                    downloadButton = `
                        <button type="button" class="download-file" data-url="${fileItem.url}" data-name="${fileItem.name}">
                            <i class="fas fa-download"></i>
                        </button>
                    `;
                }
                
                li.innerHTML = `
                    <i class="fas ${iconClass} file-icon"></i>
                    <span class="file-name">${fileItem.name}</span>
                    <span class="file-size">${fileItem.size}</span>
                    <div class="file-actions">
                        ${downloadButton}
                        <button type="button" class="delete-file" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                fileList.appendChild(li);
                
                // Add event listener for delete button
                li.querySelector('.delete-file').addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    
                    // Remove file from array
                    attachedFiles.splice(index, 1);
                    
                    // Rerender file list
                    renderFileList();
                });
                
                // Add event listener for download button if it exists
                const downloadBtn = li.querySelector('.download-file');
                if (downloadBtn) {
                    downloadBtn.addEventListener('click', function() {
                        const url = this.getAttribute('data-url');
                        const fileName = this.getAttribute('data-name');
                        
                        // Create a temporary link element to trigger download
                        const downloadLink = document.createElement('a');
                        downloadLink.href = url;
                        downloadLink.target = '_blank';
                        downloadLink.download = fileName;
                        
                        // Append to document, trigger click and remove
                        document.body.appendChild(downloadLink);
                        downloadLink.click();
                        document.body.removeChild(downloadLink);
                    });
                }
            }
            
            function renderFileList() {
                fileList.innerHTML = '';
                
                if (attachedFiles.length === 0) {
                    fileList.innerHTML = '<li class="no-files">No files attached</li>';
                    return;
                }
                
                attachedFiles.forEach((fileItem, index) => {
                    addFileToList(fileItem, index);
                });
            }
            
            // Load locations from Firebase
            function loadLocations() {
                const locationSelect = document.getElementById('eventLocation');
                
                database.ref('locations').once('value')
                    .then(snapshot => {
                        // Clear existing options except the first one
                        while (locationSelect.options.length > 1) {
                            locationSelect.remove(1);
                        }
                        
                        if (snapshot.exists()) {
                            snapshot.forEach(locSnapshot => {
                                const loc = locSnapshot.val();
                                const option = document.createElement('option');
                                option.value = locSnapshot.key;
                                option.textContent = loc.name || locSnapshot.key;
                                locationSelect.appendChild(option);
                            });
                        } else {
                            // Add default locations if none exist
                            const defaultLocations = [
                                'Main Building', 'Warehouse', 'Production Floor', 
                                'Office Area', 'Loading Dock', 'Laboratory', 'Outdoor Yard'
                            ];
                            
                            defaultLocations.forEach(location => {
                                const option = document.createElement('option');
                                option.value = location.toLowerCase().replace(/\s+/g, '-');
                                option.textContent = location;
                                locationSelect.appendChild(option);
                            });
                        }
                        
                        // If editing an event, set the location value after options are loaded
                        if (currentEventData && currentEventData.location) {
                            locationSelect.value = currentEventData.location;
                        }
                    });
            }
            
            // Load departments from Firebase
            function loadDepartments() {
                const departmentSelect = document.getElementById('department');
                
                database.ref('departments').once('value')
                    .then(snapshot => {
                        // Clear existing options except the first one
                        while (departmentSelect.options.length > 1) {
                            departmentSelect.remove(1);
                        }
                        
                        if (snapshot.exists()) {
                            snapshot.forEach(deptSnapshot => {
                                const dept = deptSnapshot.val();
                                const option = document.createElement('option');
                                option.value = deptSnapshot.key;
                                option.textContent = dept.name || deptSnapshot.key;
                                departmentSelect.appendChild(option);
                            });
                        } else {
                            // Add default departments if none exist
                            const defaultDepts = ['Operations', 'Warehouse', 'Manufacturing', 'Logistics', 'Maintenance', 'Administration', 'HR', 'IT'];
                            defaultDepts.forEach(dept => {
                                const option = document.createElement('option');
                                option.value = dept.toLowerCase();
                                option.textContent = dept;
                                departmentSelect.appendChild(option);
                            });
                        }
                        
                        // If editing an event, set the department value after options are loaded
                        if (currentEventData && currentEventData.department) {
                            departmentSelect.value = currentEventData.department;
                        }
                    });
            }
            
            // Load users for assignment
            function loadUsers() {
                const assignedToSelect = document.getElementById('assignedTo');
                
                // Clear existing options except the first one
                while (assignedToSelect.options.length > 1) {
                    assignedToSelect.remove(1);
                }
                
                database.ref('users').once('value')
                    .then(snapshot => {
                        if (snapshot.exists()) {
                            snapshot.forEach(userSnapshot => {
                                const user = userSnapshot.val();
                                const option = document.createElement('option');
                                option.value = userSnapshot.key;
                                
                                // Determine display name
                                let displayName = '';
                                if (user.firstName && user.lastName) {
                                    displayName = `${user.firstName} ${user.lastName}`;
                                } else if (user.name) {
                                    displayName = user.name;
                                } else {
                                    displayName = user.email || `User ${userSnapshot.key}`;
                                }
                                
                                option.textContent = displayName;
                                assignedToSelect.appendChild(option);
                            });
                            
                            // Set the selected user after populating the dropdown
                            if (currentEventData && currentEventData.assignedTo) {
                                assignedToSelect.value = currentEventData.assignedTo;
                                
                                // If the assigned user doesn't exist in the dropdown (might have been deleted),
                                // add a temporary option with their ID as both value and text
                                if (assignedToSelect.value !== currentEventData.assignedTo) {
                                    const tempOption = document.createElement('option');
                                    tempOption.value = currentEventData.assignedTo;
                                    tempOption.textContent = `User ${currentEventData.assignedTo}`;
                                    assignedToSelect.appendChild(tempOption);
                                    assignedToSelect.value = currentEventData.assignedTo;
                                }
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error loading users:', error);
                    });
            }
            
            // Load existing event data if editing
            function loadEventData(eventId) {
                database.ref('events/' + eventId).once('value')
                    .then(snapshot => {
                        if (snapshot.exists()) {
                            const eventData = snapshot.val();
                            // Store event data globally for use in other functions
                            currentEventData = eventData;
                            
                            // Fill form fields with event data
                            document.getElementById('eventType').value = eventData.eventType || '';
                            document.getElementById('eventTitle').value = eventData.title || '';
                            document.getElementById('eventDate').value = eventData.dateOfEvent || '';
                            document.getElementById('eventTime').value = eventData.timeOfEvent || '';
                            document.getElementById('eventDescription').value = eventData.description || '';
                            document.getElementById('severity').value = eventData.severity || '';
                            document.getElementById('eventStatus').value = eventData.status || 'open';
                            document.getElementById('immediateActions').value = eventData.immediateActions || '';
                            document.getElementById('correctiveActions').value = eventData.correctiveActions || '';
                            document.getElementById('dueDate').value = eventData.dueDate || '';
                            document.getElementById('assignedTo').value = eventData.assignedTo || '';

                            // Load contributing factors if they exist
                            if (eventData.contributingFactors && Array.isArray(eventData.contributingFactors)) {
                                selectedFactorItems = eventData.contributingFactors.map(factor => ({
                                    value: factor.value,
                                    label: factor.label,
                                    color: factor.color || '#000000', // Default color if not specified
                                    description: factor.description || '',
                                    correctiveAction: factor.correctiveAction || '',
                                    deadline: factor.deadline || '',
                                    responsiblePerson: factor.responsiblePerson || ''
                                }));
                                renderSelectedFactors();
                            }

                            // Show event type specific section and populate fields
                            if (eventData.eventType) {
                                document.getElementById('eventType').dispatchEvent(new Event('change'));
                            }
                        } else {
                            alert('Event not found');
                            window.location.href = 'event.html';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading event data:', error);
                        alert('Error loading event data. Please try again.');
                    });
            }
            
            // Form submission
            document.getElementById('eventForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Disable submit button to prevent double submission
                document.getElementById('submitBtn').disabled = true;
                document.getElementById('submitBtn').textContent = 'Submitting...';
                
                try {
                    const eventId = document.getElementById('eventId').value;
                    const isNewEvent = !eventId;
                    
                    // Prepare event data with common fields
                    const eventData = {
                        eventType: document.getElementById('eventType').value,
                        title: document.getElementById('eventTitle').value,
                        dateOfEvent: document.getElementById('eventDate').value,
                        timeOfEvent: document.getElementById('eventTime').value,
                        location: document.getElementById('eventLocation').value,
                        department: document.getElementById('department').value,
                        description: document.getElementById('eventDescription').value,
                        severity: document.getElementById('severity').value,
                        status: document.getElementById('eventStatus').value,
                        immediateActions: document.getElementById('immediateActions').value,
                        contributingFactors: getSelectedFactors(), // Use the function to get selected factors
                        correctiveActions: document.getElementById('correctiveActions').value,
                        assignedTo: document.getElementById('assignedTo').value,
                        dueDate: document.getElementById('dueDate').value,
                        reportedBy: document.getElementById('reportedById').value,
                        reportedByName: document.getElementById('reportedBy').value,
                        dateReported: document.getElementById('reportDate').value,
                        updatedAt: new Date().toISOString()
                    };
                    
                    // Add event-type specific data
                    switch(eventData.eventType) {
                        case 'incident':
                        case 'near-miss':
                            eventData.injuryType = document.getElementById('injuryType').value;
                            eventData.propertyDamage = document.getElementById('propertyDamage').value;
                            eventData.incidentCategory = document.getElementById('incidentCategory').value;
                            eventData.workRelated = document.getElementById('workRelated').value;
                            break;
                            
                        case 'inspection':
                            eventData.inspectionArea = document.getElementById('inspectionArea').value;
                            eventData.inspectionType = document.getElementById('inspectionType').value;
                            eventData.checklistUsed = document.getElementById('checklistUsed').value;
                            eventData.inspectionFrequency = document.getElementById('inspectionFrequency').value;
                            eventData.inspectionFindings = document.getElementById('inspectionFindings').value;
                            eventData.totalItems = document.getElementById('totalItems').value;
                            eventData.nonConformities = document.getElementById('nonConformities').value;
                            eventData.selectedEquipment = selectedEquipmentItems; // Add selected equipment
                            break;
                            
                        case 'observation':
                            eventData.observationType = document.getElementById('observationType').value;
                            eventData.behaviorCategory = document.getElementById('behaviorCategory').value;
                            eventData.observationFeedback = document.getElementById('observationFeedback').value;
                            eventData.observationResponse = document.getElementById('observationResponse').value;
                            break;
                            
                        case 'audit':
                            eventData.auditScope = document.getElementById('auditScope').value;
                            eventData.auditStandard = document.getElementById('auditStandard').value;
                            eventData.auditType = document.getElementById('auditType').value;
                            eventData.leadAuditor = document.getElementById('leadAuditor').value;
                            eventData.auditTeam = document.getElementById('auditTeam').value;
                            eventData.majorFindings = document.getElementById('majorFindings').value;
                            eventData.minorFindings = document.getElementById('minorFindings').value;
                            break;
                    }
                    
                    // Add creation date for new events
                    if (isNewEvent) {
                        eventData.createdAt = new Date().toISOString();
                    }
                    
                    // Handle file uploads
                    let fileUploadPromises = [];
                    let newAttachments = [];
                    
                    // Keep track of existing files
                    const existingAttachments = attachedFiles.filter(file => file.isExisting);
                    
                    // Upload new files
                    const newFiles = attachedFiles.filter(file => !file.isExisting);
                    for (const fileItem of newFiles) {
                        if (fileItem.file) {
                            const storageRef = storage.ref(`event-attachments/${Date.now()}-${fileItem.name}`);
                            const uploadTask = storageRef.put(fileItem.file);
                            
                            const uploadPromise = uploadTask.then(() => {
                                return storageRef.getDownloadURL().then(downloadURL => {
                                    return {
                                        name: fileItem.name,
                                        url: downloadURL,
                                        size: fileItem.size,
                                        path: `event-attachments/${Date.now()}-${fileItem.name}`,
                                        uploadedAt: firebase.database.ServerValue.TIMESTAMP
                                    };
                                });
                            });
                            
                            fileUploadPromises.push(uploadPromise);
                        }
                    }
                    
                    // Wait for all uploads to complete
                    if (fileUploadPromises.length > 0) {
                        newAttachments = await Promise.all(fileUploadPromises);
                    }
                    
                    // Combine existing and new attachments
                    eventData.attachments = [...existingAttachments, ...newAttachments];
                    
                    // Save to Firebase
                    const eventRef = isNewEvent ? 
                        database.ref('events').push() : 
                        database.ref(`events/${eventId}`);
                    
                    await eventRef.set(eventData);

                    // Create notification data
                    const notificationData = {
                        title: isNewEvent ? 'New Event Created' : 'Event Updated',
                        message: `${isNewEvent ? 'A new event' : 'An event'} "${eventData.title}" has been ${isNewEvent ? 'created' : 'updated'}.`,
                        type: 'update',
                        targetUrl: `event.html?id=${isNewEvent ? eventRef.key : eventId}`,
                        relatedId: isNewEvent ? eventRef.key : eventId,
                        tag: 'Event',
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };

                    // Create notification in the global notifications collection
                    const notificationRef = await database.ref('notifications').push(notificationData);
                    const notificationId = notificationRef.key;

                    // Get all users who should be notified
                    const usersToNotify = new Set();
                    
                    // Add the current user (event creator) to notifications
                    const currentUserId = document.getElementById('reportedById').value;
                    usersToNotify.add(currentUserId);
                    
                    // Add the assigned user if present
                    if (eventData.assignedTo && eventData.assignedTo !== currentUserId) {
                        usersToNotify.add(eventData.assignedTo);
                    }
                    
                    // Check for admins or safety managers to notify
                    const usersSnapshot = await database.ref('users').once('value');
                    if (usersSnapshot.exists()) {
                        usersSnapshot.forEach(userSnapshot => {
                            const userData = userSnapshot.val();
                            if (userData.role === 'admin' || userData.role === 'safety-manager') {
                                if (userSnapshot.key !== eventData.assignedTo && userSnapshot.key !== currentUserId) {
                                    usersToNotify.add(userSnapshot.key);
                                }
                            }
                        });
                    }
                    
                    // Create user-specific notifications
                    const userNotificationUpdates = {};
                    for (const userId of usersToNotify) {
                        userNotificationUpdates[`users/${userId}/userNotifications/${notificationId}`] = {
                            id: notificationId,
                            read: false
                        };
                    }
                    
                    // Apply all updates atomically
                    await database.ref().update(userNotificationUpdates);

                    alert(`Event ${isNewEvent ? 'created' : 'updated'} successfully!`);
                    window.location.href = 'event.html';
                    
                } catch (error) {
                    console.error('Error saving event:', error);
                    alert(`Error: ${error.message}`);
                    
                    // Re-enable submit button
                    document.getElementById('submitBtn').disabled = false;
                    document.getElementById('submitBtn').textContent = document.getElementById('eventId').value ? 
                        'Update Event' : 'Submit Event';
                }

                // Get all users who should be notified
                const usersToNotify = new Set();
                
                // Add the current user (event creator) to notifications
                const currentUserId = document.getElementById('reportedById').value;
                usersToNotify.add(currentUserId);
                
                // Add the assigned user if present
                if (eventData.assignedTo && eventData.assignedTo !== currentUserId) {
                    usersToNotify.add(eventData.assignedTo);
                }
                
                // Check for admins or safety managers to notify
                try {
                    const usersSnapshot = await database.ref('users').once('value');
                    if (usersSnapshot.exists()) {
                        usersSnapshot.forEach(userSnapshot => {
                            const userData = userSnapshot.val();
                            // Assuming role property exists and identifies admins/managers
                            if (userData.role === 'admin' || userData.role === 'safety-manager') {
                                // Don't duplicate if already added as assigned user or creator
                                if (userSnapshot.key !== eventData.assignedTo && userSnapshot.key !== currentUserId) {
                                    usersToNotify.add(userSnapshot.key);
                                }
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error fetching users for notifications:', error);
                }
                
                // Create a global notification first for reference
                try {
                    const globalNotificationRef = await database.ref('notifications').push(notificationData);
                    const globalNotificationId = globalNotificationRef.key;
                    
                    // Create notifications for individual users with reference to the global notification
                    for (const userId of usersToNotify) {
                        try {
                            await database.ref(`users/${userId}/userNotifications/${globalNotificationId}`).set({
                                id: globalNotificationId,
                                read: false
                            });
                        } catch (error) {
                            console.error(`Error creating notification for user ${userId}:`, error);
                        }
                    }
                } catch (error) {
                    console.error('Error creating global notification:', error);
                }
            });
            
            // Save as draft functionality
            document.getElementById('saveAsDraftBtn').addEventListener('click', function() {
                const eventId = document.getElementById('eventId').value;
                const isNewEvent = !eventId;
                
                // Prepare minimal event data
                const eventData = {
                    eventType: document.getElementById('eventType').value || 'draft',
                    title: document.getElementById('eventTitle').value || 'Draft Event',
                    status: 'draft',
                    reportedBy: document.getElementById('reportedById').value,
                    reportedByName: document.getElementById('reportedBy').value,
                    dateReported: document.getElementById('reportDate').value,
                    updatedAt: new Date().toISOString()
                };
                
                // Add any other filled fields
                if (document.getElementById('eventDate').value) {
                    eventData.dateOfEvent = document.getElementById('eventDate').value;
                }
                
                if (document.getElementById('eventDescription').value) {
                    eventData.description = document.getElementById('eventDescription').value;
                }
                
                if (document.getElementById('eventLocation').value) {
                    eventData.location = document.getElementById('eventLocation').value;
                }
                
                if (document.getElementById('department').value) {
                    eventData.department = document.getElementById('department').value;
                }
                
                // Add creation date for new events
                if (isNewEvent) {
                    eventData.createdAt = new Date().toISOString();
                }
                
                // Save to Firebase
                const eventRef = isNewEvent ? 
                    database.ref('events').push() : 
                    database.ref(`events/${eventId}`);
                
                eventRef.set(eventData)
                    .then(() => {
                        alert('Event saved as draft.');
                        window.location.href = 'event.html';
                    })
                    .catch(error => {
                        console.error('Error saving draft:', error);
                        alert(`Error: ${error.message}`);
                    });
            });
            
            // Cancel button
            document.getElementById('cancelBtn').addEventListener('click', function() {
                if (confirm('Are you sure you want to cancel? Any unsaved changes will be lost.')) {
                    window.location.href = 'event.html';
                }
            });
        });
        
        // Add CSS styles for download button
        document.head.insertAdjacentHTML('beforeend', `
            <style>
                .file-actions button {
                    background: none;
                    border: none;
                    cursor: pointer;
                    font-size: 14px;
                    margin: 0 3px;
                }
                
                .download-file {
                    color: #3498db;
                }
                
                .download-file:hover {
                    color: #2980b9;
                }
                
                .delete-file {
                    color: #dc3545;
                }
                
                .delete-file:hover {
                    color: #c82333;
                }
            </style>
        `);

        // Load injury type options from fieldOptions in Firebase
        const injuryTypeSelect = document.getElementById('injuryType');
        
        // Clear existing options except the first one
        while (injuryTypeSelect.options.length > 1) {
            injuryTypeSelect.remove(1);
        }
        
        // Load options from Firebase injury-type collection
        database.ref('fieldOptions/injury-type').once('value')
            .then(snapshot => {
                if (snapshot.exists()) {
                    // Use options defined in settings
                    snapshot.forEach(optionSnapshot => {
                        const option = optionSnapshot.val();
                        if (option.enabled) {
                            const selectOption = document.createElement('option');
                            selectOption.value = option.value;
                            selectOption.textContent = option.label;
                            injuryTypeSelect.appendChild(selectOption);
                        }
                    });
                } else {
                    // Use default options if none exist in settings
                    const defaultInjuryTypes = [
                        {value: 'no-injury', label: 'No Injury'},
                        {value: 'minor', label: 'Minor - First Aid'},
                        {value: 'medical', label: 'Medical Treatment'},
                        {value: 'lost-time', label: 'Lost Time Injury'},
                        {value: 'fatality', label: 'Fatality'}
                    ];
                    
                    defaultInjuryTypes.forEach(injuryType => {
                        const option = document.createElement('option');
                        option.value = injuryType.value;
                        option.textContent = injuryType.label;
                        injuryTypeSelect.appendChild(option);
                    });
                }
            });

        // Load property damage options from fieldOptions in Firebase
        const propertyDamageSelect = document.getElementById('propertyDamage');
        
        // Clear all existing options
        while (propertyDamageSelect.options.length > 0) {
            propertyDamageSelect.remove(0);
        }
        
        // Add an empty default option
        const emptyOption = document.createElement('option');
        emptyOption.value = "";
        emptyOption.textContent = "Select Property Damage";
        propertyDamageSelect.appendChild(emptyOption);
        
        // Load options from Firebase property-damage collection
        database.ref('fieldOptions/property-damage').once('value')
            .then(snapshot => {
                if (snapshot.exists()) {
                    // Use options defined in settings
                    snapshot.forEach(optionSnapshot => {
                        const option = optionSnapshot.val();
                        if (option.enabled) {
                            const selectOption = document.createElement('option');
                            selectOption.value = option.value;
                            selectOption.textContent = option.label;
                            propertyDamageSelect.appendChild(selectOption);
                        }
                    });
                } else {
                    // Use default options if none exist in settings
                    const defaultPropertyDamage = [
                        {value: 'none', label: 'None'},
                        {value: 'minor', label: 'Minor'},
                        {value: 'significant', label: 'Significant'},
                        {value: 'major', label: 'Major'},
                        {value: 'vehicle', label: 'Vehicle Damage'},
                        {value: 'equipment', label: 'Equipment Damage'},
                        {value: 'structural', label: 'Structural Damage'}
                    ];
                    
                    defaultPropertyDamage.forEach(damage => {
                        const option = document.createElement('option');
                        option.value = damage.value;
                        option.textContent = damage.label;
                        propertyDamageSelect.appendChild(option);
                    });
                }
            });

        // Load incident category options from fieldOptions
        const incidentCategorySelect = document.getElementById('incidentCategory');
        
        // Clear all existing options
        while (incidentCategorySelect.options.length > 0) {
            incidentCategorySelect.remove(0);
        }
        
        // Add an empty default option
        const emptyCategoryOption = document.createElement('option');
        emptyCategoryOption.value = "";
        emptyCategoryOption.textContent = "Select Category";
        incidentCategorySelect.appendChild(emptyCategoryOption);
        
        // Load options from Firebase incident-category collection
        database.ref('fieldOptions/incident-category').once('value')
            .then(snapshot => {
                if (snapshot.exists()) {
                    // Use options defined in settings
                    snapshot.forEach(optionSnapshot => {
                        const option = optionSnapshot.val();
                        if (option.enabled) {
                            const selectOption = document.createElement('option');
                            selectOption.value = option.value;
                            selectOption.textContent = option.label;
                            incidentCategorySelect.appendChild(selectOption);
                        }
                    });
                } else {
                    // Use default options if none exist in settings
                    const defaultCategories = [
                        {value: 'slip-trip-fall', label: 'Slip, Trip, or Fall'},
                        {value: 'struck-by', label: 'Struck By Object'},
                        {value: 'caught-in-between', label: 'Caught In/Between'},
                        {value: 'vehicle-accident', label: 'Vehicle Accident'},
                        {value: 'electrical', label: 'Electrical'},
                        {value: 'fire-explosion', label: 'Fire/Explosion'},
                        {value: 'chemical-exposure', label: 'Chemical Exposure'},
                        {value: 'ergonomic', label: 'Ergonomic'},
                        {value: 'falling-object', label: 'Falling Object'},
                        {value: 'other', label: 'Other'}
                    ];
                    
                    defaultCategories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.value;
                        option.textContent = category.label;
                        incidentCategorySelect.appendChild(option);
                    });
                }
            });

        // Load observation type options from fieldOptions in Firebase
        const observationTypeSelect = document.getElementById('observationType');
        
        // Clear all existing options
        while (observationTypeSelect.options.length > 0) {
            observationTypeSelect.remove(0);
        }
        
        // Add an empty default option
        const emptyObservationOption = document.createElement('option');
        emptyObservationOption.value = "";
        emptyObservationOption.textContent = "Select Type";
        observationTypeSelect.appendChild(emptyObservationOption);
        
        // Load options from Firebase observation-type collection
        database.ref('fieldOptions/observation-type').once('value')
            .then(snapshot => {
                if (snapshot.exists()) {
                    // Use options defined in settings
                    snapshot.forEach(optionSnapshot => {
                        const option = optionSnapshot.val();
                        if (option.enabled) {
                            const selectOption = document.createElement('option');
                            selectOption.value = option.value;
                            selectOption.textContent = option.label;
                            observationTypeSelect.appendChild(selectOption);
                        }
                    });
                } else {
                    // Use default options if none exist in settings
                    const defaultObservationTypes = [
                        {value: 'unsafe-act', label: 'Unsafe Act'},
                        {value: 'unsafe-condition', label: 'Unsafe Condition'},
                        {value: 'safe-behavior', label: 'Safe Behavior'},
                        {value: 'good-practice', label: 'Good Practice'},
                        {value: 'improvement', label: 'Improvement Opportunity'}
                    ];
                    
                    defaultObservationTypes.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type.value;
                        option.textContent = type.label;
                        observationTypeSelect.appendChild(option);
                    });
                }
            });

        // Load behavior category options from fieldOptions in Firebase
        const behaviorCategorySelect = document.getElementById('behaviorCategory');
        
        // Clear all existing options
        while (behaviorCategorySelect.options.length > 0) {
            behaviorCategorySelect.remove(0);
        }
        
        // Add an empty default option
        const emptyBehaviorOption = document.createElement('option');
        emptyBehaviorOption.value = "";
        emptyBehaviorOption.textContent = "Select Category";
        behaviorCategorySelect.appendChild(emptyBehaviorOption);
        
        // Load options from Firebase behavior-category collection
        database.ref('fieldOptions/behavior-category').once('value')
            .then(snapshot => {
                if (snapshot.exists()) {
                    // Use options defined in settings
                    snapshot.forEach(optionSnapshot => {
                        const option = optionSnapshot.val();
                        if (option.enabled) {
                            const selectOption = document.createElement('option');
                            selectOption.value = option.value;
                            selectOption.textContent = option.label;
                            behaviorCategorySelect.appendChild(selectOption);
                        }
                    });
                } else {
                    // Use default options if none exist in settings
                    const defaultBehaviorCategories = [
                        {value: 'ppe-usage', label: 'PPE Usage'},
                        {value: 'procedures', label: 'Following Procedures'},
                        {value: 'housekeeping', label: 'Housekeeping'},
                        {value: 'ergonomics', label: 'Ergonomics'},
                        {value: 'tools-equipment', label: 'Tools & Equipment'},
                        {value: 'communication', label: 'Communication'},
                        {value: 'hazard-awareness', label: 'Hazard Awareness'},
                        {value: 'other', label: 'Other'}
                    ];
                    
                    defaultBehaviorCategories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.value;
                        option.textContent = category.label;
                        behaviorCategorySelect.appendChild(option);
                    });
                }
            });

        // Load inspection type options from fieldOptions in Firebase
        const inspectionTypeSelect = document.getElementById('inspectionType');
        
        // Clear all existing options
        while (inspectionTypeSelect.options.length > 0) {
            inspectionTypeSelect.remove(0);
        }
        
        // Add an empty default option
        const emptyInspectionOption = document.createElement('option');
        emptyInspectionOption.value = "";
        emptyInspectionOption.textContent = "Select Type";
        inspectionTypeSelect.appendChild(emptyInspectionOption);
        
        // Load options from Firebase inspection-type collection
        database.ref('fieldOptions/inspection-type').once('value')
            .then(snapshot => {
                if (snapshot.exists()) {
                    // Use options defined in settings
                    snapshot.forEach(optionSnapshot => {
                        const option = optionSnapshot.val();
                        if (option.enabled) {
                            const selectOption = document.createElement('option');
                            selectOption.value = option.value;
                            selectOption.textContent = option.label;
                            inspectionTypeSelect.appendChild(selectOption);
                        }
                    });
                } else {
                    // Use default options if none exist in settings
                    const defaultInspectionTypes = [
                        {value: 'routine', label: 'Routine'},
                        {value: 'planned', label: 'Planned'},
                        {value: 'follow-up', label: 'Follow-up'},
                        {value: 'regulatory', label: 'Regulatory'},
                        {value: 'pre-operational', label: 'Pre-Operational'},
                        {value: 'safety-walk', label: 'Safety Walk'},
                        {value: 'housekeeping', label: 'Housekeeping'},
                        {value: 'equipment-specific', label: 'Equipment-Specific'}
                    ];
                    
                    defaultInspectionTypes.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type.value;
                        option.textContent = type.label;
                        inspectionTypeSelect.appendChild(option);
                    });
                }
            });

        // Load equipment options from Firebase equipment collection
        function loadEquipmentOptions() {
            const equipmentSelect = document.getElementById('inspectionArea');
            
            // Clear all existing options except the first one
            while (equipmentSelect.options.length > 1) {
                equipmentSelect.remove(1);
            }
            
            // Load options from Firebase equipment collection
            database.ref('fieldOptions/equipment').once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        // Use options defined in settings
                        snapshot.forEach(optionSnapshot => {
                            const option = optionSnapshot.val();
                            if (option.enabled) {
                                const selectOption = document.createElement('option');
                                selectOption.value = option.value;
                                selectOption.textContent = option.label;
                                equipmentSelect.appendChild(selectOption);
                            }
                        });
                    } else {
                        // Use default options if none exist in settings
                        const defaultEquipment = [
                            {value: 'forklift', label: 'Forklift'},
                            {value: 'crane', label: 'Crane'},
                            {value: 'scaffold', label: 'Scaffold'},
                            {value: 'power-tools', label: 'Power Tools'},
                            {value: 'heavy-machinery', label: 'Heavy Machinery'},
                            {value: 'conveyor-belt', label: 'Conveyor Belt'},
                            {value: 'electrical-panel', label: 'Electrical Panel'},
                            {value: 'ventilation-system', label: 'Ventilation System'}
                        ];
                        
                        defaultEquipment.forEach(equipment => {
                            const option = document.createElement('option');
                            option.value = equipment.value;
                            option.textContent = equipment.label;
                            equipmentSelect.appendChild(option);
                        });
                    }
                    
                    // If editing an event, set the equipment value after options are loaded
                    if (currentEventData && currentEventData.inspectionArea) {
                        equipmentSelect.value = currentEventData.inspectionArea;
                    }
                });
        }

        // Initialize equipment modal functionality
        const equipmentModal = document.getElementById('equipmentModal');
        const equipmentList = document.getElementById('equipmentList');
        const equipmentSearch = document.getElementById('equipmentSearch');
        const addEquipmentBtn = document.getElementById('addEquipmentBtn');
        const selectEquipmentBtn = document.getElementById('selectEquipmentBtn');
        const cancelEquipmentBtn = document.getElementById('cancelEquipmentBtn');
        const closeModal = document.querySelector('.close-modal');
        
        let equipmentOptions = [];
        let selectedEquipment = null;
        
        // Load equipment for the modal
        function loadEquipmentForModal() {
            // Clear existing equipment in the list
            equipmentList.innerHTML = '';
            
            // Load options from Firebase equipment collection
            database.ref('fieldOptions/equipment').once('value')
                .then(snapshot => {
                    equipmentOptions = [];
                    
                    if (snapshot.exists()) {
                        // Use options defined in settings
                        snapshot.forEach(optionSnapshot => {
                            const option = optionSnapshot.val();
                            if (option.enabled) {
                                equipmentOptions.push({
                                    id: optionSnapshot.key,
                                    value: option.value,
                                    label: option.label
                                });
                            }
                        });
                    } else {
                        // Use default options if none exist in settings
                        const defaultEquipment = [
                            {value: 'forklift', label: 'Forklift'},
                            {value: 'crane', label: 'Crane'},
                            {value: 'scaffold', label: 'Scaffold'},
                            {value: 'power-tools', label: 'Power Tools'},
                            {value: 'heavy-machinery', label: 'Heavy Machinery'},
                            {value: 'conveyor-belt', label: 'Conveyor Belt'},
                            {value: 'electrical-panel', label: 'Electrical Panel'},
                            {value: 'ventilation-system', label: 'Ventilation System'}
                        ];
                        
                        equipmentOptions = defaultEquipment.map((equipment, index) => ({
                            id: `default-${index}`,
                            value: equipment.value,
                            label: equipment.label
                        }));
                    }
                    
                    // Render the equipment list
                    renderEquipmentList(equipmentOptions);
                });
        }
        
        // Render equipment list in the modal
        function renderEquipmentList(equipmentItems) {
            equipmentList.innerHTML = '';
            
            if (equipmentItems.length === 0) {
                equipmentList.innerHTML = '<div class="equipment-item">No equipment found. Add equipment in Settings.</div>';
                return;
            }
            
            equipmentItems.forEach(equipment => {
                const equipmentItem = document.createElement('div');
                equipmentItem.className = 'equipment-item';
                equipmentItem.dataset.value = equipment.value;
                equipmentItem.dataset.label = equipment.label;
                equipmentItem.textContent = equipment.label;
                
                // If this is the currently selected equipment, highlight it
                if (selectedEquipment && selectedEquipment.value === equipment.value) {
                    equipmentItem.classList.add('selected');
                }
                
                equipmentItem.addEventListener('click', function() {
                    // Remove selection from all items
                    document.querySelectorAll('.equipment-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    
                    // Add selection to this item
                    this.classList.add('selected');
                    
                    // Update selected equipment
                    selectedEquipment = {
                        value: this.dataset.value,
                        label: this.dataset.label
                    };
                });
                
                equipmentList.appendChild(equipmentItem);
            });
        }
        
        // Filter equipment based on search input
        function filterEquipment(searchText) {
            const filteredEquipment = equipmentOptions.filter(equipment => {
                return equipment.label.toLowerCase().includes(searchText.toLowerCase());
            });
            
            renderEquipmentList(filteredEquipment);
        }
        
        // Equipment search functionality
        equipmentSearch.addEventListener('input', function() {
            filterEquipment(this.value);
        });
        
        // Open equipment modal
        addEquipmentBtn.addEventListener('click', function() {
            // Get currently selected equipment from the dropdown
            const equipmentSelect = document.getElementById('inspectionArea');
            const selectedValue = equipmentSelect.value;
            const selectedLabel = equipmentSelect.options[equipmentSelect.selectedIndex].text;
            
            if (selectedValue) {
                selectedEquipment = {
                    value: selectedValue,
                    label: selectedLabel
                };
            } else {
                selectedEquipment = null;
            }
            
            // Load equipment options
            loadEquipmentForModal();
            
            // Show modal
            equipmentModal.style.display = 'block';
        });
        
        // Close modal when clicking the X
        closeModal.addEventListener('click', function() {
            equipmentModal.style.display = 'none';
        });
        
        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target === equipmentModal) {
                equipmentModal.style.display = 'none';
            }
        });
        
        // Select equipment button
        selectEquipmentBtn.addEventListener('click', function() {
            if (selectedEquipment) {
                // Add the selected equipment to the list
                addSelectedEquipment(selectedEquipment);
            }
            
            // Close the modal
            equipmentModal.style.display = 'none';
        });
        
        // Selected equipment container
        const selectedEquipmentContainer = document.getElementById('selectedEquipmentContainer');
        let selectedEquipmentItems = [];
        
        // Add selected equipment to the list
        function addSelectedEquipment(equipment) {
            // Check if equipment is already selected
            if (!selectedEquipmentItems.some(item => item.value === equipment.value)) {
                // Add to array with default quantity of 1
                selectedEquipmentItems.push({...equipment, quantity: 1});
                
                // Create DOM element and update total
                renderSelectedEquipmentItems();
            }
        }
        
        // Remove equipment from the list
        function removeSelectedEquipment(value) {
            // Remove from array
            selectedEquipmentItems = selectedEquipmentItems.filter(item => item.value !== value);
            
            // Update DOM and recalculate total
            renderSelectedEquipmentItems();
        }
        
        // When equipment quantity changes, update total items automatically
        function updateTotalItemsCount() {
            const totalItems = selectedEquipmentItems.reduce((sum, item) => {
                return sum + (parseInt(item.quantity, 10) || 1);
            }, 0);
            
            // Update the total items field
            document.getElementById('totalItems').value = totalItems;
        }
        
        // Modify the equipment quantity event listener to update totals
        function renderSelectedEquipmentItems() {
            // Clear container
            selectedEquipmentContainer.innerHTML = '';
            
            if (selectedEquipmentItems.length === 0) {
                // Show empty state
                const emptyState = document.createElement('div');
                emptyState.className = 'equipment-empty-state';
                emptyState.textContent = 'No equipment selected';
                selectedEquipmentContainer.appendChild(emptyState);
                
                // Reset total items to 0 when no equipment is selected
                document.getElementById('totalItems').value = 0;
                return;
            }
            
            // Add each item
            selectedEquipmentItems.forEach(equipment => {
                const equipmentItem = document.createElement('div');
                equipmentItem.className = 'selected-equipment-item';
                equipmentItem.dataset.value = equipment.value;
                
                equipmentItem.innerHTML = `
                    <div class="equipment-header">
                        <div class="equipment-name-section">
                            <span class="equipment-name">${equipment.label}</span>
                        </div>
                        <div class="equipment-quantity-section">
                            <span class="equipment-quantity-label">Quantity:</span>
                            <input type="number" class="equipment-quantity" data-value="${equipment.value}" 
                                   min="1" value="${equipment.quantity || 1}">
                            <button type="button" class="remove-equipment" data-value="${equipment.value}">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="equipment-findings-section">
                        <label class="equipment-findings-label" for="findings-${equipment.value}">Findings:</label>
                        <textarea class="equipment-findings" id="findings-${equipment.value}" data-value="${equipment.value}">${equipment.findings || ''}</textarea>
                    </div>
                `;
                
                // Add event listener for quantity input
                equipmentItem.querySelector('.equipment-quantity').addEventListener('input', function() {
                    const value = this.dataset.value;
                    const quantity = parseInt(this.value, 10) || 1;
                    
                    // Update the quantity in the selectedEquipmentItems array
                    const equipmentToUpdate = selectedEquipmentItems.find(item => item.value === value);
                    if (equipmentToUpdate) {
                        equipmentToUpdate.quantity = quantity;
                    }
                    
                    // Update total items count
                    updateTotalItemsCount();
                });
                
                // Add event listener for findings textarea
                equipmentItem.querySelector('.equipment-findings').addEventListener('input', function() {
                    const value = this.dataset.value;
                    const findings = this.value;
                    
                    // Update the findings in the selectedEquipmentItems array
                    const equipmentToUpdate = selectedEquipmentItems.find(item => item.value === value);
                    if (equipmentToUpdate) {
                        equipmentToUpdate.findings = findings;
                    }
                });
                
                // Add event listener for remove button
                equipmentItem.querySelector('.remove-equipment').addEventListener('click', function() {
                    removeSelectedEquipment(this.dataset.value);
                });
                
                selectedEquipmentContainer.appendChild(equipmentItem);
            });
            
            // Update total items count after rendering all equipment
            updateTotalItemsCount();
        }
        
        // Update addSelectedEquipment to include total recalculation
        function addSelectedEquipment(equipment) {
            // Check if equipment is already selected
            if (!selectedEquipmentItems.some(item => item.value === equipment.value)) {
                // Add to array with default quantity of 1
                selectedEquipmentItems.push({...equipment, quantity: 1});
                
                // Create DOM element and update total
                renderSelectedEquipmentItems();
            }
        }
        
        // Update removeSelectedEquipment to include total recalculation
        function removeSelectedEquipment(value) {
            // Remove from array
            selectedEquipmentItems = selectedEquipmentItems.filter(item => item.value !== value);
            
            // Update DOM and recalculate total
            renderSelectedEquipmentItems();
        }
        
        // Load selected equipment when editing an event
        function loadSelectedEquipmentFromEvent(eventData) {
            if (eventData && eventData.selectedEquipment && Array.isArray(eventData.selectedEquipment)) {
                selectedEquipmentItems = eventData.selectedEquipment;
                renderSelectedEquipmentItems();
            } else if (eventData && eventData.inspectionArea) {
                // For backwards compatibility with old data format
                const equipmentSelect = document.getElementById('inspectionArea');
                
                // Find the label for the selected value
                let label = '';
                for (let i = 0; i < equipmentSelect.options.length; i++) {
                    if (equipmentSelect.options[i].value === eventData.inspectionArea) {
                        label = equipmentSelect.options[i].text;
                        break;
                    }
                }
                
                if (label) {
                    addSelectedEquipment({
                        value: eventData.inspectionArea,
                        label: label
                    });
                }
            }
        }
        
        // Initialize equipment options when the document is loaded
        loadEquipmentOptions();

        // Load contributing factors options from fieldOptions in Firebase
        const contributingFactorsSelect = document.getElementById('contributingFactors');
        
        // Load options from Firebase contributing-factors collection
        database.ref('fieldOptions/contributing-factors').once('value')
            .then(snapshot => {
                if (snapshot.exists()) {
                    // Use options defined in settings
                    snapshot.forEach(optionSnapshot => {
                        const option = optionSnapshot.val();
                        if (option.enabled) {
                            const selectOption = document.createElement('option');
                            selectOption.value = option.value;
                            selectOption.textContent = option.label;
                            selectOption.style.color = option.color;
                            contributingFactorsSelect.appendChild(selectOption);
                        }
                    });
                } else {
                    // Use default options if none exist in settings
                    const defaultContributingFactors = [
                        {value: 'human-error', label: 'Human Error', color: '#dc3545'},
                        {value: 'equipment-failure', label: 'Equipment Failure', color: '#fd7e14'},
                        {value: 'environmental', label: 'Environmental Conditions', color: '#20c997'},
                        {value: 'procedural', label: 'Procedural Deficiency', color: '#0d6efd'},
                        {value: 'training-gap', label: 'Training Gap', color: '#6f42c1'},
                        {value: 'communication', label: 'Communication Breakdown', color: '#6610f2'},
                        {value: 'design-flaw', label: 'Design Flaw', color: '#17a2b8'},
                        {value: 'supervision', label: 'Inadequate Supervision', color: '#ffc107'},
                        {value: 'time-pressure', label: 'Time Pressure', color: '#6c757d'}
                    ];
                    
                    defaultContributingFactors.forEach(factor => {
                        const option = document.createElement('option');
                        option.value = factor.value;
                        option.textContent = factor.label;
                        option.style.color = factor.color;
                        contributingFactorsSelect.appendChild(option);
                    });
                }
            });

        // Initialize selected factors array
        let selectedFactorItems = [];

        // Add factor button click handler
        document.getElementById('addFactorBtn').addEventListener('click', function() {
            const select = document.getElementById('contributingFactors');
            const selectedOption = select.options[select.selectedIndex];
            
            if (select.value) {
                const factor = {
                    value: select.value,
                    label: selectedOption.textContent,
                    color: selectedOption.style.color,
                    description: '',
                    correctiveAction: '',
                    deadline: '',
                    responsiblePerson: ''
                };
                
                if (!selectedFactorItems.some(item => item.value === factor.value)) {
                    selectedFactorItems.push(factor);
                    renderSelectedFactors();
                }
                
                select.selectedIndex = 0;
            }
        });

        // Render selected factors
        function renderSelectedFactors() {
            const container = document.getElementById('selectedFactorsContainer');
            container.innerHTML = '';
            
            selectedFactorItems.forEach(factor => {
                const factorElement = document.createElement('div');
                factorElement.className = 'selected-factor-item';
                factorElement.innerHTML = `
                    <div class="factor-header">
                        <span style="color: ${factor.color}">${factor.label}</span>
                        <button type="button" class="remove-factor" data-value="${factor.value}">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="factor-details">
                        <div class="form-group">
                            <label>Description</label>
                            <textarea class="form-control factor-description" placeholder="Describe the contributing factor">${factor.description || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label>Corrective Action</label>
                            <textarea class="form-control factor-corrective-action" placeholder="Describe the corrective action">${factor.correctiveAction || ''}</textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label>Deadline</label>
                                <input type="date" class="form-control factor-deadline" value="${factor.deadline || ''}">
                            </div>
                            <div class="form-group col-md-6">
                                <label>Responsible Person</label>
                                <select class="form-control factor-responsible">
                                    <option value="">Select Person</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(factorElement);

                // Add event listeners for the new fields
                const descriptionField = factorElement.querySelector('.factor-description');
                const correctiveActionField = factorElement.querySelector('.factor-corrective-action');
                const deadlineField = factorElement.querySelector('.factor-deadline');
                const responsibleField = factorElement.querySelector('.factor-responsible');

                // Populate the responsible person dropdown
                const responsibleSelect = factorElement.querySelector('.factor-responsible');
                database.ref('users').once('value').then(snapshot => {
                    if (snapshot.exists()) {
                        snapshot.forEach(userSnapshot => {
                            const user = userSnapshot.val();
                            const option = document.createElement('option');
                            option.value = userSnapshot.key;
                            option.textContent = user.firstName && user.lastName ? 
                                `${user.firstName} ${user.lastName}` : user.email || userSnapshot.key;
                            responsibleSelect.appendChild(option);
                        });
                        // Set the selected value if it exists
                        if (factor.responsiblePerson) {
                            responsibleSelect.value = factor.responsiblePerson;
                        }
                    }
                });

                // Update the factor object when fields change
                descriptionField.addEventListener('change', function() {
                    factor.description = this.value;
                });

                correctiveActionField.addEventListener('change', function() {
                    factor.correctiveAction = this.value;
                });

                deadlineField.addEventListener('change', function() {
                    factor.deadline = this.value;
                });

                responsibleField.addEventListener('change', function() {
                    factor.responsiblePerson = this.value;
                });

                // Add event listener for remove button
                factorElement.querySelector('.remove-factor').addEventListener('click', function() {
                    const value = this.getAttribute('data-value');
                    selectedFactorItems = selectedFactorItems.filter(item => item.value !== value);
                    renderSelectedFactors();
                });
            });
        }

        // Modify the existing event data preparation to include selected factors
        function getSelectedFactors() {
            return selectedFactorItems.map(item => ({
                value: item.value,
                label: item.label,
                color: item.color,
                description: item.description,
                correctiveAction: item.correctiveAction,
                deadline: item.deadline,
                responsiblePerson: item.responsiblePerson
            }));
        }
    </script>
</body>
</html>
