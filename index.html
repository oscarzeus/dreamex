<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Dreamex Lab</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Modern color palette and base styles */
        :root {
            --primary: #1E88E5;
            --primary-dark: #1565C0;
            --secondary: #43A047;
            --dark: #2E3B4E;
            --warning: #F9A825;
            --danger: #E53935;
            --light: #f9f9f9;
            --info: #00ACC1;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* Beautiful animated background */
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(-45deg, #1E88E5, #43A047, #2E3B4E, #00ACC1);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center; /* Center the login form vertically */
            align-items: center;     /* Center the login form horizontally */
            color: #34495e;
            position: relative;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }
        
        /* Animated gradient background */
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Remove the previous background image for a cleaner look */
        body::before {
            content: none;
        }
        
        /* Floating particles */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }
        
        .particle {
            position: absolute;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.3);
            pointer-events: none;
            z-index: -1;
        }

        /* Login Container Enhancement - Even Further Height Reduction */
        .login-container {
            background: rgba(255, 255, 255, 0.9);
            max-width: 420px; /* Reduced from 450px */
            width: 90%;
            margin: 10px auto; /* Reduced from 20px auto */
            padding: 15px; /* Reduced from 20px */
            border-radius: 12px; /* Reduced from 16px */
            box-shadow: 
                0 10px 25px rgba(0, 0, 0, 0.15),
                0 2px 5px rgba(0, 0, 0, 0.1),
                0 0 50px rgba(255, 255, 255, 0.1);
            text-align: center;
            position: relative;
            overflow: hidden;
            animation: fadeIn 0.8s ease-out;
            backdrop-filter: blur(10px);
        }
        
        .login-container::before {
            content: '';
            position: absolute;
            top: -50px;
            left: -50px;
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, var(--secondary) 0%, transparent 70%);
            border-radius: 50%;
            opacity: 0.1;
        }
        
        .login-container::after {
            content: '';
            position: absolute;
            bottom: -50px;
            right: -50px;
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, var(--primary) 0%, transparent 70%);
            border-radius: 50%;
            opacity: 0.1;
        }
        
        /* Logo Enhancement - Further Size Reduction */
        .login-logo {
            margin-bottom: 10px; /* Reduced from 15px */
            text-align: center;
            position: relative;
        }
        
        .login-logo svg {
            width: 60px; /* Reduced from 70px */
            height: 60px; /* Reduced from 70px */
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
            transition: transform 0.5s ease;
        }
        
        .login-logo svg:hover {
            transform: scale(1.05) rotate(5deg);
        }
        
        .login-title {
            font-size: 20px; /* Reduced from 22px */
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 8px; /* Reduced from 12px */
            position: relative;
        }
        
        .login-title::after {
            content: '';
            position: absolute;
            bottom: -5px; /* Adjusted from -6px */
            left: 50%;
            transform: translateX(-50%);
            width: 50px; /* Reduced from 60px */
            height: 2px; /* Reduced from 3px */
            background: linear-gradient(to right, var(--secondary), var(--primary));
            border-radius: 3px;
        }

        /* Form Elements - Even More Height Reduction */
        .login-form {
            margin-top: 10px; /* Reduced from 15px */
        }
        
        .login-form .form-group {
            margin-bottom: 8px; /* Reduced from 12px */
            text-align: left;
            position: relative;
        }
        
        .login-form label {
            display: block;
            margin-bottom: 2px; /* Reduced from 4px */
            font-weight: 500;
            font-size: 13px; /* Reduced from 14px */
            color: var(--dark);
            transition: all 0.3s;
        }
        
        .login-form input {
            width: 100%;
            padding: 8px 12px; /* Reduced from 10px 14px */
            border: 1px solid #e0e0e0;
            border-radius: 5px; /* Reduced from 6px */
            font-size: 14px; /* Reduced from 15px */
            transition: all 0.3s;
            background-color: #f9f9fb;
            color: #495057;
        }
        
        .login-form input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.2);
            background-color: #fff;
        }
        
        /* Error Styling */
        .error-message {
            color: var(--danger);
            font-size: 12px; /* Reduced from 13px */
            margin-top: 3px; /* Reduced from 6px */
            display: none;
            transition: all 0.3s;
            opacity: 0;
            transform: translateY(-5px);
        }
        
        .login-form .has-error input {
            border-color: var(--danger);
            background-color: rgba(229, 57, 53, 0.05);
        }
        
        .login-form .has-error label {
            color: var(--danger);
        }
        
        .login-form .has-error .error-message {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        /* Button Styling - Further Height Reduction */
        .login-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 8px 0; /* Reduced from 10px */
            border-radius: 6px; /* Reduced from 8px */
            font-size: 14px; /* Reduced from 15px */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            margin-bottom: 8px; /* Reduced from 12px */
            box-shadow: 0 4px 6px rgba(21, 101, 192, 0.2);
        }
        
        .login-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.2),
                transparent
            );
            transition: left 0.7s;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(21, 101, 192, 0.3);
        }
        
        .login-btn:hover::before {
            left: 100%;
        }
        
        .login-btn:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px rgba(21, 101, 192, 0.3);
        }
        
        .login-btn:disabled {
            background: linear-gradient(135deg, #bdc3c7, #95a5a6);
            cursor: not-allowed;
        }

        /* Divider Styling - Further Height Reduction */
        .divider {
            display: flex;
            align-items: center;
            margin: 8px 0; /* Reduced from 12px */
            color: #95a5a6;
            font-size: 13px; /* Reduced from 14px */
        }
        
        .divider:before,
        .divider:after {
            content: "";
            flex: 1;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .divider:before {
            margin-right: 10px; /* Reduced from 15px */
        }
        
        .divider:after {
            margin-left: 10px; /* Reduced from 15px */
        }

        /* Social Login Styling - Further Height Reduction */
        .social-login {
            margin-bottom: 10px; /* Reduced from 16px */
        }
        
        .google-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #ffffff;
            color: #5f6368;
            border: 1px solid #e0e0e0;
            padding: 6px 0; /* Reduced from 8px */
            border-radius: 8px;
            font-size: 14px; /* Reduced from 16px */
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .google-btn:hover {
            background-color: #f9f9fa;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        .google-btn:active {
            transform: translateY(1px);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .google-btn img {
            width: 18px; /* Reduced from 20px */
            height: 18px; /* Reduced from 20px */
            margin-right: 8px; /* Reduced from 10px */
        }
        
        /* Additional Links - Further Height Reduction */
        .additional-links {
            margin-top: 8px; /* Reduced from 12px */
            color: #7f8c8d;
            font-size: 12px; /* Reduced from 13px */
            line-height: 1.3; /* Reduced from 1.4 */
        }
        
        .additional-links a {
            color: var(--primary);
            text-decoration: none;
            position: relative;
            transition: all 0.3s;
            padding-bottom: 2px;
        }
        
        .additional-links a::after {
            content: '';
            position: absolute;
            width: 0;
            height: 1px;
            bottom: 0;
            left: 0;
            background-color: var(--primary);
            transition: width 0.3s;
        }
        
        .additional-links a:hover {
            color: var(--primary-dark);
        }
        
        .additional-links a:hover::after {
            width: 100%;
        }
        
        .additional-links p {
            margin: 4px 0; /* New property to reduce spacing between links */
        }
        
        /* Alert Message Enhancement - Further Height Reduction */
        .alert {
            padding: 8px; /* Reduced from 10px */
            margin-bottom: 8px; /* Reduced from 12px */
            border-radius: 6px; /* Reduced from 8px */
            display: none;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.3s, transform 0.3s;
            font-size: 12px; /* Reduced from 13px */
        }
        
        .alert.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .alert-error {
            background-color: rgba(231, 76, 60, 0.1);
            color: #c0392b;
            border-left: 4px solid #e74c3c;
        }
        
        .alert-success {
            background-color: rgba(39, 174, 96, 0.1);
            color: #27ae60;
            border-left: 4px solid #2ecc71;
        }

        /* Loading Indicator Enhancement */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .loading-overlay.show {
            opacity: 1;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            position: relative;
        }
        
        .loading-spinner:before, 
        .loading-spinner:after {
            content: '';
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: var(--primary);
            opacity: 0.6;
            position: absolute;
            top: 0;
            left: 0;
            animation: pulse 2s infinite ease-in-out;
        }
        
        .loading-spinner:after {
            animation-delay: -1s;
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(0);
            } 
            50% {
                transform: scale(1);
            }
        }
        
        /* Already Logged In Container - Further Height Reduction */
        #alreadyLoggedInContainer {
            display: none;
            text-align: center;
            padding: 5px 0; /* Reduced from 8px */
            animation: fadeIn 0.5s ease-out;
        }
        
        #alreadyLoggedInContainer p {
            font-size: 14px; /* Reduced from 15px */
            margin-bottom: 8px; /* Reduced from 12px */
            color: var(--dark);
        }
        
        #switchAccountBtn {
            margin-top: 6px; /* Reduced from 8px */
            background-color: #f8f9fa;
            border: 1px solid #e0e0e0;
        }
        
        #switchAccountBtn:hover {
            background-color: #f1f3f4;
        }
        
        /* Remove unnecessary decorative elements to save space */
        .safety-icon {
            display: none;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .login-container {
                width: 95%;
                padding: 30px 20px;
                margin: 80px auto;
            }
            
            .login-title {
                font-size: 24px;
            }
            
            .login-form input {
                padding: 12px 15px;
            }
            
            .login-btn {
                padding: 12px 0;
            }
        }
    </style>
    <!-- Load Firebase SDKs directly in the head -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    
    <!-- THEN load AuthManager before the main script -->
    <script src="js/authManager.js"></script>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="particles"></div>

    <div class="login-container">
        <div class="login-logo">
            <!-- Replace with your logo -->
            <svg width="60" height="60" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect width="80" height="80" rx="16" fill="#3498db" fill-opacity="0.1"/>
                <path d="M40 16C26.7452 16 16 26.7452 16 40C16 53.2548 26.7452 64 40 64C53.2548 64 64 53.2548 64 40C64 26.7452 53.2548 16 40 16Z" stroke="#3498db" stroke-width="4"/>
                <path d="M40 28V52" stroke="#3498db" stroke-width="4" stroke-linecap="round"/>
                <path d="M28 40H52" stroke="#3498db" stroke-width="4" stroke-linecap="round"/>
            </svg>
        </div>
        <h1 class="login-title">Welcome Back</h1>
        
        <div class="alert alert-error" id="errorAlert"></div>
        <div class="alert alert-success" id="successAlert" style="display: none;"></div>
        
        <!-- New already-logged-in message container -->
        <div id="alreadyLoggedInContainer" style="display: none; text-align: center; margin-bottom: 20px;">
            <p style="font-size: 16px; margin-bottom: 20px;">You are already logged in.</p>
            <button type="button" class="login-btn" id="continueToSiteBtn">Continue to Site</button>
            <button type="button" class="google-btn" id="switchAccountBtn" style="margin-top: 10px;">
                Switch Account
            </button>
        </div>
        
        <form class="login-form" id="loginForm">
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" required>
                <div class="error-message">Please enter a valid email address</div>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" required>
                <div class="error-message">Password is required</div>
            </div>
            
            <button type="submit" class="login-btn" id="loginButton">Log In</button>
        </form>
        
        <div class="divider">or</div>
        
        <div class="social-login">
            <button class="google-btn" id="googleSignInBtn">
                <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google">
                Sign in with Google
            </button>
        </div>
        
        <div class="additional-links">
            <p>Don't have an account? <a href="signup.html">Sign Up</a></p>
            <p><a href="forgot-password.html">Forgot your password?</a></p>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.appspot.com",
            messagingSenderId: "829083030831",
            appId: "1:829083030831:web:36a370e62691e560bc3dda"
        };
        
        // Clean, direct Firebase initialization
        let auth;
        let database;
        
        // Initialize Firebase ONLY once (avoid multiple initializations)
        if (firebase.apps.length === 0) {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase initialized in login page");
        } else {
            console.log("Using existing Firebase initialization");
        }
        
        // Get Firebase services
        auth = firebase.auth();
        database = firebase.database();
        
        // Explicitly set auth persistence to LOCAL
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
            .then(() => console.log("Firebase persistence set to LOCAL"))
            .catch(e => console.error("Error setting persistence:", e));
        
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const returnUrl = urlParams.get('returnUrl') || 'login.html';
        const redirectParam = urlParams.get('redirect') || '';
        
        // Check if this is a login page reload - prevent login loops
        const isRedirectFromLogin = sessionStorage.getItem('loginRedirectAttempt') === 'true';
        if (isRedirectFromLogin) {
            // Clear the redirect attempt flag
            sessionStorage.removeItem('loginRedirectAttempt');
            console.warn("Preventing login redirect loop");
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const loginForm = document.getElementById('loginForm');
            const googleSignInBtn = document.getElementById('googleSignInBtn');
            const errorAlert = document.getElementById('errorAlert');
            const successAlert = document.getElementById('successAlert');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const alreadyLoggedInContainer = document.getElementById('alreadyLoggedInContainer');
            const continueToSiteBtn = document.getElementById('continueToSiteBtn');
            const switchAccountBtn = document.getElementById('switchAccountBtn');
            
            // SIMPLE, DIRECT LOGIN IMPLEMENTATION
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password').value;
                
                // Basic validation
                let isValid = true;
                
                if (!email || !email.includes('@')) {
                    document.getElementById('email').parentNode.classList.add('has-error');
                    showError("Oops! That doesn't look like a valid email. Please check and try again.");
                    isValid = false;
                } else {
                    document.getElementById('email').parentNode.classList.remove('has-error');
                }
                
                if (!password) {
                    document.getElementById('password').parentNode.classList.add('has-error');
                    showError("Password is required. Please enter your password to continue.");
                    isValid = false;
                } else {
                    document.getElementById('password').parentNode.classList.remove('has-error');
                }
                
                if (isValid) {
                    // Show loading indicator immediately
                    showLoading();
                    
                    // DIRECT FIREBASE AUTHENTICATION - simplest approach
                    console.log(`Attempting Firebase login for: ${email}`);
                    
                    auth.signInWithEmailAndPassword(email, password)
                        .then((userCredential) => {
                            // Authentication successful
                            const user = userCredential.user;
                            console.log('Login successful for:', email);
                            
                            // Update user data in database
                            updateUserData(user);
                            
                            // ENHANCED: Set robust auth flags across storage mechanisms
                            setAuthenticationFlags(user);
                            
                            // Set a flag that we just logged in (for auth state change handler)
                            sessionStorage.setItem('justLoggedIn', 'true');
                            
                            // Show success message - the auth state change handler will do the redirect
                            hideLoading();
                            showSuccess("Login successful! Redirecting...");
                        })
                        .catch((error) => {
                            // Authentication failed
                            console.error("Firebase login error:", error.code, error.message);
                            hideLoading();
                            
                            // Pass full error object, not just error.code
                            const errorMessage = getAuthErrorMessage(error.code) || error.message;
                            showError(errorMessage);
                            
                            // Log failed attempt
                            logAction('FAILED_LOGIN', {
                                method: 'email',
                                error: error.code,
                                errorMessage: error.message,
                                email: email
                            });
                        });
                }
            });
            
            // Google Sign In
            googleSignInBtn.addEventListener('click', function() {
                showLoading();
                
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.setCustomParameters({ prompt: 'select_account' });
                
                auth.signInWithPopup(provider)
                    .then((result) => {
                        const user = result.user;
                        
                        // Save or update user data
                        const userRef = database.ref('users/' + user.uid);
                        userRef.once('value').then((snapshot) => {
                            if (!snapshot.exists()) {
                                userRef.set({
                                    email: user.email,
                                    displayName: user.displayName,
                                    photoURL: user.photoURL,
                                    role: 'user',
                                    lastLogin: firebase.database.ServerValue.TIMESTAMP
                                });
                            } else {
                                userRef.update({
                                    lastLogin: firebase.database.ServerValue.TIMESTAMP,
                                    photoURL: user.photoURL // Update photo in case it changed
                                });
                            }
                        });
                        
                        // Log successful login
                        logAction('LOGIN', {method: 'google', email: user.email});
                        
                        // ENHANCED: Also set robust auth flags
                        setAuthenticationFlags(user);
                        
                        // Set flag for automatic redirect
                        sessionStorage.setItem('justLoggedIn', 'true');
                        
                        // Show success - auth state change will handle redirect
                        hideLoading();
                        showSuccess("Login successful! Redirecting...");
                    })
                    .catch((error) => {
                        console.error("Google sign-in error:", error);
                        
                        // Log more details about the error
                        console.log("Error code:", error.code);
                        console.log("Error message:", error.message);
                        
                        logAction('FAILED_LOGIN', {
                            method: 'google',
                            error: error.code,
                            errorMessage: error.message
                        });
                        
                        hideLoading();
                        const errorMessage = getAuthErrorMessage(error.code) || error.message;
                        showError(errorMessage);
                    });
            });
            
            // Continue to site button clicked
            continueToSiteBtn.addEventListener('click', function() {
                window.location.href = returnUrl;
            });
            
            // Switch account button clicked
            switchAccountBtn.addEventListener('click', function() {
                showLoading();
                
                auth.signOut().then(() => {
                    hideLoading();
                    alreadyLoggedInContainer.style.display = 'none';
                    loginForm.style.display = 'block';
                    document.querySelector('.divider').style.display = 'flex';
                    document.querySelector('.social-login').style.display = 'block';
                }).catch((error) => {
                    console.error("Error signing out:", error);
                    hideLoading();
                    showError("Error signing out. Please try again.");
                });
            });
            
            // Function to show loading overlay
            function showLoading() {
                loadingOverlay.style.display = 'flex';
                setTimeout(() => {
                    loadingOverlay.classList.add('show');
                }, 10);
            }
            
            // Function to hide loading overlay
            function hideLoading() {
                loadingOverlay.classList.remove('show');
                setTimeout(() => {
                    loadingOverlay.style.display = 'none';
                }, 300);
            }
            
            // Function to show error message
            function showError(message) {
                errorAlert.textContent = message;
                errorAlert.style.display = 'block';
                successAlert.style.display = 'none';
                
                setTimeout(() => {
                    errorAlert.classList.add('show');
                }, 10);
                
                setTimeout(() => {
                    errorAlert.classList.remove('show');
                    setTimeout(() => {
                        errorAlert.style.display = 'none';
                    }, 300);
                }, 5000);
            }
            
            // Function to show success message
            function showSuccess(message) {
                successAlert.textContent = message;
                successAlert.style.display = 'block';
                errorAlert.style.display = 'none';
                
                setTimeout(() => {
                    successAlert.classList.add('show');
                }, 10);
            }
            
            // Function to log actions to Firebase
            function logAction(action, details = {}) {
                const logRef = database.ref('auditLogs').push();
                logRef.set({
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    action: action,
                    details: details
                });
            }
            
            // Function to get user-friendly error message
            function getAuthErrorMessage(errorCode) {
                console.log("Error code received:", errorCode);
                
                switch (errorCode) {
                    case 'auth/invalid-email':
                        return "Oops! That doesn't look like a valid email. Please check and try again.";
                    case 'auth/user-disabled':
                        return "This account has been disabled. If you think this is a mistake, please contact support.";
                    case 'auth/user-not-found':
                        return "We couldn't find an account with this email. Double-check or sign up if you're new.";
                    case 'auth/wrong-password':
                        return "Incorrect password. Try again or reset it if you've forgotten.";
                    case 'auth/invalid-login-credentials':
                        return "Invalid email or password. Please check your credentials and try again.";
                    case 'auth/too-many-requests':
                        return "Too many failed attempts. Your account is temporarily locked. Please try again later.";
                    case 'auth/popup-closed-by-user':
                        return "It looks like you closed the sign-in window before finishing. Try again when you're ready!";
                    case 'auth/cancelled-popup-request':
                        return "Sign-in was canceled. If this wasn't intentional, try again.";
                    case 'auth/popup-blocked':
                        return "Your browser blocked the sign-in popup. Please enable popups or try a different method.";
                    case 'auth/email-already-in-use':
                        return "This email is already in use. Please try logging in or use a different email.";
                    case 'auth/weak-password':
                        return "Your password is too weak. Please use a stronger password with at least 6 characters.";
                    case 'auth/network-request-failed':
                        return "Network error. Please check your internet connection and try again.";
                    case 'auth/invalid-credential':
                        return "Invalid login credentials. Please check your email and password.";
                    case 'auth/operation-not-allowed':
                        return "Login with this method is not enabled. Please contact support.";
                    case 'auth/account-exists-with-different-credential':
                        return "An account already exists with the same email but different sign-in credentials.";
                    default:
                        // For unknown errors, return the actual Firebase error message
                        return errorCode ? `Error: ${errorCode}` : "Something went wrong during sign-in. Please try again.";
                }
            }
            
            // Improved auth state change handler with automatic redirect
            auth.onAuthStateChanged(function(user) {
                if (user) {
                    console.log("User is logged in:", user.email);
                    
                    // If the user just logged in (not a page reload), redirect them
                    const justLoggedIn = sessionStorage.getItem('justLoggedIn') === 'true';
                    
                    if (justLoggedIn) {
                        // Clear the flag
                        sessionStorage.removeItem('justLoggedIn');
                        
                        // Get redirect URL - prioritize redirect param, then returnUrl, then default
                        const redirectTo = redirectParam || returnUrl || 'index.html';
                        
                        console.log(`Auto-redirecting to: ${redirectTo}`);
                        window.location.href = redirectTo;
                        return;
                    } else if (!isRedirectFromLogin) {
                        // This might be a page reload or direct access to login page while logged in
                        // Set redirect attempt flag to prevent loops
                        sessionStorage.setItem('loginRedirectAttempt', 'true');
                        
                        // Determine where to redirect
                        const currentPath = window.location.pathname;
                        // Only redirect if on the login page
                        if (currentPath.endsWith('login.html')) {
                            console.log("Already logged in, redirecting to default page");
                            
                            // Get redirect URL - prioritize redirect param, then returnUrl, then default
                            const redirectTo = redirectParam || returnUrl || 'index.html';
                            
                            // Show brief message, then redirect
                            showSuccess("Already logged in. Redirecting...");
                            
                            setTimeout(() => {
                                window.location.href = redirectTo;
                            }, 1000);
                            return;
                        }
                    }
                    
                    // As a fallback, if no redirect happens, show the "already logged in" UI
                    loginForm.style.display = 'none';
                    document.querySelector('.divider').style.display = 'none';
                    document.querySelector('.social-login').style.display = 'none';
                    alreadyLoggedInContainer.style.display = 'block';
                    
                } else {
                    // User is not logged in, show the login form
                    loginForm.style.display = 'block';
                    alreadyLoggedInContainer.style.display = 'none';
                    document.querySelector('.divider').style.display = 'flex';
                    document.querySelector('.social-login').style.display = 'block';
                }
                
                // Hide loading overlay in either case
                hideLoading();
            });
        });
        
        // ENHANCED: Function to set consistent authentication flags across storage mechanisms
        function setAuthenticationFlags(user) {
            // Store in localStorage for cross-page compatibility
            localStorage.setItem('isAuthenticated', 'true');
            localStorage.setItem('authTimestamp', Date.now().toString());
            localStorage.setItem('userId', user.uid);
            localStorage.setItem('userEmail', user.email);
            
            // Also store in sessionStorage as a backup
            sessionStorage.setItem('isAuthenticated', 'true');
            sessionStorage.setItem('userId', user.uid);
            
            // Set a login cookie (helps with some edge cases)
            document.cookie = `isAuthenticated=true; path=/; max-age=86400`; // 24 hours
            document.cookie = `userId=${user.uid}; path=/; max-age=86400`;
            
            // Store auth token if available
            user.getIdToken().then(token => {
                localStorage.setItem('authToken', token);
                console.log("Authentication token stored successfully");
            });
            
            console.log("Authentication flags set across storage mechanisms");
        }
        
        // Update user data in database function
        function updateUserData(user) {
            if (!user) return;
            
            const userRef = database.ref('users/' + user.uid);
            userRef.once('value').then((snapshot) => {
                if (!snapshot.exists()) {
                    // Create new user record
                    userRef.set({
                        email: user.email,
                        displayName: user.displayName || user.email,
                        photoURL: user.photoURL || null,
                        role: 'user',
                        lastLogin: firebase.database.ServerValue.TIMESTAMP,
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    });
                } else {
                    // Update existing user
                    userRef.update({
                        lastLogin: firebase.database.ServerValue.TIMESTAMP,
                        email: user.email
                    });
                }
            }).catch(error => {
                console.error("Error updating user data:", error);
            });
        }
        
        // Add this after the existing scripts
        document.addEventListener('DOMContentLoaded', function() {
            // Create animated particles for the background but use fewer particles
            const particlesContainer = document.createElement('div');
            particlesContainer.className = 'particles';
            document.body.appendChild(particlesContainer);
            
            // Create 30 particles instead of 50
            for (let i = 0; i < 30; i++) {
                createParticle();
            }
            
            function createParticle() {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                // Random size between 2px and 6px
                const size = Math.random() * 4 + 2;
                particle.style.width = size + 'px';
                particle.style.height = size + 'px';
                
                // Random position
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                
                // Random opacity
                particle.style.opacity = Math.random() * 0.5 + 0.1;
                
                // Random animation
                const duration = Math.random() * 20 + 10;
                particle.style.animation = `float ${duration}s linear infinite`;
                
                particlesContainer.appendChild(particle);
            }
            
            // Add float animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes float {
                    0% { transform: translateY(0) rotate(0); }
                    25% { transform: translateY(-20px) rotate(90deg); }
                    50% { transform: translateY(-40px) rotate(180deg); }
                    75% { transform: translateY(-20px) rotate(270deg); }
                    100% { transform: translateY(0) rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
        });
    </script>
</body>
</html>
