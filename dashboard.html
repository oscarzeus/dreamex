<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard - Data Analysis Hub</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            overflow-x: hidden;
        }
        
        main {
            width: 100%;
            box-sizing: border-box;
            padding: 0;
        }

        /* Dashboard specific styles */
        .dashboard-container {
            width: 100%;
            max-width: none;
            margin: 80px 0 20px 0;
            padding: 15px;
            box-sizing: border-box;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .dashboard-title h2 {
            margin: 0;
            color: #34495e;
        }

        .dashboard-title p {
            margin: 5px 0 0;
            color: #7f8c8d;
            font-size: 14px;
        }

        .dashboard-actions {
            display: flex;
            gap: 10px;
        }

        .dashboard-btn {
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }

        .refresh-btn {
            background-color: #3498db;
            color: white;
        }

        .refresh-btn:hover {
            background-color: #2980b9;
        }

        .dashboard-search {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        .dashboard-search input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .dashboard-search button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 4px;
            cursor: pointer;
        }

        /* User table styles */
        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .user-table th,
        .user-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .user-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #34495e;
        }

        .user-table tbody tr:hover {
            background-color: #f5f7fa;
        }

        .user-avatar-cell {
            width: 60px;
        }

        .user-avatar-sm {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .user-initial-sm {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .user-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .status-active {
            background-color: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* Pagination styles */
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .pagination-btn {
            padding: 8px 12px;
            margin: 0 5px;
            border: 1px solid #ddd;
            background-color: #fff;
            color: #333;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .pagination-btn:hover {
            background-color: #f5f5f5;
        }

        .pagination-btn.active {
            background-color: #3498db;
            color: #fff;
            border-color: #3498db;
        }

        .pagination-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Dashboard stats styles */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 14px;
        }

        /* Loading indicator */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }

        .loading-spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Menu bar styles */
        .menu-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #34495e;
            padding: 0 20px;
        }
        
        .menu-bar ul {
            display: flex;
            align-items: center;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .menu-bar ul li {
            margin: 0 10px;
        }
        
        .menu-bar ul li a {
            display: block;
            padding: 15px 10px;
            color: #ecf0f1;
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .menu-bar ul li a:hover {
            color: #f1f3f5;
        }
        
        .menu-bar ul li.current a {
            color: #fafcfd;
            font-weight: bold;
        }

        /* Dropdown styles */
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white !important;
            color: black !important;
            min-width: 160px;
            box-shadow: 0px 8px 16px rgba(0,0,0,0.2);
            z-index: 1;
            top: calc(100%);
            font-size: 6px !important;
            font-weight: normal;
            text-align: left;
        }
        .dropdown-content a {
            color: rgb(44, 43, 43) !important;
            padding: 6px 10px !important;
            text-decoration: none;  
            display: block;
            font-size: 11px !important;
        }
        .dropdown-content a:hover {
            background-color: #e8e8e8;
            transform: none; 
        }
        .dropdown:hover .dropdown-content,
        .dropdown:focus-within .dropdown-content {
            display: block;
        }

        /* User Avatar Styles */
        .user-avatar-container {
            position: relative;
            display: flex;
            align-items: center;
            margin-right: 20px;
            cursor: pointer;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .user-dropdown {
            position: absolute;
            top: 45px;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 0;
            min-width: 200px;
            display: none;
            z-index: 1000;
            text-align: left;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.08);
        }

        /* Add class for showing the dropdown */
        .user-dropdown.show {
            display: block;
            animation: dropdown-fade-in 0.2s ease-out;
        }
        
        .user-email {
            padding: 5px 15px; /* Further reduced from 8px to 5px */
            border-bottom: 1px solid #eaeaea;
            color: #34495e;
            font-weight: 500;
            background-color: #f8f9fa;
            font-size: 13px; /* Reduced from 14px to 13px */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .user-dropdown a {
            display: block;
            padding: 2px 15px; /* Further reduced from 4px to 2px */
            color: #000000;
            text-decoration: none;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            font-size: 13px; /* Reduced from 14px to 13px */
            line-height: 1.4; /* Added to provide some minimal spacing */
        }
        
        /* Ensure specific dropdown links are black */
        #profileLink, #accountLink {
            color: #474646 !important; /* Pure black color with !important to override any other styles */
        }
        
        .user-dropdown a:hover {
            background-color: #f1f8fe;
            border-left-color: #3498db;
            color: #3498db;
        }
        
        .user-dropdown a:last-child {
            border-top: 1px solid #eaeaea;
        }
        
        #logoutButton {
            color: #e74c3c; /* Keep logout button red */
        }
        
        #logoutButton:hover {
            background-color: #fdeeee;
            border-left-color: #e74c3c;
        }
        
        #loginButton {
            color: #000000; /* Changed to black */
        }
        
        #loginButton:hover {
            background-color: #f1f8fe;
            border-left-color: #3498db;
            color: #3498db;
        }
        
        .user-initial {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s linear 0.25s, opacity 0.25s;
        }
        
        .modal-visible {
            visibility: visible;
            opacity: 1;
            transition-delay: 0s;
        }
        
        .modal-container {
            background-color: #fff;
            border-radius: 8px;
            width: 90%;
            max-width: 700px; /* Increased from 500px to 700px for wider modal */
            padding: 20px; /* Reduced from 30px to 20px for less vertical space */
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            max-height: 80vh; /* Reduced from 90vh to 80vh for lower height */
            overflow-y: auto;
        }

        /* Make edit user modal specifically wider */
        #editUserModal .modal-container {
            max-width: 750px; /* Even wider for edit modal specifically */
        }

        /* Align text to left in form inputs */
        .modal-form input,
        .modal-form select,
        .modal-form textarea {
            text-align: left;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px; /* Reduced from 20px to 15px */
            padding-bottom: 10px; /* Reduced from 15px to 10px */
            border-bottom: 1px solid #eee;
            padding-right: 15px; /* Add some space for the close button */
        }

        .modal-form .form-group {
            margin-bottom: 15px; /* Reduced from 20px to 15px */
        }

        .modal-form input,
        .modal-form select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .modal-form input:focus,
        .modal-form select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }
        
        .modal-form .form-row {
            display: flex;
            gap: 10px; /* Reduced from 15px to 10px */
        }

        /* Add more space between form fields in edit modal */
        #editUserModal .form-row {
            gap: 30px; /* Increased gap for more separation between fields */
            margin-bottom: 10px; /* Add vertical space between rows */
        }

        /* Make first name and last name fields have more separation */
        #editUserModal .form-row:first-of-type {
            margin-bottom: 10px; /* Extra space after first row */
        }

        /* Make email and status fields have more separation from role field */
        #editUserModal .form-row:nth-of-type(2) {
            margin-bottom: 20px; /* Extra space after second row */
        }

        /* Make form fields have equal widths within rows */
        .modal-form .form-row > div {
            flex: 1 0 0; /* flex-grow: 1, flex-shrink: 0, flex-basis: 0 */
            min-width: 0; /* Prevent overflow issues */
        }

        /* Ensure inputs maintain equal width */
        .modal-form .form-row input,
        .modal-form .form-row select {
            box-sizing: border-box;
            width: 100%;
        }

        .modal-form .error-message {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }
        
        .modal-form .has-error input {
            border-color: #e74c3c;
        }
        
        .modal-form .has-error .error-message {
            display: block;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-btn {
            padding: 10px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }
        
        .modal-cancel {
            background-color: #f1f2f6;
            color: #333;
        }
        
        .modal-save {
            background-color: #3498db;
            color: white;
        }
        
        .modal-save:hover {
            background-color: #2980b9;
        }
        
        .modal-cancel:hover {
            background-color: #e8e8e8;
        }
        
        /* Button to create user */
        .create-user-btn {
            background-color: #2ecc71;
            color: white;
        }
        
        .create-user-btn:hover {
            background-color: #27ae60;
        }
        
        /* Clickable table rows */
        .user-table tbody tr {
            cursor: pointer;
        }

        .modal-delete {
            background-color: #e74c3c;
            color: white;
        }
        
        .modal-delete:hover {
            background-color: #c0392b;
        }
        
        .restricted-user {
            opacity: 0.7;
            cursor: not-allowed !important;
        }
        
        .dashboard-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Add styles for restricted view banner */
        .restricted-view-banner {
            background-color: #fff3cd;
            color: #856404;
            padding: 10px 15px;
            border-left: 4px solid #ffc107;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .restricted-view-banner .banner-icon {
            margin-right: 10px;
            font-size: 18px;
        }
        
        .restricted-view-banner .banner-message {
            flex-grow: 1;
        }
        
        .restricted-view-banner .banner-actions button {
            background-color: #ffc107;
            color: #212529;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .restricted-view-banner .banner-actions button:hover {
            background-color: #e0a800;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Add notification styles with explicit left alignment */
        .notification-container {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 300px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            text-align: left;
        }
        
        .notification {
            background-color: white;
            border-left: 4px solid #3498db;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 15px;
            margin-bottom: 10px;
            animation: slideIn 0.3s ease-out forwards;
            position: relative;
            max-width: 100%;
            text-align: left;
        }
        
        .notification.success {
            border-left-color: #2ecc71;
        }
        
        .notification.warning {
            border-left-color: #f39c12;
        }
        
        .notification.error {
            border-left-color: #e74c3c;
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 5px;
            text-align: left;
        }
        
        .notification-title {
            font-weight: bold;
            margin: 0;
            padding-right: 20px;
            text-align: left;
        }
        
        .notification-body {
            margin-bottom: 5px;
            word-wrap: break-word;
            text-align: left;
        }
        
        .notification-time {
            font-size: 12px;
            color: #7f8c8d;
            text-align: left;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        /* Notification bell styles */
        .notification-bell-container {
            position: relative;
            margin-right: 10px;
            cursor: pointer;
        }
        
        .notification-bell {
            font-size: 20px;
            color: #ecf0f1;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s ease;
        }
        
        .notification-bell:hover {
            color: #f1c40f;
        }
        
        .notification-counter {
            position: absolute;
            top: 2px;
            right: 2px;
            background-color: #e74c3c;
            color: white;
            border-radius: 50%;
            min-width: 18px;
            height: 18px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 2px;
            box-sizing: border-box;
            border: 1px solid #34495e;
        }
        
        .notification-dropdown {
            position: absolute;
            top: 48px;
            right: -10px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            width: 350px;
            z-index: 1001;
            display: none;
            max-height: 450px;
            overflow-y: auto;
            animation: dropdownFadeIn 0.3s ease-out;
            border: 1px solid rgba(0,0,0,0.08);
            text-align: left;
        }
        
        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .notification-bell-container:hover .notification-dropdown,
        .notification-bell-container.active .notification-dropdown {
            display: block;
        }
        
        /* Triangle pointer for dropdown */
        .notification-dropdown::before {
            content: '';
            position: absolute;
            top: -10px;
            right: 20px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 10px solid white;
            filter: drop-shadow(0 -2px 2px rgba(0,0,0,0.1));
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            position: sticky;
            top: 0;
            background: white;
            border-radius: 12px 12px 0 0;
            z-index: 5;
        }
        
        .notification-header h4 {
            margin: 0;
            font-size: 16px;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .notification-header-actions {
            display: flex;
            gap: 15px;
        }
        
        .notification-header-actions button {
            background: none;
            border: none;
            color: #3498db;
            font-size: 13px;
            cursor: pointer;
            padding: 0;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        .notification-header-actions button:hover {
            color: #2980b9;
            text-decoration: underline;
        }
        
        .notification-list {
            max-height: 350px;
            overflow-y: auto;
            padding: 0;
            margin: 0;
            scrollbar-width: thin;
            scrollbar-color: #bdc3c7 #f5f5f5;
            text-align: left;
        }
        
        .notification-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .notification-list::-webkit-scrollbar-track {
            background: #f5f5f5;
        }
        
        .notification-list::-webkit-scrollbar-thumb {
            background-color: #bdc3c7;
            border-radius: 6px;
        }
        
        .notification-list-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: flex-start;
            transition: all 0.2s ease;
            cursor: pointer;
            text-align: left;
        }
        
        .notification-list-item:last-child {
            border-bottom: none;
            border-radius: 0 0 12px 12px;
        }
        
        .notification-list-item:hover {
            background-color: #f8f9fa;
        }
        
        .notification-list-item.unread {
            background-color: rgba(52, 152, 219, 0.05);
            position: relative;
        }
        
        .notification-list-item.unread:before {
            content: '';
            display: block;
            width: 6px;
            height: 6px;
            background-color: #3498db;
            border-radius: 50%;
            position: absolute;
            left: 7px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .notification-icon {
            margin-right: 15px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(52, 152, 219, 0.3);
        }
        
        .notification-icon.warning {
            background-color: #f39c12;
            box-shadow: 0 2px 5px rgba(243, 156, 18, 0.3);
        }
        
        .notification-icon.error {
            background-color: #e74c3c;
            box-shadow: 0 2px 5px rgba(231, 76, 60, 0.3);
        }
        
        .notification-icon.success {
            background-color: #2ecc71;
            box-shadow: 0 2px 5px rgba(46, 204, 113, 0.3);
        }
        
        .notification-content {
            flex: 1;
            text-align: left;
        }
        
        .notification-title {
            margin: 0 0 5px 0;
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            line-height: 1.3;
            text-align: left;
        }
        
        .notification-message {
            margin: 0 0 5px 0;
            font-size: 13px;
            color: #7f8c8d;
            line-height: 1.4;
            text-align: left;
        }
        
        .notification-time {
            font-size: 11px;
            color: #95a5a6;
            font-style: italic;
            text-align: left;
        }
        
        .notification-empty {
            padding: 40px 15px;
            text-align: left;
            color: #7f8c8d;
            font-style: italic;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="%23ecf0f1" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>');
            background-position: center 30px;
            background-repeat: no-repeat;
            background-size: 60px;
            padding-top: 100px;
        }
        
        /* Make notification bell and user avatar aligned */
        .menu-bar ul.menu-right {
            display: flex;
            align-items: center;
        }
        
        /* Bell icon using SVG for better quality */
        .bell-icon-svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }
        
        /* Pulse animation for new notifications */
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(231, 76, 60, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0);
            }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        /* Add hover states for notification items */
        .notification-list-item:hover .notification-icon {
            transform: scale(1.1);
            transition: transform 0.2s ease;
        }
        
        /* Mark as read button within each notification */
        .notification-mark-read {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            color: #bdc3c7;
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            display: none;
            transition: all 0.2s ease;
        }
        
        .notification-list-item:hover .notification-mark-read {
            display: block;
        }
        
        .notification-mark-read:hover {
            color: #7f8c8d;
            background-color: rgba(0,0,0,0.05);
        }

        /* Ensure all text in edit modal is left-aligned */
        #editUserModal .modal-form {
            text-align: left;
        }

        #editUserModal .modal-form label,
        #editUserModal .modal-form input,
        #editUserModal .modal-form select,
        #editUserModal .modal-form .permissions-title,
        #editUserModal .modal-form .permissions-note,
        #editUserModal .modal-form .permission-label,
        #editUserModal .modal-header h3 {
            text-align: left;
        }

        #editUserModal .permission-checkbox {
            margin-right: 10px;
        }

        #editUserModal .modal-buttons {
            display: flex;
            justify-content: space-between; /* Keep the buttons properly spaced */
        }

        #editUserModal .modal-right-buttons {
            display: flex;
            gap: 10px;
        }

        /* Update line manager badge to be left aligned */
        .line-manager-badge {
            font-size: 11px;
            background-color: #34495e;
            color: white;
            padding: 2px 4px;
            border-radius: 3px;
            margin-left: 5px;
            vertical-align: middle;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-align: left;
        }

        /* Enhanced Modal Close Button Styles */
        .modal-close {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 28px;
            color: #7f8c8d;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease-in-out;
            position: relative;
            outline: none;
            padding: 0;
            margin: 0;
            line-height: 1;
        }

        .modal-close:hover {
            background-color: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
            transform: rotate(90deg);
        }

        .modal-close:active {
            background-color: rgba(231, 76, 60, 0.2);
            transform: rotate(90deg) scale(0.95);
        }

        /* Permission badge styles */
        .permission-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .permission-badge {
            font-size: 10px;
            padding: 2px 5px;
            border-radius: 3px;
            color: white;
            background-color: #95a5a6;
            display: inline-block;
        }

        .permission-badge.create {
            background-color: #2ecc71;
        }

        .permission-badge.edit {
            background-color: #3498db;
        }

        .permission-badge.delete {
            background-color: #e74c3c;
        }

        .permission-badge.view {
            background-color: #9b59b6;
        }
    </style>
</head>
<body>
    <header>
        <nav class="menu-bar">
            <ul class="menu-left">
                <li><a href="login.html">Home</a></li>
                <li class="dropdown">
                    <a href="#">Risk Management</a>
                    <div class="dropdown-content">
                        <a href="riskassessment.html">Risk Assessment</a>
                        <a href="jsaboard.html">Job Safety Analysis</a>
                    </div>
                </li>
                <li class="dropdown">
                    <a href="#">Safety reporting</a>
                    <div class="dropdown-content">
                        <a href="eventboard.html">Event</a>
                        <a href="inspectionsboard.html">Inspections</a>
                    </div>
                </li>
                <li class="dropdown">
                    <a href="#">Settings</a>
                    <div class="dropdown-content">
                        <a href="account.html">User account</a>
                        <a href="setup.html">Inspections</a>
                        <a href="log.html">System audit log</a>
                    </div>
                </li>
                <li><a href="dashboard.html">Dashboard</a></li>
            </ul>
            <ul class="menu-right">
                <ul class="menu-right">
                    <!-- Add Notification Bell -->
                    <li class="notification-bell-container" id="notificationBellContainer">
                        <div class="notification-bell" id="notificationBell">
                            <svg class="bell-icon-svg" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9M13.73 21a2 2 0 0 1-3.46 0"></path>
                            </svg>
                            <span class="notification-counter" id="notificationCounter" style="display: none;">0</span>
                        </div>
                        <div class="notification-dropdown" id="notificationDropdown">
                            <div class="notification-header">
                                <h4>Notifications</h4>
                                <div class="notification-header-actions">
                                    <button id="markAllReadBtn">Mark all as read</button>
                                    <button id="clearAllBtn">Clear all</button>
                                </div>
                            </div>
                            <div class="notification-list" id="notificationList">
                                <div class="notification-empty">No new notifications</div>
                            </div>
                        </div>
                    </li>
                    
                    <!-- User Avatar Button -->
                    <li class="user-avatar-container">
                        <div id="userAvatarContainer">
                            <img src="https://via.placeholder.com/32" alt="User" class="user-avatar" id="userAvatar" style="display: none;">
                            <div id="userInitial" class="user-initial">?</div>
                        </div>
                        <div class="user-dropdown">
                            <div class="user-email" id="userEmail">Not logged in</div>
                            <a href="account.html" id="profileLink" style="display: none;">My Profile</a>
                            <!-- Account Settings link removed -->
                            <a href="#" id="logoutButton" style="display: none;">Log Out</a>
                            <a href="login.html" id="loginButton">Log In</a>
                        </div>
                    </li>
                </ul>
            </ul>
        </nav>
    </header>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <main>
        <div class="dashboard-container">
            <div class="dashboard-header">
                <div class="dashboard-title">
                    <h2>User Dashboard</h2>
                    <p>Manage and monitor all registered users in real-time</p>
                </div>
                <div class="dashboard-actions">
                    <button class="dashboard-btn create-user-btn" id="createUserBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="8.5" cy="7" r="4"></circle>
                            <line x1="20" y1="8" x2="20" y2="14"></line>
                            <line x1="23" y1="11" x2="17" y2="11"></line>
                        </svg>
                        Create User
                    </button>
                    <button class="dashboard-btn refresh-btn" id="refreshBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M23 4v6h-6"></path>
                            <path d="M1 20v-6h6"></path>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                        </svg>
                        Refresh
                    </button>
                </div>
            </div>

            <!-- Add restricted view banner -->
            <div class="restricted-view-banner" id="restrictedViewBanner" style="display: none;">
                <div class="banner-icon">🔒</div>
                <div class="banner-message">
                    <strong>Restricted view:</strong> You can only see your own user profile because you don't have permission to view other users.
                </div>
                <div class="banner-actions">
                    <button id="dismissBannerBtn">Dismiss</button>
                </div>
            </div>

            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalUsersCount">0</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeUsersCount">0</div>
                    <div class="stat-label">Active Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="withPhotoCount">0</div>
                    <div class="stat-label">With Profile Photo</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="withPermissionsCount">0</div>
                    <div class="stat-label">Custom Permissions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="newUsersCount">0</div>
                    <div class="stat-label">New Users (7 days)</div>
                </div>
            </div>

            <div class="dashboard-search">
                <input type="text" id="searchInput" placeholder="Search by name or email...">
                <button id="searchBtn">Search</button>
            </div>

            <table class="user-table">
                <thead>
                    <tr>
                        <th class="user-avatar-cell">Avatar</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Created</th>
                        <th>Last Updated</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    <!-- User rows will be inserted here dynamically -->
                </tbody>
            </table>

            <div class="pagination" id="pagination">
                <!-- Pagination buttons will be inserted here dynamically -->
            </div>
        </div>
    </main>

    <!-- Add notification container -->
    <div class="notification-container" id="notificationContainer">
        <!-- Notifications will be added here dynamically -->
    </div>

    <!-- User Create Modal -->
    <div id="createUserModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3>Create New User</h3>
                <button class="modal-close" id="closeCreateModal">&times;</button>
            </div>
            <form id="createUserForm" class="modal-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="createFirstName">First Name</label>
                        <input type="text" id="createFirstName" name="firstName" required>
                        <div class="error-message">Please enter a first name</div>
                    </div>
                    <div class="form-group">
                        <label for="createLastName">Last Name</label>
                        <input type="text" id="createLastName" name="lastName" required>
                        <div class="error-message">Please enter a last name</div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="createEmail">Email</label>
                    <input type="email" id="createEmail" name="email" required>
                    <div class="error-message">Please enter a valid email address</div>
                </div>
                <div class="form-group">
                    <label for="createPassword">Password</label>
                    <input type="password" id="createPassword" name="password" required minlength="6">
                    <div class="error-message">Password must be at least 6 characters</div>
                </div>
                <div class="form-group">
                    <label for="createStatus">Status</label>
                    <select id="createStatus" name="status">
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="createRole">Role</label>
                    <select id="createRole" name="role">
                        <option value="user">User</option>
                        <option value="editor">Editor</option>
                        <option value="admin">Administrator</option>
                    </select>
                </div>
                
                <div class="modal-buttons">
                    <button type="button" class="modal-btn modal-cancel" id="cancelCreateUser">Cancel</button>
                    <button type="submit" class="modal-btn modal-save">Create User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Edit Modal -->
    <div id="editUserModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3>Edit User</h3>
                <button class="modal-close" id="closeEditModal">&times;</button>
            </div>
            <form id="editUserForm" class="modal-form">
                <input type="hidden" id="editUserId">
                <div class="form-row">
                    <div class="form-group">
                        <label for="editFirstName">First Name</label>
                        <input type="text" id="editFirstName" name="firstName" required>
                        <div class="error-message">Please enter a first name</div>
                    </div>
                    <div class="form-group">
                        <label for="editLastName">Last Name</label>
                        <input type="text" id="editLastName" name="lastName" required>
                        <div class="error-message">Please enter a last name</div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editEmail">Email</label>
                    <input type="email" id="editEmail" name="email" required>
                    <div class="error-message">Please enter a valid email address</div>
                </div>
                <div class="form-group">
                    <label for="editStatus">Status</label>
                    <select id="editStatus" name="status">
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <!-- Removed profile image URL field -->
                <div class="form-group">
                    <label for="editRole">Role</label>
                    <select id="editRole" name="role">
                        <option value="guest">Guest</option>
                        <option value="user">User</option>
                        <option value="editor">Editor</option>
                        <option value="admin">Administrator</option>
                        <option value="superuser">Super User</option>
                    </select>
                </div>
                
                <div class="modal-buttons">
                    <button type="button" class="modal-btn modal-delete" id="deleteUserBtn">Delete User</button>
                    <div class="modal-right-buttons">
                        <button type="button" class="modal-btn modal-cancel" id="cancelEditUser">Cancel</button>
                        <button type="submit" class="modal-btn modal-save">Save Changes</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal-overlay">
        <div class="modal-container" style="max-width: 400px;">
            <div class="modal-header">
                <h3>Confirm Action</h3>
                <button class="modal-close" id="closeConfirmationModal">&times;</button>
            </div>
            <div style="padding: 10px 0 20px;">
                <p id="confirmationMessage">Are you sure you want to delete this user? This action cannot be undone.</p>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-cancel" id="cancelConfirmation">Cancel</button>
                <button class="modal-btn modal-delete" id="confirmAction">Delete</button>
            </div>
        </div>
    </div>

    <!-- Add Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.appspot.com",
            messagingSenderId: "829083030831",
            appId: "1:829083030831:web:36a370e62691e560bc3dda"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        
        // Global variables
        let allUsers = [];
        let currentUsers = [];
        let currentPage = 1;
        const usersPerPage = 10;
        let searchTerm = '';
        
        // Add variables to store notification listener references for cleanup
        let notificationListeners = {
            childAdded: null,
            childChanged: null,
            eventsAdded: null,
            eventsChanged: null,
            unreadCounter: null // Add specific listener for unread counter
        };
        
        // Add notification tracking to prevent duplicates
        let processedNotifications = new Set();
        
        // Add a notification cache to store recently loaded notifications
        let cachedNotifications = [];
        let lastNotificationFetch = 0;
        const CACHE_LIFETIME = 30000; // 30 seconds
        
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Check if user is authenticated with Firebase
                auth.onAuthStateChanged(function(user) {
                    if (user) {
                        // User is signed in
                        console.log("User is authenticated:", user.email);
                        initializeDashboard(user);
                    } else {
                        // User is not signed in, redirect to login
                        console.log("User not authenticated, redirecting to login");
                        window.location.href = "index.html";
                    }
                });
                
                // Get DOM elements
                const userTableBody = document.getElementById('userTableBody');
                const searchInput = document.getElementById('searchInput');
                const searchBtn = document.getElementById('searchBtn');
                const refreshBtn = document.getElementById('refreshBtn');
                const pagination = document.getElementById('pagination');
                const loadingOverlay = document.getElementById('loadingOverlay');
                
                // Set up event listeners
                searchBtn.addEventListener('click', handleSearch);
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') handleSearch();
                });
                refreshBtn.addEventListener('click', refreshUsers);
                
                // Create User Modal Elements
                const createUserBtn = document.getElementById('createUserBtn');
                const createUserModal = document.getElementById('createUserModal');
                const closeCreateModal = document.getElementById('closeCreateModal');
                const cancelCreateUser = document.getElementById('cancelCreateUser');
                const createUserForm = document.getElementById('createUserForm');
                
                // Edit User Modal Elements
                const editUserModal = document.getElementById('editUserModal');
                const closeEditModal = document.getElementById('closeEditModal');
                const cancelEditUser = document.getElementById('cancelEditUser');
                const editUserForm = document.getElementById('editUserForm');
                
                // Confirmation Modal Elements
                const confirmationModal = document.getElementById('confirmationModal');
                const closeConfirmationModal = document.getElementById('closeConfirmationModal');
                const cancelConfirmation = document.getElementById('cancelConfirmation');
                const confirmAction = document.getElementById('confirmAction');
                const deleteUserBtn = document.getElementById('deleteUserBtn');
                
                // Create User Modal Handlers
                createUserBtn.addEventListener('click', () => {
                    createUserModal.classList.add('modal-visible');
                    createUserForm.reset();
                });
                
                closeCreateModal.addEventListener('click', () => {
                    createUserModal.classList.remove('modal-visible');
                });
                
                cancelCreateUser.addEventListener('click', () => {
                    createUserModal.classList.remove('modal-visible');
                });
                
                // Create User Form Submit - updated to remove permissions
                createUserForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const userRole = sessionStorage.getItem('userRole');
                    
                    // Check if user has permission to create users
                    if (userRole === 'guest') {
                        showPermissionDeniedMessage("Guest accounts cannot create users");
                        return;
                    }
                    
                    if (!['admin', 'superuser'].includes(userRole)) {
                        showPermissionDeniedMessage("You don't have permission to create users");
                        return;
                    }
                    
                    // Form validation and processing - existing code
                    const firstName = document.getElementById('createFirstName').value.trim();
                    const lastName = document.getElementById('createLastName').value.trim();
                    const email = document.getElementById('createEmail').value.trim();
                    const password = document.getElementById('createPassword').value;
                    const status = document.getElementById('createStatus').value;
                    const role = document.getElementById('createRole').value;
                    
                    // Basic validation - existing code
                    let isValid = true;
                    // ...validation checks...
                    
                    if (isValid) {
                        showLoading();
                        
                        // Create user with Firebase Authentication
                        auth.createUserWithEmailAndPassword(email, password)
                            .then((userCredential) => {
                                const newUserId = userCredential.user.uid;
                                
                                // Store additional user data in the Realtime Database
                                // Important: No longer storing individual permissions
                                return database.ref(`users/${newUserId}`).set({
                                    firstName: firstName,
                                    lastName: lastName,
                                    email: email,
                                    status: status,
                                    role: role,
                                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                                });
                            })
                            .then(() => {
                                // Hide modal and show success message
                                createUserModal.classList.remove('modal-visible');
                                showNotification({
                                    title: "User Created",
                                    message: "New user has been successfully created.",
                                    type: "success"
                                });
                                
                                // Refresh user list
                                refreshUsers();
                            })
                            .catch((error) => {
                                // Error handling - existing code
                                hideLoading();
                                showNotification({
                                    title: "Error",
                                    message: "Failed to create user: " + error.message,
                                    type: "error"
                                });
                            });
                    }
                });
                
                // Edit User Form Submit
                editUserForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const userId = document.getElementById('editUserId').value;
                    
                    // Check if current user has permission to edit users (fix: changed edit_user to edit_users)
                    if (!canPerformAction('edit_users') && auth.currentUser.uid !== userId) {
                        showPermissionDeniedMessage("You don't have permission to edit other users");
                        return;
                    }
                    
                    const firstName = document.getElementById('editFirstName').value.trim();
                    const lastName = document.getElementById('editLastName').value.trim();
                    const email = document.getElementById('editEmail').value.trim();
                    const status = document.getElementById('editStatus').value;
                    const role = document.getElementById('editRole').value;
                    
                    // Basic validation
                    let isValid = true;
                    if (!firstName) {
                        document.getElementById('editFirstName').parentNode.classList.add('has-error');
                        isValid = false;
                    } else {
                        document.getElementById('editFirstName').parentNode.classList.remove('has-error');
                    }
                    
                    if (!lastName) {
                        document.getElementById('editLastName').parentNode.classList.add('has-error');
                        isValid = false;
                    } else {
                        document.getElementById('editLastName').parentNode.classList.remove('has-error');
                    }
                    
                    if (!email || !email.includes('@')) {
                        document.getElementById('editEmail').parentNode.classList.add('has-error');
                        isValid = false;
                    } else {
                        document.getElementById('editEmail').parentNode.classList.remove('has-error');
                    }
                    
                    if (isValid) {
                        showLoading();
                        
                        // Update user data in the database
                        const updates = {
                            firstName: firstName,
                            lastName: lastName,
                            email: email,
                            status: status,
                            role: role, // Add role to updates
                            updatedAt: firebase.database.ServerValue.TIMESTAMP
                        };
                        
                        database.ref(`users/${userId}`).update(updates)
                            .then(() => {
                                hideLoading();
                                editUserModal.classList.remove('modal-visible');
                                alert('User account updated successfully!');
                                
                                // Refresh the user list
                                refreshUsers();
                            })
                            .catch((error) => {
                                hideLoading();
                                alert(`Error updating user account: ${error.message}`);
                                console.error("Error updating user account:", error);
                            });
                    }
                });
                
                // Delete User Button Handler
                deleteUserBtn.addEventListener('click', function() {
                    const userId = document.getElementById('editUserId').value;
                    const userName = `${document.getElementById('editFirstName').value} ${document.getElementById('editLastName').value}`;
                    
                    // Check if current user is admin
                    const currentUser = auth.currentUser;
                    if (currentUser && currentUserRole !== 'admin') {
                        alert('You need administrator privileges to delete users');
                        return;
                    }
                    
                    // Update confirmation message with user name
                    document.getElementById('confirmationMessage').textContent = `Are you sure you want to delete ${userName}? This action cannot be undone.`;
                    
                    // Hide edit modal and show confirmation modal
                    editUserModal.classList.remove('modal-visible');
                    confirmationModal.classList.add('modal-visible');
                    
                    // Set up confirmation action
                    confirmAction.onclick = function() {
                        deleteUser(userId);
                    };
                });
                
                // Confirmation Modal Handlers
                closeConfirmationModal.addEventListener('click', () => {
                    confirmationModal.classList.remove('modal-visible');
                    editUserModal.classList.add('modal-visible'); // Return to edit modal
                });
                
                cancelConfirmation.addEventListener('click', () => {
                    confirmationModal.classList.remove('modal-visible');
                    editUserModal.classList.add('modal-visible'); // Return to edit modal
                });
                
                // Setup logout handler using Firebase Auth
                document.getElementById('logoutButton').addEventListener('click', function(e) {
                    e.preventDefault();
                    auth.signOut().then(() => {
                        console.log("User signed out");
                        window.location.href = "index.html";
                    }).catch((error) => {
                        console.error("Error signing out:", error);
                    });
                });
                
                // Function to initialize dashboard after authentication
                function initializeDashboard(user) {
                    // Setup user avatar with authenticated user
                    setupUserAvatar(user);
                    
                    // Check user permissions
                    checkPermissions();
                    
                    // Load users from Firebase
                    setupRealTimeUserListener();
                    
                    // Setup notifications listener
                    setupEventNotifications();
                }
                
                // Function to handle search
                function handleSearch() {
                    searchTerm = searchInput.value.trim().toLowerCase();
                    filterUsers();
                }
                
                // Function to refresh users - enhanced to properly update UI with permissions
                function refreshUsers() {
                    showLoading();
                    
                    // Get a fresh copy of user data instead of relying on listener
                    database.ref('users').once('value')
                        .then((snapshot) => {
                            allUsers = [];
                            let activeCount = 0;
                            let photoCount = 0;
                            let newUserCount = 0;
                            let usersWithPermissions = 0;
                            
                            const sevenDaysAgo = new Date();
                            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                            
                            const currentUser = auth.currentUser;
                            const hasViewUsersPermission = canPerformAction('view_users');
                            
                            // Process user data
                            snapshot.forEach(function(childSnapshot) {
                                const userId = childSnapshot.key;
                                const userData = childSnapshot.val();
                                
                                // Add user to array with all properties
                                const user = {
                                    id: userId,
                                    ...userData
                                };
                                
                                allUsers.push(user);
                                
                                // Only calculate stats for visible users based on permission
                                if (hasViewUsersPermission || (currentUser && userId === currentUser.uid)) {
                                    // Calculate stats
                                    if (userData.lastLogin && new Date(userData.lastLogin) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)) {
                                        activeCount++;
                                    }
                                    
                                    if (userData.profileImage) {
                                        photoCount++;
                                    }
                                    
                                    if (userData.createdAt && new Date(userData.createdAt) > sevenDaysAgo) {
                                        newUserCount++;
                                    }
                                    
                                    // Count users with custom permissions
                                    if (userData.permissions && Object.keys(userData.permissions).length > 0) {
                                        usersWithPermissions++;
                                    }
                                }
                            });
                            
                            // Update stats display (based on permission level)
                            if (!hasViewUsersPermission && currentUser) {
                                // If restricted, only show stats for current user (which is 1)
                                document.getElementById('totalUsersCount').textContent = '1';
                            } else {
                                document.getElementById('totalUsersCount').textContent = allUsers.length;
                            }
                            
                            document.getElementById('activeUsersCount').textContent = activeCount;
                            document.getElementById('withPhotoCount').textContent = photoCount;
                            document.getElementById('newUsersCount').textContent = newUserCount;
                            
                            // Add permissions stat if element exists
                            if (document.getElementById('withPermissionsCount')) {
                                document.getElementById('withPermissionsCount').textContent = usersWithPermissions;
                            }
                            
                            // Apply current search filter and update UI
                            filterUsers();
                            
                            // Also refresh current user's permissions
                            checkPermissions();
                            
                            hideLoading();
                            console.log(`Refreshed ${allUsers.length} users from Firebase`);
                        })
                        .catch(error => {
                            console.error("Error refreshing users:", error);
                            hideLoading();
                            alert("Failed to refresh user data. Please try again.");
                        });
                }
                
                // Function to set up real-time listener for users
                function setupRealTimeUserListener() {
                    showLoading();
                    
                    // Reference to users
                    const usersRef = database.ref('users');
                    
                    // Listen for changes
                    usersRef.on('value', function(snapshot) {
                        allUsers = [];
                        let activeCount = 0;
                        let photoCount = 0;
                        let newUserCount = 0;
                        let usersWithPermissions = 0;
                        
                        const sevenDaysAgo = new Date();
                        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                        
                        const currentUser = auth.currentUser;
                        const hasViewUsersPermission = canPerformAction('view_users');
                        
                        // Process user data
                        snapshot.forEach(function(childSnapshot) {
                            const userId = childSnapshot.key;
                            const userData = childSnapshot.val();
                            
                            // Add user to array
                            const user = {
                                id: userId,
                                ...userData
                            };
                            
                            allUsers.push(user);
                            
                            // Only calculate stats for visible users based on permission
                            if (hasViewUsersPermission || (currentUser && userId === currentUser.uid)) {
                                // Calculate stats
                                if (userData.lastLogin && new Date(userData.lastLogin) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)) {
                                    activeCount++;
                                }
                                
                                if (userData.profileImage) {
                                    photoCount++;
                                }
                                
                                if (userData.createdAt && new Date(userData.createdAt) > sevenDaysAgo) {
                                    newUserCount++;
                                }
                                
                                // Count users with custom permissions
                                if (userData.permissions && Object.keys(userData.permissions).length > 0) {
                                    usersWithPermissions++;
                                }
                            }
                        });
                        
                        // Update stats display (based on permission level)
                        if (!hasViewUsersPermission && currentUser) {
                            // If restricted, only show stats for current user (which is 1)
                            document.getElementById('totalUsersCount').textContent = '1';
                        } else {
                            document.getElementById('totalUsersCount').textContent = allUsers.length;
                        }
                        
                        document.getElementById('activeUsersCount').textContent = activeCount;
                        document.getElementById('withPhotoCount').textContent = photoCount;
                        document.getElementById('newUsersCount').textContent = newUserCount;
                        document.getElementById('withPermissionsCount').textContent = usersWithPermissions;
                        
                        // Apply any current search filter
                        filterUsers();
                        hideLoading();
                        
                        console.log(`Loaded ${allUsers.length} users from Firebase`);
                    }, function(error) {
                        console.error("Error fetching users:", error);
                        hideLoading();
                    });
                }
                
                // Function to filter users based on search term
                function filterUsers() {
                    const currentUser = auth.currentUser;
                    const userRole = sessionStorage.getItem('userRole') || 'user';
                    const hasViewUsersPermission = ['admin', 'editor', 'superuser'].includes(userRole);
                    
                    // First filter by search term
                    let filteredUsers = [];
                    if (searchTerm === '') {
                        filteredUsers = [...allUsers];
                    } else {
                        filteredUsers = allUsers.filter(user => {
                            const fullName = `${user.firstName || ''} ${user.lastName || ''}`.toLowerCase();
                            const email = (user.email || '').toLowerCase();
                            return fullName.includes(searchTerm) || email.includes(searchTerm);
                        });
                    }
                    
                    // Then filter by permission if needed
                    if (!hasViewUsersPermission && currentUser) {
                        filteredUsers = filteredUsers.filter(user => user.id === currentUser.uid);
                        
                        // Show restricted view banner
                        document.getElementById('restrictedViewBanner').style.display = 'flex';
                    } else {
                        // Hide restricted view banner
                        document.getElementById('restrictedViewBanner').style.display = 'none';
                    }
                    
                    // Sort by most recently updated
                    filteredUsers.sort((a, b) => {
                        const dateA = new Date(a.updatedAt || a.createdAt || 0);
                        const dateB = new Date(b.updatedAt || b.createdAt || 0);
                        return dateB - dateA;
                    });
                    
                    // Update current users array
                    currentUsers = filteredUsers;
                    
                    // Reset to first page and update display
                    currentPage = 1;
                    renderUserTable();
                    renderPagination();
                }
                
                // Function to render user table
                function renderUserTable() {
                    // Clear table
                    userTableBody.innerHTML = '';
                    
                    // Get users for current page
                    const startIndex = (currentPage - 1) * usersPerPage;
                    const endIndex = startIndex + usersPerPage;
                    const usersToShow = currentUsers.slice(startIndex, endIndex);
                    
                    // Check if we have users to display
                    if (usersToShow.length === 0) {
                        userTableBody.innerHTML = `
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 20px;">
                                    No users found ${searchTerm ? 'matching your search.' : '.'}
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    // Update table header to include Role and Actions columns
                    const tableHeader = document.querySelector('.user-table thead tr');
                    
                    // Check if the Role column exists, if not add it
                    if (!tableHeader.querySelector('th:nth-child(7)')) {
                        const roleHeader = document.createElement('th');
                        roleHeader.textContent = 'Role';
                        tableHeader.appendChild(roleHeader);
                    }
                    
                    // Check if the Actions column exists, if not add it
                    if (!tableHeader.querySelector('th:nth-child(8)')) {
                        const actionsHeader = document.createElement('th');
                        actionsHeader.textContent = 'Permissions';
                        tableHeader.appendChild(actionsHeader);
                    }
                    
                    // Check if current user is superuser or guest
                    const isSuperuser = sessionStorage.getItem('userRole') === 'superuser';
                    const isGuest = sessionStorage.getItem('userRole') === 'guest';
                    
                    // Render each user
                    usersToShow.forEach(user => {
                        // Format dates
                        const createdAt = user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A';
                        const updatedAt = user.updatedAt ? new Date(user.updatedAt).toLocaleDateString() : createdAt;
                        
                        // Determine user status
                        const isActive = user.status === 'active' || (user.lastLogin && (new Date(user.lastLogin) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)));
                        const statusClass = isActive ? 'status-active' : 'status-inactive';
                        const statusText = isActive ? 'Active' : 'Inactive';
                        
                        // Create avatar cell
                        let avatarHTML;
                        if (user.profileImage) {
                            avatarHTML = `
                                <img src="${user.profileImage}" alt="Avatar" class="user-avatar-sm" 
                                    onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div class="user-initial-sm" style="display:none;">
                                    ${getInitials(user)}
                                </div>
                            `;
                        } else {
                            avatarHTML = `<div class="user-initial-sm">${getInitials(user)}</div>`;
                        }
                        
                        // Format role display
                        const roleDisplay = (user.role || 'user').charAt(0).toUpperCase() + (user.role || 'user').slice(1);
                        
                        // Create permission badges for user
                        const permissionBadges = createPermissionBadges(user.role || 'user');
                        
                        // Create table row
                        const row = document.createElement('tr');
                        
                        // Check if current user has permission to edit this user
                        let clickable = true;
                        const currentUserId = auth.currentUser ? auth.currentUser.uid : null;
                        
                        // Guest users can never edit anything
                        if (isGuest) {
                            clickable = false;
                            row.classList.add('restricted-user');
                        } 
                        // If user is superuser, they can edit anyone
                        else if (!isSuperuser) {
                            // Cannot edit other admin users unless you're an admin with edit permission
                            if (user.role === 'admin' && currentUserId !== user.id && 
                                (!canPerformAction('edit_users') || currentUserRole !== 'admin')) {
                                clickable = false;
                                row.classList.add('restricted-user');
                            }
                            
                            // Cannot edit any users if you don't have edit_users permission (unless it's yourself)
                            if (!canPerformAction('edit_users') && currentUserId !== user.id) {
                                clickable = false;
                                row.classList.add('restricted-user');
                            }
                        }
                        
                        row.innerHTML = `
                            <td class="user-avatar-cell">${avatarHTML}</td>
                            <td>${user.firstName || ''} ${user.lastName || ''}</td>
                            <td>${user.email || 'N/A'}</td>
                            <td>${createdAt}</td>
                            <td>${updatedAt}</td>
                            <td><span class="user-status ${statusClass}">${statusText}</span></td>
                            <td>${roleDisplay}</td>
                            <td><div class="permission-badges">${permissionBadges}</div></td>
                        `;
                        
                        // Make the row clickable to edit user if permissions allow
                        if (clickable) {
                            // Check if current user has "user" role - they shouldn't be able to click profiles
                            const currentUserRole = sessionStorage.getItem('userRole');
                            if (currentUserRole === 'user') {
                                // Users with "user" role can't click on any profiles
                                row.classList.add('restricted-user');
                                row.title = "Regular users cannot access user profiles";
                            } else {
                                row.addEventListener('click', function() {
                                    openEditUserModal(user);
                                });
                            }
                        } else {
                            // Different message for guests vs. other restricted users
                            let restrictionReason = "You don't have permission to edit other users";
                            if (isGuest) {
                                restrictionReason = "Guest accounts can only view information, not edit";
                            }
                            row.title = restrictionReason;
                        }
                        
                        userTableBody.appendChild(row);
                    });
                }
                
                // Function to open edit user modal - updated to handle role restrictions
                function openEditUserModal(user) {
                    // Guest users should never be able to open edit modal, even for themselves
                    if (sessionStorage.getItem('userRole') === 'guest') {
                        showPermissionDeniedMessage("Guest accounts cannot edit user information");
                        return;
                    }
                    
                    const currentUserRole = sessionStorage.getItem('userRole');
                    const currentUserId = auth.currentUser?.uid;
                    const isSelf = currentUserId === user.id;
                    const targetUserRole = user.role || 'user';
                    
                    // Prevent admins from editing superusers
                    if (currentUserRole === 'admin' && targetUserRole === 'superuser') {
                        showPermissionDeniedMessage("Administrators cannot edit superuser accounts");
                        return;
                    }
                    
                    // Regular users can edit themselves, admin/superuser can edit anyone
                    if (!['admin', 'superuser'].includes(currentUserRole) && !isSelf) {
                        showPermissionDeniedMessage("You don't have permission to edit other users");
                        return;
                    }
                    
                    // Set form values
                    document.getElementById('editUserId').value = user.id;
                    document.getElementById('editFirstName').value = user.firstName || '';
                    document.getElementById('editLastName').value = user.lastName || '';
                    document.getElementById('editEmail').value = user.email || '';
                    document.getElementById('editStatus').value = user.status || 'inactive';
                    document.getElementById('editRole').value = user.role || 'user';
                    
                    // Show delete button based on role permissions
                    const deleteUserBtn = document.getElementById('deleteUserBtn');
                    
                    // Only superusers can delete anyone
                    // Admins can delete anyone except superusers
                    if (currentUserRole === 'superuser') {
                        deleteUserBtn.style.display = 'block';
                    } else if (currentUserRole === 'admin') {
                        deleteUserBtn.style.display = targetUserRole !== 'superuser' ? 'block' : 'none';
                    } else {
                        deleteUserBtn.style.display = 'none';
                    }
                    
                    // Show the modal
                    editUserModal.classList.add('modal-visible');
                    setupEditUserModalButtons();
                }
                
                // Function to render pagination
                function renderPagination() {
                    // Clear pagination
                    pagination.innerHTML = '';
                    
                    // Calculate total pages
                    const totalPages = Math.ceil(currentUsers.length / usersPerPage);
                    
                    if (totalPages <= 1) {
                        pagination.style.display = 'none';
                        return;
                    }
                    
                    pagination.style.display = 'flex';
                    
                    // Add previous button
                    const prevBtn = document.createElement('button');
                    prevBtn.className = `pagination-btn ${currentPage === 1 ? 'disabled' : ''}`;
                    prevBtn.innerHTML = '&laquo; Previous';
                    prevBtn.disabled = currentPage === 1;
                    prevBtn.addEventListener('click', () => {
                        if (currentPage > 1) {
                            currentPage--;
                            renderUserTable();
                            renderPagination();
                        }
                    });
                    pagination.appendChild(prevBtn);
                    
                    // Add page buttons (show max 5 pages)
                    const maxButtons = 5;
                    let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
                    let endPage = Math.min(totalPages, startPage + maxButtons - 1);
                    
                    if (endPage - startPage + 1 < maxButtons) {
                        startPage = Math.max(1, endPage - maxButtons + 1);
                    }
                    
                    for (let i = startPage; i <= endPage; i++) {
                        const pageBtn = document.createElement('button');
                        pageBtn.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
                        pageBtn.textContent = i;
                        pageBtn.addEventListener('click', () => {
                            currentPage = i;
                            renderUserTable();
                            renderPagination();
                        });
                        pagination.appendChild(pageBtn);
                    }
                    
                    // Add next button
                    const nextBtn = document.createElement('button');
                    nextBtn.className = `pagination-btn ${currentPage === totalPages ? 'disabled' : ''}`;
                    nextBtn.innerHTML = 'Next &raquo;';
                    nextBtn.disabled = currentPage === totalPages;
                    nextBtn.addEventListener('click', () => {
                        if (currentPage < totalPages) {
                            currentPage++;
                            renderUserTable();
                            renderPagination();
                        }
                    });
                    pagination.appendChild(nextBtn);
                }
                
                // Function to get user initials
                function getInitials(user) {
                    if (user.firstName && user.firstName.length > 0) {
                        return user.firstName.charAt(0).toUpperCase();
                    }
                    if (user.email && user.email.length > 0) {
                        return user.email.charAt(0).toUpperCase();
                    }
                    return '?';
                }
                
                // Function to show loading overlay
                function showLoading() {
                    loadingOverlay.style.display = 'flex';
                }
                
                // Function to hide loading overlay
                function hideLoading() {
                    loadingOverlay.style.display = 'none';
                }
                
                // Global variable to store current user's role
                let currentUserRole = 'user';
                
                // Function to check user permissions - simplified to use roles only
                function checkPermissions() {
                    const currentUser = auth.currentUser;
                    if (!currentUser) return;
                    
                    // Fetch current user's role
                    database.ref(`users/${currentUser.uid}`).once('value')
                        .then((snapshot) => {
                            const userData = snapshot.val() || {};
                            const currentUserRole = userData.role || 'user';
                            
                            // Store role in session storage
                            sessionStorage.setItem('userRole', currentUserRole);
                            
                            // For guest users, restrict all create, edit, delete functionality
                            if (currentUserRole === 'guest') {
                                const createUserBtn = document.getElementById('createUserBtn');
                                if (createUserBtn) {
                                    createUserBtn.title = "Guest accounts cannot create users";
                                    createUserBtn.disabled = true;
                                    createUserBtn.classList.add('disabled-by-permission');
                                }
                                
                                // Show guest notification banner
                                showGuestBanner();
                            } 
                            // Superuser bypasses specific permission checks
                            else if (currentUserRole === 'superuser') {
                                const createUserBtn = document.getElementById('createUserBtn');
                                if (createUserBtn) {
                                    createUserBtn.title = "Create a new user";
                                    createUserBtn.disabled = false;
                                    createUserBtn.classList.remove('disabled-by-permission');
                                }
                            } 
                            // Admin can create users
                            else if (currentUserRole === 'admin') {
                                const createUserBtn = document.getElementById('createUserBtn');
                                if (createUserBtn) {
                                    createUserBtn.title = "Create a new user";
                                    createUserBtn.disabled = false;
                                    createUserBtn.classList.remove('disabled-by-permission');
                                }
                            }
                            // Regular users and editors can't create users
                            else {
                                const createUserBtn = document.getElementById('createUserBtn');
                                if (createUserBtn) {
                                    createUserBtn.title = "You don't have permission to create users";
                                    createUserBtn.disabled = true;
                                    createUserBtn.classList.add('disabled-by-permission');
                                }
                            }
                            
                            // Check if view_users permission has changed and update UI if needed
                            const canViewUsers = ['admin', 'editor', 'superuser'].includes(currentUserRole);
                            filterUsers(); // Re-filter users based on updated role
                            
                            console.log(`User role: ${currentUserRole}`);
                        })
                        .catch(error => {
                            console.error("Error checking permissions:", error);
                        });
                }
                
                // Function to delete a user
                function deleteUser(userId) {
                    showLoading();
                    
                    // Prevent deleting self
                    const currentUser = auth.currentUser;
                    if (currentUser && currentUser.uid === userId) {
                        hideLoading();
                        confirmationModal.classList.remove('modal-visible');
                        alert("You cannot delete your own account while logged in.");
                        return;
                    }
                    
                    // Get user data before deleting (for email lookup)
                    database.ref(`users/${userId}`).once('value')
                        .then((snapshot) => {
                            const userData = snapshot.val();
                            if (!userData) {
                                throw new Error('User not found');
                            }
                            
                            // First delete from database
                            return database.ref(`users/${userId}`).remove()
                                .then(() => {
                                    // Try to delete the auth user if it's not the current admin
                                    if (currentUser && currentUser.uid !== userId) {
                                        // This operation requires special privileges and might not work in all contexts
                                        console.log("Note: Deleting auth users from client requires Firebase Admin SDK");
                                        
                                        // In a real app, you would use a server function with Firebase Admin SDK
                                        console.log(`Auth user deletion would be triggered for: ${userData.email}`);
                                    }
                                });
                        })
                        .then(() => {
                            hideLoading();
                            confirmationModal.classList.remove('modal-visible');
                            alert('User account deleted successfully!');
                            
                            // Refresh the user list
                            refreshUsers();
                        })
                        .catch((error) => {
                            hideLoading();
                            confirmationModal.classList.remove('modal-visible');
                            alert(`Error deleting user: ${error.message}`);
                            console.error("Error deleting user:", error);
                        });
                }
                
                // Function to render user table - updated with permission checks
                function renderUserTable() {
                    // Clear table
                    userTableBody.innerHTML = '';
                    
                    // Get users for current page
                    const startIndex = (currentPage - 1) * usersPerPage;
                    const endIndex = startIndex + usersPerPage;
                    const usersToShow = currentUsers.slice(startIndex, endIndex);
                    
                    // Check if we have users to display
                    if (usersToShow.length === 0) {
                        userTableBody.innerHTML = `
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 20px;">
                                    No users found ${searchTerm ? 'matching your search.' : '.'}
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    // Update table header to include Role column
                    const tableHeader = document.querySelector('.user-table thead tr');
                    if (!tableHeader.querySelector('th:nth-child(7)')) {
                        const roleHeader = document.createElement('th');
                        roleHeader.textContent = 'Role';
                        tableHeader.appendChild(roleHeader);
                    }
                    
                    // Check if current user is superuser or guest
                    const isSuperuser = sessionStorage.getItem('userRole') === 'superuser';
                    const isGuest = sessionStorage.getItem('userRole') === 'guest';
                    
                    // Render each user
                    usersToShow.forEach(user => {
                        // Format dates
                        const createdAt = user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A';
                        const updatedAt = user.updatedAt ? new Date(user.updatedAt).toLocaleDateString() : createdAt;
                        
                        // Determine user status
                        const isActive = user.status === 'active' || (user.lastLogin && (new Date(user.lastLogin) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)));
                        const statusClass = isActive ? 'status-active' : 'status-inactive';
                        const statusText = isActive ? 'Active' : 'Inactive';
                        
                        // Create avatar cell
                        let avatarHTML;
                        if (user.profileImage) {
                            avatarHTML = `
                                <img src="${user.profileImage}" alt="Avatar" class="user-avatar-sm" 
                                    onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div class="user-initial-sm" style="display:none;">
                                    ${getInitials(user)}
                                </div>
                            `;
                        } else {
                            avatarHTML = `<div class="user-initial-sm">${getInitials(user)}</div>`;
                        }
                        
                        // Format role display
                        const roleDisplay = (user.role || 'user').charAt(0).toUpperCase() + (user.role || 'user').slice(1);
                        
                        // Create table row
                        const row = document.createElement('tr');
                        
                        // Check if current user has permission to edit this user
                        let clickable = true;
                        const currentUserId = auth.currentUser ? auth.currentUser.uid : null;
                        
                        // Guest users can never edit anything
                        if (isGuest) {
                            clickable = false;
                            row.classList.add('restricted-user');
                        } 
                        // If user is superuser, they can edit anyone
                        else if (!isSuperuser) {
                            // Cannot edit other admin users unless you're an admin with edit permission
                            if (user.role === 'admin' && currentUserId !== user.id && 
                                (!canPerformAction('edit_users') || currentUserRole !== 'admin')) {
                                clickable = false;
                                row.classList.add('restricted-user');
                            }
                            
                            // Cannot edit any users if you don't have edit_users permission (unless it's yourself)
                            if (!canPerformAction('edit_users') && currentUserId !== user.id) {
                                clickable = false;
                                row.classList.add('restricted-user');
                            }
                        }
                        
                        row.innerHTML = `
                            <td class="user-avatar-cell">${avatarHTML}</td>
                            <td>${user.firstName || ''} ${user.lastName || ''}</td>
                            <td>${user.email || 'N/A'}</td>
                            <td>${createdAt}</td>
                            <td>${updatedAt}</td>
                            <td><span class="user-status ${statusClass}">${statusText}</span></td>
                            <td>${roleDisplay}</td>
                        `;
                        
                        // Make the row clickable to edit user if permissions allow
                        if (clickable) {
                            // Check if current user has "user" role - they shouldn't be able to click profiles
                            const currentUserRole = sessionStorage.getItem('userRole');
                            if (currentUserRole === 'user') {
                                // Users with "user" role can't click on any profiles
                                row.classList.add('restricted-user');
                                row.title = "Regular users cannot access user profiles";
                            } else {
                                row.addEventListener('click', function() {
                                    openEditUserModal(user);
                                });
                            }
                        } else {
                            const restrictionReason = user.role === 'admin' ? 
                                "You don't have permission to edit administrators" : 
                                "You don't have permission to edit other users";
                            row.title = restrictionReason;
                        }
                        
                        userTableBody.appendChild(row);
                    });
                }
                
                // Add event listener for the dismiss banner button
                document.getElementById('dismissBannerBtn').addEventListener('click', function() {
                    document.getElementById('restrictedViewBanner').style.display = 'none';
                });

                // Function to set up notifications for events - updated to populate the dropdown
                function setupEventNotifications() {
                    // Clean up any existing listeners first
                    cleanupListeners();
                    
                    // Get the current user
                    const currentUser = auth.currentUser;
                    if (!currentUser) return;
                    
                    console.log("Setting up notification listeners for user:", currentUser.uid);
                    
                    // Create a reference to the user's notifications
                    const userNotificationsRef = database.ref(`userNotifications/${currentUser.uid}`);
                    
                    // Set up real-time listener specifically for unread notifications count
                    notificationListeners.unreadCounter = userNotificationsRef
                        .orderByChild('read')
                        .equalTo(false)
                        .on('value', snapshot => {
                            const unreadCount = snapshot.numChildren();
                            console.log(`Real-time unread notifications count: ${unreadCount}`);
                            
                            const counter = document.getElementById('notificationCounter');
                            const bell = document.getElementById('notificationBell');
                            
                            if (unreadCount > 0) {
                                // Update counter text
                                counter.textContent = unreadCount > 99 ? '99+' : unreadCount;
                                
                                // Handle animations based on state changes
                                if (counter.style.display === 'none') {
                                    // Counter was hidden before, display with pop animation
                                    counter.style.display = 'flex';
                                    counter.classList.remove('updated');
                                    // Add the has-glow class for subtle pulsing
                                    counter.classList.add('has-glow');
                                    // Animation for the bell
                                    bell.classList.add('has-new');
                                } else {
                                    // Count is showing, update animation
                                    counter.classList.remove('updated');
                                    void counter.offsetWidth; // Force reflow to restart animation
                                    counter.classList.add('updated');
                                }
                                
                                // Always keep the subtle animation going if there are notifications
                                bell.classList.add('has-notifications');
                            } else {
                                // No notifications, hide counter
                                counter.style.display = 'none';
                                counter.classList.remove('updated', 'has-glow');
                                bell.classList.remove('has-new', 'has-notifications');
                            }
                        }, error => {
                            console.error("Error setting up unread counter listener:", error);
                        });
                    
                    // Add event listeners for notification buttons
                    document.getElementById('markAllReadBtn').addEventListener('click', markNotificationsAsRead);
                    document.getElementById('clearAllBtn').addEventListener('click', clearAllNotifications);
                    
                    // Setup notification bell hover and click behavior
                    const bellContainer = document.getElementById('notificationBellContainer');
                    
                    // Track if notifications have been loaded during this hover session
                    let notificationsLoaded = false;
                    
                    // Add hover event to load notifications
                    bellContainer.addEventListener('mouseenter', function() {
                        if (!notificationsLoaded) {
                            loadNotifications(true); // Skip loading state
                            notificationsLoaded = true;
                            
                            // Reset the flag after a delay to allow reloading when hovering again later
                            setTimeout(() => {
                                notificationsLoaded = false;
                            }, 30000); // Reset after 30 seconds 
                        }
                    });
                    
                    // Toggle dropdown visibility on click
                    bellContainer.addEventListener('click', function(e) {
                        e.stopPropagation();
                        bellContainer.classList.toggle('active');
                        
                        if (bellContainer.classList.contains('active')) {
                            // Remove shaking animation when dropdown is opened
                            document.getElementById('notificationBell').classList.remove('has-new');
                        }
                    });
                    
                    // Close dropdown when clicking outside
                    document.addEventListener('click', function() {
                        bellContainer.classList.remove('active');
                    });
                }

                // Update the cleanupListeners function to properly remove the unread counter listener
                function cleanupListeners() {
                    console.log('Cleaning up Firebase listeners');
                    
                    const currentUser = auth.currentUser;
                    if (!currentUser) return;
                    
                    // Remove unread counter listener
                    if (notificationListeners.unreadCounter) {
                        try {
                            const userNotificationsRef = database.ref(`userNotifications/${currentUser.uid}`);
                            userNotificationsRef.orderByChild('read').equalTo(false).off('value', notificationListeners.unreadCounter);
                            notificationListeners.unreadCounter = null;
                            console.log("Unread counter listener removed");
                        } catch (error) {
                            console.error("Error removing unread counter listener:", error);
                        }
                    }
                    
                    // Remove other notification listeners
                    if (notificationListeners.childAdded) {
                        const userNotificationsRef = database.ref(`userNotifications/${currentUser.uid}`);
                        userNotificationsRef.off('child_added', notificationListeners.childAdded);
                        notificationListeners.childAdded = null;
                    }
                    
                    if (notificationListeners.childChanged) {
                        const userNotificationsRef = database.ref(`userNotifications/${currentUser.uid}`);
                        userNotificationsRef.off('child_changed', notificationListeners.childChanged);
                        notificationListeners.childChanged = null;
                    }
                    
                    if (notificationListeners.eventsAdded) {
                        const eventsRef = database.ref('events');
                        eventsRef.off('child_added', notificationListeners.eventsAdded);
                        notificationListeners.eventsAdded = null;
                    }
                    
                    if (notificationListeners.eventsChanged) {
                        const eventsRef = database.ref('events');
                        eventsRef.off('child_changed', notificationListeners.eventsChanged);
                        notificationListeners.eventsChanged = null;
                    }
                    
                    // Clear processed notifications cache
                    processedNotifications.clear();
                }

                // Add function to force refresh the unread counter (useful after operations)
                function refreshUnreadCounter() {
                    const currentUser = auth.currentUser;
                    if (!currentUser) return;
                    
                    // Create a reference to the user's notifications
                    const userNotificationsRef = database.ref(`userNotifications/${currentUser.uid}`);
                    
                    // Check unread notifications count
                    userNotificationsRef.orderByChild('read').equalTo(false).once('value')
                        .then(snapshot => {
                            const unreadCount = snapshot.numChildren();
                            console.log(`Manual refresh - unread notifications count: ${unreadCount}`);
                            
                            const counter = document.getElementById('notificationCounter');
                            const bell = document.getElementById('notificationBell');
                            
                            if (unreadCount > 0) {
                                counter.textContent = unreadCount > 99 ? '99+' : unreadCount;
                                counter.style.display = 'flex';
                                bell.classList.add('has-notifications');
                            } else {
                                counter.style.display = 'none';
                                bell.classList.remove('has-notifications');
                            }
                            
                            // Refresh the cache in the background
                            preloadNotifications();
                        })
                        .catch(error => {
                            console.error('Error refreshing unread counter:', error);
                        });
                }

                // Update the markNotificationAsRead function to update counter immediately
                function markNotificationAsRead(notificationId) {
                    const currentUser = auth.currentUser;
                    if (!currentUser) return;
                    
                    // Update the notification in Firebase
                    database.ref(`userNotifications/${currentUser.uid}/${notificationId}`).update({
                        read: true
                    }).then(() => {
                        console.log('Notification marked as read in Firebase');
                        
                        // Update the UI element immediately for better UX
                        const notificationItem = document.querySelector(`.notification-list-item[data-id="${notificationId}"]`);
                        if (notificationItem) {
                            notificationItem.classList.remove('unread');
                        }
                    }).catch(error => {
                        console.error('Error marking notification as read:', error);
                    });
                    // Counter will update automatically via the real-time listener
                }

                // Update handleVisibilityChange to refresh notifications when returning to the page
                function handleVisibilityChange() {
                    if (document.visibilityState === 'hidden') {
                        // Clean up listeners when page is hidden (user navigated away)
                        cleanupListeners();
                    } else if (document.visibilityState === 'visible') {
                        // Refresh notifications when returning to the page
                        cleanupListeners(); // First clean up any existing listeners
                        setupEventNotifications(); // Then set up fresh listeners
                        preloadNotifications(); // Preload notifications for instant access
                    }
                }
                
                // Function to load notifications from Firebase and update UI
                function loadNotifications(skipLoadingState = false) {
                    const currentUser = auth.currentUser;
                    if (!currentUser) return;
                    
                    const notificationList = document.getElementById('notificationList');
                    
                    // Check if we have a recent cache
                    const isCacheValid = cachedNotifications.length > 0 && 
                                        (Date.now() - lastNotificationFetch < CACHE_LIFETIME);
                    
                    // Use cache if it's valid
                    if (isCacheValid) {
                        renderNotificationsFromCache(notificationList);
                        return;
                    }
                    
                    // Show loading state only if not skipping
                    if (!skipLoadingState) {
                        notificationList.innerHTML = '<div class="notification-empty">Loading notifications...</div>';
                    }
                    
                    // Fetch fresh data
                    database.ref(`userNotifications/${currentUser.uid}`)
                        .orderByChild('time')
                        .limitToLast(50)
                        .once('value')
                        .then(snapshot => {
                            // Clear the list
                            notificationList.innerHTML = '';
                            
                            // Convert to array for sorting
                            cachedNotifications = [];
                            snapshot.forEach(childSnapshot => {
                                const notification = childSnapshot.val();
                                notification.id = childSnapshot.key;
                                cachedNotifications.push(notification);
                            });
                            
                            // Sort by time descending (newest first)
                            cachedNotifications.sort((a, b) => (b.time || 0) - (a.time || 0));
                            lastNotificationFetch = Date.now();
                            
                            renderNotificationsFromCache(notificationList);
                        })
                        .catch(error => {
                            console.error('Error loading notifications from Firebase:', error);
                            notificationList.innerHTML = '<div class="notification-empty">Error loading notifications</div>';
                        });
                }
                
                // Helper function to render notifications from cache
                function renderNotificationsFromCache(notificationList) {
                    // Clear the list
                    notificationList.innerHTML = '';
                    
                    if (cachedNotifications.length === 0) {
                        notificationList.innerHTML = '<div class="notification-empty">No notifications to display</div>';
                        return;
                    }
                    
                    // Sort by time descending (newest first)
                    cachedNotifications.sort((a, b) => (b.time || 0) - (a.time || 0));
                    
                    // Add each notification to the list
                    cachedNotifications.forEach(notification => {
                        const notificationItem = createNotificationElement(notification);
                        notificationList.appendChild(notificationItem); // Use appendChild to maintain sort order
                    });
                }

                // Function to create a notification element
                function createNotificationElement(notification) {
                    const notificationItem = document.createElement('div');
                    notificationItem.className = `notification-list-item ${isNotificationUnreadForCurrentUser(notification) ? 'unread' : ''}`;
                    notificationItem.dataset.id = notification.id;
                    
                    // Get icon based on type
                    let iconContent = '📢';
                    if (notification.type === 'warning') iconContent = '⚠️';
                    if (notification.type === 'error') iconContent = '❌';
                    if (notification.type === 'success') iconContent = '✅';
                    
                    // Add line manager badge if applicable
                    const lineManagerBadge = notification.isLineManagerNotification ? 
                        '<span class="line-manager-badge" title="You are the line manager for this notification">👨‍💼</span>' : '';
                    
                    // Format time
                    const notificationTime = new Date(notification.time);
                    const timeAgo = getTimeAgo(notificationTime);
                    
                    // Set inner HTML with possible line manager indicator
                    notificationItem.innerHTML = `
                        <div class="notification-icon ${notification.type}">
                            ${iconContent}
                        </div>
                        <div class="notification-content">
                            <h4 class="notification-title">${notification.title} ${lineManagerBadge}</h4>
                            <p class="notification-message">${notification.message}</p>
                            <span class="notification-time">${timeAgo}</span>
                        </div>
                    `;
                    
                    // Add click event to mark as read and navigate
                    notificationItem.addEventListener('click', function() {
                        markNotificationAsRead(notification.id);
                        
                        // Navigate to eventboard.html for all event-related notifications
                        if (notification.eventId) {
                            window.location.href = 'eventboard.html';
                        }
                    });
                    
                    return notificationItem;
                }

                // Update the addNotificationToUI function to append instead of prepend
                function addNotificationToUI(notification) {
                    const notificationList = document.getElementById('notificationList');
                    
                    // Remove empty message if present
                    const emptyMessage = notificationList.querySelector('.notification-empty');
                    if (emptyMessage) {
                        emptyMessage.remove();
                    }
                    
                    // Create notification element and append it to maintain proper order
                    const notificationItem = createNotificationElement(notification);
                    notificationList.appendChild(notificationItem);
                }
                
                // Function to preload notifications in the background
                function preloadNotifications() {
                    const currentUser = auth.currentUser;
                    if (!currentUser) return;
                    
                    return database.ref(`userNotifications/${currentUser.uid}`)
                        .orderByChild('time')
                        .limitToLast(50)
                        .once('value')
                        .then(snapshot => {
                            // Convert to array for sorting
                            cachedNotifications = [];
                            snapshot.forEach(childSnapshot => {
                                const notification = childSnapshot.val();
                                notification.id = childSnapshot.key;
                                cachedNotifications.push(notification);
                            });
                            
                            // Sort by time descending (newest first)
                            cachedNotifications.sort((a, b) => (b.time || 0) - (a.time || 0));
                            lastNotificationFetch = Date.now();
                        })
                        .catch(error => {
                            console.error('Error preloading notifications:', error);
                        });
                }
                
                // Function to add a notification to the UI - unchanged except for event listener
                function addNotificationToUI(notification) {
                    const notificationList = document.getElementById('notificationList');
                    
                    // Remove empty message if present
                    const emptyMessage = notificationList.querySelector('.notification-empty');
                    if (emptyMessage) {
                        emptyMessage.remove();
                    }
                    
                    // Create notification element
                    const notificationItem = document.createElement('div');
                    notificationItem.className = `notification-list-item ${notification.read ? '' : 'unread'}`;
                    notificationItem.dataset.id = notification.id;
                    
                    // Get icon based on type
                    let iconContent = '📢';
                    if (notification.type === 'warning') iconContent = '⚠️';
                    if (notification.type === 'error') iconContent = '❌';
                    if (notification.type === 'success') iconContent = '✅';
                    
                    // Format time
                    const notificationTime = new Date(notification.time);
                    const timeAgo = getTimeAgo(notificationTime);
                    
                    // Set inner HTML
                    notificationItem.innerHTML = `
                        <div class="notification-icon ${notification.type}">
                            ${iconContent}
                        </div>
                        <div class="notification-content">
                            <h4 class="notification-title">${notification.title}</h4>
                            <p class="notification-message">${notification.message}</p>
                            <span class="notification-time">${timeAgo}</span>
                        </div>
                    `;
                    
                    // Add click event to mark as read and navigate
                    notificationItem.addEventListener('click', function() {
                        markNotificationAsRead(notification.id);
                        
                        // Navigate to eventboard.html for all event-related notifications
                        if (notification.eventId) {
                            window.location.href = 'eventboard.html';
                        }
                    });
                    
                    // Always add to the beginning of the list to ensure newest notifications are on top
                    notificationList.insertBefore(notificationItem, notificationList.firstChild);
                }
                
                // Function to update notification UI
                function updateNotificationUI() {
                    // Load notifications from Firebase
                    loadNotifications();
                }
                
                // Function to update notification counter
                function updateNotificationCounter() {
                    const currentUser = auth.currentUser;
                    if (!currentUser) return;
                    
                    // Create a reference to the user's notifications
                    const userNotificationsRef = database.ref(`userNotifications/${currentUser.uid}`);
                    
                    // Count unread notifications
                    userNotificationsRef.orderByChild('read').equalTo(false).once('value')
                        .then(snapshot => {
                            const unreadCount = snapshot.numChildren();
                            const counter = document.getElementById('notificationCounter');
                            
                            if (unreadCount > 0) {
                                counter.textContent = unreadCount > 99 ? '99+' : unreadCount;
                                counter.style.display = 'flex';
                                
                                // Add has-new class to bell for animation
                                document.getElementById('notificationBell').classList.add('has-new');
                            } else {
                                counter.style.display = 'none';
                                
                                // Remove has-new class from bell
                                document.getElementById('notificationBell').classList.remove('has-new');
                            }
                        })
                        .catch(error => {
                            console.error('Error counting unread notifications:', error);
                        });
                }
                
                // Function to mark a notification as read
                function markNotificationAsRead(notificationId) {
                    const currentUser = auth.currentUser;
                    if (!currentUser) return;
                    
                    // Update the notification in Firebase
                    database.ref(`userNotifications/${currentUser.uid}/${notificationId}`).update({
                        read: true
                    }).then(() => {
                        // UI update will happen via the 'child_changed' listener
                        console.log('Notification marked as read in Firebase');
                        
                        // Update the UI element immediately for better UX
                        const notificationItem = document.querySelector(`.notification-list-item[data-id="${notificationId}"]`);
                        if (notificationItem) {
                            notificationItem.classList.remove('unread');
                        }
                        
                        // Update counter
                        updateNotificationCounter();
                    }).catch(error => {
                        console.error('Error marking notification as read:', error);
                    });
                }
                
                // Function to mark all notifications as read
                function markNotificationsAsRead() {
                    const currentUser = auth.currentUser;
                    if (!currentUser) return;
                    
                    // Get all unread notifications
                    database.ref(`userNotifications/${currentUser.uid}`).orderByChild('read').equalTo(false).once('value')
                        .then(snapshot => {
                            const updates = {};
                            
                            // Create batch update object
                            snapshot.forEach(childSnapshot => {
                                updates[`${childSnapshot.key}/read`] = true;
                            });
                            
                            // Apply updates if there are any
                            if (Object.keys(updates).length > 0) {
                                return database.ref(`userNotifications/${currentUser.uid}`).update(updates);
                            }
                            
                            return null;
                        })
                        .then(() => {
                            // UI update will happen via the 'child_changed' listener
                            console.log('All notifications marked as read');
                            
                            // Update the UI elements immediately for better UX
                            document.querySelectorAll('.notification-list-item').forEach(item => {
                                item.classList.remove('unread');
                            });
                            
                            // Update counter
                            updateNotificationCounter();
                        })
                        .catch(error => {
                            console.error('Error marking all notifications as read:', error);
                        });
                }
                
                // Function to clear all notifications
                function clearAllNotifications() {
                    const currentUser = auth.currentUser;
                    if (!currentUser) return;
                    
                    // Remove all notifications
                    database.ref(`userNotifications/${currentUser.uid}`).remove()
                        .then(() => {
                            console.log('All notifications cleared');
                            
                            // Update the UI
                            const notificationList = document.getElementById('notificationList');
                            notificationList.innerHTML = '<div class="notification-empty">No notifications to display</div>';
                            
                            // Update the counter
                            updateNotificationCounter();
                        })
                        .catch(error => {
                            console.error('Error clearing notifications:', error);
                        });
                }
                
                // Function to show toast notification (the floating notifications)
                function showToastNotification(notification) {
                    showNotification({
                        title: notification.title,
                        message: notification.message,
                        type: notification.type,
                        duration: notification.type === 'error' ? 10000 : 5000
                    });
                }
                
                // Helper function to format time ago - unchanged
                function getTimeAgo(date) {
                    const seconds = Math.floor((new Date() - date) / 1000);
                    
                    let interval = Math.floor(seconds / 31536000);
                    if (interval >= 1) {
                        return interval + " year" + (interval === 1 ? "" : "s") + " ago";
                    }
                    
                    interval = Math.floor(seconds / 2592000);
                    if (interval >= 1) {
                        return interval + " month" + (interval === 1 ? "" : "s") + " ago";
                    }
                    
                    interval = Math.floor(seconds / 86400);
                    if (interval >= 1) {
                        return interval + " day" + (interval === 1 ? "" : "s") + " ago";
                    }
                    
                    interval = Math.floor(seconds / 3600);
                    if (interval >= 1) {
                        return interval + " hour" + (interval === 1 ? "" : "s") + " ago";
                    }
                    
                    interval = Math.floor(seconds / 60);
                    if (interval >= 1) {
                        return interval + " minute" + (interval === 1 ? "" : "s") + " ago";
                    }
                    
                    return "just now";
                }

                // Function to show a notification - keep existing
                function showNotification(options) {
                    // ...existing code...
                }
                
                // Add the closeNotification function to the global scope - keep existing
                window.closeNotification = function(id) {
                    // ...existing code...
                };

                // Add click handler for user avatar dropdown
                const userAvatarContainer = document.querySelector('.user-avatar-container');
                const userDropdown = document.querySelector('.user-dropdown');
                
                if (userAvatarContainer && userDropdown) {
                    userAvatarContainer.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation(); // Prevent document click from immediately closing it
                        userDropdown.classList.toggle('show');
                    });
                    
                    // Close dropdown when clicking elsewhere
                    document.addEventListener('click', function(e) {
                        if (!userAvatarContainer.contains(e.target) && userDropdown.classList.contains('show')) {
                            userDropdown.classList.remove('show');
                        }
                    });
                    
                    // Add keydown event listener for accessibility
                    document.addEventListener('keydown', function(e) {
                        if (e.key === 'Escape' && userDropdown.classList.contains('show')) {
                            userDropdown.classList.remove('show');
                        }
                    });
                }
                
                // Add page visibility and unload event listeners to clean up Firebase listeners
                document.addEventListener('visibilitychange', handleVisibilityChange);
                window.addEventListener('beforeunload', cleanupListeners);
            } catch (error) {
                // ...existing code...
            }
        });
        
        // Function to handle page visibility changes
        function handleVisibilityChange() {
            if (document.visibilityState === 'hidden') {
                // Clean up listeners when page is hidden (user navigated away)
                cleanupListeners();
            } else if (document.visibilityState === 'visible') {
                // Refresh notifications when returning to the page
                cleanupListeners(); // First clean up any existing listeners
                setupEventNotifications(); // Then set up fresh listeners
                preloadNotifications(); // Preload notifications for instant access
            }
        }
        
        // Function to clean up all Firebase listeners
        function cleanupListeners() {
            console.log('Cleaning up Firebase listeners');
            
            const currentUser = auth.currentUser;
            if (!currentUser) return;
            
            // Remove notification listeners
            if (notificationListeners.childAdded) {
                const userNotificationsRef = database.ref(`userNotifications/${currentUser.uid}`);
                userNotificationsRef.off('child_added', notificationListeners.childAdded);
                notificationListeners.childAdded = null;
            }
            
            if (notificationListeners.childChanged) {
                const userNotificationsRef = database.ref(`userNotifications/${currentUser.uid}`);
                userNotificationsRef.off('child_changed', notificationListeners.childChanged);
                notificationListeners.childChanged = null;
            }
            
            if (notificationListeners.eventsAdded) {
                const eventsRef = database.ref('events');
                eventsRef.off('child_added', notificationListeners.eventsAdded);
                notificationListeners.eventsAdded = null;
            }
            
            if (notificationListeners.eventsChanged) {
                const eventsRef = database.ref('events');
                eventsRef.off('child_changed', notificationListeners.eventsChanged);
                notificationListeners.eventsChanged = null;
            }
            
            // Clear processed notifications cache
            processedNotifications.clear();
        }
        
        // Function to setup user avatar in navigation
        function setupUserAvatar(authUser) {
            const userId = authUser.uid;
            const userEmail = authUser.email || "user@example.com";
            document.getElementById('userEmail').textContent = userEmail;
            
            // Show profile link and logout button, hide login button when user is logged in
            document.getElementById('profileLink').style.display = 'block';
            document.getElementById('logoutButton').style.display = 'block';
            document.getElementById('loginButton').style.display = 'none';
            
            // Get user data from Firebase
            database.ref(`users/${userId}`).once('value').then((snapshot) => {
                const userData = snapshot.val() || {};
                const avatarContainer = document.getElementById('userAvatarContainer');
                
                // If user doesn't exist in the database yet, create entry
                if (!userData.email) {
                    // Create basic user profile if not exists
                    database.ref(`users/${userId}`).update({
                        email: userEmail,
                        createdAt: firebase.database.ServerValue.TIMESTAMP,
                        lastLogin: firebase.database.ServerValue.TIMESTAMP
                    });
                } else {
                    // Update last login time
                    database.ref(`users/${userId}`).update({
                        lastLogin: firebase.database.ServerValue.TIMESTAMP
                    });
                }
                
                if (userData.profileImage) {
                    // Add cache buster
                    const cacheBuster = `?t=${new Date().getTime()}`;
                    
                    // Create image element with error handling
                    avatarContainer.innerHTML = `
                        <img src="${userData.profileImage}${cacheBuster}" 
                            alt="Profile" 
                            class="user-avatar" 
                            onerror="this.style.display='none'; this.parentNode.innerHTML='<div class=\'user-initial\'>${getUserInitial(userData, userEmail)}</div>';">
                    `;
                } else {
                    // No profile image, show initial
                    avatarContainer.innerHTML = `<div class="user-initial">${getUserInitial(userData, userEmail)}</div>`;
                }
            }).catch(error => {
                console.error("Error fetching user data:", error);
                // Show default initial based on email
                const avatarContainer = document.getElementById('userAvatarContainer');
                avatarContainer.innerHTML = `<div class="user-initial">${userEmail.charAt(0).toUpperCase()}</div>`;
            });
            
            function getUserInitial(userData, email) {
                const firstName = userData.firstName;
                
                if (firstName && firstName.length > 0) {
                    return firstName.charAt(0).toUpperCase();
                }
                
                if (email && email.length > 0) {
                    return email.charAt(0).toUpperCase();
                }
                
                return "?";
            }
        }

        // Make sure hasPermission is properly defined
        function hasPermission(permissionName, roleFallback = false) {
            const userRole = sessionStorage.getItem('userRole');
            
            // Guest users can only have view_events permission regardless of settings
            if (userRole === 'guest' && permissionName !== 'view_events') {
                return false;
            }
            
            // Superuser role has all permissions
            if (userRole === 'superuser') {
                return true;
            }
            
            // If the permission is explicitly set, use that value
            if (permissions && permissionName in permissions) {
                return permissions[permissionName] === true;
            }
            
            // Otherwise, fall back to role-based permission
            return roleFallback;
        }

        // Add a basic error handler to catch any uncaught errors
        window.addEventListener('error', function(event) {
            console.error('Caught unhandled error:', event.error);
            // Prevent the dashboard from completely failing
            hideLoading();
            
            // Display an error message to the user
            if (document.getElementById('userTableBody')) {
                document.getElementById('userTableBody').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 20px; color: #721c24; background-color: #f8d7da;">
                            An error occurred while loading the dashboard. Please try refreshing the page.
                        </td>
                    </tr>
                `;
            }
            
            return true; // Prevents the default error handler
        });

        // Update CSS to ensure dropdown shows on hover as well as on click
        function addHoverStyles() {
            // Check if the style element already exists
            let notificationStyle = document.getElementById('notification-hover-style');
            
            // Create new style element if it doesn't exist
            if (!notificationStyle) {
                notificationStyle = document.createElement('style');
                notificationStyle.id = 'notification-hover-style';
                notificationStyle.textContent = `
                    .notification-bell-container:hover .notification-dropdown {
                        display: block;
                    }
                `;
                document.head.appendChild(notificationStyle);
            }
        }

        // Update the document ready event to add our custom hover styles
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Existing code...
                
                // Add hover styles for notifications dropdown
                addHoverStyles();
                
                // Add listener for page visibility changes to refresh the counter when returning to the page
                document.addEventListener('visibilitychange', function() {
                    if (document.visibilityState === 'visible' && auth.currentUser) {
                        // Check for unread notifications when tab becomes visible again
                        refreshUnreadCounter();
                    }
                });
                
            } catch (error) {
                console.error("Error in DOMContentLoaded:", error);
            }
        });

        // Update the loadNotifications function to filter by line manager

        // Modified preloadNotifications to filter by line manager relationship
        function preloadNotifications() {
            const currentUser = auth.currentUser;
            if (!currentUser) return;
            
            return database.ref(`userNotifications/${currentUser.uid}`)
                .orderByChild('time')
                .limitToLast(50)
                .once('value')
                .then(snapshot => {
                    // Convert to array for sorting
                    cachedNotifications = [];
                    snapshot.forEach(childSnapshot => {
                        const notification = childSnapshot.val();
                        notification.id = childSnapshot.key;
                        cachedNotifications.push(notification);
                    });
                    
                    // Sort by time descending (newest first)
                    cachedNotifications.sort((a, b) => (b.time || 0) - (a.time || 0));
                    lastNotificationFetch = Date.now();
                    
                    // After loading user notifications, check for line manager notifications
                    return loadLineManagerNotifications();
                })
                .catch(error => {
                    console.error('Error preloading notifications:', error);
                });
        }

        // New function to load notifications where the user is listed as line manager
        function loadLineManagerNotifications() {
            const currentUser = auth.currentUser;
            if (!currentUser) return Promise.resolve();
            
            // First check if the user is a manager (optional optimization)
            return database.ref('users').orderByChild('lineManagerId').equalTo(currentUser.uid)
                .once('value')
                .then(managerSnapshot => {
                    // If the user is not a line manager for anyone, no need to continue
                    if (!managerSnapshot.exists()) {
                        return Promise.resolve();
                    }
                    
                    // User is a line manager, search for notifications across all users
                    const lineManagerNotificationsPromises = [];
                    
                    // For each user that has this user as their manager
                    managerSnapshot.forEach(userSnapshot => {
                        const userId = userSnapshot.key;
                        
                        // Get notifications for this user
                        const promise = database.ref(`userNotifications/${userId}`)
                            .orderByChild('time')
                            .limitToLast(50)
                            .once('value')
                            .then(notificationSnapshot => {
                                notificationSnapshot.forEach(childSnapshot => {
                                    const notification = childSnapshot.val();
                                    notification.id = `${userId}_${childSnapshot.key}`;
                                    notification.originalUserId = userId;
                                    
                                    // Only add if it has lineManagerId matching current user or notify_manager flag
                                    if ((notification.lineManagerId && notification.lineManagerId === currentUser.uid) || 
                                         notification.notify_manager === true) {
                                        
                                        // Add a property to indicate this is a line manager notification
                                        notification.isLineManagerNotification = true;
                                        
                                        // Add to cached notifications if not already there
                                        if (!cachedNotifications.some(n => n.id === notification.id)) {
                                            cachedNotifications.push(notification);
                                        }
                                    }
                                });
                            });
                        
                        lineManagerNotificationsPromises.push(promise);
                    });
                    
                    return Promise.all(lineManagerNotificationsPromises).then(() => {
                        // Re-sort all notifications by time
                        cachedNotifications.sort((a, b) => (b.time || 0) - (a.time || 0));
                    });
                })
                .catch(error => {
                    console.error('Error loading line manager notifications:', error);
                });
        }

        // Update markNotificationAsRead to handle line manager notifications
        function markNotificationAsRead(notificationId) {
            const currentUser = auth.currentUser;
            if (!currentUser) return;
            
            // Check if this is a line manager notification (contains underscore in the ID)
            if (notificationId.includes('_')) {
                const [userId, originalNotificationId] = notificationId.split('_');
                
                // Update the notification in Firebase, but don't mark original user's notification as read
                // Instead, store read status separately for the line manager
                const lineManagerReadPath = `userNotifications/${userId}/${originalNotificationId}/readByManagers/${currentUser.uid}`;
                
                database.ref(lineManagerReadPath).set(true)
                    .then(() => {
                        console.log('Line manager notification marked as read');
                        
                        // Update the UI element immediately
                        const notificationItem = document.querySelector(`.notification-list-item[data-id="${notificationId}"]`);
                        if (notificationItem) {
                            notificationItem.classList.remove('unread');
                        }
                        
                        // Update cachedNotifications to reflect read status
                        const notification = cachedNotifications.find(n => n.id === notificationId);
                        if (notification) {
                            if (!notification.readByManagers) notification.readByManagers = {};
                            notification.readByManagers[currentUser.uid] = true;
                        }
                    })
                    .catch(error => {
                        console.error('Error marking line manager notification as read:', error);
                    });
            } else {
                // Regular notification handling
                database.ref(`userNotifications/${currentUser.uid}/${notificationId}`).update({
                    read: true
                }).then(() => {
                    console.log('Notification marked as read in Firebase');
                    
                    // Update the UI element immediately
                    const notificationItem = document.querySelector(`.notification-list-item[data-id="${notificationId}"]`);
                    if (notificationItem) {
                        notificationItem.classList.remove('unread');
                    }
                    
                    // Update cachedNotifications to reflect read status
                    const notification = cachedNotifications.find(n => n.id === notificationId);
                    if (notification) {
                        notification.read = true;
                    }
                }).catch(error => {
                    console.error('Error marking notification as read:', error);
                });
            }
            
            // Counter will update automatically via the real-time listener
        }

        // Helper function to determine if a notification is unread by the current user
        function isNotificationUnreadForCurrentUser(notification) {
            const currentUser = auth.currentUser;
            if (!currentUser) return false;
            
            // If it's a line manager notification
            if (notification.isLineManagerNotification) {
                return !(notification.readByManagers && notification.readByManagers[currentUser.uid]);
            }
            
            // Regular notification
            return !notification.read;
        }

        // Update addNotificationToUI to handle line manager notifications
        function addNotificationToUI(notification) {
            const notificationList = document.getElementById('notificationList');
            
            // Remove empty message if present
            const emptyMessage = notificationList.querySelector('.notification-empty');
            if (emptyMessage) {
                emptyMessage.remove();
            }
            
            // Check if this notification is unread for the current user
            const isUnread = isNotificationUnreadForCurrentUser(notification);
            
            // Create notification element
            const notificationItem = document.createElement('div');
            notificationItem.className = `notification-list-item ${isUnread ? 'unread' : ''}`;
            notificationItem.dataset.id = notification.id;
            
            // Get icon based on type
            let iconContent = '📢';
            if (notification.type === 'warning') iconContent = '⚠️';
            if (notification.type === 'error') iconContent = '❌';
            if (notification.type === 'success') iconContent = '✅';
            
            // Add line manager badge if applicable
            const lineManagerBadge = notification.isLineManagerNotification ? 
                '<span class="line-manager-badge" title="You are the line manager for this notification">👨‍💼</span>' : '';
            
            // Format time
            const notificationTime = new Date(notification.time);
            const timeAgo = getTimeAgo(notificationTime);
            
            // Set inner HTML with possible line manager indicator
            notificationItem.innerHTML = `
                <div class="notification-icon ${notification.type}">
                    ${iconContent}
                </div>
                <div class="notification-content">
                    <h4 class="notification-title">${notification.title} ${lineManagerBadge}</h4>
                    <p class="notification-message">${notification.message}</p>
                    <span class="notification-time">${timeAgo}</span>
                </div>
            `;
            
            // Add click event to mark as read and navigate
            notificationItem.addEventListener('click', function() {
                markNotificationAsRead(notification.id);
                
                // Navigate to related resource if applicable
                if (notification.eventId) {
                    let url = `evnt.html?id=${notification.eventId}`;
                    
                    // If this is a line manager notification and requires approval
                    if (notification.isLineManagerNotification && notification.type === 'event_requires_approval') {
                        url = `evnt.html?edit=${notification.eventId}&manager=true`;
                    }
                    
                    window.location.href = url;
                }
            });
            
            // Always add to the beginning of the list to ensure newest notifications are on top
            notificationList.insertBefore(notificationItem, notificationList.firstChild);
        }

        // Update refreshUnreadCounter to consider line manager notifications
        function refreshUnreadCounter() {
            const currentUser = auth.currentUser;
            if (!currentUser) return;
            
            // Load fresh notifications to count unread ones
            preloadNotifications()
                .then(() => {
                    // Count unread notifications including line manager ones
                    const unreadCount = cachedNotifications.filter(notification => 
                        isNotificationUnreadForCurrentUser(notification)
                    ).length;
                    
                    console.log(`Manual refresh - unread notifications count: ${unreadCount}`);
                    
                    const counter = document.getElementById('notificationCounter');
                    const bell = document.getElementById('notificationBell');
                    
                    if (unreadCount > 0) {
                        counter.textContent = unreadCount > 99 ? '99+' : unreadCount;
                        counter.style.display = 'flex';
                        bell.classList.add('has-notifications');
                    } else {
                        counter.style.display = 'none';
                        bell.classList.remove('has-notifications');
                    }
                })
                .catch(error => {
                    console.error('Error refreshing unread counter:', error);
                });
        }

        // Update setupEventNotifications to track line manager notifications too
        function setupEventNotifications() {
            // Clean up any existing listeners first
            cleanupListeners();
            
            // Get the current user
            const currentUser = auth.currentUser;
            if (!currentUser) return;
            
            console.log("Setting up notification listeners for user:", currentUser.uid);
            
            // Create a reference to the user's notifications
            const userNotificationsRef = database.ref(`userNotifications/${currentUser.uid}`);
            
            // Set up real-time listener specifically for unread notifications count
            notificationListeners.unreadCounter = userNotificationsRef
                .orderByChild('read')
                .equalTo(false)
                .on('value', snapshot => {
                    // We'll load all notifications including line manager ones to get the total unread count
                    refreshUnreadCounter();
                }, error => {
                    console.error("Error setting up unread counter listener:", error);
                });
            
            // Add event listeners for notification buttons
            document.getElementById('markAllReadBtn').addEventListener('click', markNotificationsAsRead);
            document.getElementById('clearAllBtn').addEventListener('click', clearAllNotifications);
            
            // Setup notification bell hover and click behavior
            const bellContainer = document.getElementById('notificationBellContainer');
            
            // Track if notifications have been loaded during this hover session
            let notificationsLoaded = false;
            
            // Add hover event to load notifications
            bellContainer.addEventListener('mouseenter', function() {
                if (!notificationsLoaded) {
                    loadNotifications(true); // Skip loading state
                    notificationsLoaded = true;
                    
                    // Reset the flag after a delay to allow reloading when hovering again later
                    setTimeout(() => {
                        notificationsLoaded = false;
                    }, 30000); // Reset after 30 seconds 
                }
            });
            
            // Toggle dropdown visibility on click
            bellContainer.addEventListener('click', function(e) {
                e.stopPropagation();
                bellContainer.classList.toggle('active');
                
                if (bellContainer.classList.contains('active')) {
                    // Remove shaking animation when dropdown is opened
                    document.getElementById('notificationBell').classList.remove('has-new');
                }
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function() {
                bellContainer.classList.remove('active');
            });
        }

        // Add CSS styles for line manager badge
        function addLineManagerBadgeStyle() {
            const style = document.createElement('style');
            style.textContent = `
                .line-manager-badge {
                    font-size: 11px;
                    background-color: #34495e;
                    color: white;
                    padding: 2px 4px;
                    border-radius: 3px;
                    margin-left: 5px;
                    vertical-align: middle;
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                    text-align: left;
                }
            `;
            document.head.appendChild(style);
        }

        // Call this in the document ready function
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // ... existing code ...
                
                // Add hover styles for notifications dropdown
                addHoverStyles();
                
                // Add line manager badge style
                addLineManagerBadgeStyle();
                
                // ... existing code ...
            } catch (error) {
                console.error("Error in DOMContentLoaded:", error);
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
    try {
        // Add guest and superuser options to role dropdowns
        const createRoleSelect = document.getElementById('createRole');
        if (createRoleSelect) {
            // ...existing code...
        }
        
        // Remove permission display sections
        const createPermissionsDisplay = document.getElementById('createPermissionsDisplay');
        if (createPermissionsDisplay) {
            createPermissionsDisplay.style.display = 'none';
        }
        
        const editPermissionsDisplay = document.getElementById('editPermissionsDisplay');
        if (editPermissionsDisplay) {
            editPermissionsDisplay.style.display = 'none';
        }
        
        // Add event listeners for form submission checking
        const createUserForm = document.getElementById('createUserForm');
        if (createUserForm) {
            createUserForm.addEventListener('submit', function(e) {
                if (sessionStorage.getItem('userRole') === 'guest') {
                    e.preventDefault();
                    showPermissionDeniedMessage("Guest accounts cannot create users");
                    return false;
                }
                
                if (!['admin', 'superuser'].includes(sessionStorage.getItem('userRole'))) {
                    e.preventDefault();
                    showPermissionDeniedMessage("You don't have permission to create users");
                    return false;
                }
            }, true);
        }
        
        const editUserForm = document.getElementById('editUserForm');
        if (editUserForm) {
            editUserForm.addEventListener('submit', function(e) {
                const userId = document.getElementById('editUserId').value;
                if (sessionStorage.getItem('userRole') === 'guest') {
                    e.preventDefault();
                    showPermissionDeniedMessage("Guest accounts cannot edit user profiles");
                    return false;
                }
                
                if (!['admin', 'superuser'].includes(sessionStorage.getItem('userRole')) && 
                    auth.currentUser.uid !== userId) {
                    e.preventDefault();
                    showPermissionDeniedMessage("You don't have permission to edit other users");
                    return false;
                }
            }, true);
        }
        
        // ...existing code...
    } catch (error) {
        console.error("Error in DOMContentLoaded:", error);
    }
});

// Function to check if the current user can perform a specific action
function canPerformAction(action) {
    const userRole = sessionStorage.getItem('userRole') || 'user';
    
    // Guest users can only perform view actions
    if (userRole === 'guest') {
        // Only allow view_events for guests
        return action === 'view_events';
    }
    
    // Superuser can perform any action
    if (userRole === 'superuser') {
        return true;
    }
    
    // Role-based permissions
    switch(action) {
        case 'create_user':
            return ['admin', 'superuser'].includes(userRole);
        case 'edit_users':
            return ['admin', 'superuser'].includes(userRole);
        case 'edit_own_profile':
            // Everyone except guests can edit their own profile
            return userRole !== 'guest';
        case 'delete_user':
            return ['admin', 'superuser'].includes(userRole);
        case 'view_users':
            return ['admin', 'editor', 'superuser'].includes(userRole);
        case 'create_event':
            // Regular users can create events
            return ['admin', 'editor', 'user', 'superuser'].includes(userRole);
        case 'edit_own_event':
            // All users can edit their own events
            return ['admin', 'editor', 'user', 'superuser'].includes(userRole);
        case 'edit_any_event':
            // Only admin and superuser can edit any event
            return ['admin', 'superuser'].includes(userRole);
        case 'delete_event':
            // Only admin and superuser can delete events
            return ['admin', 'superuser'].includes(userRole);
        case 'view_events':
            // All authenticated users can view events
            return true;
        default:
            return false;
    }
}

// Function to open edit user modal - prevent guests from editing even their own profile
function openEditUserModal(user) {
    // Guest users should never be able to open edit modal, even for themselves
    if (sessionStorage.getItem('userRole') === 'guest') {
        showPermissionDeniedMessage("Guest accounts cannot edit user information");
        return;
    }
    
    // Regular users can edit themselves, admin/superuser can edit anyone
    const currentUserId = auth.currentUser?.uid;
    const isSelf = currentUserId === user.id;
    const isAdminOrSuperuser = ['admin', 'superuser'].includes(sessionStorage.getItem('userRole'));
    
    if (!isSelf && !isAdminOrSuperuser) {
        showPermissionDeniedMessage("You don't have permission to edit other users");
        return;
    }
    
    // Set form values
    document.getElementById('editUserId').value = user.id;
    document.getElementById('editFirstName').value = user.firstName || '';
    document.getElementById('editLastName').value = user.lastName || '';
    document.getElementById('editEmail').value = user.email || '';
    document.getElementById('editStatus').value = user.status || 'inactive';
    document.getElementById('editRole').value = user.role || 'user';
    
    // Show delete button for superusers, admins or when editing self (but not guests)
    if (sessionStorage.getItem('userRole') === 'superuser' || 
        sessionStorage.getItem('userRole') === 'admin' || 
        (isSelf && sessionStorage.getItem('userRole') !== 'guest')) {
        deleteUserBtn.style.display = 'block';
    } else {
        deleteUserBtn.style.display = 'none';
    }
    
    // Show the modal
    editUserModal.classList.add('modal-visible');
    setupEditUserModalButtons();
}

// Update renderUserTable to handle guest row restrictions
function renderUserTable() {
    // Clear table
    userTableBody.innerHTML = '';
    
    // ...existing code...
    
    // Check current user role
    const isSuperuser = sessionStorage.getItem('userRole') === 'superuser';
    const isAdmin = sessionStorage.getItem('userRole') === 'admin';
    const isGuest = sessionStorage.getItem('userRole') === 'guest';
    
    // Render each user
    usersToShow.forEach(user => {
        // ...existing code...
        
        // Create table row
        const row = document.createElement('tr');
        
        // Check if current user has permission to edit this user
        let clickable = true;
        const currentUserId = auth.currentUser ? auth.currentUser.uid : null;
        
        // Guest users can never edit anything, even their own profiles
        if (isGuest) {
            clickable = false;
            row.classList.add('restricted-user');
        } 
        // If user is superuser or admin, they can edit anyone except superusers (if not superuser themselves)
        else if (!isSuperuser && !isAdmin) {
            clickable = currentUserId === user.id;
            if (!clickable) {
                row.classList.add('restricted-user');
            }
        }
        // Admin users can't edit superusers
        else if (isAdmin && !isSuperuser && user.role === 'superuser') {
            clickable = false;
            row.classList.add('restricted-user');
        }
        
        // ...existing code...
        
        // Make the row clickable to edit user if permissions allow
        if (clickable) {
            // Check if current user has "user" role - they shouldn't be able to click profiles
            const currentUserRole = sessionStorage.getItem('userRole');
            if (currentUserRole === 'user') {
                // Users with "user" role can't click on any profiles
                row.classList.add('restricted-user');
                row.title = "Regular users cannot access user profiles";
            } else {
                row.addEventListener('click', function() {
                    openEditUserModal(user);
                });
            }
        } else {
            // Different message for guests vs. other restricted users
            let restrictionReason = "You don't have permission to edit this user";
            if (isGuest) {
                restrictionReason = "Guest accounts can only view information, not edit";
            } else if (!isSuperuser && user.role === 'superuser') {
                restrictionReason = "Only superusers can edit other superusers";
            }
            row.title = restrictionReason;
        }
        
        userTableBody.appendChild(row);
    });
}

// Edit User Form Submit - prevent guests from submitting
editUserForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const userId = document.getElementById('editUserId').value;
    const userRole = sessionStorage.getItem('userRole');
    
    // Check if current user has permission to edit users
    if (userRole === 'guest') {
        showPermissionDeniedMessage("Guest accounts cannot edit user information");
        return;
    }
    
    // Regular users can only edit themselves
    if (!['admin', 'superuser'].includes(userRole) && auth.currentUser.uid !== userId) {
        showPermissionDeniedMessage("You don't have permission to edit other users");
        return;
    }
    
    const firstName = document.getElementById('editFirstName').value.trim();
    const lastName = document.getElementById('editLastName').value.trim();
    const email = document.getElementById('editEmail').value.trim();
    const status = document.getElementById('editStatus').value;
    const role = document.getElementById('editRole').value;
    
    // Basic validation
    let isValid = true;
    // ...existing validation code...
    
    if (isValid) {
        showLoading();
        
        // Update user data in the database without permissions
        const updates = {
            firstName: firstName,
            lastName: lastName,
            email: email,
            status: status,
            role: role,
            updatedAt: firebase.database.ServerValue.TIMESTAMP
        };
        
        database.ref(`users/${userId}`).update(updates)
            .then(() => {
                refreshUsers();
                editUserModal.classList.remove('modal-visible');
                showNotification({
                    title: "User Updated",
                    message: "User information has been successfully updated.",
                    type: "success"
                });
            })
            .catch((error) => {
                console.error("Error updating user:", error);
                showNotification({
                    title: "Error",
                    message: "Failed to update user: " + error.message,
                    type: "error"
                });
            });
    }
});

// Function to close the edit user modal
function closeEditUserModal() {
    const editUserModal = document.getElementById('editUserModal');
    if (editUserModal) {
        editUserModal.classList.remove('modal-visible');
    }
}

// Enhanced function to ensure modal close and cancel buttons work properly
function setupEditUserModalButtons() {
    // Close button (X) in the modal header
    const closeButton = document.querySelector('#editUserModal .modal-close');
    if (closeButton) {
        const newCloseButton = closeButton.cloneNode(true);
        closeButton.parentNode.replaceChild(newCloseButton, closeButton);
        newCloseButton.addEventListener('click', closeEditUserModal);
    }

    // Cancel button in the modal footer
    const cancelButton = document.querySelector('#editUserModal .modal-cancel');
    if (cancelButton) {
        const newCancelButton = cancelButton.cloneNode(true);
        cancelButton.parentNode.replaceChild(newCancelButton, cancelButton);
        newCancelButton.addEventListener('click', closeEditUserModal);
    }
}

// Ensure the buttons are set up when the DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    // ...existing code...
    setupEditUserModalButtons();
});

// Ensure the buttons are set up when the modal is opened
function openEditUserModal(user) {
    // ...existing code...
    setupEditUserModalButtons();
    // ...existing code...
}
    </script>
</body>
</html>
