<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Training Request - Dreamex Lab</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Main container styles */
        .ptw-container {
            max-width: 1600px; /* Increased from 1000px for wider form */
            margin: 80px auto 30px;
            padding: 30px;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        .ptw-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .ptw-title h2 {
            margin: 0;
            color: #34495e;
        }

        .ptw-title p {
            margin: 5px 0 0;
            color: #7f8c8d;
            font-size: 14px;
        }

        /* Form styles */
        .ptw-form {
            margin-top: 20px;
            width: 100%;
        }

        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .form-section h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #34495e;
            font-size: 18px;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 10px;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 15px;
            max-width: 100%;
        }

        .form-group {
            flex: 1;
            min-width: 250px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            height: 40px;
            padding: 8px 12px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fff;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            box-sizing: border-box;
        }

        .form-control:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        .checkbox-group {
            margin-top: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 10px;
        }

        .checkbox-item label {
            font-weight: normal;
            margin-bottom: 0;
        }

        /* Nested sections for hazards/controls */
        .nested-section {
            background-color: #fff;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            margin-top: 15px;
        }

        .nested-item {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: start;
        }

        .nested-item .form-group {
            margin-bottom: 0;
        }

        .nested-item-controls {
            display: flex;
            gap: 10px;
            margin-top: 28px; /* Align with inputs */
        }

        /* Button styles */
        .btn {
            height: 40px;
            min-width: 120px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            letter-spacing: 0.3px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 14px;
        }

        .btn:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: #2ecc71;
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        .btn-danger {
            background-color: #e74c3c;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-add {
            height: 32px;
            min-width: 32px;
            padding: 0;
            font-size: 20px;
            font-weight: bold;
        }

        .btn-remove {
            height: 32px;
            min-width: 32px;
            padding: 0;
            font-weight: bold;
        }

        .form-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
        }

        /* Required field indicator */
        .required:after {
            content: '*';
            color: #e74c3c;
            margin-left: 4px;
        }

        /* Form validation styles */
        .invalid-feedback {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .form-control.is-invalid {
            border-color: #e74c3c;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='none' stroke='%23e74c3c' viewBox='0 0 12 12'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23e74c3c' stroke='none'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px 16px;
        }

        .form-control.is-invalid + .invalid-feedback {
            display: block;
        }

        /* Status styles */
        .status-indicator {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            max-width: 120px;
        }

        .status-draft {
            background-color: #f8f9fa;
            color: #495057;
            border: 1px dashed #ced4da;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background-color: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background-color: #f8d7da;
            color: #721c24;
        }

        .status-expired {
            background-color: #e2e3e5;
            color: #383d41;
        }

        /* Permit types styling */
        .permit-type-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .permit-type {
            flex: 1;
            min-width: 160px;
            text-align: center;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .permit-type:hover {
            border-color: #3498db;
            background-color: #f1f9ff;
        }

        .permit-type.selected {
            border-color: #3498db;
            background-color: #ebf5fb;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .permit-type-icon {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .permit-type-name {
            font-weight: 600;
            color: #34495e;
        }

        /* Notification bell and user avatar styles (keep consistent with other pages) */
        .menu-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* Notification bell styles */
        .notification-bell-container {
            position: relative;
        }

        .notification-bell {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.2s ease;
            position: relative;
        }

        .notification-bell:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .bell-icon-svg {
            width: 20px;
            height: 20px;
            fill: none;
            stroke: #555;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .notification-counter {
            position: absolute;
            top: 0;
            right: 0;
            background-color: #e74c3c;
            color: white;
            font-size: 10px;
            min-width: 16px;
            height: 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .notification-dropdown {
            position: fixed;
            top: 45px;
            right: -10px;
            background-color: white;
            width: 320px;
            max-height: calc(100vh - 60px);
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }

        .notification-bell:hover + .notification-dropdown,
        .notification-dropdown:hover {
            display: block;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        .notification-header h4 {
            margin: 0;
            font-size: 16px;
            color: #333;
        }

        .notification-header-actions button {
            background: none;
            border: none;
            color: #3498db;
            font-size: 13px;
            cursor: pointer;
            padding: 3px 6px;
        }

        .notification-list {
            max-height: 350px;
            overflow-y: auto;
        }

        .notification-empty {
            padding: 20px;
            text-align: center;
            color: #7f8c8d;
            font-size: 14px;
        }

        /* User avatar styles */
        .menu-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #34495e;
            padding: 0 20px;
        }
        
        .menu-bar ul {
            display: flex;
            align-items: center;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .menu-bar ul li {
            margin: 0 10px;
        }
        
        .menu-bar ul li a {
            display: block;
            padding: 15px 10px;
            color: #ecf0f1;
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .menu-bar ul li a:hover {
            color: #f1f3f5;
        }
        
        .menu-bar ul li.current a {
            color: #fafcfd;
            font-weight: bold;
        }

        /* Dropdown styles */
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white !important;
            color: black !important;
            min-width: 160px;
            box-shadow: 0px 8px 16px rgba(0,0,0,0.2);
            z-index: 1;
            top: calc(100%);
            font-size: 6px !important;
            font-weight: normal;
            text-align: left;
        }
        .dropdown-content a {
            color: rgb(44, 43, 43) !important;
            padding: 6px 10px !important;
            text-decoration: none;  
            display: block;
            font-size: 11px !important;
        }
        .dropdown-content a:hover {
            background-color: #e8e8e8;
            transform: none; 
        }
        .dropdown:hover .dropdown-content,
        .dropdown:focus-within .dropdown-content {
            display: block;
        }

        /* User Avatar Styles */
        .user-avatar-container {
            position: relative;
            display: flex;
            align-items: center;
            margin-right: 20px;
            cursor: pointer;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .user-dropdown {
            position: absolute;
            top: 45px;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 0;
            min-width: 200px;
            display: none;
            z-index: 1000;
            text-align: left;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.08);
        }

        /* Add class for showing the dropdown */
        .user-dropdown.show {
            display: block;
            animation: dropdown-fade-in 0.2s ease-out;
        }
        
        /* Add missing animation definition */
        @keyframes dropdown-fade-in {
            0% { opacity: 0; transform: translateY(-10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        .user-email {
            padding: 5px 15px; /* Further reduced from 8px to 5px */
            border-bottom: 1px solid #eaeaea;
            color: #34495e;
            font-weight: 500;
            background-color: #f8f9fa;
            font-size: 13px; /* Reduced from 14px to 13px */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .user-dropdown a {
            display: block;
            padding: 2px 15px; /* Further reduced from 4px to 2px */
            color: #000000;
            text-decoration: none;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            font-size: 13px; /* Reduced from 14px to 13px */
            line-height: 1.4; /* Added to provide some minimal spacing */
        }
        
        /* Ensure specific dropdown links are black */
        #profileLink, #accountLink {
            color: #474646 !important; /* Pure black color with !important to override any other styles */
        }
        
        .user-dropdown a:hover {
            background-color: #f1f8fe;
            border-left-color: #3498db;
            color: #3498db;
        }
        
        .user-dropdown a:last-child {
            border-top: 1px solid #eaeaea;
        }
        
        #logoutButton {
            color: #e74c3c; /* Keep logout button red */
        }
        
        #logoutButton:hover {
            background-color: #fdeeee;
            border-left-color: #e74c3c;
        }
        
        #loginButton {
            color: #000000; /* Changed to black */
        }
        
        #loginButton:hover {
            background-color: #f1f8fe;
            border-left-color: #3498db;
            color: #3498db;
        }
        
        .user-initial {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Align table headers to left */
        table th {
            text-align: left !important;
        }
        
        /* Ensure nested tables in permit-specific content are also left-aligned */
        #permitSpecificContent th {
            text-align: left !important;
        }

        /* Ensure all heading elements are left-aligned */
        h1, h2, h3, h4, h5, h6, .section-title, .ptw-title h2, .ptw-title p, .form-section h3 {
            text-align: left !important;
        }
        
        /* Ensure permit type headings and descriptions are left-aligned */
        .permit-type-name,
        .permit-type-desc {
            text-align: left !important;
        }

        /* Ensure consistent alignment in permit-specific content */
        #permitSpecificTitle,
        #permitSpecificContent p,
        .checkbox-group p {
            text-align: left !important;
        }

        /* Improve left alignment for all title elements */
        h1, h2, h3, h4, h5, h6, 
        .section-title, 
        .ptw-title h2, 
        .ptw-title p, 
        .form-section h3,
        .modal-title,
        .detail-section h3,
        .board-title h2,
        .board-title p {
            text-align: left !important;
        }
        
        /* Ensure specific elements are also left-aligned */
        .permit-type-name,
        .permit-type-desc,
        .checkbox-group p,
        .checkbox-item label,
        .detail-label,
        .detail-value,
        .notification-header h4 {
            text-align: left !important;
        }
        
        /* Remove any center alignment that might be applied elsewhere */
        .ptw-header,
        .form-section,
        .board-header {
            text-align: left !important;
        }
    </style>
    <!-- Add Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <!-- Include auth.js after Firebase SDKs -->
    <script src="js/auth.js"></script>
</head>
<body>
    <header>
        <nav class="menu-bar">
            <ul class="menu-left">
                <li><a href="login.html">Home</a></li>
                <li class="dropdown">
                    <a href="#">Risk Management</a>
                    <div class="dropdown-content">
                        <a href="riskassessment.html">Risk Assessment</a>
                        <a href="jsaboard.html">Job Safety Analysis</a>
                    </div>
                </li>
                <li class="dropdown">
                    <a href="#">Safety reporting</a>
                    <div class="dropdown-content">
                        <a href="eventboard.html">Event</a>
                        <a href="inspectionsboard.html">Inspections</a>
                    </div>
                </li>
                <li class="dropdown">
                    <a href="#">Settings</a>
                    <div class="dropdown-content">
                        <a href="account.html">User account</a>
                        <a href="setup.html">Inspections</a>
                        <a href="log.html">System audit log</a>
                    </div>
                </li>
                <li><a href="dashboard.html">Dashboard</a></li>
            </ul>
            <ul class="menu-right">
                <!-- Add Notification Bell -->
                <li class="notification-bell-container" id="notificationBellContainer">
                    <div class="notification-bell" id="notificationBell">
                        <svg class="bell-icon-svg" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                        <span class="notification-counter" id="notificationCounter" style="display: none;">0</span>
                    </div>
                    <div class="notification-dropdown" id="notificationDropdown">
                        <div class="notification-header">
                            <h4>Notifications</h4>
                            <div class="notification-header-actions">
                                <button id="markAllReadBtn">Mark all as read</button>
                            </div>
                        </div>
                        <div class="notification-list" id="notificationList">
                            <div class="notification-empty">No new notifications</div>
                        </div>
                    </div>
                </li>
                
                <!-- User Avatar Button -->
                <li class="user-avatar-container">
                    <div id="userAvatarContainer">
                        <img src="https://via.placeholder.com/32" alt="User" class="user-avatar" id="userAvatar" style="display: none;">
                        <div id="userInitial" class="user-initial">?</div>
                    </div>
                    <div class="user-dropdown">
                        <div class="user-email" id="userEmail">Not logged in</div>
                        <a href="profile.html" id="profileLink" style="display: none;">My Profile</a>
                        <a href="#" id="logoutButton" style="display: none;">Log Out</a>
                        <a href="login.html" id="loginButton">Log In</a>
                    </div>
                </li>
            </ul>
        </nav>
    </header>

    <main class="ptw-container">
        <div class="ptw-header">
            <div class="ptw-title">
                <h2>Training Request Application</h2>
                <p>Complete this form to request training for yourself or your team members</p>
            </div>
        </div>

        <form id="trainingRequestForm" class="ptw-form">
            <!-- Training Type Selection -->
            <div class="form-section">
                <h3>Training Type</h3>
                <p>Select the type of training required:</p>
                <div class="permit-type-selector">
                    <div class="permit-type" data-type="health-safety">
                        <div class="permit-type-icon">üõ°Ô∏è</div>
                        <div class="permit-type-name">Health & Safety</div>
                        <div class="permit-type-desc">HSE regulations, first aid, emergency procedures</div>
                    </div>
                    <div class="permit-type" data-type="technical">
                        <div class="permit-type-icon">üîß</div>
                        <div class="permit-type-name">Technical Skills</div>
                        <div class="permit-type-desc">Software, equipment, machinery operation</div>
                    </div>
                    <div class="permit-type" data-type="soft-skills">
                        <div class="permit-type-icon">üó£Ô∏è</div>
                        <div class="permit-type-name">Soft Skills</div>
                        <div class="permit-type-desc">Communication, leadership, team building</div>
                    </div>
                    <div class="permit-type" data-type="compliance">
                        <div class="permit-type-icon">üìã</div>
                        <div class="permit-type-name">Compliance</div>
                        <div class="permit-type-desc">Legal requirements, certifications, standards</div>
                    </div>
                </div>
                <input type="hidden" id="trainingType" name="trainingType" required>
                <div class="invalid-feedback">Please select a training type</div>
            </div>

            <!-- Training Request Details -->
            <div class="form-section">
                <h3>Training Details</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="trainingTitle" class="required">Training Title</label>
                        <input type="text" class="form-control" id="trainingTitle" name="trainingTitle" required placeholder="Brief title for the training">
                        <div class="invalid-feedback">Please provide a training title</div>
                    </div>
                    <div class="form-group">
                        <label for="department" class="required">Department</label>
                        <input type="text" class="form-control" id="department" name="department" required placeholder="Department requesting the training">
                        <div class="invalid-feedback">Please provide a department</div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="trainingDescription" class="required">Description of Training Needs</label>
                        <textarea class="form-control" id="trainingDescription" name="trainingDescription" rows="4" required placeholder="Detailed description of the training requirements and objectives"></textarea>
                        <div class="invalid-feedback">Please describe the training needs</div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="trainingJustification" class="required">Business Justification</label>
                        <textarea class="form-control" id="trainingJustification" name="trainingJustification" rows="3" required placeholder="Explain how this training will benefit the business"></textarea>
                        <div class="invalid-feedback">Please provide business justification</div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="preferredDate" class="required">Preferred Start Date</label>
                        <input type="date" class="form-control" id="preferredDate" name="preferredDate" required>
                        <div class="invalid-feedback">Please provide a preferred date</div>
                    </div>
                    <div class="form-group">
                        <label for="duration">Duration (Days)</label>
                        <input type="number" class="form-control" id="duration" name="duration" min="0.5" step="0.5" placeholder="Number of training days">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="location">Preferred Location</label>
                        <select class="form-control" id="location" name="location">
                            <option value="">Select location...</option>
                            <option value="onsite">Onsite</option>
                            <option value="offsite">Offsite</option>
                            <option value="virtual">Virtual/Online</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="budget" class="required">Estimated Budget</label>
                        <input type="number" class="form-control" id="budget" name="budget" required placeholder="Estimated training cost">
                        <div class="invalid-feedback">Please provide an estimated budget</div>
                    </div>
                </div>
            </div>

            <!-- Participants Information -->
            <div class="form-section">
                <h3>Participants Information</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="numberOfParticipants" class="required">Number of Participants</label>
                        <input type="number" class="form-control" id="numberOfParticipants" name="numberOfParticipants" min="1" required>
                        <div class="invalid-feedback">Please specify the number of participants</div>
                    </div>
                    <div class="form-group">
                        <label for="targetAudience" class="required">Target Audience</label>
                        <input type="text" class="form-control" id="targetAudience" name="targetAudience" required placeholder="Job roles or teams requiring this training">
                        <div class="invalid-feedback">Please specify the target audience</div>
                    </div>
                </div>
                
                <div id="participantsContainer" class="nested-section">
                    <div class="nested-item" data-index="0">
                        <div class="form-group">
                            <label for="participant-0">Participant Name</label>
                            <input type="text" class="form-control" id="participant-0" name="participants[0].name" placeholder="Full name">
                        </div>
                        <div class="form-group">
                            <label for="participantEmail-0">Email</label>
                            <input type="email" class="form-control" id="participantEmail-0" name="participants[0].email" placeholder="Email address">
                        </div>
                        <div class="nested-item-controls">
                            <button type="button" class="btn btn-danger btn-remove" onclick="removeParticipant(0)">-</button>
                        </div>
                    </div>
                </div>
                <div style="text-align: right; margin-top: 10px;">
                    <button type="button" class="btn btn-success btn-add" onclick="addParticipant()">+</button>
                </div>
            </div>

            <!-- Training-Specific Requirements -->
            <div id="trainingSpecificSection" class="form-section" style="display:none;">
                <h3 id="trainingSpecificTitle">Training-Specific Requirements</h3>
                <div id="trainingSpecificContent">
                    <!-- Content will be loaded dynamically -->
                </div>
            </div>

            <!-- Approvals -->
            <div class="form-section">
                <h3>Request Authorization</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="requestorName" class="required">Requestor Name</label>
                        <input type="text" class="form-control" id="requestorName" name="requestorName" required placeholder="Your name">
                        <div class="invalid-feedback">Please provide your name</div>
                    </div>
                    <div class="form-group">
                        <label for="requestorPosition" class="required">Position</label>
                        <input type="text" class="form-control" id="requestorPosition" name="requestorPosition" required placeholder="Your position">
                        <div class="invalid-feedback">Please provide your position</div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="managerName" class="required">Line Manager Name</label>
                        <input type="text" class="form-control" id="managerName" name="managerName" required placeholder="Name of approving manager">
                        <div class="invalid-feedback">Please provide manager name</div>
                    </div>
                    <div class="form-group">
                        <label for="managerEmail" class="required">Manager Email</label>
                        <input type="email" class="form-control" id="managerEmail" name="managerEmail" required placeholder="Manager's email">
                        <div class="invalid-feedback">Please provide manager email</div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="additionalComments">Additional Comments</label>
                        <textarea class="form-control" id="additionalComments" name="additionalComments" rows="3" placeholder="Any additional information or special considerations"></textarea>
                    </div>
                </div>
            </div>

            <!-- Declaration -->
            <div class="form-section">
                <h3>Declaration</h3>
                <div class="checkbox-item">
                    <input type="checkbox" id="declaration" name="declaration" required>
                    <label for="declaration" class="required">I confirm that the information provided is accurate and the training requested aligns with department/company objectives.</label>
                    <div class="invalid-feedback">You must agree to the declaration</div>
                </div>
            </div>

            <!-- Submit Buttons -->
            <div class="form-buttons">
                <button type="button" class="btn" id="saveDraftBtn">Save Draft</button>
                <button type="submit" class="btn btn-success">Submit for Approval</button>
            </div>
        </form>
    </main>

    <script>
        // Initialize Firebase with error handling
        let database;
        let auth;
        let currentUser;
        let participantCount = 1;

        function initializeFirebase() {
            const firebaseConfig = {
                apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
                authDomain: "users-8be65.firebaseapp.com",
                databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
                projectId: "users-8be65",
                storageBucket: "users-8be65.appspot.com",
                messagingSenderId: "829083030831",
                appId: "1:829083030831:web:36a370e62691e560bc3dda"
            };
            
            // Check if Firebase is already initialized
            if (firebase.apps.length === 0) {
                console.log("Initializing Firebase");
                firebase.initializeApp(firebaseConfig);
            } else {
                console.log("Firebase already initialized");
            }
            
            database = firebase.database();
            auth = firebase.auth();
            
            // Force browser to persist auth state
            return auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                .then(() => console.log("Firebase persistence set to LOCAL"))
                .catch(error => console.error("Firebase persistence error:", error));
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM loaded, setting up Training Request form");
            
            // Initialize Firebase
            initializeFirebase().then(() => {
                // Check authentication state
                auth.onAuthStateChanged(user => {
                    if (user) {
                        console.log("User authenticated:", user.email);
                        currentUser = user;
                        updateUserDisplay(user);
                        
                        // Check if we're editing an existing training request
                        const urlParams = new URLSearchParams(window.location.search);
                        const editRequestId = urlParams.get('edit');
                        
                        if (editRequestId) {
                            // We're in edit mode, load the training request data
                            loadTrainingRequestForEditing(editRequestId);
                        } else {
                            // New training request mode
                            prefillUserData(user);
                        }
                        
                        // Set up form event listeners
                        setupFormListeners();
                    } else {
                        console.log("Not authenticated, redirecting to login page");
                        window.location.href = "login.html?redirect=" + encodeURIComponent(window.location.pathname);
                    }
                });
            }).catch(error => {
                console.error("Firebase initialization failed:", error);
                showError("Failed to initialize Firebase. Please try again later.");
            });
            
            // Set up training type selection
            setupTrainingTypeSelection();

            // Position the user dropdown correctly
            const avatarContainer = document.querySelector('.user-avatar-container');
            const userDropdownElement = document.querySelector('.user-dropdown');
            const notificationBell = document.getElementById('notificationBell');
            const notificationDropdown = document.getElementById('notificationDropdown');
            
            // Setup position calculation functions
            avatarContainer.addEventListener('mouseenter', positionUserDropdown);
            notificationBell.addEventListener('mouseenter', positionNotificationDropdown);
            window.addEventListener('resize', function() {
                positionUserDropdown();
                positionNotificationDropdown();
            });
            
            function positionUserDropdown() {
                if (!userDropdown || !avatarContainer) return;
                
                const rect = avatarContainer.getBoundingClientRect();
                
                // First position at the default location
                userDropdown.style.top = (rect.bottom + 5) + 'px';
                userDropdown.style.right = (window.innerWidth - rect.right) + 'px';
                
                // After positioning, check if it goes off-screen
                setTimeout(() => {
                    const dropdownRect = userDropdown.getBoundingClientRect();
                    
                    // Check if dropdown extends beyond the viewport
                    if (dropdownRect.right > window.innerWidth) {
                        // Adjust position to fit within viewport
                        userDropdown.style.right = '5px';
                    }
                    
                    if (dropdownRect.bottom > window.innerHeight) {
                        // Adjust height to fit within viewport or position above
                        if (rect.top > dropdownRect.height + 10) {
                            // There's enough space above, position there
                            userDropdown.style.top = 'auto';
                            userDropdown.style.bottom = (window.innerHeight - rect.top + 5) + 'px';
                        } else {
                            // Not enough space above, reduce height to fit
                            const newHeight = window.innerHeight - dropdownRect.top - 10;
                            userDropdown.style.maxHeight = newHeight + 'px';
                        }
                    }
                }, 0);
            }
            
            function positionNotificationDropdown() {
                if (!notificationDropdown || !notificationBell) return;
                
                const rect = notificationBell.getBoundingClientRect();
                
                // First position at the default location
                notificationDropdown.style.top = (rect.bottom + 5) + 'px';
                notificationDropdown.style.right = (window.innerWidth - rect.right - 15) + 'px';
                
                // After positioning, check if it goes off-screen
                setTimeout(() => {
                    const dropdownRect = notificationDropdown.getBoundingClientRect();
                    
                    // Check if dropdown extends beyond the viewport
                    if (dropdownRect.right > window.innerWidth) {
                        // Adjust position to fit within viewport
                        notificationDropdown.style.right = '5px';
                    }
                    
                    if (dropdownRect.bottom > window.innerHeight) {
                        // Adjust height to fit within viewport
                        const newHeight = window.innerHeight - dropdownRect.top - 10;
                        notificationDropdown.style.maxHeight = newHeight + 'px';
                    }
                }, 0);
            }

            // Setup user avatar dropdown toggle functionality
            const userAvatarContainer = document.getElementById('userAvatarContainer');
            const userDropdown = document.querySelector('.user-dropdown');
            
            if (userAvatarContainer && userDropdown) {
                // Toggle dropdown when clicking the avatar
                userAvatarContainer.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent event from bubbling up
                    userDropdown.classList.toggle('show');
                    console.log('Avatar clicked, dropdown visible:', userDropdown.classList.contains('show'));
                });
                
                // Close dropdown when clicking anywhere else
                document.addEventListener('click', function(e) {
                    if (userDropdown.classList.contains('show')) {
                        userDropdown.classList.remove('show');
                        console.log('Document clicked, closing dropdown');
                    }
                });
                
                // Prevent clicks inside dropdown from closing it
                userDropdown.addEventListener('click', function(e) {
                    e.stopPropagation();
                    console.log('Click inside dropdown, preventing propagation');
                });
            } else {
                console.error('User avatar or dropdown elements not found:', 
                              'userAvatarContainer:', userAvatarContainer, 
                              'userDropdown:', userDropdown);
            }
        });

        // Update function names and logic for training request 
        function updateUserDisplay(user) {
            // Update user email in dropdown
            document.getElementById('userEmail').textContent = user.email || "Not logged in";
            
            // Show logout button and hide login button
            document.getElementById('profileLink').style.display = 'block';
            document.getElementById('accountLink').style.display = 'block';
            document.getElementById('logoutButton').style.display = 'block';
            document.getElementById('loginButton').style.display = 'none';
            
            // Update user avatar/initial
            const userInitial = document.getElementById('userInitial');
            const userAvatar = document.getElementById('userAvatar');
            
            // Get user data from Firebase
            database.ref(`users/${user.uid}`).once('value')
                .then(snapshot => {
                    const userData = snapshot.val() || {};
                    if (userData.profileImage) {
                        // Show profile image
                        userAvatar.src = userData.profileImage;
                        userAvatar.style.display = 'block';
                        userInitial.style.display = 'none';
                    } else {
                        // Show initial
                        userInitial.textContent = getUserInitial(user);
                        userInitial.style.display = 'flex';
                        userAvatar.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error("Error fetching user data:", error);
                });
        }

        function getUserInitial(user) {
            if (!user || !user.email) return '?';
            return user.email.charAt(0).toUpperCase();
        }

        // Prefill user data in the form
        function prefillUserData(user) {
            database.ref(`users/${user.uid}`).once('value')
                .then(snapshot => {
                    const userData = snapshot.val() || {};
                    
                    // Prefill requestor name if available
                    if (userData.displayName) {
                        document.getElementById('requestorName').value = userData.displayName;
                    }

                    if (userData.position) {
                        document.getElementById('requestorPosition').value = userData.position;
                    }
                    
                    // Set default date (today)
                    const now = new Date();
                    
                    // Format date for date input (YYYY-MM-DD)
                    const formatDate = (date) => {
                        return date.toISOString().split('T')[0];
                    };
                    
                    document.getElementById('preferredDate').value = formatDate(now);
                })
                .catch(error => {
                    console.error("Error prefilling user data:", error);
                });
        }

        // Set up training type selection functionality
        function setupTrainingTypeSelection() {
            const trainingTypes = document.querySelectorAll('.permit-type');
            
            trainingTypes.forEach(type => {
                type.addEventListener('click', () => {
                    // Remove selected class from all types
                    trainingTypes.forEach(t => t.classList.remove('selected'));
                    
                    // Add selected class to clicked type
                    type.classList.add('selected');
                    
                    // Update hidden input value
                    const trainingTypeValue = type.getAttribute('data-type');
                    document.getElementById('trainingType').value = trainingTypeValue;
                    
                    // Show training-specific section
                    loadTrainingSpecificContent(trainingTypeValue);
                });
            });
        }

        // Load content specific to the selected training type
        function loadTrainingSpecificContent(trainingType) {
            const trainingSpecificSection = document.getElementById('trainingSpecificSection');
            const trainingSpecificTitle = document.getElementById('trainingSpecificTitle');
            const trainingSpecificContent = document.getElementById('trainingSpecificContent');
            
            // Show the section
            trainingSpecificSection.style.display = 'block';
            
            // Set title and content based on training type
            switch (trainingType) {
                case 'health-safety':
                    trainingSpecificTitle.textContent = 'Health & Safety Training Details';
                    trainingSpecificContent.innerHTML = `
                        <div class="form-row">
                            <div class="form-group">
                                <label for="certificationRequired">Certification Required</label>
                                <select class="form-control" id="certificationRequired" name="trainingSpecific.certificationRequired">
                                    <option value="">Select...</option>
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="certificationLevel">Certification Level/Type</label>
                                <input type="text" class="form-control" id="certificationLevel" name="trainingSpecific.certificationLevel" placeholder="e.g., First Aid Level 2, Fire Warden">
                            </div>
                        </div>
                        <div class="checkbox-group">
                            <p><strong>Training Areas:</strong></p>
                            <div class="form-row">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="hs-area-1" name="trainingSpecific.areas" value="first-aid">
                                    <label for="hs-area-1">First Aid</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="hs-area-2" name="trainingSpecific.areas" value="fire-safety">
                                    <label for="hs-area-2">Fire Safety</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="hs-area-3" name="trainingSpecific.areas" value="manual-handling">
                                    <label for="hs-area-3">Manual Handling</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="hs-area-4" name="trainingSpecific.areas" value="hazardous-materials">
                                    <label for="hs-area-4">Hazardous Materials</label>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'technical':
                    trainingSpecificTitle.textContent = 'Technical Training Details';
                    trainingSpecificContent.innerHTML = `
                        <div class="form-row">
                            <div class="form-group">
                                <label for="skillLevel">Current Skill Level</label>
                                <select class="form-control" id="skillLevel" name="trainingSpecific.skillLevel">
                                    <option value="">Select...</option>
                                    <option value="beginner">Beginner - No knowledge</option>
                                    <option value="basic">Basic - Fundamental awareness</option>
                                    <option value="intermediate">Intermediate - Practical application</option>
                                    <option value="advanced">Advanced - Seeking deeper knowledge</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="trainingProvider">Preferred Training Provider</label>
                                <input type="text" class="form-control" id="trainingProvider" name="trainingSpecific.trainingProvider" placeholder="Specific vendor or training company if known">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="softwareHardware">Software/Hardware Details</label>
                                <textarea class="form-control" id="softwareHardware" name="trainingSpecific.softwareHardware" rows="3" placeholder="Specify the software/hardware/equipment that training is required for"></textarea>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'soft-skills':
                    trainingSpecificTitle.textContent = 'Soft Skills Training Details';
                    trainingSpecificContent.innerHTML = `
                        <div class="form-row">
                            <div class="form-group">
                                <label for="deliveryFormat">Preferred Delivery Format</label>
                                <select class="form-control" id="deliveryFormat" name="trainingSpecific.deliveryFormat">
                                    <option value="">Select...</option>
                                    <option value="workshop">Interactive Workshop</option>
                                    <option value="seminar">Seminar/Presentation</option>
                                    <option value="coaching">One-on-One Coaching</option>
                                    <option value="role-play">Role-playing Exercises</option>
                                    <option value="online">Online Self-paced</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="assessmentRequired">Assessment Required</label>
                                <select class="form-control" id="assessmentRequired" name="trainingSpecific.assessmentRequired">
                                    <option value="">Select...</option>
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                            </div>
                        </div>
                        <div class="checkbox-group">
                            <p><strong>Primary Focus Areas:</strong></p>
                            <div class="form-row">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="ss-area-1" name="trainingSpecific.focusAreas" value="communication">
                                    <label for="ss-area-1">Communication</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="ss-area-2" name="trainingSpecific.focusAreas" value="leadership">
                                    <label for="ss-area-2">Leadership</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="ss-area-3" name="trainingSpecific.focusAreas" value="team-building">
                                    <label for="ss-area-3">Team Building</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="ss-area-4" name="trainingSpecific.focusAreas" value="conflict-resolution">
                                    <label for="ss-area-4">Conflict Resolution</label>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'compliance':
                    trainingSpecificTitle.textContent = 'Compliance Training Details';
                    trainingSpecificContent.innerHTML = `
                        <div class="form-row">
                            <div class="form-group">
                                <label for="complianceType">Compliance Type</label>
                                <select class="form-control" id="complianceType" name="trainingSpecific.complianceType">
                                    <option value="">Select...</option>
                                    <option value="regulatory">Regulatory Requirement</option>
                                    <option value="industry">Industry Standard</option>
                                    <option value="internal">Internal Policy</option>
                                    <option value="certification">Professional Certification</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="urgencyLevel">Urgency Level</label>
                                <select class="form-control" id="urgencyLevel" name="trainingSpecific.urgencyLevel">
                                    <option value="low">Low - For future compliance</option>
                                    <option value="medium">Medium - Required within 3 months</option>
                                    <option value="high">High - Required within 1 month</option>
                                    <option value="critical">Critical - Immediate requirement</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="regulationReference">Regulation/Standard Reference</label>
                                <input type="text" class="form-control" id="regulationReference" name="trainingSpecific.regulationReference" placeholder="Reference to the specific regulation or standard">
                            </div>
                            <div class="form-group">
                                <label for="expiryDate">Current Certification Expiry Date</label>
                                <input type="date" class="form-control" id="expiryDate" name="trainingSpecific.expiryDate">
                            </div>
                        </div>
                    `;
                    break;
                    
                default:
                    trainingSpecificSection.style.display = 'none';
                    break;
            }
        }

        // Add more participants dynamically
        function addParticipant() {
            const participantsContainer = document.getElementById('participantsContainer');
            const newIndex = participantCount++;
            
            const participantItem = document.createElement('div');
            participantItem.className = 'nested-item';
            participantItem.setAttribute('data-index', newIndex);
            
            participantItem.innerHTML = `
                <div class="form-group">
                    <label for="participant-${newIndex}">Participant Name</label>
                    <input type="text" class="form-control" id="participant-${newIndex}" name="participants[${newIndex}].name" placeholder="Full name">
                </div>
                <div class="form-group">
                    <label for="participantEmail-${newIndex}">Email</label>
                    <input type="email" class="form-control" id="participantEmail-${newIndex}" name="participants[${newIndex}].email" placeholder="Email address">
                </div>
                <div class="nested-item-controls">
                    <button type="button" class="btn btn-danger btn-remove" onclick="removeParticipant(${newIndex})">-</button>
                </div>
            `;
            
            participantsContainer.appendChild(participantItem);
        }

        // Remove a participant
        function removeParticipant(index) {
            const participantItem = document.querySelector(`.nested-item[data-index="${index}"]`);
            if (participantItem && document.querySelectorAll('.nested-item').length > 1) {
                participantItem.remove();
            }
        }

        // Set up form event listeners
        function setupFormListeners() {
            const form = document.getElementById('trainingRequestForm');
            const saveDraftBtn = document.getElementById('saveDraftBtn');
            
            // Save draft button
            saveDraftBtn.addEventListener('click', () => {
                saveTrainingRequest('draft');
            });
            
            // Form submission
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                if (validateForm()) {
                    saveTrainingRequest('pending');
                }
            });
            
            // Logout button
            document.getElementById('logoutButton').addEventListener('click', function(e) {
                e.preventDefault();
                auth.signOut().then(() => {
                    window.location.href = "login.html";
                }).catch(error => {
                    console.error("Error during logout:", error);
                });
            });
        }

        // Form validation
        function validateForm() {
            const form = document.getElementById('trainingRequestForm');
            let isValid = true;
            
            // Check all required inputs
            const requiredInputs = form.querySelectorAll('[required]');
            requiredInputs.forEach(input => {
                if (!input.value.trim()) {
                    input.classList.add('is-invalid');
                    isValid = false;
                } else {
                    input.classList.remove('is-invalid');
                }
            });
            
            // Check training type is selected
            const trainingType = document.getElementById('trainingType');
            if (!trainingType.value) {
                trainingType.classList.add('is-invalid');
                isValid = false;
                alert("Please select a training type");
            }
            
            // Check declaration checkbox
            const declaration = document.getElementById('declaration');
            if (!declaration.checked) {
                declaration.classList.add('is-invalid');
                isValid = false;
                alert("You must agree to the declaration");
            }
            
            return isValid;
        }

        // Save training request to Firebase
        function saveTrainingRequest(status) {
            if (!currentUser) {
                alert("You must be logged in to submit a training request");
                return;
            }
            
            console.log("Saving training request with status:", status);
            
            // Check if we're editing an existing request
            const form = document.getElementById('trainingRequestForm');
            const existingRequestId = form.getAttribute('data-request-id');
            const isEditing = Boolean(existingRequestId);
            
            // Collect form data
            const formData = new FormData(form);
            const requestData = {};
            
            // Create structure to hold participants properly
            requestData.participants = [];
            const participantItems = {};
            
            formData.forEach((value, key) => {
                // Special handling for participants to avoid bracket notation
                if (key.includes('participants[')) {
                    const match = key.match(/participants\[(\d+)\]\.(.+)/);
                    if (match) {
                        const [, index, prop] = match;
                        if (!participantItems[index]) {
                            participantItems[index] = {};
                        }
                        participantItems[index][prop] = value;
                    }
                }
                // Handle other nested properties (using dot notation)
                else if (key.includes('.')) {
                    const parts = key.split('.');
                    if (!requestData[parts[0]]) {
                        requestData[parts[0]] = {};
                    }
                    requestData[parts[0]][parts[1]] = value;
                } 
                // Handle checkboxes (multiple values with same name)
                else if (key === 'ppe') {
                    if (!requestData[key]) {
                        requestData[key] = [];
                    }
                    requestData[key].push(value);
                }
                // Handle other fields
                else {
                    requestData[key] = value;
                }
            });
            
            // Convert participant items object to array
            Object.keys(participantItems).forEach(index => {
                if (participantItems[index].name || participantItems[index].email) {
                    requestData.participants.push({
                        name: participantItems[index].name || '',
                        email: participantItems[index].email || ''
                    });
                }
            });
            
            // Add metadata
            requestData.createdAt = new Date().toISOString();
            requestData.createdBy = currentUser.uid;
            requestData.createdByEmail = currentUser.email;
            requestData.status = status;
            requestData.lastUpdatedAt = new Date().toISOString();
            
            console.log("Training request data prepared:", requestData);
            
            try {
                // Create a reference based on whether we're editing or creating new
                let requestRef;
                let actionMessage;
                
                if (isEditing) {
                    requestRef = database.ref(`trainingRequests/${existingRequestId}`);
                    actionMessage = status === 'draft' ? "Training request updated as draft" : "Training request updated and submitted for approval";
                } else {
                    requestRef = database.ref('trainingRequests').push();
                    actionMessage = status === 'draft' ? "Training request saved as draft" : "Training request submitted successfully for approval";
                }
                
                console.log(`${isEditing ? 'Updating' : 'Creating'} request, attempting to save data...`);
                
                // Set or update the data
                requestRef.update(requestData)
                    .then(() => {
                        console.log("Training request saved successfully");
                        alert(actionMessage);
                        // Redirect to board page
                        window.location.href = "trainingboard.html";
                    })
                    .catch(error => {
                        console.error("Firebase error saving request:", error);
                        alert("Failed to save request: " + error.message);
                    });
            } catch (error) {
                console.error("Exception while saving training request:", error);
                alert("An error occurred while saving the training request: " + error.message);
            }
        }

        // Load training request for editing
        function loadTrainingRequestForEditing(requestId) {
            console.log("Loading training request for editing:", requestId);
            
            // Update the UI to show we're in edit mode
            document.querySelector('.ptw-title h2').textContent = "Edit Training Request";
            
            // Get the training request data from Firebase
            database.ref(`trainingRequests/${requestId}`).once('value')
                .then(snapshot => {
                    const requestData = snapshot.val();
                    
                    if (!requestData) {
                        alert("Training request not found");
                        window.location.href = "trainingboard.html";
                        return;
                    }
                    
                    console.log("Loaded training request data:", requestData);
                    
                    // Store the original request ID for updating later
                    document.getElementById('trainingRequestForm').setAttribute('data-request-id', requestId);
                    
                    // Populate form fields with request data
                    populateFormWithRequestData(requestData);
                })
                .catch(error => {
                    console.error("Error loading training request:", error);
                    alert("Failed to load training request: " + error.message);
                });
        }

        // Populate form with training request data
        function populateFormWithRequestData(requestData) {
            // Select the training type
            if (requestData.trainingType) {
                const trainingTypeElement = document.querySelector(`.permit-type[data-type="${requestData.trainingType}"]`);
                if (trainingTypeElement) {
                    document.querySelectorAll('.permit-type').forEach(el => el.classList.remove('selected'));
                    trainingTypeElement.classList.add('selected');
                    document.getElementById('trainingType').value = requestData.trainingType;
                    
                    // Load training-specific content
                    loadTrainingSpecificContent(requestData.trainingType);
                }
            }
            
            // Populate basic fields
            const fieldsToPopulate = [
                'trainingTitle', 'department', 'trainingDescription', 'trainingJustification',
                'preferredDate', 'duration', 'location', 'budget',
                'numberOfParticipants', 'targetAudience', 'requestorName', 
                'requestorPosition', 'managerName', 'managerEmail', 'additionalComments'
            ];
            
            fieldsToPopulate.forEach(field => {
                if (requestData[field]) {
                    const element = document.getElementById(field);
                    if (element) {
                        element.value = requestData[field];
                    }
                }
            });
            
            // Handle participants (clear existing and add from data)
            if (requestData.participants && Array.isArray(requestData.participants)) {
                // Clear existing participants except the first one
                const participantsContainer = document.getElementById('participantsContainer');
                const existingParticipants = document.querySelectorAll('.nested-item');
                for (let i = 1; i < existingParticipants.length; i++) {
                    existingParticipants[i].remove();
                }
                
                // Reset participant counter
                participantCount = 1;
                
                // Clear first participant inputs
                document.getElementById('participant-0').value = '';
                document.getElementById('participantEmail-0').value = '';
                
                // Add participants from request data
                requestData.participants.forEach((participant, index) => {
                    if (index === 0) {
                        // Use the existing first participant row
                        document.getElementById('participant-0').value = participant.name || '';
                        document.getElementById('participantEmail-0').value = participant.email || '';
                    } else {
                        // Add new participant rows for the rest
                        addParticipant();
                        document.getElementById(`participant-${participantCount-1}`).value = participant.name || '';
                        document.getElementById(`participantEmail-${participantCount-1}`).value = participant.email || '';
                    }
                });
            }
            
            // Handle training-specific fields after a short delay to ensure content is loaded
            setTimeout(() => {
                if (requestData.trainingSpecific) {
                    const specificData = requestData.trainingSpecific;
                    
                    // Populate based on training type
                    switch (requestData.trainingType) {
                        case 'health-safety':
                            populateSelect('certificationRequired', specificData.certificationRequired);
                            populateField('certificationLevel', specificData.certificationLevel);
                            populateCheckboxes('trainingSpecific.areas', specificData.areas);
                            break;
                        
                        case 'technical':
                            populateSelect('skillLevel', specificData.skillLevel);
                            populateField('trainingProvider', specificData.trainingProvider);
                            populateField('softwareHardware', specificData.softwareHardware);
                            break;
                        
                        case 'soft-skills':
                            populateSelect('deliveryFormat', specificData.deliveryFormat);
                            populateSelect('assessmentRequired', specificData.assessmentRequired);
                            populateCheckboxes('trainingSpecific.focusAreas', specificData.focusAreas);
                            break;
                        
                        case 'compliance':
                            populateSelect('complianceType', specificData.complianceType);
                            populateSelect('urgencyLevel', specificData.urgencyLevel);
                            populateField('regulationReference', specificData.regulationReference);
                            populateField('expiryDate', specificData.expiryDate);
                            break;
                    }
                }
            }, 500); // Give the DOM time to update
            
            // Update form buttons for edit mode
            const formButtons = document.querySelector('.form-buttons');
            formButtons.innerHTML = `
                <button type="button" class="btn" id="saveDraftBtn">Update as Draft</button>
                <button type="submit" class="btn btn-success">Update for Approval</button>
            `;
        }

        // Helper functions for populating form elements
        function populateField(fieldId, value) {
            if (value !== undefined) {
                const field = document.getElementById(fieldId);
                if (field) field.value = value;
            }
        }

        function populateSelect(selectId, value) {
            if (value !== undefined) {
                const select = document.getElementById(selectId);
                if (select) {
                    for (let i = 0; i < select.options.length; i++) {
                        if (select.options[i].value === value) {
                            select.selectedIndex = i;
                            break;
                        }
                    }
                }
            }
        }

        function populateCheckboxes(name, values) {
            if (!values) return;
            
            // Handle both array and single string cases
            const valuesArray = Array.isArray(values) ? values : [values];
            
            document.querySelectorAll(`input[name="${name}"]`).forEach(checkbox => {
                checkbox.checked = valuesArray.includes(checkbox.value);
            });
        }
    </script>
</body>
</html>
