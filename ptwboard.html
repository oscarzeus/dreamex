<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PTW Board - Dreamex Lab</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Main container styles */
        .ptwboard-container {
            max-width: 1800px; /* Increased from 1200px for wider table display */
            margin: 80px auto 30px;
            padding: 30px;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        .ptwboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .ptwboard-title h2 {
            margin: 0;
            color: #34495e;
            text-align: left;
        }

        .ptwboard-title p {
            margin: 5px 0 0;
            color: #7f8c8d;
            font-size: 14px;
            text-align: left;
        }

        /* Filter and search styles */
        .filter-section {
            display: flex;
            align-items: flex-start;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            gap: 15px;
            flex-wrap: nowrap;
            overflow-x: auto;
        }

        /* Add specific margin to the search box to create separation */
        .search-box {
            flex: 1;
            min-width: 200px;
            max-width: none;
            width: 100%;
            margin-right: 53px; /* Added margin to create extra space */
        }

        .filter-group, .search-box {
            flex: 1;
            min-width: 200px;
            max-width: none;
            width: 100%;
        }

        .filter-group label, .search-box label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #34495e;
            font-size: 14px;
            white-space: nowrap;
            text-align: left;
        }

        .filter-control {
            width: 100%;
            height: 28px; /* Further reduced from 32px to 28px */
            padding: 4px 12px; /* Reduced padding from 6px to 4px to maintain proportions */
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fff;
        }

        .search-box input {
            width: 100%;
            height: 19px;  /* Also reduced from 32px to 28px */
            padding: 4px 12px 4px 40px; /* Adjusted padding */
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23888' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 10px center; /* Slightly adjusted icon position for new height */
            background-color: #fff;
        }

        @media (max-width: 768px) {
            .filter-section {
                flex-wrap: wrap;
            }
            
            .filter-group, .search-box {
                min-width: 100%;
                max-width: none;
            }
        }

        /* Permits table styles */
        .permits-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .permits-table th,
        .permits-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .permits-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #34495e;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .permits-table tbody tr:hover {
            background-color: #f1f9ff;
        }

        /* Status indicators */
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            display: inline-block;
            min-width: 80px;
        }

        .status-draft {
            background-color: #f8f9fa;
            color: #495057;
            border: 1px dashed #ced4da;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background-color: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background-color: #f8d7da;
            color: #721c24;
        }

        .status-expired {
            background-color: #e2e3e5;
            color: #383d41;
        }

        /* Actions column styles */
        .action-buttons {
            display: flex;
            gap: 5px; /* Reduced from 8px to fit more buttons */
            flex-wrap: wrap; /* Allow buttons to wrap if needed */
        }

        .btn-action {
            min-width: auto;
            padding: 3px 6px; /* Reduced slightly */
            height: 15px;
            font-size: 11px; /* Reduced from 12px */
            line-height: 1;
        }

        /* Optional: Adjust the table cell padding if needed for better vertical alignment */
        .permits-table td:last-child {
            padding-top: 8px;
            padding-bottom: 8px;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 0;
            color: #7f8c8d;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
            color: #bdc3c7;
        }

        /* Permit details modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 50px auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 1000px; /* Increased from 800px to support the wider container */
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .close-modal {
            color: #aaa;
            position: absolute;
            right: 20px;
            top: 10px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-modal:hover {
            color: #555;
        }

        .modal-header {
            padding-bottom: 15px;
            margin-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .modal-header h3 {
            margin: 0;
            text-align: left;
        }

        .detail-section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .detail-section h4 {
            margin: 0 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
            text-align: left;
        }

        .detail-row {
            display: flex;
            margin-bottom: 10px;
        }

        .detail-label {
            width: 30%;
            font-weight: 600;
            padding-right: 15px;
            text-align: left;
        }

        .detail-value {
            width: 70%;
            text-align: left;
        }

        /* Approve/reject action buttons */
        .approval-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Loading indicator */
        .loading-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-left-color: #3498db;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Button styles */
        .btn {
            height: 40px;
            min-width: 120px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            letter-spacing: 0.3px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 14px;
        }

        .btn:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: #2ecc71;
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        .btn-danger {
            background-color: #e74c3c;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        /* Notification bell and user avatar styles */
        .menu-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* Notification bell styles */
        .notification-bell-container {
            position: relative;
        }

        .notification-bell {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.2s ease;
            position: relative;
        }

        .notification-bell:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .bell-icon-svg {
            width: 20px;
            height: 20px;
            fill: none;
            stroke: #555;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .notification-counter {
            position: absolute;
            top: 0;
            right: 0;
            background-color: #e74c3c;
            color: white;
            font-size: 10px;
            min-width: 16px;
            height: 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .notification-dropdown {
            position: absolute;
            top: 45px;
            right: -10px;
            background-color: white;
            width: 320px;
            max-height: 400px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            display: none;
            z-index: 1000;
        }

        .notification-bell:hover + .notification-dropdown,
        .notification-dropdown:hover {
            display: block;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        .notification-header h4 {
            margin: 0;
            font-size: 16px;
            color: #333;
        }

        .notification-header-actions button {
            background: none;
            border: none;
            color: #3498db;
            font-size: 13px;
            cursor: pointer;
            padding: 3px 6px;
        }

        .notification-list {
            max-height: 350px;
            overflow-y: auto;
        }

        .notification-empty {
            padding: 20px;
            text-align: center;
            color: #7f8c8d;
            font-size: 14px;
        }

        .user-avatar-container {
            position: relative;
            display: flex;
            align-items: center;
            margin-right: 20px;
            cursor: pointer;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .user-dropdown {
            position: absolute;
            top: 45px;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 0;
            min-width: 200px;
            display: none;
            z-index: 1000;
            text-align: left;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.08);
        }

        /* Add class for showing the dropdown */
        .user-dropdown.show {
            display: block;
            animation: dropdown-fade-in 0.2s ease-out;
        }
        
        .user-email {
            padding: 5px 15px; /* Further reduced from 8px to 5px */
            border-bottom: 1px solid #eaeaea;
            color: #34495e;
            font-weight: 500;
            background-color: #f8f9fa;
            font-size: 13px; /* Reduced from 14px to 13px */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .user-dropdown a {
            display: block;
            padding: 2px 15px; /* Further reduced from 4px to 2px */
            color: #000000;
            text-decoration: none;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            font-size: 13px; /* Reduced from 14px to 13px */
            line-height: 1.4; /* Added to provide some minimal spacing */
        }
        
        /* Ensure specific dropdown links are black */
        #profileLink, #accountLink {
            color: #474646 !important; /* Pure black color with !important to override any other styles */
        }
        
        .user-dropdown a:hover {
            background-color: #f1f8fe;
            border-left-color: #3498db;
            color: #3498db;
        }
        
        .user-dropdown a:last-child {
            border-top: 1px solid #eaeaea;
        }
        
        #logoutButton {
            color: #e74c3c; /* Keep logout button red */
        }
        
        #logoutButton:hover {
            background-color: #fdeeee;
            border-left-color: #e74c3c;
        }
        
        #loginButton {
            color: #000000; /* Changed to black */
        }
        
        #loginButton:hover {
            background-color: #f1f8fe;
            border-left-color: #3498db;
            color: #3498db;
        }
        
        .user-initial {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Responsive styles */
        @media (max-width: 992px) {
            .detail-row {
                flex-direction: column;
            }
            
            .detail-label, .detail-value {
                width: 100%;
                padding-right: 0;
            }
            
            .detail-label {
                margin-bottom: 5px;
            }
        }

        @media (max-width: 768px) {
            .permits-table {
                display: block;
                overflow-x: auto;
            }
            
            .filter-section {
                flex-wrap: wrap;
            }
            
            .filter-group, .search-box {
                min-width: 100%;
                max-width: none;
            }
        }

        /* Reduce the size of the row text */
        .permits-table td {
            padding: 8px 12px; /* Reduced padding from 12px 15px */
            font-size: 12px; /* Reduced from default size */
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        /* Actions column styles - modified to ensure all buttons stay on same row */
        .action-buttons {
            display: flex;
            gap: 2px; /* Reduced from 5px to fit better in one row */
            flex-wrap: nowrap; /* Prevent wrapping to ensure all buttons stay in one line */
            justify-content: flex-start;
            white-space: nowrap; /* Prevent button text from wrapping */
        }

        .btn-action {
            min-width: auto;
            padding: 2px 4px; /* Reduced from 3px 6px */
            height: 15px;
            font-size: 10px; /* Reduced from 11px */
            line-height: 1;
        }

        /* Add this to make the actions column wider to fit all buttons */
        .permits-table th:last-child,
        .permits-table td:last-child {
            min-width: 160px; /* Ensure enough width for all buttons */
        }

        /* Make sure buttons don't overflow their container */
        .action-buttons button {
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Add responsive behavior for smaller screens */
        @media (max-width: 1200px) {
            .ptwboard-container {
                max-width: 95%; /* Use percentage width on smaller screens */
                padding: 20px;
            }
        }
        .menu-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #34495e;
            padding: 0 20px;
        }
        
        .menu-bar ul {
            display: flex;
            align-items: center;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .menu-bar ul li {
            margin: 0 10px;
        }
        
        .menu-bar ul li a {
            display: block;
            padding: 15px 10px;
            color: #ecf0f1;
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .menu-bar ul li a:hover {
            color: #f1f3f5;
        }
        
        .menu-bar ul li.current a {
            color: #fafcfd;
            font-weight: bold;
        }

        /* Dropdown styles */
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white !important;
            color: black !important;
            min-width: 160px;
            box-shadow: 0px 8px 16px rgba(0,0,0,0.2);
            z-index: 1;
            top: calc(100%);
            font-size: 6px !important;
            font-weight: normal;
            text-align: left;
        }
        .dropdown-content a {
            color: rgb(44, 43, 43) !important;
            padding: 6px 10px !important;
            text-decoration: none;  
            display: block;
            font-size: 11px !important;
        }
        .dropdown-content a:hover {
            background-color: #e8e8e8;
            transform: none; 
        }
        .dropdown:hover .dropdown-content,
        .dropdown:focus-within .dropdown-content {
            display: block;
        }
    </style>
    <!-- Add Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <!-- Include auth.js after Firebase SDKs -->
    <script src="js/auth.js"></script>
</head>
<body>
    <header>
        <nav class="menu-bar">
            <ul class="menu-left">
                <li><a href="login.html">Home</a></li>
                <li class="dropdown">
                    <a href="#">Risk Management</a>
                    <div class="dropdown-content">
                        <a href="riskassessment.html">Risk Assessment</a>
                        <a href="jsaboard.html">Job Safety Analysis</a>
                    </div>
                </li>
                <li class="dropdown">
                    <a href="#">Safety reporting</a>
                    <div class="dropdown-content">
                        <a href="eventboard.html">Event</a>
                        <a href="inspectionsboard.html">Inspections</a>
                    </div>
                </li>
                <li class="dropdown">
                    <a href="#">Settings</a>
                    <div class="dropdown-content">
                        <a href="account.html">User account</a>
                        <a href="setup.html">Inspections</a>
                        <a href="log.html">System audit log</a>
                    </div>
                </li>
                <li><a href="dashboard.html">Dashboard</a></li>
            </ul>
            <ul class="menu-right">
                <!-- User Avatar Button -->
                <li class="user-avatar-container">
                    <div id="userAvatarContainer">
                        <img src="https://via.placeholder.com/32" alt="User" class="user-avatar" id="userAvatar" style="display: none;">
                        <div id="userInitial" class="user-initial">?</div>
                    </div>
                    <div class="user-dropdown">
                        <div class="user-email" id="userEmail">Not logged in</div>
                        <a href="profile.html" id="profileLink" style="display: none;">My Profile</a>
                        <a href="#" id="logoutButton" style="display: none;">Log Out</a>
                        <a href="login.html" id="loginButton">Log In</a>
                    </div>
                </li>
            </ul>
        </nav>
    </header>

    <main class="ptwboard-container">
        <div class="ptwboard-header">
            <div class="ptwboard-title">
                <h2>Permit to Work Board</h2>
                <p>View and manage all permit to work applications</p>
            </div>
            <a href="ptw.html" class="btn">Create New Permit</a>
        </div>

        <!-- Filters -->
        <div class="filter-section">
            <div class="search-box">
                <label for="searchInput">Search</label>
                <input type="text" id="searchInput" placeholder="Search permits..." class="filter-control">
            </div>
            <div class="filter-group">
                <label for="statusFilter">Status</label>
                <select id="statusFilter" class="filter-control">
                    <option value="">All Statuses</option>
                    <option value="draft">Draft</option>
                    <option value="pending">Pending Approval</option>
                    <option value="approved">Approved</option>
                    <option value="rejected">Rejected</option>
                    <option value="expired">Expired</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="typeFilter">Permit Type</label>
                <select id="typeFilter" class="filter-control">
                    <option value="">All Types</option>
                    <option value="hot-work">Hot Work</option>
                    <option value="confined-space">Confined Space</option>
                    <option value="working-at-height">Working at Height</option>
                    <option value="electrical">Electrical</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="dateFilter">Date Range</label>
                <select id="dateFilter" class="filter-control">
                    <option value="">All Dates</option>
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                </select>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="loading-indicator">
            <div class="spinner"></div>
        </div>

        <!-- Permits Table -->
        <div id="permitsTableContainer" style="display: none;">
            <table class="permits-table">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Type</th>
                        <th>Location</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Requestor</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="permitsTableBody">
                    <!-- Permit rows will be added here dynamically -->
                </tbody>
            </table>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="empty-state-icon">📃</div>
            <h3>No permits found</h3>
            <p>No permits match your search criteria or no permits have been created yet.</p>
            <a href="ptw.html" class="btn" style="margin: 20px auto; display: inline-block;">Create New Permit</a>
        </div>

        <!-- Permit Details Modal -->
        <div id="permitModal" class="modal">
            <div class="modal-content">
                <span class="close-modal" id="closeModal">&times;</span>
                <div class="modal-header">
                    <h3 id="modalTitle">Permit Details</h3>
                </div>
                <div id="modalContent">
                    <!-- Permit details will be loaded here dynamically -->
                </div>
                <div class="approval-actions" id="approvalActions">
                    <button id="rejectPermitBtn" class="btn btn-danger">Reject Permit</button>
                    <button id="approvePermitBtn" class="btn btn-success">Approve Permit</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Initialize Firebase with error handling
        let database;
        let auth;
        let currentUser;
        let permits = [];
        let currentPermit = null;

        function initializeFirebase() {
            const firebaseConfig = {
                apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
                authDomain: "users-8be65.firebaseapp.com",
                databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
                projectId: "users-8be65",
                storageBucket: "users-8be65.appspot.com",
                messagingSenderId: "829083030831",
                appId: "1:829083030831:web:36a370e62691e560bc3dda"
            };
            
            // Check if Firebase is already initialized
            if (firebase.apps.length === 0) {
                console.log("Initializing Firebase");
                firebase.initializeApp(firebaseConfig);
            } else {
                console.log("Firebase already initialized");
            }
            
            database = firebase.database();
            auth = firebase.auth();
            
            // Force browser to persist auth state
            return auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                .then(() => console.log("Firebase persistence set to LOCAL"))
                .catch(error => console.error("Firebase persistence error:", error));
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM loaded, initializing PTW board");
            
            // Initialize Firebase
            initializeFirebase().then(() => {
                // Check authentication state
                auth.onAuthStateChanged(user => {
                    if (user) {
                        console.log("User authenticated:", user.email);
                        currentUser = user;
                        updateUserDisplay(user);
                        
                        // Load permits
                        loadPermits();
                        
                        // Set up event listeners
                        setupEventListeners();
                    } else {
                        console.log("Not authenticated, redirecting to login page");
                        window.location.href = "login.html?redirect=" + encodeURIComponent(window.location.pathname);
                    }
                });
            }).catch(error => {
                console.error("Firebase initialization failed:", error);
                showError("Failed to initialize Firebase. Please try again later.");
            });
        });

        // Helper function to update user display in UI
        function updateUserDisplay(user) {
            // Update user email in dropdown
            document.getElementById('userEmail').textContent = user.email || "Not logged in";
            
            // Show logout button and hide login button
            document.getElementById('profileLink').style.display = 'block';
            document.getElementById('accountLink').style.display = 'block';
            document.getElementById('logoutButton').style.display = 'block';
            document.getElementById('loginButton').style.display = 'none';
            
            // Update user avatar/initial
            const userInitial = document.getElementById('userInitial');
            const userAvatar = document.getElementById('userAvatar');
            
            // Get user data from Firebase
            database.ref(`users/${user.uid}`).once('value')
                .then(snapshot => {
                    const userData = snapshot.val() || {};
                    if (userData.profileImage) {
                        // Show profile image
                        userAvatar.src = userData.profileImage;
                        userAvatar.style.display = 'block';
                        userInitial.style.display = 'none';
                    } else {
                        // Show initial
                        userInitial.textContent = getUserInitial(user);
                        userInitial.style.display = 'flex';
                        userAvatar.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error("Error fetching user data:", error);
                });
        }

        function getUserInitial(user) {
            if (!user || !user.email) return '?';
            return user.email.charAt(0).toUpperCase();
        }

        // Set up event listeners
        function setupEventListeners() {
            // Logout button
            document.getElementById('logoutButton').addEventListener('click', function(e) {
                e.preventDefault();
                auth.signOut().then(() => {
                    window.location.href = "login.html";
                }).catch(error => {
                    console.error("Error during logout:", error);
                });
            });
            
            // Filter event listeners
            document.getElementById('searchInput').addEventListener('input', filterPermits);
            document.getElementById('statusFilter').addEventListener('change', filterPermits);
            document.getElementById('typeFilter').addEventListener('change', filterPermits);
            document.getElementById('dateFilter').addEventListener('change', filterPermits);
            
            // Modal close button
            document.getElementById('closeModal').addEventListener('click', closeModal);
            
            // Approval buttons
            document.getElementById('approvePermitBtn').addEventListener('click', () => updatePermitStatus('approved'));
            document.getElementById('rejectPermitBtn').addEventListener('click', () => updatePermitStatus('rejected'));

            // Add click handler for user avatar dropdown
            const userAvatarContainer = document.getElementById('userAvatarContainer');
            const userDropdown = document.querySelector('.user-dropdown');
            
            if (userAvatarContainer && userDropdown) {
                // Toggle dropdown when clicking the avatar
                userAvatarContainer.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent event from bubbling up
                    userDropdown.classList.toggle('show');
                });
                
                // Close dropdown when clicking anywhere else
                document.addEventListener('click', function(e) {
                    if (userDropdown.classList.contains('show')) {
                        userDropdown.classList.remove('show');
                    }
                });
                
                // Prevent clicks inside dropdown from closing it
                userDropdown.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }
        }

        // Load permits from Firebase
        function loadPermits() {
            const permitsRef = database.ref('permits');
            
            // Show loading indicator
            document.getElementById('loadingIndicator').style.display = 'flex';
            document.getElementById('permitsTableContainer').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
            
            permitsRef.on('value', snapshot => {
                // Hide loading indicator
                document.getElementById('loadingIndicator').style.display = 'none';
                
                const data = snapshot.val();
                
                if (!data) {
                    // Show empty state if no permits exist
                    document.getElementById('emptyState').style.display = 'block';
                    permits = [];
                    return;
                }
                
                // Convert object to array of permits with ID
                permits = Object.entries(data).map(([id, permit]) => ({
                    id,
                    ...permit
                }));
                
                // Check for expired permits and update their status
                checkExpiredPermits();
                
                // Display permits
                displayPermits(permits);
            }, error => {
                console.error("Error loading permits:", error);
                document.getElementById('loadingIndicator').style.display = 'none';
                alert("Error loading permits. Please try again later.");
            });
        }

        // Check for expired permits and update their status
        function checkExpiredPermits() {
            const now = new Date();
            
            permits.forEach(permit => {
                if (permit.status === 'approved' || permit.status === 'pending') {
                    const endDate = new Date(permit.endDate);
                    
                    if (endDate < now) {
                        // Update permit status to expired in Firebase
                        database.ref(`permits/${permit.id}`).update({
                            status: 'expired',
                            lastUpdatedAt: new Date().toISOString()
                        }).catch(error => {
                            console.error("Error updating expired permit:", error);
                        });
                    }
                }
            });
        }

        // Display permits in the table
        function displayPermits(permitsToDisplay) {
            const tableBody = document.getElementById('permitsTableBody');
            tableBody.innerHTML = '';
            
            if (permitsToDisplay.length === 0) {
                // Show empty state
                document.getElementById('permitsTableContainer').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
                return;
            }
            
            // Show table and hide empty state
            document.getElementById('permitsTableContainer').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';
            
            // Sort permits by creation date (newest first)
            permitsToDisplay.sort((a, b) => {
                return new Date(b.createdAt) - new Date(a.createdAt);
            });
            
            permitsToDisplay.forEach(permit => {
                const row = document.createElement('tr');
                
                // Format dates
                const startDate = new Date(permit.startDate).toLocaleDateString();
                const endDate = new Date(permit.endDate).toLocaleDateString();
                
                // Get permit type display name
                const permitTypeMap = {
                    'hot-work': 'Hot Work',
                    'confined-space': 'Confined Space',
                    'working-at-height': 'Working at Height',
                    'electrical': 'Electrical'
                };
                
                const permitTypeDisplay = permitTypeMap[permit.permitType] || permit.permitType;
                
                row.innerHTML = `
                    <td>${permit.workTitle || 'Untitled'}</td>
                    <td>${permitTypeDisplay}</td>
                    <td>${permit.location || 'N/A'}</td>
                    <td>${startDate}</td>
                    <td>${endDate}</td>
                    <td>${permit.requestorName || permit.createdByEmail || 'Unknown'}</td>
                    <td><span class="status-badge status-${permit.status}">${capitalizeFirstLetter(permit.status)}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-action" onclick="viewPermitDetails('${permit.id}')">View</button>
                            <button class="btn btn-action" onclick="editPermit('${permit.id}')">Edit</button>
                            ${permit.status === 'pending' ? `
                                <button class="btn btn-action btn-success" onclick="updatePermitStatus('${permit.id}', 'approved')">Approve</button>
                                <button class="btn btn-action btn-danger" onclick="updatePermitStatus('${permit.id}', 'rejected')">Reject</button>
                            ` : ''}
                        </div>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // Filter permits based on search input and filters
        function filterPermits() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            
            let filteredPermits = permits;
            
            // Filter by search term
            if (searchTerm) {
                filteredPermits = filteredPermits.filter(permit => 
                    (permit.workTitle && permit.workTitle.toLowerCase().includes(searchTerm)) ||
                    (permit.workDescription && permit.workDescription.toLowerCase().includes(searchTerm)) ||
                    (permit.location && permit.location.toLowerCase().includes(searchTerm)) ||
                    (permit.requestorName && permit.requestorName.toLowerCase().includes(searchTerm)) ||
                    (permit.createdByEmail && permit.createdByEmail.toLowerCase().includes(searchTerm))
                );
            }
            
            // Filter by status
            if (statusFilter) {
                filteredPermits = filteredPermits.filter(permit => permit.status === statusFilter);
            }
            
            // Filter by permit type
            if (typeFilter) {
                filteredPermits = filteredPermits.filter(permit => permit.permitType === typeFilter);
            }
            
            // Filter by date range
            if (dateFilter) {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - today.getDay());
                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                
                filteredPermits = filteredPermits.filter(permit => {
                    const startDate = new Date(permit.startDate);
                    
                    if (dateFilter === 'today') {
                        return startDate >= today && startDate < new Date(today.getTime() + 24 * 60 * 60 * 1000);
                    } else if (dateFilter === 'week') {
                        return startDate >= weekStart;
                    } else if (dateFilter === 'month') {
                        return startDate >= monthStart;
                    }
                    
                    return true;
                });
            }
            
            displayPermits(filteredPermits);
        }

        // View permit details
        function viewPermitDetails(permitId) {
            const permit = permits.find(p => p.id === permitId);
            
            if (!permit) {
                alert("Permit not found");
                return;
            }
            
            currentPermit = permit;
            
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            const approvalActions = document.getElementById('approvalActions');
            
            // Set modal title
            modalTitle.textContent = permit.workTitle || 'Untitled Permit';
            
            // Build modal content
            let contentHTML = '';
            
            // Build general information section
            contentHTML += `
                <div class="detail-section">
                    <h4>General Information</h4>
                    <div class="detail-row">
                        <div class="detail-label">Status</div>
                        <div class="detail-value"><span class="status-badge status-${permit.status}">${capitalizeFirstLetter(permit.status)}</span></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Permit Type</div>
                        <div class="detail-value">${getPermitTypeDisplay(permit.permitType)}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Created By</div>
                        <div class="detail-value">${permit.createdByEmail || 'Unknown'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Created Date</div>
                        <div class="detail-value">${new Date(permit.createdAt).toLocaleString()}</div>
                    </div>
                </div>
            `;
            
            // Work details section
            contentHTML += `
                <div class="detail-section">
                    <h4>Work Details</h4>
                    <div class="detail-row">
                        <div class="detail-label">Project Reference</div>
                        <div class="detail-value">${permit.projectName || 'N/A'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Location</div>
                        <div class="detail-value">${permit.location || 'N/A'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Department</div>
                        <div class="detail-value">${permit.department || 'N/A'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Start Date & Time</div>
                        <div class="detail-value">${new Date(permit.startDate).toLocaleString()}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">End Date & Time</div>
                        <div class="detail-value">${new Date(permit.endDate).toLocaleString()}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Description</div>
                        <div class="detail-value">${permit.workDescription || 'No description provided'}</div>
                    </div>
                </div>
            `;
            
            // Hazards and controls section
            contentHTML += `
                <div class="detail-section">
                    <h4>Hazards and Controls</h4>
                    ${permit.hazards && Array.isArray(permit.hazards) && permit.hazards.length > 0 ? 
                        `<table class="permits-table">
                            <thead>
                                <tr>
                                    <th>Hazard</th>
                                    <th>Control Measure</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${permit.hazards.map(hazard => `
                                    <tr>
                                        <td>${hazard.description || 'N/A'}</td>
                                        <td>${hazard.control || 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>` : 
                        '<p>No hazards specified</p>'
                    }
                </div>
            `;
            
            // PPE Requirements section
            contentHTML += `
                <div class="detail-section">
                    <h4>PPE Requirements</h4>
                    ${permit.ppe && Array.isArray(permit.ppe) && permit.ppe.length > 0 ? 
                        `<ul>
                            ${permit.ppe.map(ppe => `<li>${formatPPEName(ppe)}</li>`).join('')}
                        </ul>` : 
                        '<p>No PPE requirements specified</p>'
                    }
                    ${permit.additionalPpe ? `<p><strong>Additional PPE:</strong> ${permit.additionalPpe}</p>` : ''}
                </div>
            `;
            
            // Permit-specific requirements section
            if (permit.permitSpecific) {
                contentHTML += `
                    <div class="detail-section">
                        <h4>${getPermitSpecificTitle(permit.permitType)}</h4>
                        ${renderPermitSpecificDetails(permit.permitType, permit.permitSpecific)}
                    </div>
                `;
            }
            
            // Authorization section
            contentHTML += `
                <div class="detail-section">
                    <h4>Authorization</h4>
                    <div class="detail-row">
                        <div class="detail-label">Requestor Name</div>
                        <div class="detail-value">${permit.requestorName || 'N/A'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Position</div>
                        <div class="detail-value">${permit.requestorPosition || 'N/A'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Supervisor Name</div>
                        <div class="detail-value">${permit.supervisorName || 'N/A'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Supervisor Contact</div>
                        <div class="detail-value">${permit.supervisorContact || 'N/A'}</div>
                    </div>
                    ${permit.additionalComments ? `
                        <div class="detail-row">
                            <div class="detail-label">Additional Comments</div>
                            <div class="detail-value">${permit.additionalComments}</div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            modalContent.innerHTML = contentHTML;
            
            // Show/hide approval actions based on permit status
            if (permit.status === 'pending') {
                approvalActions.style.display = 'flex';
            } else {
                approvalActions.style.display = 'none';
            }
            
            // Show modal
            document.getElementById('permitModal').style.display = 'block';
        }

        // Close the modal
        function closeModal() {
            document.getElementById('permitModal').style.display = 'none';
            currentPermit = null;
        }

        // Update permit status
        function updatePermitStatus(status) {
            if (!currentPermit) {
                alert("No permit selected");
                return;
            }
            
            const permitId = currentPermit.id;
            
            // Confirm action
            if (!confirm(`Are you sure you want to ${status} this permit?`)) {
                return;
            }
            
            // Update permit status in Firebase
            database.ref(`permits/${permitId}`).update({
                status,
                lastUpdatedAt: new Date().toISOString(),
                approvedBy: currentUser.uid,
                approvedByEmail: currentUser.email
            }).then(() => {
                alert(`Permit ${status} successfully`);
                closeModal();
            }).catch(error => {
                console.error("Error updating permit status:", error);
                alert("Error updating permit status. Please try again later.");
            });
        }

        // Helper function to capitalize first letter
        function capitalizeFirstLetter(string) {
            if (!string) return '';
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        // Helper function to get permit type display name
        function getPermitTypeDisplay(permitType) {
            const permitTypeMap = {
                'hot-work': 'Hot Work',
                'confined-space': 'Confined Space', 
                'working-at-height': 'Working at Height',
                'electrical': 'Electrical'
            };
            
            return permitTypeMap[permitType] || permitType;
        }

        // Helper function to format PPE name
        function formatPPEName(ppe) {
            const ppeMap = {
                'safety-helmet': 'Safety Helmet',
                'safety-glasses': 'Safety Glasses',
                'face-shield': 'Face Shield',
                'hearing-protection': 'Hearing Protection',
                'respiratory': 'Respiratory Protection',
                'safety-gloves': 'Safety Gloves',
                'safety-harness': 'Safety Harness',
                'safety-boots': 'Safety Boots'
            };
            
            return ppeMap[ppe] || ppe;
        }

        // Helper function to get permit-specific section title
        function getPermitSpecificTitle(permitType) {
            const titleMap = {
                'hot-work': 'Hot Work Requirements',
                'confined-space': 'Confined Space Requirements',
                'working-at-height': 'Working at Height Requirements',
                'electrical': 'Electrical Work Requirements'
            };
            
            return titleMap[permitType] || 'Permit-Specific Requirements';
        }

        // Helper function to render permit-specific details
        function renderPermitSpecificDetails(permitType, details) {
            if (!details) return '<p>No specific details provided</p>';
            
            let content = '<div>';
            
            switch (permitType) {
                case 'hot-work':
                    content += `
                        <div class="detail-row">
                            <div class="detail-label">Fire Watch Required</div>
                            <div class="detail-value">${capitalizeFirstLetter(details.fireWatchRequired || 'N/A')}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Fire Extinguisher Type</div>
                            <div class="detail-value">${formatFireExtinguisherType(details.fireExtinguisherType) || 'N/A'}</div>
                        </div>
                        ${renderChecklistItems('Pre-work Checks', details.preChecks, {
                            'combustibles-removed': 'Combustible materials removed or protected',
                            'fire-alarm': 'Fire alarm system status confirmed',
                            'ventilation': 'Adequate ventilation confirmed',
                            'equipment-inspected': 'Equipment inspected and in good condition'
                        })}
                    `;
                    break;
                    
                case 'confined-space':
                    content += `
                        <div class="detail-row">
                            <div class="detail-label">Atmosphere Tested By</div>
                            <div class="detail-value">${details.atmosphereTestedBy || 'N/A'}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Oxygen Level (%)</div>
                            <div class="detail-value">${details.oxygenLevel || 'N/A'}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Emergency Rescue Plan</div>
                            <div class="detail-value">${details.emergencyPlan || 'N/A'}</div>
                        </div>
                        ${renderChecklistItems('Required Controls', details.controls, {
                            'continuous-monitoring': 'Continuous atmosphere monitoring',
                            'standby-person': 'Standby person assigned',
                            'communication': 'Communication method established',
                            'isolation': 'Energy isolation completed'
                        })}
                    `;
                    break;
                    
                case 'working-at-height':
                    content += `
                        <div class="detail-row">
                            <div class="detail-label">Working Height (meters)</div>
                            <div class="detail-value">${details.workHeight || 'N/A'}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Access Equipment</div>
                            <div class="detail-value">${formatAccessEquipment(details.accessEquipment) || 'N/A'}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Drop Zone Control Measures</div>
                            <div class="detail-value">${details.dropZoneControl || 'N/A'}</div>
                        </div>
                        ${renderChecklistItems('Fall Prevention/Protection', details.fallProtection, {
                            'guardrails': 'Guardrails in place',
                            'harness': 'Full body harness and lanyard',
                            'anchor-points': 'Anchor points identified and secure',
                            'rescue-plan': 'Rescue plan in place'
                        })}
                    `;
                    break;
                    
                case 'electrical':
                    content += `
                        <div class="detail-row">
                            <div class="detail-label">Voltage Level</div>
                            <div class="detail-value">${formatVoltageLevel(details.voltageLevel) || 'N/A'}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Isolation Method</div>
                            <div class="detail-value">${formatIsolationMethod(details.isolationMethod) || 'N/A'}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Worker Competency</div>
                            <div class="detail-value">${details.electricalCompetency || 'N/A'}</div>
                        </div>
                        ${renderChecklistItems('Electrical Safety Checks', details.safetyChecks, {
                            'verified-dead': 'Circuit verified dead',
                            'earthing': 'Earthing/grounding in place',
                            'insulated-tools': 'Insulated tools available',
                            'warning-signs': 'Warning signs posted'
                        })}
                    `;
                    break;
                    
                default:
                    Object.entries(details).forEach(([key, value]) => {
                        content += `
                            <div class="detail-row">
                                <div class="detail-label">${formatLabel(key)}</div>
                                <div class="detail-value">${value}</div>
                            </div>
                        `;
                    });
            }
            
            content += '</div>';
            return content;
        }

        // Helper function to render checklist items
        function renderChecklistItems(title, items, itemMap) {
            if (!items) return '';
            
            const itemsArray = Array.isArray(items) ? items : [items];
            
            return `
                <div class="detail-row">
                    <div class="detail-label">${title}</div>
                    <div class="detail-value">
                        <ul>
                            ${itemsArray.map(item => `<li>${itemMap[item] || item}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;
        }

        // Helper function to format fire extinguisher type
        function formatFireExtinguisherType(type) {
            const typeMap = {
                'water': 'Water',
                'foam': 'Foam',
                'co2': 'CO2',
                'dry-powder': 'Dry Powder',
                'wet-chemical': 'Wet Chemical'
            };
            
            return typeMap[type] || type;
        }

        // Helper function to format access equipment
        function formatAccessEquipment(equipment) {
            const equipmentMap = {
                'ladder': 'Ladder',
                'scaffold': 'Scaffold',
                'mewp': 'MEWP (Mobile Elevating Work Platform)',
                'roof': 'Roof Access',
                'other': 'Other'
            };
            
            return equipmentMap[equipment] || equipment;
        }

        // Helper function to format voltage level
        function formatVoltageLevel(level) {
            const levelMap = {
                'low': 'Low Voltage (< 1000V AC)',
                'high': 'High Voltage (≥ 1000V AC)'
            };
            
            return levelMap[level] || level;
        }

        // Helper function to format isolation method
        function formatIsolationMethod(method) {
            const methodMap = {
                'lock-out': 'Lock-out/Tag-out',
                'isolation-switch': 'Isolation Switch',
                'circuit-breaker': 'Circuit Breaker',
                'fuse-removal': 'Fuse Removal',
                'other': 'Other'
            };
            
            return methodMap[method] || method;
        }

        // Helper function to format label from camelCase
        function formatLabel(camelCase) {
            const result = camelCase.replace(/([A-Z])/g, ' $1');
            return result.charAt(0).toUpperCase() + result.slice(1);
        }

        // Add editPermit function
        function editPermit(permitId) {
            // Redirect to the PTW form with the permit ID as a parameter
            window.location.href = `ptw.html?edit=${permitId}`;
        }
    </script>
    <!-- Standalone script for user avatar dropdown -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Setting up standalone avatar dropdown handler");
            
            // Get elements
            const userAvatarContainer = document.getElementById('userAvatarContainer');
            const userDropdown = document.querySelector('.user-dropdown');
            
            if (userAvatarContainer && userDropdown) {
                console.log("Found avatar container and dropdown elements");
                
                // Remove any existing event listeners by cloning the element
                const newUserAvatarContainer = userAvatarContainer.cloneNode(true);
                userAvatarContainer.parentNode.replaceChild(newUserAvatarContainer, userAvatarContainer);
                
                // Add fresh event listener to the avatar container
                newUserAvatarContainer.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log("Avatar clicked, toggling dropdown");
                    userDropdown.classList.toggle('show');
                });
                
                // Add document click handler to close dropdown when clicking elsewhere
                document.addEventListener('click', function(e) {
                    if (!newUserAvatarContainer.contains(e.target) && userDropdown.classList.contains('show')) {
                        console.log("Clicked outside, closing dropdown");
                        userDropdown.classList.remove('show');
                    }
                });
                
                // Prevent dropdown clicks from closing it
                userDropdown.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            } else {
                console.error("Could not find avatar container or dropdown elements");
                console.log("userAvatarContainer:", userAvatarContainer);
                console.log("userDropdown:", userDropdown);
            }
        });
    </script>
</body>
</html>
